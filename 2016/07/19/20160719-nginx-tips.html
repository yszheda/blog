<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Nginx Tips</title>
                        <link rel="stylesheet" href="../../../theme/css/main.css" />
    <meta name="description" content="最近在做server端开发，需要熟悉nginx，本渣也就在这里记录下自己遇到的一些问题。其实都比较小白，纯粹当作自我扫盲啦XD 本文将不 …" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../../../">Galoisplusplus</a></h1>
                        <nav><ul>
                                                <li><a href="../../../category/misc.html">misc</a></li>
                                                <li><a href="../../../category/music.html">music</a></li>
                                                <li><a href="../../../category/reading.html">reading</a></li>
                                                <li class="active"><a href="../../../category/tech.html">tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="../../../2016/07/19/20160719-nginx-tips.html" rel="bookmark"
             title="Permalink to Nginx Tips">Nginx Tips</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-07-19T11:22:00+08:00">
                Published: 二 19 7月 2016
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../../../author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="../../../category/tech.html">tech</a>.</p>
<p>tags: <a href="../../../tag/linux.html">Linux</a> <a href="../../../tag/cs.html">CS</a> <a href="../../../tag/tech.html">tech</a> <a href="../../../tag/nginx.html">nginx</a> </p>        
</footer><!-- /.post-info -->        <p>最近在做server端开发，需要熟悉nginx，本渣也就在这里记录下自己遇到的一些问题。其实都比较小白，纯粹当作自我扫盲啦XD 本文将不定期更新。</p>
<h1 id="nginx-emerg-bind-to-ipport-failed-98-address-already-in-use">nginx: [emerg] bind() to \&lt;ip&gt;:\&lt;port&gt; failed (98: Address already in use)</h1>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nl">nginx</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">emerg</span><span class="o">]</span><span class="w"> </span><span class="n">bind</span><span class="p">()</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ip</span><span class="o">&gt;</span><span class="err">:</span><span class="o">&lt;</span><span class="n">port</span><span class="o">&gt;</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">98</span><span class="err">:</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">use</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>端口被占用，可以用查看使用文件或socket的命令<code>fuser</code>来杀掉占用端口的进程：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>fuser<span class="w"> </span>-k<span class="w"> </span>&lt;port&gt;/tcp
</code></pre></div></td></tr></table></div>

<p>此外，如果使用IPv6还可能出现如下报错：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nl">nginx</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">emerg</span><span class="o">]</span><span class="w"> </span><span class="n">bind</span><span class="p">()</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="o">&lt;</span><span class="n">port</span><span class="o">&gt;</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">98</span><span class="err">:</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">use</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>这是由于<code>nginx</code>配置中有<code>listen &lt;port&gt;;</code>，又有<code>listen [::]:&lt;port&gt;;</code>所致。
根据<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#listen">nginx文档</a>的描述：</p>
<blockquote>
<p>By default, nginx will look up both IPv4 and IPv6 addresses while resolving. </p>
</blockquote>
<p>也就是说，<code>listen [::]:&lt;port&gt;;</code>会同时监听IPv4和IPv6的流量，所以<code>listen &lt;port&gt;;</code>是重复配置，将它删掉即可。
如果只想使用IPv6可以采用：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>listen [::]:&lt;port&gt; ipv6only=on;
</code></pre></div></td></tr></table></div>

<h2 id="_1">参考</h2>
<p><a href="http://stackoverflow.com/questions/14972792/nginx-nginx-emerg-bind-to-80-failed-98-address-already-in-use">(SOF) nginx - nginx: [emerg] bind() to [::]:80 failed (98: Address already in use)</a></p>
<h1 id="worker_connections-are-more-than-open-file-resource-limit-1024">worker_connections are more than open file resource limit: 1024</h1>
<p>这是因为nginx worker的用户打开的文件超过上限。</p>
<p>如果nginx配置中有<code>worker_rlimit_nofile</code>参数，则打开的文件数量上限由<code>worker_rlimit_nofile</code>决定（nofile=number of open files）。
那么<code>worker_rlimit_nofile</code>应该配多少呢？</p>
<p>在nginx配置的core module中找到<code>worker_processes</code>数量：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>worker_processes  4;
</code></pre></div></td></tr></table></div>

<p>在event module中找到<code>worker_connections</code>数量：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>events {
    worker_connections  1024;
}
</code></pre></div></td></tr></table></div>

<p>那么最大总连接数是<code>worker_connections * worker_processes</code>，每个active connection都会占用一个文件描述符（file descriptor），所以<code>worker_rlimit_nofile</code>最好大于<code>worker_connections * worker_processes</code>。</p>
<h2 id="_2">参考</h2>
<p><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile">nginx worker_rlimit_nofile文档</a></p>
<p><a href="http://serverfault.com/questions/208916/understanding-max-file-descriptors-for-linux-and-nginx-and-best-value-for-worke">(SOF) understanding max file descriptors for linux and nginx, and best value for worker_rlimit_nofile</a></p>
<p><a href="http://serverfault.com/questions/209014/how-can-i-observe-what-nginx-is-doing-to-solve-1024-worker-connections-are-n">(SOF) How can I observe what nginx is doing? (to solve: “1024 worker_connections are not enough”)</a></p>
<p>如果nginx配置中没有<code>worker_rlimit_nofile</code>参数，则采用系统默认的打开的文件数量上限。那么如何查看并修改这一上限呢？</p>
<p>首先在nginx配置的core module中找到nginx worker进程的用户：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>user nginx;
</code></pre></div></td></tr></table></div>

<p>在终端登入这一用户：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>nginx
</code></pre></div></td></tr></table></div>

<p>查看文件描述符的硬上限：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-Hn
</code></pre></div></td></tr></table></div>

<p>查看文件描述符的软上限：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-Sn
</code></pre></div></td></tr></table></div>

<p>这里硬上限是严格不能超过的上限，不能增加。软上限属于警告性质的上限，可以调高，但也不能超过硬上限。</p>
<p>在<code>/etc/sysctl.conf</code>中修改下述数值：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>fs.file-max = 65536
</code></pre></div></td></tr></table></div>

<p>使用以下命令加载新的配置：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>sysctl<span class="w"> </span>-p
</code></pre></div></td></tr></table></div>

<p>检查是否已更新：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/proc/sys/fs/file-max
</code></pre></div></td></tr></table></div>

<p>一些资料提到修改<code>/etc/security/limits.conf</code>中nofile的软上限和硬上限：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">*</span> soft     nofile         65535
<span class="k">*</span> hard     nofile         65535
root soft     nofile         65535
root hard     nofile         65535
</code></pre></div></td></tr></table></div>

<p>这种方式至少需要nginx worker进程重启才能生效。</p>
<h2 id="_3">参考</h2>
<p><a href="http://ss64.com/bash/ulimit.html">ulimit manual</a></p>
<p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/index.html">通过 ulimit 改善系统性能</a></p>
<p><a href="http://stackoverflow.com/questions/3107476/what-does-soft-hard-nofile-mean-on-linux">What does “soft/hard nofile” mean on Linux</a></p>
<p><a href="http://unix.stackexchange.com/questions/29577/ulimit-difference-between-hard-and-soft-limits">ulimit: difference between hard and soft limits</a></p>
<p><a href="http://ss64.com/bash/limits.conf.html">limits.conf manual</a></p>
<p><a href="http://www.cyberciti.biz/faq/making-changes-to-proc-filesystem-permanently/">Making changes to /proc filesystem permanently</a></p>
<p><a href="http://serverfault.com/questions/640976/nginx-ulimit-worker-connections-exceed-open-file-resource-limit-1024">nginx uLimit 'worker_connections exceed open file resource limit: 1024'</a></p>
<p><a href="http://unix.stackexchange.com/questions/108603/do-changes-in-etc-security-limits-conf-require-a-reboot">do changes in /etc/security/limits.conf require a reboot?</a></p>
<p><a href="http://serverfault.com/questions/165316/how-to-configure-linux-file-descriptor-limit-with-fs-file-max-and-ulimit">How to configure linux file descriptor limit with fs.file-max and ulimit</a></p>
<p><a href="http://stackoverflow.com/questions/21515463/how-to-increase-maximum-file-open-limit-ulimit-in-ubuntu">How to increase maximum file open limit (ulimit) in Ubuntu?</a></p>
<p><a href="http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files/">Nginx: 24: Too Many Open Files Error And Solution</a></p>
<h1 id="an-upstream-response-is-buffered-to-a-temporary-file">an upstream response is buffered to a temporary file</h1>
<h1 id="proxy_temp-failed-13-permission-denied-while-reading-upstream">proxy_temp failed (13: Permission denied) while reading upstream</h1>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="http://getpelican.com/">Pelican</a></li>
                                                        <li><a href="http://python.org/">Python.org</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/yszheda">GitHub</a></li>
                                                        <li><a href="https://twitter.com/yszheda">Twitter</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>