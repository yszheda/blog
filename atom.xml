<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Galoisplusplus]]></title>
  <link href="http://yszheda.github.io/blog/atom.xml" rel="self"/>
  <link href="http://yszheda.github.io/blog/"/>
  <updated>2020-05-08T19:38:26+08:00</updated>
  <id>http://yszheda.github.io/blog/</id>
  <author>
    <name><![CDATA[Galoisplusplus]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[《麦克白》的布莱希特剧场实践]]></title>
    <link href="http://yszheda.github.io/blog/blog/2019/04/07/macbeth-by-tang-shu-wing/"/>
    <updated>2019-04-07T23:36:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2019/04/07/macbeth-by-tang-shu-wing</id>
    <content type="html"><![CDATA[<p>之前我曾对莎剧中<a href="http://galoisplusplus.coding.me/galoisplusplus/blog/2016/04/03/nt-live-kinglear-and-othello/">某些“间离”元素</a>感到好奇，但也怀疑采用布莱希特（Bertolt Brecht）理论来制作莎剧是否可行，这种疑虑直到前段时间看了邓树荣工作室的《麦克白》才有所消除。</p>

<p>布莱希特在创作和理论中，曾从中国传统戏曲中汲取过养分（布莱希特看过梅兰芳的演出，也用中国传统戏曲解释他的“间离”理论。他的部分剧作也与戏曲经典剧目相关，例如受元杂剧《灰阑记》启发所创作的《高加索灰阑记》）。而在邓树荣导演的《麦克白》中，对于布莱希特“间离”理论的运用也与中国传统戏曲息息相关。
在这版制作中，场景被移植到古代中国，绝大部分角色皆着简易戏曲戏服，对白基本采用粤语，再加上舞台侧边的音效师根据台上表演实时“配乐”，乍一看还真有点粤剧的感觉。
然而，男女主角Macbeth夫妇则身穿现代西方服饰，与其他角色的着装、台上的布景和道具形成反差，构成了某种不让观众“入戏”的“间离”效果。演出一开始的画外音还交代此二人乃是现代人穿越古代，这又明白告诉观众，台上演员并不等同于戏中角色。
另外，《麦克白》第一幕原本最开始有一场三女巫的戏 [1]，邓导将其删去，直接从第二场开始。然而第二场戏的所有对白也只保留了军曹对战斗绘声绘色的描述作为画外音，舞台上则是Macbeth和Banquo以一种接近传统戏曲程式化表演的象征性动作来表现战斗的过程，这种表演效果也正是布莱希特所称赞的中国戏剧表演艺术的“陌生化”效果之一。</p>

<p>恰巧这段时间我在翻看浦安迪（Andrew H.Plaks）的《红楼梦的原型与寓意（Archetype and Allegory in the Dream of the Red Chamber）》，浦安迪关于中西方文学的原型和神话的比较于我很有启发，也提供给我思考布莱系特理论与中国传统戏曲之间关系的一个新角度：
西方文学原型具有叙事性特征，当神话素材中的人物在之后的文学作品中再现时，“其主要目的是重温那些与他们名字相关的经历”。比如讲到赫拉克勒斯时，他所做的十二项任务要比直接评价他是怎样一个人更为关键（“不管他们的行为是失意的、得志的、还是下场凄惨的，他们做了什么，远比他们是什么更重要，这些行为在整个西方文学史中回响”）。
而中国文学原型却恰恰相反，往往是给人物定性，至于人物事迹的过程，则通常一笔带过。比如大禹治水、女娲补天等神话素材，往往都是没有细节的（“在后来的中国文学中，神话的本质上的非叙述使用，事实上是比较明确的，即通常对神话人物的反映就是指一个特殊品质或是与之相关的联系，而不是他们行动的任何细枝末节”）。
我认为，后者所体现的非叙事性本质也和中国传统戏曲的审美观息息相关：在戏曲中，角色的善恶忠奸是明明白白画在脸谱上的；一般而言，角色在上场后会自报家门、交代目的，所以故事的展开并不具有悬疑性质；至于战争等大事件更是以程式化的抽象动作一带而过。
而在西方现实主义戏剧中延续的前一种传统，则受到了布莱希特的挑战。布莱希特认为：演员不应当“成为”角色而应当“展现”角色；“科学时代”的观众，不应该沉浸在角色的际遇与情感之中，而是应该成为观察家，把感受升华为认识。
也正是站在这一立场上，布莱希特对西方传统戏剧注重悬念和冲突的“戏剧性”提出质疑，并借鉴中国传统戏曲中某些非叙述性元素加以革新。</p>

<p>有意思的是，邓导的这版制作不仅巧妙融合了布莱希特理论及中国传统戏曲元素，而且又绝非是脱离莎翁《麦克白》文本的生硬植入。
其实当我们阅读《麦克白》前三幕的文本时，我们并不难发现其中某种「非叙事性」：</p>

<ul>
<li><p>Macbeth人生的转折点以及在权力的游戏中一连串杀戮的开端，是从杀害邓肯王开始的。然而，在整个第二幕中，弑君的过程却始终缺席（即使在第二幕第二场Macbeth事后的叙述中，也只有恐惧与反悔、幻听到的“Sleep no more”诅咒，并没有行为本身——正如Macbeth的台词“I am afraid to think what I have done”所揭示的对弑君行为的叙述的缺失）。而考虑到莎翁的其他作品其实并不缺少对重要的杀戮、酷刑场景的赤裸裸的描绘——比如奥赛罗掐死苔丝狄梦娜、葛罗斯特伯爵被刳眼等等——这似乎是《麦克白》相对特殊的地方。</p></li>
<li><p>不同于诸如《冬天的故事》《暴风雨》中的戏剧冲突和反转，Macbeth的弑君即位既没有过程，也不存在悬念，一切正如女巫的预言。</p></li>
<li><p>悬疑性的弱化还体现在Macbeth夫妇对于Duncan、Banquo和Macduff的阴谋都事先告知观众。莎翁在《奥赛罗》中对于伊阿古也采取了类似的设计，但这似乎并非他惯用的创作手法，例如在《李尔王》中，爱德蒙杀害考狄利娅直到事后才公诸于众。</p></li>
</ul>


<p>可以说，这些剧本中与布莱希特理论以及中国文学原型的外在相似性，正好给邓导的制作理念提供了文本的支撑。
不过，邓导对于莎翁原著的熟稔与对布莱希特理论的妙用之处尚不止如此。
例如，在第二幕第三场，Macbeth嫁祸两位守卫并杀掉他们灭口后，饰演Macbeth的演员接过话筒，以朗诵的方式念了如下辩白的台词：</p>

<blockquote><p>谁能够在惊愕之中保持冷静，在盛怒之中保持镇定，在激于忠愤的时候，保持他的不偏不倚的精神？世上没有这样的人吧。我的理智来不及控制我的愤激的忠诚。这儿躺着邓肯，他的白银的皮肤上镶着一缕缕黄金的宝血，他的创巨痛深的伤痕张开了裂口，像是一道道毁灭的门户；那边站着这两个凶手，身上浸润着他们罪恶的颜色，他们的刀上凝结着刺目的血块。只要是一个尚有几分忠心的人，谁不要怒火中烧，替他的主子报仇雪恨？</p></blockquote>

<p>这种破坏“第四堵墙”的非自然主义表演方法既符合布莱希特的“陌生化”理论（布莱希特甚至希望演员直接念舞台指示），同时也与莎翁文本此处暗示Macbeth是在众人面前“演戏”相吻合。</p>

<p>更令我拍案称奇的是，在戏的后半段，饰演Macbeth夫妇的两位演员还对调了角色——正如布莱希特曾在对演员的指示里所提到的，“演员应当和他的对手交换角色，有时仿照对手表演，有时向他示范自己的表演方式”——而且这一设计并非异想天开：在莎翁的文本中，这对夫妇一个更为冷血决绝，一个则备受良心所带来的种种梦魇折磨，在第三幕之后似乎也正好互换了人设。</p>

<p><a href="http://galoisplusplus.coding.me/galoisplusplus/blog/2016/04/03/nt-live-kinglear-and-othello/">在之前的博文里</a>我曾提到，英国国家剧院2014年制作、Sam Mendes导演的《李尔王》采用了某种为剧本台词寻找现代意义上合理解释的“实证主义”诠释方法（布莱希特也许不会赞成这种处理方式。他的某篇文章也曾以《李尔王》中李尔诅咒他的大女儿为例，认为并不应该只表达李尔“有理由”去诅咒自己的女儿，而是表现这种诅咒同时也是“毫无道理”的。），然而邓导在这一版制作中却无意于此——《麦克白》剧本中某些令人困惑以及人设不统一之处，也只是以接近布莱希特所谓「突兀给出事件」的方式加以原本呈现。文本中这些矛盾的地方诸如：在第一幕第四场，邓肯王在被考特爵士背叛后，曾感慨自己的轻信，可他很快又毫无防范地给予Macbeth相同的信任，但如果说邓肯王是毫无机心的忠厚长者的话，又缘何在授予Macbeth考特爵士后，立马就册封了长子Malcolm为Cumberland王子，以老辣果断的政治手腕明确打消Macbeth继承王位的希望？ [3] 在第四幕第三场，Malcolm一直在试探Macduff的底线，他讲了“好色”“贪财”、甚至包括对贵族权利的肆无忌惮的侵犯，Macduff为何竟然都觉得可以妥协？个人认为，要想像Sam Mendes导演一样为上述问题给出合理的解释几乎是不可能的，这一方面和剧中“fair is foul, and foul is fair”之类的朴素辩证法有关（从一点来说，又可以把该剧和布莱希特对马克思主义、中国古代哲学朴素辩证法的研究联系起来），另一方面也有莎翁写作《麦克白》时处理历史素材所遇到的政治问题的因素 [3] ——邓导也想提醒观众去注意后者：他有意在剧中打断剧情发展，安排饰演Macbeth夫人的演员朗读一段关于Gunpowder Plot的史料 [4]，这种类似布莱希特剧作中interlude的处理，把观众从演员所表现的Macbeth的世界，拉到了莎翁创作《麦克白》的世界。</p>

<p>然而，布莱希特的“理想观众”仅仅认识过去的世界是不够的，对戏剧作品的批判立场应延续至当下。
邓导版本中Macbeth夫妇的现代装束，似乎也是时刻提醒着观众本剧某种母题在当下的延续。
当我们回头审视《麦克白》前半部分的「非叙事性」时，我们也应该清醒认识到：莎翁绝不可能依据布莱希特理论来创作，似乎也不大可能了解中国传统戏曲的表现方式（当然，如果我们仔细读浦安迪关于中国文学原型的论述，我们也会发现，这两种「非叙事性」虽然相似，但无法等同）。个人认为，莎翁在此之所以弱化戏剧性冲突和悬念，是因为人类面对欲望的母题更值得探讨。
在《麦克白》剧本中，Macbeth和Banquo恰好代表了对待诱惑和欲望的两种态度。
在第一幕中，两人共同面对女巫们的预言，Banquo被许诺的荣华富贵甚至不亚于Macbeth（“less than Macbeth, and greater&hellip;”）。
但即使莎翁有意通过褒扬Banquo的品质来奉承詹姆士一世，在他的角色塑造中，Banquo仍和绝大部分凡夫俗子一般，面对如此大的诱惑绝非毫不动心（我们可以从Banquo在第二幕的台词“merciful powers, restrain in me the cursed thoughts that nature gives way to in repose!”、以及在第三幕第一场期望女巫预言实现的台词中略见一斑）。
只不过，Banquo的自制力使他没有被这样的欲望所吞噬，避免了成为另一个Macbeth的悲剧。
在第四幕Malcolm和Macduff的对话中，这一母题再次出现：
Malcolm所列举种种自己天性中的罪恶，固然是夸大其辞的试探，但这是否也是某种程度的肺腑之言呢？这是否也是某种人类普适的原罪？ [5]</p>

<p>《麦克白》的后半部分与前三幕不同，又回到了西方文学原型的「叙事性」传统。
这一次，麦克白如何战败被杀有了详尽的铺陈，女巫预言的悬念（如“none of woman born shall harm Macbeth”、森林向Dunsinane移动）也直到最后才解开。 [6]
邓导的制作中也做了一些强化戏剧冲突的调整。
例如第四幕第二场Macduff母子被杀的一场戏，被安排成第三场中Ross向Macduff传达噩耗的戏中戏（这也有点像电影中的闪回镜头，此外，这一制作在人物内心独白时也让其他人物暂时“定格”，这也是电影电视等现代媒介反向影响戏剧后产生的表现技巧），让Macduff“亲眼目睹”悲剧的一幕，不仅更富张力，而且也让后面Macduff对Macbeth的愤慨更为顺理成章。</p>

<p>邓导在戏剧表现手法上的独到还体现在第三幕第四场Macbeth国王及王后那场宴请群臣的戏。
如果要按照现实主义的表演方法，以邓导的小剧团实在不足以表现这场盛宴的宏大场面。
然而，他却反其道而行之，做了一个更大胆的、精简到极致的安排：将Ross、Lennox等群臣的戏份全部删去，台上只留下饰演Macbeth夫妇的两位演员，同时又把台下的灯打开，让观众变成群臣，观赏Macbeth“见鬼”的荒诞表演。
此外，Banquo鬼魂的不在场又进一步加强了这一场戏原有的荒诞意味（我个人觉得，《麦克白》中这一场戏、第二幕第一场中Macbeth刺杀Duncan前见到匕首的幻觉、第五幕第一场中Macbeth夫人梦魇的戏都很有荒诞意味。这一场戏邓导安排台上两位演员对着空气说对白，也有点像荒诞派尤涅斯库的《椅子》）。
在Macbeth疯疯癫癫的台词中，甚至还挪用了一段和“sleep no more”互文相关的《哈姆雷特》文本：[7]</p>

<blockquote><p>To die: to sleep;</p>

<p>No more; and by a sleep to say we end</p>

<p>The heart-ache and the thousand natural shocks</p>

<p>That flesh is heir to, &lsquo;tis a consummation</p>

<p>Devoutly to be wish&rsquo;d. To die, to sleep;</p>

<p>To sleep: perchance to dream: ay, there&rsquo;s the rub;</p>

<p>For in that sleep of death what dreams may come</p>

<p>When we have shuffled off this mortal coil,</p>

<p>Must give us pause.</p></blockquote>

<p>邓导的这一版《麦克白》，除去以上我所想到的部分之外，在粤语念白、动作编排 [7] 、舞美等方面也颇有可圈可点之处。然而，他对这一剧作的解构与重构之尺度亦不小，难免会惹来不解和争议，被认为是妄自尊大擅改经典。
而邓导通过剧末的一处安排也解释了他的态度——《麦克白》原剧的剧情结束后，Macbeth夫妇从穿越中醒来，画外音开始用普通话——这也是本制作唯一采用普通话的地方——朗读了以下这段《在延安文艺座谈会的讲话》：</p>

<blockquote><p>有人说，书本上的文艺作品，古代的和外国的文艺作品，不也是源泉吗？实际上，过去的文艺作品不是源而是流，是古人和外国人根据他们彼时彼地所得到的人民生活中的文学艺术原料创造出来的东西。我们必须继承一切优秀的文学艺术遗产，批判地吸收其中一切有益的东西，作为我们从此时此地的人民生活中的文学艺术原料创造作品时候的借鉴。有这个借鉴和没有这个借鉴是不同的，这里有文野之分，粗细之分，高低之分，快慢之分。所以我们决不可拒绝继承和借鉴古人和外国人，哪怕是封建阶级和资产阶级的东西。但是继承和借鉴决不可以变成替代自己的创造，这是决不能替代的。文学艺术中对于古人和外国人的毫无批判的硬搬和模仿，乃是最没有出息的最害人的文学教条主义和艺术教条主义。中国的革命的文学家艺术家，有出息的文学家艺术家，必须到群众中去，必须长期地无条件地全心全意地到工农兵群众中去，到火热的斗争中去，到唯一的最广大最丰富的源泉中去，观察、体验、研究、分析一切人，一切阶级，一切群众，一切生动的生活形式和斗争形式，一切文学和艺术的原始材料，然后才有可能进入创作过程。否则你的劳动就没有对象，你就只能做鲁迅在他的遗嘱里所谆谆嘱咐他的儿子万不可做的那种空头文学家，或空头艺术家。</p></blockquote>

<p>当时看了这一幕，我就在想：这个导演真是皮得很，还给大陆观众设计了这么一出，而且竟然还搬出领袖的话来为自己撑腰[滑稽]
不过仔细想想，实际上邓导的制作理念也并不激进，一些对布莱希特理论的运用也设计得小心翼翼：
例如麦克白夫妇是现代人穿越的设定，这何尝不是一种对台上演员不等于剧中角色的“写实主义解释”呢？</p>

<hr />

<p>前段时间恰好看到资深莎迷朋友翔哥在安利Bunny博士「英国文学」公众号的共读活动，在看完邓树荣导演这版制作后，我也跟了一期《麦克白》的共读。虽然很早就读过《麦克白》的译文，但用A.R.Braunmuller编写的剑桥版《Macbeth》直接读原文对我而言还是第一回，这也一次难得的反刍和学习的过程。通过群主Channing博士的导读和群里各位朋友的讨论，也打开了思路，关注到许多以前走马观花没留意的细节，本文的拙见不少也从这次共读的讨论而来，在此感谢并推荐以下几篇文章：</p>

<ul>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzI5NDExMDczOQ==&amp;mid=2650926232&amp;idx=1&amp;sn=37a166b5bf2e395bba887aa0afac96ae">古今将相在何方？荒冢一堆草没了| 《麦克白》共读内容分享</a></p></li>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzUxMzQyMTIxNA==&amp;mid=2247483785&amp;idx=1&amp;sn=e0504a851c1432d72614da7d77075bdd">《麦克白》小礼包</a></p></li>
</ul>


<hr />

<p>[1] 个人认为开头这一场戏可视为简略版的prologue，交代背景和预告故事大致走向——女巫们的对话虽然不多，但已经包含了一些重要信息：</p>

<ol>
<li>女巫们将会重新上场，她们要见Macbeth（预告第一幕第三场）。</li>
<li>有一场反败为胜的战斗（预告第一幕第二场）。</li>
<li>“fair is foul, and foul is fair”就像这部剧其中一个“剧眼”，剧中Macbeth夫妇的人生也正是这句箴言的印证（从第一幕第二场中我们也看到了对Macbeth fair一面的刻画）。
在后续几场戏的文本中，关于人的外在表现与内在品质之间关系的话题，也隐隐约约呼应这一”剧眼“。
例如第一幕第四场中，Duncan在听到考特爵士的下场后，曾感慨“知人知面不知心”（“There&rsquo;s no art / To find the mind&rsquo;s construction in the face.”）然而，他却很快在Macbeth身上又犯了同样的错误，甚至会“爱屋及乌”称赞起Macbeth的城堡（见第一幕第六场。这一场戏也有个细节，Banquo有一段对白，表达了对在此筑巢的martlet鸟的称赞，这有点像中国传统文学作品里提到“海鸥”就象征着“忘机”，也是一种赞美城堡主人品质高尚的奉承话。有趣的是，身处同一个城堡，Banquo注意到了martlet，而Macbeth夫人却注意到了乌鸦——见第一幕第五场——这是否也是一种二人内在品质的外在表现？） [2]</li>
</ol>


<p>如果从今天戏剧制作的职能分工来看，莎翁在当时并不单单只是一位编剧，而且也是戏剧导演。这意味着，他在创作时也应该会考虑到实际演出的效果。像第一场这种电闪雷鸣（舞台指示“thunder and lightning”）怪力乱神的处理也有剧场效果的考虑，提示观众肃静，表演即将开始。
（一些朋友对这一场戏简短的篇幅和某些不合常理的台词感到疑惑，我这里姑且开个脑洞：其实开头第一场的文本只保留了莎翁所认为的最重要的台词，当时三女巫的演员或许会被要求按照这份大致的指示即兴表演，甚至有可能为了迎合当时观众的趣味，还会搞些滑稽表演。）
从这一角度而言，这一场戏并不一定适合当下的剧场实践，所以邓导的版本做了删节也可理解。</p>

<p>[2] 此处我应有误读。第一幕第五场Macbeth夫人有一段台词：</p>

<blockquote><p>The raven himself is hoarse</p>

<p>That croaks the fatal entrance of Duncan</p>

<p>Under my battlements. Come, you spirits</p>

<p>That tend on mortal thoughts, unsex me here,</p>

<p>And fill me from the crown to the toe top-full</p>

<p>Of direst cruelty! make thick my blood;</p>

<p>Stop up the access and passage to remorse,</p>

<p>That no compunctious visitings of nature</p>

<p>Shake my fell purpose, nor keep peace between</p>

<p>The effect and it! Come to my woman’s breasts,</p>

<p>And take my milk for gall, you murdering ministers,</p>

<p>Wherever in your sightless substances</p>

<p>You wait on nature’s mischief! Come, thick night,</p>

<p>And pall thee in the dunnest smoke of hell,</p>

<p>That my keen knife see not the wound it makes,</p>

<p>Nor heaven peep through the blanket of the dark,</p>

<p>To cry ‘Hold, hold!’</p></blockquote>

<p>我之前误以为Macbeth夫人当时也听到乌鸦叫，由乌鸦这一凶鸟联想到“you spirits that tend on mortal thoughts”，末尾的“Hold, hold!”也从乌鸦的叫声联想而来，类似爱伦坡《乌鸦》中“Nevermore”的拟声双关，第二幕第三场Duncan被刺后Lennox说的“The obscure bird clamoured the livelong night.”应该也是指乌鸦叫。翔哥纠正说此处Macbeth夫人所说的“乌鸦”只是比喻报信人。</p>

<p>[3] 关于莎翁《麦克白》的历史素材、詹姆士一世时期的历史政治背景、以及前二者如何影响莎翁的这一创作，David Norbrook的《〈麦克白〉与历史编纂的政治》一文中有相当精到的论述。
该文也提到，按照当时苏格兰的王位继承制度，Macbeth作为王室支系完全可以通过合法手段继承王位。剧中Macbeth的一句台词也隐约暗示了这一点：</p>

<blockquote><p>If chance will have me king, why, chance may crown me, without my stir.</p></blockquote>

<p>[4] 关于Gunpowder Plot和《麦克白》的关系已有诸多讨论，可参考：</p>

<ul>
<li><a href="http://www.shakespeare-online.com/biography/gunpowderplot.html">Shakespeare and the Gunpowder Plot</a></li>
</ul>


<p>[5] 翔哥在这方面提出了很有说服力的质疑，在我想清楚之前，这里姑且采用我之前的观点。</p>

<p>[6] <a href="https://mp.weixin.qq.com/s?__biz=MzI5NDExMDczOQ==&amp;mid=2650926232&amp;idx=1&amp;sn=37a166b5bf2e395bba887aa0afac96ae">古今将相在何方？荒冢一堆草没了| 《麦克白》共读内容分享</a>中Channing博士关于第四幕第一场的导读讲得很好，此处摘录如下：</p>

<blockquote><p>Macbeth来问命运，三女巫这次没有直接告诉结果，而是由三个灵魂（戴头盔的脑袋，流血的小孩和戴王冠的小孩）给出一些提示。第一次预言的时候，Macbeth被告知知己当皇帝，这是令人垂涎的结果，但是却没有被告知过程——弑君；这次预言就不一样，告知经过和小细节，却没有告知最终结果——被杀。那么到底杀老国王、当国王、杀Banquo、Birnam森林的移动、被Macduff杀死这些事情中哪些是一定会发生的，哪些是不一定会发生的呢？女巫说的是真话吗？试想，如果女巫给预言的方式是反过来的，第一次告知过程不告知结果：Macbeth你将来会弑君；第二次告知结果而不告知过程：Macbeth你会被杀掉，那么整个故事又会怎么发展呢？女巫为什么要用不同的方式预言呢？这到底是女巫的预言，还是Macbeth自己想要听到的内容呢？</p></blockquote>

<p>[7] 《麦克白》与《哈姆雷特》的文本比较也是一个很有意思的课题。</p>

<p>比如，在面对命运时，Hamlet有过发问：</p>

<blockquote><p>Whether &lsquo;tis nobler in the mind to suffer the slings and arrows of outrageous fortune, or to take arms against a sea of troubles, and by opposing end them?</p></blockquote>

<p>而Macbeth也有顺其自然还是加速历史进程的纠结：</p>

<blockquote><p>If chance will have me king, why, chance may crown me, without my stir.</p></blockquote>

<p>然而，Macbeth对行凶的犹豫与反思逐渐让位于某种彻头彻尾的行动主义（activism）。
这方面在Timothy Fuller的《〈麦克白〉中的思与行》一文中得到了较好的讨论。</p>

<p>[8] 关于舞台动作仅举一例：前两幕饰演Macbeth夫人的演员在独白时采用了和三女巫相似的躬身踱步的动作，而莎翁剧本中Macbeth夫人这一角色与女巫的相似之处其实也被诸多评论家探讨过，例如把怂恿丈夫作恶的Macbeth夫人比作女巫喀耳刻。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[盘点2018年度的现场音乐会]]></title>
    <link href="http://yszheda.github.io/blog/blog/2019/01/01/those-concerts-in-2018/"/>
    <updated>2019-01-01T20:55:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2019/01/01/those-concerts-in-2018</id>
    <content type="html"><![CDATA[<p>之前老和朋友们黑我村是“文化沙漠”，也没少抱怨说来我村后基本告别音乐会了，结果年终回顾时，一翻过去的日记和票根还是&hellip;唉，怎么说呢，就是以为改用拼多多消费降级、结果反而被坑了更多钱的mmp（当然很多只是日常吐槽，比如RNO（还好有Pletnev公公的拉二）、比如Repin的车祸）。所以不搞十大也还是随便写写好了，恩。</p>

<p>18年听了不少场深交，也许是因为深交这一年请了不少大咖的缘故吧（滑稽）深交甚至有一晚还一连请了两位独奏家——贾然和诹访内晶子。这一场因为主办方很少宣传，不少乐迷都不造诹访竟然还来过我朝，之前XD大师也为错过这场被雪藏的音乐会而惋惜。但港真，个人觉得贾然的老肖第一钢协没啥听头，诹访也没有想象中那么好，只是至少可以听名琴，乐队的表现也不在最佳水准。燃鹅，深交18年有几场的表现还是让我刮目相看的，甚至我觉得和前一年听的简直判若两团——比如吕绍嘉（那一场还有秦立巍的德大协）、Fedoseyev（那一场还有莱姨的勃二钢协）、Herbig大师指挥的几场——可见这只乐团还是很有潜力，只是尚需靠谱大师调教。这一年还忽悠了一位同事一起去听深交，也还好没坑他XD（至于为啥多了一张票，我也忘了[捂脸]）</p>

<p>这一年“文化沙漠”让人惊喜的还有一场非音乐会版歌剧《蝴蝶夫人》，原本还以为在我村只能看看偶尔到影院看个METLive呢。不过，唱巧巧桑的权慧丞和Pickton的Paul O'Neill都表现平平，倒不如Sarks Agnes唱的铃木那么有感染力。此外，汤沐海老司机带的央歌也只是正常水准，不至于酿成车祸，页谈不上特别出彩。最大的亮点恐怕还是从悉尼歌剧院引进的制作：在有限的舞台上诗意表现了日本文化中的物哀和寂灭，蝴蝶被钉住的歌词也被视觉化为巧巧桑被绸缎束缚住的舞蹈，成为之后巧巧桑悲剧中反复出现的意象。</p>

<p>18年是德彪西逝世一百周年，这一年我也从华纳、DG家出的纪念包子里听了不少之前不熟悉的德彪西作品，其中艺术歌曲是我的「新欢」，为此我还找了Hyperion出的Debussy Songs系列边听边翻booklet自我扫盲。比较遗憾的是，这一年深交和其他本地乐团并没搞啥像样的纪念德彪西的活动，好在还有中法文化节所引进的Pascal Rénéric编排的“Claude, es-tu là”（竟然不是Monsieur Croche哈XD）。这场音乐会形式新颖，揉合了德彪西书信及艺术评论朗诵、钢琴作品《意象集》选段、艺术歌曲选段和弦乐四重奏，Rénéric在朗诵之余甚至还耍了一把小魔术——考虑到他的「招魂」设定，这倒也不逾矩。演奏家中钢琴家Momo Kodama、男中音Josep-Ramon Olivé虽然不能让我满意，但Quatour Tana的演奏却让我路转粉了。他们录音所选的作品还相对小众，其中Reich已经算是比较大俗了，还有一些作曲家我之前还不认识（捂脸）。据说他们还有签售，原本是应该去一下，至少把碟剁了，然而要赶高铁伤不起&hellip;而且之前买碟买太多了，如果再买碟带回家是要zuo die啊&hellip;要是有乐迷帮我带就好了，可惜在我村你懂的（滑稽）BTW. 这又是一场被我村雪藏的优质音乐会——看看我村最近炒作的都是些啥，西本智实的团好歹还是渣渣里的正规军，维也纳莫扎特乐团这种割不明真相游客韭菜的野鸡团也好意思吹上天：「金色大厅常驻团首次来华巡演！全套妆发加原始曲谱，带你震撼“穿越”莫扎特」？。而且，某音乐厅的推文甚至连艺术歌曲都宣传成歌剧了&hellip;《佩里亚斯与梅丽桑德》一句都木有！差评！偶可以打12315投诉你们虚假宣传么？（滑稽）</p>

<p>18年纪念性的演出还有塔霍和比诺什合作的纪念Barbara逝世二十周年舞台剧“Vaille que Vivre”。看之前恰好在影展上看了Mathieu
Amalric拍的Barbara传记片，还蛮喜欢Barbara唱的chanson，于是就买票去了。结果国内的巡演塔霍又不来，钢伴换了人，兴趣直接降了一半，比诺什女神唱得简直&hellip;难听哭（怪不得访谈里她提到，塔霍一开始只给她排了四首歌orz）与其说是去听Barbara的音乐，倒不如说听了一场法语朗诵，看了一场简约肢体剧&hellip;</p>

<p>虽然我村的古典音乐演出不尽如人意，但是当代音乐/声音艺术/民乐之类的活动倒还让人耳目一新。最后提下18年在33空间的「山居吟——跨媒体实验剧场 古琴x当代舞x声影景致氛围」。</p>

<p>当我在写此文时，33空间恰好有沈丕基和文怡的古琴实验声音现场「时差」。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[cudaErrorCudartUnloading问题排查及建议方案]]></title>
    <link href="http://yszheda.github.io/blog/blog/2018/05/22/cudaErrorCudartUnloading/"/>
    <updated>2018-05-22T22:00:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2018/05/22/cudaErrorCudartUnloading</id>
    <content type="html"><![CDATA[<p>最近一段时间一直在负责做我厂神经网络前向框架库的优化，前几天接了一个bug report，报错信息大体是这样的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Program hit cudaErrorCudartUnloading (error 29) due to "driver shutting down" on CUDA API call to cudaFreeHost.</span></code></pre></td></tr></table></div></figure>


<p>同样的库链接出来的可执行文件，有的会出现这种问题有的不会，一开始让我很自然以为是使用库的应用程序出了bug。排除了这种可能之后，这句话最后的<code>cudaFreeHost</code>又让我想当然地以为是个内存相关的问题，折腾了一阵后才发现方向又双叒叕错了。而且我发现，无论我在报错的那段代码前使用任何CUDA runtime API，都会出现这个错误。
后来在网上查找相关信息，以下的bug report虽然没有具体解决方案，但相似的call stack让我怀疑这和我遇到的是同一个问题，而且也让我把怀疑的目光聚焦在"driver shutting down"而非<code>cudaFreeHost</code>上。</p>

<ul>
<li><p><a href="https://github.com/opencv/opencv/issues/7816">https://github.com/opencv/opencv/issues/7816</a></p></li>
<li><p><a href="https://github.com/BVLC/caffe/issues/6281">https://github.com/BVLC/caffe/issues/6281</a></p></li>
<li><p><a href="https://stackoverflow.com/questions/40979060/cudaerrorcudartunloading-error-29-due-to-driver-shutting-down">https://stackoverflow.com/questions/40979060/cudaerrorcudartunloading-error-29-due-to-driver-shutting-down</a></p></li>
<li><p><a href="https://github.com/NVlabs/SASSI/issues/4">https://github.com/NVlabs/SASSI/issues/4</a></p></li>
<li><p><a href="https://blog.csdn.net/jobbofhe/article/details/79386160">https://blog.csdn.net/jobbofhe/article/details/79386160</a></p></li>
</ul>


<h1>强制阻止"driver shutting down"？</h1>

<p>首先一个看似理所当然的思路是：我们能否在使用CUDA API时防止CUDA driver不被shutdown呢？问题在于"driver shutting down"究竟指的是什么？如果从<code>cudaErrorCudartUnloading</code>的字面意思来讲，很可能是指cuda_runtime的library被卸载了。
由于我们用的是动态链接库，于是我尝试在报错的地方前加上<code>dlopen</code>强制加载<code>libcuda_runtime.so</code>。改完后马上发现不对，如果是动态库被卸载，理应是调用CUDA API时发现相关symbol都没有定义才对，而不应该是可以正常调用动态库的函数、然后返回error code这样的runtime error现象。
此外，我通过<code>strace</code>发现，还有诸如<code>libcuda.so</code>、<code>libnvidia-fatbinaryloader.so</code>之类的动态库会被加载，都要试一遍并不现实。何况和CUDA相关的动态库并不少（可参考<a href="http://us.download.nvidia.com/XFree86/Linux-x86/367.35/README/installedcomponents.html">《NVIDIA Accelerated Linux Graphics Driver README and Installation Guide》中的“Chapter 5. Listing of Installed Components”</a>），不同的程序依赖的动态库也不尽相同，上述做法即使可行，也很难通用。</p>

<p>无独有偶，在nvidia开发者论坛上也有开发者有<a href="https://devtalk.nvidia.com/default/topic/1019780/?comment=5191690">类似的想法</a>，被官方人士否定了：</p>

<blockquote><p>For instance, can I have my class maintain certain variables/handles that will force cuda run time library to stay loaded.</p>

<p>No. It is a bad design practice to put calls to the CUDA runtime API in constructors that may run before main and destructors that may run after main.</p></blockquote>

<h1>如何使CUDA runtime API正常运作？</h1>

<p>对于CUDA应用程序开发者而言，我们通常是通过调用CUDA runtime API来向GPU设备下达我们的指令。所以首先让我们来看，在程序中调用CUDA runtime API时，有什么角色参与了进来。我从<a href="http://www.cudahandbook.com/">Nicholas Wilt的《The CUDA Handbook》</a>中借了一张图：</p>

<p><img src="http://yszheda.github.io/blog/images/cudaErrorCudartUnloading/CUDA-software-layers.png"></p>

<p>我们可以看到，主要的角色有：运行在操作系统的User Mode下的CUDART(CUDA Runtime) library（对于动态库来说就是上文提到的<code>libcuda_runtime.so</code>）和CUDA driver library（对于动态库来说就是上文提到的<code>libcuda.so</code>），还有运行在Kernel Mode下的CUDA driver内核模块。众所周知，我们的CUDA应用程序是运行在操作系统的User Mode下的，无法直接操作GPU硬件，在操作系统中有权控制GPU硬件的是运行在Kernel Mode下的内核模块（OT一下，作为CUDA使用者，我们很少能感觉到这些内核模块的存在，也它们许最有存在感的时候就是我们遇上<code>Driver/library version mismatch</code>错误了XD）。在Linux下我们可以通过<code>lsmod | grep nvidia</code>来查看这些内核模块，通常有管理Unified Memory的<code>nvidia_uvm</code>、Linux内核<a href="https://dri.freedesktop.org/wiki/DRM/">Direct Rendering Manager</a>显示驱动<code>nvidia_drm</code>、还有<code>nvidia_modeset</code>。与这些内核模块沟通的是运行在User Mode下的CUDA driver library，我们所调用的CUDA runtime API会被CUDART library转换成一系列CUDA driver API，交由CUDA driver library这个连接CUDA内核模块与其他运行在User Mode下CUDA library的中介。</p>

<p>那么，要使CUDA runtime API所表示的指令能被正常传达到GPU，就需要上述角色都能通力协作了。这就自然引发一个问题：在我们的程序运行的时候，这些角色什么时候开始/结束工作？它们什么时候被初始化？我们不妨<code>strace</code>看一下CUDA应用程序的系统调用：
首先，<code>libcuda_runtime.so</code>、<code>libcuda.so</code>、<code>libnvidia-fatbinaryloader.so</code>等动态库被加载。当前被加载进内核的内核模块列表文件<code>/proc/modules</code>被读取，由于<code>nvidia_uvm</code>、<code>nvidia_drm</code>等模块之前已被加载，所以不需要额外<code>insmod</code>。接下来，设备参数文件<code>/proc/driver/nvidia/params</code>被读取，相关的设备——如<code>/dev/nvidia0</code>（GPU卡0）、<code>/dev/nvidia-uvm</code>（看名字自然与Unified Memory有关，可能是Pascal体系Nvidia GPU的Page Migration Engine）、<code>/dev/nvidiactl</code>等——被打开，并通过<code>ioctl</code>初始化设定。（此外，还有home目录下<code>~/.nv/ComputeCache</code>的一些文件被使用，这个目录是用来缓存PTX伪汇编JIT编译后的二进制文件fat binaries，与我们当前的问题无关，感兴趣的朋友可参考<a href="https://devblogs.nvidia.com/cuda-pro-tip-understand-fat-binaries-jit-caching/">Mark Harris的《CUDA Pro Tip: Understand Fat Binaries and JIT Caching》</a>。）要使CUDA runtime API能被正常执行，需要完成上述动态库的加载、内核模块的加载和GPU设备设置。</p>

<p>但以上还只是从系统调用角度来探究的一个必要条件，还有一个条件写过CUDA的朋友应该不陌生，那就是CUDA context（如果你没印象了，可以回顾一下CUDA官方指南中讲<a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#initialization">初始化</a>和<a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#context">context</a>的部分）。我们都知道：所有CUDA的资源（包括分配的内存、CUDA event等等）和操作都只在CUDA context内有效；在第一次调用CUDA runtime API时，如果当前设备没有创建CUDA context，新的context会被创建出来作为当前设备的primary context。这些操作对于CUDA runtime API使用者来说是不透明的，那么又是谁做的呢？让我来引用一下<a href="https://stackoverflow.com/questions/35815597/cuda-call-fails-in-destructor">SOF上某个问题下</a>community wiki的标准答案：</p>

<blockquote><p>The CUDA front end invoked by nvcc silently adds a lot of boilerplate code and translation unit scope objects which perform CUDA context setup and teardown. That code must run before any API calls which rely on a CUDA context can be executed. If your object containing CUDA runtime API calls in its destructor invokes the API after the context is torn down, your code may fail with a runtime error.</p></blockquote>

<p>这段话提供了几个信息：一是<code>nvcc</code>插入了一些代码来完成的CUDA context的创建和销毁所需要做的准备工作，二是CUDA context销毁之后再调用CUDA runtime API就可能会出现runtime error这样的未定义行为（Undefined Behaviour，简称UB）。</p>

<p>接下来让我们来稍微深入地探究一下。我们有若干<code>.cu</code>文件通过<code>nvcc</code>编译后产生的<code>.o</code>文件，还有这些<code>.o</code>文件链接后生成的可执行文件<code>exe</code>。我们通过<code>nm</code>等工具去查看这些<code>.o</code>文件，不难发现这些文件的代码段中都被插入了一个以<code>__sti____cudaRegisterAll_</code>为名字前缀的函数。我们在<code>gdb &lt;exe&gt;</code>中对其中函数设置断点再单步调试，可以看到类似这样的call stack：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) bt
</span><span class='line'>#0  0x00002aaab16695c0 in __cudaRegisterFatBinary () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#1  0x00002aaaaad3eee1 in __sti____cudaRegisterAll_53_tmpxft_000017c3_00000000_19_im2col_compute_61_cpp1_ii_a0760701() ()
</span><span class='line'>    at /tmp/tmpxft_000017c3_00000000-4_im2col.compute_61.cudafe1.stub.c:98
</span><span class='line'>#2  0x00002aaaaaaba3a3 in _dl_init_internal () at /lib64/ld-linux-x86-64.so.2
</span><span class='line'>#3  0x00002aaaaaaac46a in _dl_start_user () at /lib64/ld-linux-x86-64.so.2
</span><span class='line'>#4  0x0000000000000001 in  ()
</span><span class='line'>#5  0x00007fffffffe2a8 in  ()
</span><span class='line'>#6  0x0000000000000000 in  ()</span></code></pre></td></tr></table></div></figure>


<p>再执行若干步，call stack就变成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) bt
</span><span class='line'>#0  0x00002aaab16692b0 in __cudaRegisterFunction () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#1  0x00002aaaaad3ef3e in __sti____cudaRegisterAll_53_tmpxft_000017c3_00000000_19_im2col_compute_61_cpp1_ii_a0760701() (__T263=0x7c4b30)
</span><span class='line'>    at /tmp/tmpxft_000017c3_00000000-4_im2col.compute_61.cudafe1.stub.c:97
</span><span class='line'>#2  0x00002aaaaad3ef3e in __sti____cudaRegisterAll_53_tmpxft_000017c3_00000000_19_im2col_compute_61_cpp1_ii_a0760701() ()
</span><span class='line'>    at /tmp/tmpxft_000017c3_00000000-4_im2col.compute_61.cudafe1.stub.c:98
</span><span class='line'>#3  0x00002aaaaaaba3a3 in _dl_init_internal () at /lib64/ld-linux-x86-64.so.2
</span><span class='line'>#4  0x00002aaaaaaac46a in _dl_start_user () at /lib64/ld-linux-x86-64.so.2
</span><span class='line'>#5  0x0000000000000001 in  ()
</span><span class='line'>#6  0x00007fffffffe2a8 in  ()
</span><span class='line'>#7  0x0000000000000000 in  ()</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) bt
</span><span class='line'>#0  0x00002aaaaae8ea20 in atexit () at XXX.so
</span><span class='line'>#1  0x00002aaaaaaba3a3 in _dl_init_internal () at /lib64/ld-linux-x86-64.so.2
</span><span class='line'>#2  0x00002aaaaaaac46a in _dl_start_user () at /lib64/ld-linux-x86-64.so.2
</span><span class='line'>#3  0x0000000000000001 in  ()
</span><span class='line'>#4  0x00007fffffffe2a8 in  ()
</span><span class='line'>#5  0x0000000000000000 in  ()</span></code></pre></td></tr></table></div></figure>


<p>那么CUDA context何时被创建完成呢？通过对<code>cuInit</code>设置断点可以发现，与官方指南的描述一致，也就是在进入<code>main</code>函数之后调用第一个CUDA runtime API的时候：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) bt
</span><span class='line'>#0  0x00002aaab1ab7440 in cuInit () at /lib64/libcuda.so.1
</span><span class='line'>#1  0x00002aaab167add5 in  () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#2  0x00002aaab167ae31 in  () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#3  0x00002aaabe416bb0 in pthread_once () at /lib64/libpthread.so.0
</span><span class='line'>#4  0x00002aaab16ad919 in  () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#5  0x00002aaab167700a in  () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#6  0x00002aaab167aceb in  () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>#7  0x00002aaab16a000a in cudaGetDevice () at /usr/local/cuda/lib64/libcudart.so.8.0
</span><span class='line'>...
</span><span class='line'>#10 0x0000000000405d77 in main(int, char**) (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;)</span></code></pre></td></tr></table></div></figure>


<p>其中，和context创建相关的若干函数就在<code>${CUDA_PATH}/include/crt/host_runtime.h</code>中声明过：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#define __cudaRegisterBinary(X)                                                   \</span>
</span><span class='line'><span class="cp">        __cudaFatCubinHandle = __cudaRegisterFatBinary((void*)&amp;__fatDeviceText); \</span>
</span><span class='line'><span class="cp">        { void (*callback_fp)(void **) =  (void (*)(void **))(X); (*callback_fp)(__cudaFatCubinHandle); }\</span>
</span><span class='line'><span class="cp">        atexit(__cudaUnregisterBinaryUtil)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span><span class="o">**</span> <span class="n">CUDARTAPI</span> <span class="n">__cudaRegisterFatBinary</span><span class="p">(</span>
</span><span class='line'>  <span class="kt">void</span> <span class="o">*</span><span class="n">fatCubin</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="n">CUDARTAPI</span> <span class="nf">__cudaUnregisterFatBinary</span><span class="p">(</span>
</span><span class='line'>  <span class="kt">void</span> <span class="o">**</span><span class="n">fatCubinHandle</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="n">CUDARTAPI</span> <span class="nf">__cudaRegisterFunction</span><span class="p">(</span>
</span><span class='line'>        <span class="kt">void</span>   <span class="o">**</span><span class="n">fatCubinHandle</span><span class="p">,</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span>    <span class="o">*</span><span class="n">hostFun</span><span class="p">,</span>
</span><span class='line'>        <span class="kt">char</span>    <span class="o">*</span><span class="n">deviceFun</span><span class="p">,</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span>    <span class="o">*</span><span class="n">deviceName</span><span class="p">,</span>
</span><span class='line'>        <span class="kt">int</span>      <span class="n">thread_limit</span><span class="p">,</span>
</span><span class='line'>        <span class="n">uint3</span>   <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
</span><span class='line'>        <span class="n">uint3</span>   <span class="o">*</span><span class="n">bid</span><span class="p">,</span>
</span><span class='line'>        <span class="n">dim3</span>    <span class="o">*</span><span class="n">bDim</span><span class="p">,</span>
</span><span class='line'>        <span class="n">dim3</span>    <span class="o">*</span><span class="n">gDim</span><span class="p">,</span>
</span><span class='line'>        <span class="kt">int</span>     <span class="o">*</span><span class="n">wSize</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="o">**</span><span class="n">__cudaFatCubinHandle</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">__cudaUnregisterBinaryUtil</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">____nv_dummy_param_ref</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">__cudaFatCubinHandle</span><span class="p">);</span>
</span><span class='line'>  <span class="n">__cudaUnregisterFatBinary</span><span class="p">(</span><span class="n">__cudaFatCubinHandle</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但这些函数都没有文档，<a href="http://people.cs.pitt.edu/~yongli/notes/gpgpu/GPGPUSIMNotes.html">Yong Li博士写的《GPGPU-SIM Code Study》</a>稍微详细一些，我就直接贴过来了：</p>

<blockquote><p>The simplest way to look at how nvcc compiles the ECS (Execution Configuration Syntax) and manages kernel code is to use nvcc’s <code>--cuda</code> switch. This generates a .cu.c file that can be compiled and linked without any support from NVIDIA proprietary tools. It can be thought of as CUDA source files in open source C. Inspection of this file verified how the ECS is managed, and showed how kernel code was managed.</p>

<ol>
<li><p>Device code is embedded as a fat binary object in the executable’s <code>.rodata</code> section. It has variable length depending on the kernel code.</p></li>
<li><p>For each kernel, a host function with the same name as the kernel is added to the source code.</p></li>
<li><p>Before <code>main(..)</code> is called, a function called <code>cudaRegisterAll(..)</code> performs the following work:</p></li>
</ol>


<p>• Calls a registration function, <code>cudaRegisterFatBinary(..)</code>, with a void pointer to the fat binary data. This is where we can access the kernel code directly.</p>

<p>• For each kernel in the source file, a device function registration function, <code>cudaRegisterFunction(..)</code>, is called. With the list of parameters is a pointer to the function mentioned in step 2.</p>

<ol>
<li>As aforementioned, each ECS is replaced with the following function calls from the execution management category of the CUDA runtime API.</li>
</ol>


<p>• <code>cudaConfigureCall(..)</code> is called once to set up the launch configuration.</p>

<p>• The function from the second step is called. This calls another function, in which, <code>cudaSetupArgument(..)</code> is called once for each kernel parameter. Then, <code>cudaLaunch(..)</code> launches the kernel with a pointer to the function from the second step.</p>

<ol>
<li>An unregister function, <code>cudaUnregisterBinaryUtil(..)</code>, is called with a handle to the fatbin data on program exit.</li>
</ol>
</blockquote>

<p>其中，<code>cudaConfigureCall</code>、<code>cudaSetupArgument</code>、<code>cudaLaunch</code>在CUDA7.5以后已经“过气”（deprecated）了，由于这些并不是在进入<code>main</code>函数之前会被调用的API，我们可以不用管。我们需要关注的是，在<code>main</code>函数被调用之前，<code>nvcc</code>加入的内部初始化代码做了以下几件事情（我们可以结合上面<code>host_runtime.h</code>头文件暴露出的接口和相关call stack来确认）：</p>

<ol>
<li>通过<code>__cudaRegisterFatBinary</code>注册fat binary入口函数。这是CUDA context创建的准备工作之一，如果在<code>__cudaRegisterFatBinary</code>执行之前调用CUDA runtime API很可能也会出现UB。SOF上就有这样一个问题，题主在<code>static</code>对象构造函数中调用了kernel函数，结果就出现了"invalid device function"错误，SOF上的<a href="https://stackoverflow.com/questions/24869167/trouble-launching-cuda-kernels-from-static-initialization-code/24883665#24883665">CUDA大神talonmies的答案</a>就探究了<code>static</code>对象构造函数和<code>__cudaRegisterFatBinary</code>的调用顺序及其产生的问题，非常推荐一读。</li>
<li>通过<code>__cudaRegisterFunction</code>注册每个device的kernel函数</li>
<li>通过<code>atexit</code>注册<code>__cudaUnregisterBinaryUtil</code>的注销函数。这个函数是CUDA context销毁的清理工作之一，前面提到，CUDA context销毁之后CUDA runtime API就很可能无法再被正常使用了，换言之，如果CUDA runtime API在<code>__cudaUnregisterBinaryUtil</code>执行完后被调用就有可能是UB。而<code>__cudaUnregisterBinaryUtil</code>在什么时候被调用又是符合<a href="http://en.cppreference.com/w/cpp/utility/program/atexit"><code>atexit</code></a>规则的——在<code>main</code>函数执行完后程序<code>exit</code>的某阶段被调用（<code>main</code>函数的执行过程可以参考<a href="http://umumble.com/blogs/development/the-thorny-path-of-hello-world/">这篇文章</a>）——这也是我们理解和解决<code>cudaErrorCudartUnloading</code>问题的关键之处。</li>
</ol>


<p><img src="http://yszheda.github.io/blog/images/cudaErrorCudartUnloading/main-procedure.png"></p>

<h1>一切皆全局对象之过</h1>

<p>吃透本码渣上述啰里啰唆的理论后，再通过代码来排查<code>cudaErrorCudartUnloading</code>问题就简单了。原来，竟和之前提过的<a href="https://stackoverflow.com/questions/35815597/cuda-call-fails-in-destructor">SOF上的问题</a>相似，我们代码中也使用了一个全局<code>static</code> singleton对象，在singleton对象的析构函数中调用CUDA runtime API来执行释放内存等操作。而我们知道，<code>static</code>对象是在<code>main</code>函数执行完后<code>exit</code>进行析构的，而之前提到<code>__cudaUnregisterBinaryUtil</code>也是在这个阶段被调用，这两者的顺序是未定义的。如果<code>__cudaUnregisterBinaryUtil</code>等清理context的操作在<code>static</code>对象析构之前就调用了，就会产生<code>cudaErrorCudartUnloading</code>报错。这种UB也解释了，为何之前我们的库链接出来的不同可执行文件，有的会出现这个问题而有的不会。</p>

<h1>解决方案</h1>

<p>在github上搜<code>cudaErrorCudartUnloading</code>相关的patch，处理方式也是五花八门，这里姑且列举几种。</p>

<h2>跳过<code>cudaErrorCudartUnloading</code>检查</h2>

<p>比如<a href="https://github.com/arrayfire/arrayfire/pull/170">arrayfire项目的这个patch</a>。可以，这很佛系（滑稽）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="o">-</span>    <span class="n">CUDA_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'><span class="o">+</span>    <span class="n">cudaError_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cudaFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">cudaErrorCudartUnloading</span><span class="p">)</span> <span class="c1">// see issue #167</span>
</span><span class='line'><span class="o">+</span>        <span class="n">CUDA_CHECK</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>干脆把可能会有<code>cudaErrorCudartUnloading</code>的CUDA runtime API去掉</h2>

<p>比如kaldi项目的<a href="https://github.com/kaldi-asr/kaldi/issues/2178">这个issue</a>和<a href="https://github.com/kaldi-asr/kaldi/pull/2185">PR</a>。论佛系，谁都不服就服你（滑稽）</p>

<h2>把CUDA runtime API放到一个独立的de-initialisation、finalize之类的接口，让用户在<code>main</code>函数<code>return</code>前调用</h2>

<p>比如MXNet项目的<code>MXNotifyShutdown</code>（参见：<a href="https://github.com/apache/incubator-mxnet/blob/master/src/c_api/c_api.cc">c_api.cc</a>）。佛系了辣么久总算看到了一种符合本程序员审美的“优雅”方案（滑稽）</p>

<p>恰好在SOF另一个问题中，talonmies大神（啊哈，又是talonmies大神！）在<a href="https://stackoverflow.com/questions/16979982/cuda-streams-destruction-and-cudadevicereset/16982503?noredirect=1#comment24536013_16982503">留言</a>里也表达了一样的意思，不能赞同更多啊：</p>

<blockquote><p>The obvious answer is don&rsquo;t put CUDA API calls in the destructor. In your class you have an explicit intialisation method not called through the constructor, so why not have an explicit de-initialisation method as well? That way scope becomes a non-issue</p></blockquote>

<p>上面的方案虽然“优雅”，但对于库维护者却有多了一层隐忧：万一加了个接口，使用者要撕逼呢？（滑稽）万一使用者根本就不鸟你，没在<code>main</code>函数<code>return</code>前调用呢？要说别人打开方式不对，人家还可以说是库的实现不够稳健把你批判一通呢。如果你也有这种隐忧，请接着看接下来的“黑科技”。</p>

<h2>土法黑科技（滑稽）</h2>

<p>首先，CUDA runtime API还是不能放在全局对象析构函数中，那么应该放在什么地方才合适呢？毕竟我们不知道库使用者最后用的是哪个API啊？不过，我们却可以知道库使用者使用什么API时是在<code>main</code>函数的作用域，那个时候是可以创建有效的CUDA context、正常使用CUDA runtime API的。这又和我们析构函数中调用的CUDA runtime API有什么关系呢？你可能还记得吧，前边提到<code>nvcc</code>加入的内部初始化代码通过<code>atexit</code>注册<code>__cudaUnregisterBinaryUtil</code>的注销函数，我们自然也可以如法炮制：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// 首先调用一个“无害”的CUDA runtime API，确保在调用`atexit`之前CUDA context已被创建</span>
</span><span class='line'><span class="c1">// 这样就确保我们通过`atexit`注册的函数在CUDA context相关的销毁函数（例如`__cudaUnregisterBinaryUtil`）之前就被执行</span>
</span><span class='line'><span class="c1">// “无害”的CUDA runtime API？这里指不会造成影响内存占用等副作用的函数，我采用了`cudaGetDeviceCount`</span>
</span><span class='line'><span class="c1">// 《The CUDA Handbook》中推荐使用`cudaFree(0);`来完成CUDART初始化CUDA context的过程，这也是可以的</span>
</span><span class='line'><span class="kt">int</span> <span class="n">gpu_num</span><span class="p">;</span>
</span><span class='line'><span class="n">cudaError_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cudaGetDeviceCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpu_num</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">std</span><span class="o">::</span><span class="n">atexit</span><span class="p">([](){</span>
</span><span class='line'>    <span class="c1">// 调用原来在全局对象析构函数中的CUDA runtime API</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么，应该在哪个地方插入上面的代码呢？解铃还须系铃人，我们的<code>cudaErrorCudartUnloading</code>问题出在<code>static</code> singleton对象身上，但以下singleton的惰性初始化却也给了我们提供了一个绝佳的入口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// OT一下，和本中老年人一样上了年纪的朋友可能知道</span>
</span><span class='line'><span class="c1">// 以前在C++中要实现线程安全的singleton有多蛋疼</span>
</span><span class='line'><span class="c1">// 有诸如Double-Checked Locking之类略恶心的写法</span>
</span><span class='line'><span class="c1">// 但自打用了C++11之后啊，腰不酸了,背不疼了,腿啊也不抽筋了,码代码也有劲儿了（滑稽）</span>
</span><span class='line'><span class="c1">// 以下实现在C++11标准中是保证线程安全的</span>
</span><span class='line'><span class="k">static</span> <span class="n">Singleton</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">static</span> <span class="n">Singleton</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为库使用者只会在<code>main</code>函数中通过这个接口使用singleton对象，所以只要在这个接口初始化CUDA context并用<code>atexit</code>注册清理函数就可以辣！当然，作为一位严谨的库作者，你也许会问：不能对库使用者抱任何幻想，万一别人在某个全局变量初始化时调用了呢？Bingo！我只能说目前我们的业务流程可以让库使用者不会想这么写来恶心自己而已&hellip;（捂脸）万一真的有这么作的使用者，这种方法就失效了，使用者会遇到和<a href="https://stackoverflow.com/questions/24869167/trouble-launching-cuda-kernels-from-static-initialization-code">前面提到的SOF某问题</a>相似的报错。毕竟，黑科技也不是万能的啊！</p>

<h1>后记</h1>

<p>解决完<code>cudaErrorCudartUnloading</code>这个问题之后，又接到新的救火任务，排查一个使用加密狗API导致的程序闪退问题。加密狗和<code>cudaErrorCudartUnloading</code>两个问题看似风马牛不相及，本质竟然也是相似的：又是一样的UB现象；又是全局对象；又是在全局对象构造和析构时调用了加密狗API，和加密狗内部的初始化和销毁函数的执行顺序未定义。看来，不乱挖坑还是要有基本的常识——在使用外设设备相关的接口时，要保证在<code>main</code>函数的作用域里啊！</p>

<h1>参考资料</h1>

<ul>
<li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html">《CUDA官方指南》</a></li>
<li><a href="http://www.cudahandbook.com/">Nicholas Wilt的《The CUDA Handbook》</a></li>
<li><a href="http://us.download.nvidia.com/XFree86/Linux-x86/367.35/README/installedcomponents.html">《NVIDIA Accelerated Linux Graphics Driver README and Installation Guide》中的“Chapter 5. Listing of Installed Components”</a></li>
<li><a href="https://devblogs.nvidia.com/cuda-pro-tip-understand-fat-binaries-jit-caching/">CUDA Pro Tip: Understand Fat Binaries and JIT Caching</a></li>
<li><a href="http://people.cs.pitt.edu/~yongli/notes/gpgpu/GPGPUSIMNotes.html">Yong Li博士写的《GPGPU-SIM Code Study》</a></li>
<li><a href="http://umumble.com/blogs/development/the-thorny-path-of-hello-world/">The thorny path of Hello World</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[盘点2017年度的现场音乐会]]></title>
    <link href="http://yszheda.github.io/blog/blog/2018/01/01/those-concerts-in-2017/"/>
    <updated>2018-01-01T18:55:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2018/01/01/those-concerts-in-2017</id>
    <content type="html"><![CDATA[<p>离开魔都之后，优质音乐会没辣么丰富，所以过去的一年便听得少了。还是随便记点流水帐好了XD</p>

<p>17年是Monteverdi诞辰450周年，自然少不了纪念蒙太公的活动。Concerto Italiano来魔都上演了L'Orfeo，采用了1609年出版的版本。
Concerto Italiano水准自然给力，Alessandrini演奏harpsichord并指挥，对dynamics的调控很值得称道。
可惜只是音乐会版歌剧，略显简陋。</p>

<p>不过，17年看的个人最佳歌剧现场却非L'Orfeo，而是“炸天师”（Rene Jacobs）指挥FBO (Freiburger Barockorchester)的莫扎特《女人心》。同样是音乐会版歌剧，但演唱家们融入了不少戏剧表演，很有喜剧效果。其中，孙海英（Sunhae Im）唱的Despina既有酷炫的花腔，又善于表演，口哨吹得骚，抢走了不少主角的光芒和掌声。炸天师在指挥之余，还不忘与之互动幽默一把——怪不得有人说孙海英是天师的御用女配（滑稽）——惹得台下阵阵笑声。难能可贵的是，上海大剧院合唱团在天师调教之下，表现也可圈可点。</p>

<p>凑巧的是，年底另一只来自弗莱堡的乐团Ensemble Recherche也来华了，不过与FBO主打古乐曲目截然相反，这只团主要演奏现当代曲目。此前钟神曾给我看了他们的巡演曲目，全是现当代作品，简直辣眼睛：作曲家中相对眼熟的有Rihm、Carl Nielsen，其他人如Chaya Czernowin、Per Norgaard则简直闻所未闻。
后来应该是考虑到我朝观众的接受程度，换了一套传统了不少的曲目单。
其中为数不多的现代作品，如Kroll的Felix namquees和Salvatore Sciarrino的Gesualdo senza parcle不合谐音很少，接受起来并不难。
唐赫的《穿粤》和沈叶的《镜中》是首演，前者写得还挺有趣，虽然我听着老想起《忐忑》（滑稽）。
龚丽妮的演唱对于舒伯特的艺术歌曲来说，则略平淡了些，倒有点古乐派“飞仙”Emma Kirkby的感觉了（滑稽）。</p>

<p>说到艺术歌曲，就不能不谈谈Kaufmann的recital。原本我并不喜欢Kaufmann的舒伯特艺术歌曲录音，反倒觉得他那张瓦格纳很出彩，但这次他排的全场艺术歌曲曲目实在诱人，而且难得他不放鸽子取消音乐会，便临时起意去听了。也许是Kaufmann刚在呆丸巡演过来，“舟车劳顿”（滑稽），上半场的舒伯特和迪帕克唱得我吐槽不能，特别是迪帕克，我一回去马上就听Gens姨的版本洗耳朵了（滑稽）。倒是下半场的Richard Strauss让我觉得不虚此行。最后Kaufmann加演了《微笑王国》《托斯卡》中的选段，也许是受现场乐迷的热情所感染，加之有迷妹送花，Kaufmann唱得格外动情，与上半场简直判若两人。这次的钢伴Helmut Deutsch起的作用也举足轻重，Kaufmann不给力时全靠他hold住了。</p>

<p>再盘点下17年听的一些独奏会。</p>

<p>年初Iveta Apkalna的recital还是我第一次现场听管风琴独奏。除了老巴赫作品外，Apkalna基本选了现当代作品。其中，Philip Glass《Satyagraha》名段Conclusion的改编版在管风琴上演奏效果更好，倒让我觉得管弦乐是不伦不类的改编了；George Thalben-Ball的帕变完全采用脚键盘演奏，令人叹为观止。</p>

<p>作为羽管键琴乐爱好者，Ruzickova的学生Esfahani来上海音乐厅弹哥德堡我自然不会错过。伊朗人不乏让人耳目一新的处理，然而这些亮点多半是一时的灵思巧动，整合起来并不能成为一套经得起推敲、可以说服我的演绎，和他老师还是有差距的。最后安可的斯卡拉蒂和拉莫个人也不太喜欢他的演奏。</p>

<p>之前曾和Pahud的recital擦肩而过，这一年倒是赶上了，这也成为我来鹏城后听得最尽兴的一场音乐会。Pahud的演奏充满张力，一直在吊着听众的注意力。Le Sage和Pahud是老搭档，尽管Le Sage的独奏个人持保留意见，但这两人的音色真是相得益彰。很希望以后能有机会现场听Les Vents Francais木管五重奏组的演奏。</p>

<p>如果要评17年年度最佳的话，说不定就是那场我很想去而最终又没去成的Elisso Virsaladze（“小薇”嘛，你们懂的）的recital了。一开始听说她年初要去HK，就有乐迷朋友种草。我想还得打飞的办签注，老东家老加班挤不出时间，就没去，但立了个flag，说“小薇”来内地一定去。非常幸运的是，年末“小薇”来我朝巡演，去帝都和魔都。原本我计划去魔都一趟的，几位朋友以为我这忠实粉必去无疑，结果我新东家到外地组织团建，改了时间后恰好错过orz&hellip;&hellip;flag不能乱立啊！多蒙翔哥和钟神发了几个现场风衣，让我聊解错失之遗憾。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jonas Kaufmann独奏会之艺术歌曲]]></title>
    <link href="http://yszheda.github.io/blog/blog/2017/11/11/Jonas-Kaufmann-recital/"/>
    <updated>2017-11-11T11:55:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2017/11/11/Jonas-Kaufmann-recital</id>
    <content type="html"><![CDATA[<h1>Schubert</h1>

<h2>鳟鱼 (The Troud, D. 550)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>明亮的小河里面  有一条小鳟鱼   快活的游来游去  像箭儿一样
</span><span class='line'>我站在小河岸旁  静静的朝它望   在清清的河水里面  它游得
</span><span class='line'>多欢畅   在清清的河水里面  它游得多欢畅 
</span><span class='line'>
</span><span class='line'>那渔夫带着钩竿  站在河岸旁  冷酷的看着它  想把鱼儿钓上
</span><span class='line'>我心里这样期望  只要河水清又亮  他别想把小鳟鱼钓上岸
</span><span class='line'>只要河水清又亮  他别想把小鳟鱼钓上岸 
</span><span class='line'>  
</span><span class='line'>但渔夫不愿久等  浪费时光   他赶忙搅浑河水  我还来不及想
</span><span class='line'>把小鳟鱼钓上岸    我满怀激愤的心情看小鳟鱼上了当
</span><span class='line'>我满怀激愤的心情看小鳟鱼上了当</span></code></pre></td></tr></table></div></figure>


<h2>菩提树 (The linden Tree from &ldquo;Winter Journey&rdquo;)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Am brunnen vor dem tore da steht ein Lindenbaum; 
</span><span class='line'>门前有棵菩提树,生长在古井边
</span><span class='line'>ich traumt' in seinem Schatten so manchen suBen Traum. 
</span><span class='line'>我做过无数美梦在它的绿荫间
</span><span class='line'>Ich schnitt in seine Rinde so manches liebe Wort;
</span><span class='line'>也曾在那树干上刻下甜蜜诗句
</span><span class='line'>es zog in freud und Leide zu ihm mich immerfort
</span><span class='line'>无论快乐和痛苦常在树下留连
</span><span class='line'>Ich muBt auch heute wandern vorbei in tiefer Nacht,
</span><span class='line'>今天像往日一样,我流浪到深夜
</span><span class='line'>da hab ich noch im Dunkel die Augen zugemacht.
</span><span class='line'>我在黑暗中行走,闭上了我的双眼
</span><span class='line'>Und seinr Zweige rauschten,
</span><span class='line'>好像听见那树叶
</span><span class='line'>als riefen sie mir zu,
</span><span class='line'>对我轻声呼唤
</span><span class='line'>kommher zu mie,Geselle,hier findstdu deine Ruh!
</span><span class='line'>同伴,回到我这里,来找寻平安!
</span><span class='line'>Die kalten Winde bliesen mir grad ins Angesicht, 
</span><span class='line'>凛冽的北风吹来,直扑上我的脸
</span><span class='line'>der Hut flog mir vom Kopfe,ich wendetemich nicht.
</span><span class='line'>把头上帽子吹落我仍坚定向前
</span><span class='line'>Nun bin ich manche Stunde entfernt von jenem Ort,
</span><span class='line'>如今我远离故乡,转眼有许多年
</span><span class='line'>und immer horich's rauschen;
</span><span class='line'>但仍常听见呼唤
</span><span class='line'>du fandest ruhe dort!
</span><span class='line'>到这里寻找平安!</span></code></pre></td></tr></table></div></figure>


<h2>春天的青春 (The Youth at the Spring, D. 300)</h2>

<ul>
<li><a href="http://www.lieder.net/lieder/get_text.html?TextId=14248">http://www.lieder.net/lieder/get_text.html?TextId=14248</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Der Jüngling an der Quelle
</span><span class='line'>
</span><span class='line'>Language: German (Deutsch)
</span><span class='line'>
</span><span class='line'>Leise, rieselnder Quell, ihr wallenden, flispernden Pappeln,
</span><span class='line'>Euer Schlummergeräusch wecket die Liebe nur auf.
</span><span class='line'>Linderung sucht' ich bei euch, und sie zu vergessen, die Spröde;
</span><span class='line'>Ach! und Blätter und Bach seufzen: [Elisa! mir zu.]1</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The youth by the spring
</span><span class='line'>
</span><span class='line'>Softly, trickling spring! Ye churning, rustling poplars!
</span><span class='line'>The sounds of slumber you make will only awaken my love.
</span><span class='line'>Balm was I seeking from you and to forget her indifference.
</span><span class='line'>Ah, the brook and each tree sigh for my loved one, for thee.</span></code></pre></td></tr></table></div></figure>


<h2>缪斯的儿子 (The Son of the Muses, D. 764)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Der Musensohn
</span><span class='line'>
</span><span class='line'>Durch Feld und Wald zu schweifen,
</span><span class='line'>Mein Liedchen wegzupfeifen,
</span><span class='line'>So gehts von Ort zu Ort!
</span><span class='line'>Und nach dem Takte reget,
</span><span class='line'>Und nach dem Maaß beweget
</span><span class='line'>Sich alles an mir fort.
</span><span class='line'>
</span><span class='line'>Ich kann sie kaum erwarten,
</span><span class='line'>Die erste Blum' im Garten,
</span><span class='line'>Die erste Blüt' am Baum.
</span><span class='line'>Sie grüßen meine Lieder,
</span><span class='line'>Und kommt der Winter wieder,
</span><span class='line'>Sing' ich noch jenen Traum.
</span><span class='line'>
</span><span class='line'>Ich sing' ihn in der Weite,
</span><span class='line'>Auf Eises Läng' und Breite,
</span><span class='line'>Da blüht der Winter schön!
</span><span class='line'>Auch diese Blüte schwindet,
</span><span class='line'>Und neue Freude findet
</span><span class='line'>Sich auf bebauten Höhn.
</span><span class='line'>
</span><span class='line'>Denn wie ich bei der Linde
</span><span class='line'>Das junge Völkchen finde,
</span><span class='line'>Sogleich erreg' ich sie.
</span><span class='line'>Der stumpfe Bursche bläht sich,
</span><span class='line'>Das steife Mädchen dreht sich
</span><span class='line'>Nach meiner Melodie.
</span><span class='line'>
</span><span class='line'>Ihr gebt den Sohlen Flügel
</span><span class='line'>Und treibt, durch Thal und Hügel,
</span><span class='line'>Den Liebling weit von Haus.
</span><span class='line'>Ihr lieben holden Musen,
</span><span class='line'>Wann ruh' ich ihr am Busen
</span><span class='line'>Auch endlich wieder aus?</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>In field and wood a-roaming -- 
</span><span class='line'>I pipe my tune a-blowing
</span><span class='line'>And dart from hill to dale (2)
</span><span class='line'>And with my rhythm beating -- 
</span><span class='line'>The pulse of life repeating
</span><span class='line'>A chorus and a dance (2) from morn to night enhance.
</span><span class='line'> 
</span><span class='line'>And I can hardly wait then - 
</span><span class='line'>To see the blooming garden
</span><span class='line'>The budding flowering trees -
</span><span class='line'>My songs I play to greet them -
</span><span class='line'>And though the winter meets them
</span><span class='line'>My song comes from the dream (the dream) (2)
</span><span class='line'> 
</span><span class='line'>I sing around the hillsides -- 
</span><span class='line'>Of winter's blooming kingdom
</span><span class='line'>The beauty of her realm (2)
</span><span class='line'>And then the ice is melted -- 
</span><span class='line'>And joy, again, is felt there
</span><span class='line'>Her bounty is alive ------ through all the countryside (2)
</span><span class='line'> 
</span><span class='line'>And when beneath the lime tree
</span><span class='line'>The lads and lasses find me -- 
</span><span class='line'>Their laughter fills the world.
</span><span class='line'>The lads show off their feathers -- 
</span><span class='line'>No matter what the weather
</span><span class='line'>The lasses dance and twirl -- Oh, how they dance and whirl and twirl !
</span><span class='line'>
</span><span class='line'>You spark my inspiration -- 
</span><span class='line'>And nurture new creation
</span><span class='line'>Your fav'rite far from home (2)
</span><span class='line'>Oh, muses, dearest, kindest - 
</span><span class='line'>Whenever will I find rest?
</span><span class='line'>Oh, shall you bring me home? (2) And I, no more to roam.</span></code></pre></td></tr></table></div></figure>


<h1>Schumann</h1>

<ul>
<li><a href="https://www.hyperion-records.co.uk/dc.asp?dc=D_CDS44441/50">https://www.hyperion-records.co.uk/dc.asp?dc=D_CDS44441/50</a>

<h2>《十二首诗》节选，op.35  (Zwölf Gedichte von Justinus Kerner Op 35)</h2>

<h3>No.1：暴风雨之夜的快乐 (No 1: Lust der Sturmnacht)</h3></li>
</ul>


<blockquote><p>The accompaniment rumbles between the hands in a way that recalls the oscillations of Schöne Wiege meiner Leiden from the Heine Liederkreis, Op 24. The tempo is faster of course because this is storm music where inn-sign and window rattle in the force of the wind. But the point of the song is that all this nasty weather is ‘draussen’ (outside) and that the narrator of the poem is cradled safely within the bosom of the family. Those with fortunate childhoods remember a sense of warm security as they were tucked up in bed, protected from the howling rain and wind. This poem translates childlike cosiness into adult exultation – a mood typical of Kerner, and of Schumann in 1840; the forces of nature are enlisted as supporting players in the poet’s ecstatic celebration of his domestic happiness. The ups and downs of the external storm only emphasize the warmth and stability of what lies safely within. So the song is not really what it appears to be at first glance or first hearing – a romanticized lowering landscape in the manner of the Eichendorff songs. Instead it attempts to depict something more abstract – the calm centre of the storm where the poet’s mental and physical rapture as a husband are counterbalances to the huffings and puffings of external influences. It was an apt poem for a newly married composer to choose to begin a cycle.
The key signature of E flat major shows us that Schumann symbolically discounts the grim weather from the outset. At the beginning (and for much of the song) the music, thanks to a slew of bristling accidentals, blusters in E flat minor. It would have been simple enough to preface the whole song with the six flats which signify this key, but this would have implied the victory of the forces of darkness over those of light. With only three flats at the core of the song the composer tells us that however violent the storm outside, his own state of mind remains calmly fixed in the radiance of the major key. The difficulty of Lust der Sturmnacht – particularly for the interpreters – is that the music gives out two messages at once, and it is usually the first and most obvious, the angry, stormy mood, which prevails. The vocal line is demanding and, as it curves to the top of its first phrase, high-lying and dramatic. The vitality of the piano writing encourages the pianist to launch into displays of temperament to mirror the vicissitudes of the weather which can easily seem furious rather than exultant.</p>

<p>After two lines of music (the poem’s first verse) we are led into the song’s inner sanctum: there is a significant change of mood as the veil of gloom lifts almost literally. Instead of growling left-hand fifths and octaves, the whole texture of the song lightens as the bass line ascends the stave and changes character completely. With these notes a curtain rises as if pulled upwards by the pianist’s left hand, revealing a bright and cosy scene of happiness. It is a scene such as this which the winter traveller glimpses through the window in Täuschung (Schubert’s Winterreise). ‘Ruht es sich so süss hier innen’ suddenly becomes bathed in a glow of F7 leading to B flat major, a gentle sighing tune which is repeated after a short piano interlude. Further musing excursions into E flat7 and A flat major at ‘all der goldne Himmelsschimmer’ restate the warmth and inner glow of a life where heaven is in the here-and-now of domestic happiness. For the poem’s third strophe the music becomes even more ethereal; now the sense of rapture has become so heady that the bass line floats further upward and takes shelter in the treble clef directly under the right-hand chords. The move into A flat major (the subdominant of the home key) has already led us into a musical region of intimacy and radiance, but as the accompaniment becomes further etiolated we are spirited beyond the living-room into the intimacy of the bedroom cushioned with the softest linen and the purest love (‘Halt’ mich fest in linden Armen!’).</p>

<p>It is time now for the song to change direction and return to the mood of the opening. Schumann uses the closing lines of the third strophe as a bridge passage back to the storm music. So strong is the magic of the human warmth surrounding the poet that he imagines spring in winter, the actual season an irrelevance to his mood. In his domestic happiness he experiences something like Goethe’s ‘Frühling übers Jahr’, spring the whole year through. Staccato semiquavers alternate between the hands with a flurry of activity suggestive of tiny buds pricking their way though the soil. First single A flats in the left hand tentatively exchange greetings with right-hand thirds; the right hand then descends and crosses over the left following the vocal line (‘Lenzesblumen aufwärts dringen’) in a courtship dance of delight. The voice then flirtatiously suddenly changes direction and moves up the scale (‘Wölklein ziehn und Vöglein singen’). With such a chase, and the rising of the vocal sap, more insistent pianistic left-hand octaves stampede in the opposite direction. Thus spring’s return is painted in an ever broader and richer spectrum of colour and movement. No sooner are we in the key of B flat at ‘Vöglein singen’ than we are off again, this time plunging back to E flat minor for a repeat of the song’s opening melody. Schumann parades the conflicting imageries of spring and winter before us side-by-side.</p>

<p>Once again we hear the stirring music of the opening and the poet seems to stand before us in all his glory. (It was always Schumann’s ability to somehow build up a portrait of his poets through his songs, and here we are introduced to Kerner in no uncertain terms.) Although the whole point of the song is that the poet is indoors when he sings it, there is something majestic about his utterance which reminds us of King Lear’s outdoor ‘Blow, winds, and crack your cheeks! rage! blow! You cataracts and hurricanoes, spout Till you have drench’d our steeples, drowned the cocks!’ Kerner is no dethroned king, but as one of Germany’s early exponents of natural medicine and other holistic therapies, he is an outsider, a free-thinking pioneer ahead of his time, well placed to defy the external elements as well as those elements in society which would accuse him of madness. Schumann’s uses a vocal trill, a device rare for him, on ‘Himmels helle’ (we hear this phrase twice) to mark the sheer delight which Kerner feels in the eye of the storm, and also his delight in the paradox which his poem describes. The major-key elation of the virtuosic final bars (one of Schumann’s more difficult postludes) unites the energy of the storm with the leaping heartbeat of personal exultation. Nature’s forces, no matter how forbidding their external manifestation, are harnessed to celebrate the joys of a fulfilled inner life.</p>

<p>from notes by Graham Johnson © 1998</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Wenn durch Berg und Tale draussen
</span><span class='line'>Regen schauert, Stürme brausen,
</span><span class='line'>Schild und Fenster hell erklirren,
</span><span class='line'>Und in Nacht die Wandrer irren,
</span><span class='line'>Ruht es sich so süss hier innen,
</span><span class='line'>Aufgelöst in selges Minnen;
</span><span class='line'>All der goldne Himmelsschimmer
</span><span class='line'>Flieht herein ins stille Zimmer:
</span><span class='line'>
</span><span class='line'>Reiches Leben, hab’ Erbarmen!
</span><span class='line'>Halt’ mich fest in linden Armen!
</span><span class='line'>Lenzesblumen aufwärts dringen,
</span><span class='line'>Wölklein ziehn und Vöglein singen.
</span><span class='line'>
</span><span class='line'>Ende nie, du Sturmnacht, wilde!
</span><span class='line'>Klirrt, ihr Fenster, schwankt, ihr Schilde,
</span><span class='line'>Bäumt euch, Wälder, braus’, o Welle,
</span><span class='line'>Mich umfängt des Himmels helle!
</span><span class='line'>
</span><span class='line'>Justinus Kerner (1786-1862)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>When, outside, over hill and vale
</span><span class='line'>rain streams and tempests rage,
</span><span class='line'>house-emblem, window, rattle loud
</span><span class='line'>and in the darkness travellers stray,
</span><span class='line'>here inside it is so sweet to rest
</span><span class='line'>and give oneself to blissful love;
</span><span class='line'>the whole of Heaven’s golden gleam
</span><span class='line'>flees hither to this quiet room:
</span><span class='line'>
</span><span class='line'>have compassion, O abundant life,
</span><span class='line'>hold me fast with gentle arm.
</span><span class='line'>The flowers of spring thrust up,
</span><span class='line'>clouds are scudding and birds sing.
</span><span class='line'>
</span><span class='line'>Never end, wild night of storm,
</span><span class='line'>rattle, house-emblems and windows,
</span><span class='line'>rear up, forests. Roar, O wave.
</span><span class='line'>Locked am I in Heaven’s bright embrace!
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 1998</span></code></pre></td></tr></table></div></figure>


<h3>No.4：第一抹绿色 (No 4: Erstes Grün)</h3>

<blockquote><p>This is certainly the most famous of all the Kerner settings and the most frequently encountered in recitals. It is not hard to see why. The song is something of a tonic, and was conceived as such by both composer and poet. Even the piano interludes ‘perk up’ in an enchanting way. The original title of the lyric was Frühlingskur (the concept of the ‘cure’ is alive and well today in a Germany where many are still addicted to ‘taking the waters’) and springtime is here presented as a great healer. This is made even clearer by Frühlingsmorgen, the poem which precedes this in Kerner’s Dichtungen (1834). In that poem, the season of gambolling lambs and singing larks is said to make the sickest heart blossom in the midst of its withering, giving it reason to sing with joy. Here are early signs of a Green Party; the poet shuns mankind in favour of nature’s awakening power, an ability to heal both psychically and physically. And by implication this also applies to the purity of what one eats, and of the herbal remedies scorned by conventional medicine. The marking ‘Einfach’ (‘simple’) implies that Schumann sees Kerner as connected to the source of nature and, as such, the music associated with his healing powers should be free of artificial flavourings.
The first signs of spring’s arrival are to be seen in the fledgling green of newly emerging grass. The key is G major and one recalls that the Andersen setting Märzveilchen (Op 40 No 1) is in this tonality. A feature common to the two songs is the interplay between the hands in the accompaniment: sighing quavers phrased away in the left hand, and panting little semiquavers pulsating off the beat. These pinpricks of sound represent the audacious act of flowers or plants making tiny holes in the earth’s surface in order to emerge into daylight. (Mendelssohn, in his G major duet Maiglöckchen und die Blümelein (1844), seems to have been influenced by Schumann.) Erstes Grün is utterly strophic, so we hear the same melody three times; the vocal line is always in G minor (representing winter gloom and depression) and the delicious interlude, which suggests a springtime roundelay, is in the major key.</p>

<p>Kerner’s words are set to music which, like so much else in Schumann’s nature mode, suggests folksong. It is the accompaniment which enriches and fills out the picture. A heart racing with feelings of fear and presentiment, certainly a heart unsettled by the winter blues, is suggested by the insistent chords off the beat which shadow the vocal melody almost throughout. The little fragmentary march on ‘Das von des Winters Schnee erkrankt’ (voice and piano suddenly coming together) provides a fleeting moment of connection with the march of awakening springtime in Schubert’s Trockne Blumen from Die schöne Müllerin. The following interlude (we hear it three times in all, including its appearance as the song’s postlude) is something new and original. It is partly rueful, partly celebratory. Traditionally, it is subject to pianists’ whimsical rubato where the tempo picks up in the manner of a spring lamb, at first slightly unsteady on its feet and then, as it gets into its stride, gaining confidence to hop and skip with impunity. This suggests the stirring of something long dormant, the rising of the sap perhaps, a half-forgotten sense of childlike delight awakened by the first blade of grass and the first ray of sunshine – winter’s chloroform negated by springtime’s chlorophyll. The interlude pivots around chromatically rising basses, but it begins in an innocent G major, and ends there too, high in the treble. This tonality is then immediately countermanded by the return of a G minor chord in the right hand, again followed by an accented D in the left – the knell of spring’s hopes which reminds us that, as yet, the new season is only a fantasy, and that winter still reigns.</p>

<p>The second and third verses of the poem perhaps suit the same music less well. Kerner’s poem was designed to reflect an increasing sense of delight in the second strophe, and Schumann forgoes this subtle change of mood in the interest of simplicity. There is, however, a sense of conspiracy and suspense on the second verse’s ‘Hier in des Waldes stillem Grund’. It seems that the music stems, so to speak, from that ground: voice and piano come together in prayer-like communion for the extraordinary ceremony of pressing the first green shoots ‘an Herz und Mund’. As he picks, and even tastes, the new green growth, Kerner reminds us that he was a naturopath. Once again the G major interlude – prancing plucked basses, starting slightly under tempo, then turning into a cheeky miniature czárdás. The last strophe seems both metaphorically eloquent as well as a practical comment on the efficacy of natural remedies for mankind’s ailments – in this case the stopping of palpitations. The interlude may here be shaped slightly differently by the pianist, less skittishly and more calmly to mirror the words ‘Macht, dass mein Herze stiller schlägt’. A sense of frustrated impatience and longing has been replaced by the glow of gentle fulfilment. This is reflected in the dreamy nature of the final cadence. At the crucial moment where the music has shifted back to G minor in earlier strophes, the piano dwells lovingly on a moment of suspended chromaticism before dropping with the utmost tenderness to three perfectly placed chords in G major. A gentle smile in music.</p>

<p>from notes by Graham Johnson © 1998</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Du junges Grün, du frisches Gras!
</span><span class='line'>Wie manches Herz durch dich genas,
</span><span class='line'>Das von des Winters Schnee erkrankt,
</span><span class='line'>O wie mein Herz nach dir verlangt!
</span><span class='line'>Schon wächst du aus der Erde Nacht,
</span><span class='line'>Wie dir mein Aug’ entgegen lacht!
</span><span class='line'>Hier in des Waldes stillem Grund
</span><span class='line'>Drück ich dich, Grün, an Herz und Mund.
</span><span class='line'>
</span><span class='line'>Wie treibt’s mich von den Menschen fort!
</span><span class='line'>Mein Leid das hebt kein Menschenwort,
</span><span class='line'>Nur junges Grün, ans Herz gelegt
</span><span class='line'>Macht, dass mein Herze stiller schlägt.
</span><span class='line'>
</span><span class='line'>Justinus Kerner (1786-1862)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Young green, fresh grass,
</span><span class='line'>how many a heart you have healed
</span><span class='line'>that fell ill from winter’s snow,
</span><span class='line'>how great my heart’s desire for you!
</span><span class='line'>Already from earth’s night you grow,
</span><span class='line'>how my eye laughs to greet you!
</span><span class='line'>Here, in the forest’s silent depths,
</span><span class='line'>you, green, I press to heart, to lips.
</span><span class='line'>
</span><span class='line'>How great my urge to quit humankind!
</span><span class='line'>No human word will lift my grief,
</span><span class='line'>only green grass, put to my heart,
</span><span class='line'>will make my heart beat calmer.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 1998</span></code></pre></td></tr></table></div></figure>


<h3>No.7：流浪汉 (No 7: Wanderung)</h3>

<blockquote><p>This song, with its lilting 6/8 rhythm, is a very close relative of Der Knabe mit dem Wunderhorn heard earlier on this disc. Like Aus alten Märchen from Dichterliebe, it belongs to that list of songs of magic-carpet enchantment which Schumann of all the great Lieder composers seems to have been best qualified to conjure. He has a quixotic strain of sheer whimsy, and the ability to pursue it, with childlike curiosity, to the point of exact musical expression. This is quite simply a matchless quality, and one that we cherish.
On the other hand Schumann could sometimes go into this fairytale mode almost too automatically, and so it seems here. Kerner’s poem is deeper and more demanding than either Geibel’s salute to the youth of Des Knaben Wunderhorn or Heine’s vision of a rocking-horse land of dreams and fantasies. Kerner’s poem is not as great as Heine’s perhaps, but it asks for things other than a magic-carpet ride through the landscape. Unlike the Cupid-like putto of the Geibel setting, the narrator here remains a real person on the printed page of poetry. In the first strophe we hear of severed bonds (‘Zerissen, ach zerissen Ist manches teure Band’); this occasions a brief dalliance with G minor, but this twinge of musical regret seems brief to the point of being glib. In Schumann’s music he sounds relieved to be rid of old ties. In the second verse Kerner describes how he has often prostrated himself at wayside shrines; and in the last he rejoices in the strength of his relationship, declaring himself to be close to all earth and heaven as a result. Perhaps embarrassed by this strain of Swabian devoutness, Schumann simply misses the deeper import of this lyric; for once, he forgets to keep the poet in mind and we have to stretch our imaginations to believe that this light-hearted song (enchanting though it is in its own terms) refers to the same man whose love for his wife and family has given rise to Lust der Sturmnacht. In short, the music lacks the gravitas we have come to expect from the Kerner songbook.</p>

<p>This having been said, there is much to admire. One can scarcely blame Schumann, the artful arranger and shuffler of moods, for engineering a change of pace in his Liederreihe after the portentous strains of the Trinkglas song. And we have the relief of that change in full measure. The music dances and floats with cheeky insouciance; the composer instructs the accompanist to keep his piano part light and gentle. The ‘scoring’ of the song suggests pizzicato strings limned with the perky woodwind gallantry of bassoons. The key of the song is B flat major. In the second strophe there is a shift to F7 which colours the music of remembered prayer with a gently rueful hue and smoother rhythms; this is capped by a shift to A flat7 for ‘Ihr Bäume, ach, ihr Hügel’ where a note of longing and nostalgia temporarily casts a shadow over the landscape – although to no very serious effect.</p>

<p>And then it is back to the first rollicking melody despite the fact that the world is asleep, and another composer might have attempted something like the mood of Schubert’s Wandrers Nachtlied. Despite their silence in the poem, the birds are made to twitter merrily in the light staccato accompaniment. The composer is perhaps at his best in the next few lines which allow him to express a deliriously joyous sense of inner happiness and satisfaction which, together with the marking of ‘Bewegter’ (‘faster’) brims over into exultingly prancing triplets pushing the voice into a higher and more heroic tessitura. Schumann seems to have taken the word ‘Pfand’ in an archaic way as if the singer is carrying the colours of his fair lady at a joust. This may account for the piano writing here which, in the way the performers approach the heights as if they were hurdles or jumps, suggests the exhilaration and rough-and-tumble of a tournament. Indeed the whole thing may be taken to be a self-consciously medieval evocation of ancient minstrelsy; Die schöne Magelone of Brahms comes instantly to mind. In Schumann’s imagination Kerner is playing the part of a gallant lover rather than being himself. The postlude is infectious in its gaiety and energy: the twin worlds of sky and earth are depicted by a dancing B flat figuration that is first heard in the treble, and echoed an octave lower. The song always brings a smile, for it is, in truth, a cocky scherzo of almost irresistible charm. Like Heine’s Aus alten Märchen it vanishes like a drift of foam (‘Zerflieht’s wie eitel Schaum’); but we cannot chide Schumann too long for being superficial when he goes so deep elsewhere in the cycle.</p>

<p>from notes by Graham Johnson © 1998</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Wohlauf und frisch gewandert
</span><span class='line'>Ins unbekannte Land!
</span><span class='line'>Zerrissen, ach zerrissen,
</span><span class='line'>Ist manches teure Band.
</span><span class='line'>Ihr heimatlichen Kreuze,
</span><span class='line'>Wo ich oft betend lag,
</span><span class='line'>Ihr Bäume, ach, ihr Hügel,
</span><span class='line'>O blickt mir segnend nach.
</span><span class='line'>
</span><span class='line'>Noch schläft die weite Erde,
</span><span class='line'>Kein Vogel weckt den Hain,
</span><span class='line'>Doch bin ich nicht verlassen,
</span><span class='line'>Doch bin ich nicht allein,
</span><span class='line'>
</span><span class='line'>Denn, ach, auf meinem Herzen
</span><span class='line'>Trag’ ich ihr teures Pfand,
</span><span class='line'>Ich fühl’s, und Erd und Himmel
</span><span class='line'>Sind innig mir verwandt.
</span><span class='line'>
</span><span class='line'>Justinus Kerner (1786-1862)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Come, briskly tramp
</span><span class='line'>to the unknown land!
</span><span class='line'>Severed, ah severed
</span><span class='line'>is many a true bond.
</span><span class='line'>Homely crucifixes,
</span><span class='line'>where often I lay in prayer,
</span><span class='line'>you trees, ah, you hills,
</span><span class='line'>gaze after me and bless me.
</span><span class='line'>
</span><span class='line'>Still the wide world sleeps,
</span><span class='line'>no bird wakes the wood,
</span><span class='line'>yet I am not forsaken,
</span><span class='line'>yet I am not alone,
</span><span class='line'>
</span><span class='line'>for, ah, upon my heart
</span><span class='line'>I wear her precious pledge,
</span><span class='line'>I feel it, and earth and sky
</span><span class='line'>are kith and kin to me.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 1998</span></code></pre></td></tr></table></div></figure>


<h3>No.9：问题 (No 9: Frage)</h3>

<blockquote><p>This is a poem which contains Kerner’s entire credo in a single strophe. It is a catalogue of the poet’s reason for living, and when read on the printed page of the Dichtungen, it seems a joyful paean to the restorative powers of nature and of poetry (it is not clear here whether ‘Lied’ means ‘word’, ‘tone’ or both). Of course it is unthinkable that any of the things that Kerner names (apart from song which needs the human touch) should not exist, unless a nuclear catastrophe or environmental disaster (a silent spring devoid of birdsong – unimaginable to the nineteenth century) should devastate the planet. The questions are thus almost entirely rhetorical, and quite different from the more usual sort of poetic fancy which imagines the barrenness of a life devoid of love and its personal embodiment. Each of the poet’s lines is followed by an exclamation, and if we were to have heard Kerner read this poem he would almost certainly have adopted a bracing tone; even if he thought of this as a hymn, it was a rousing hymn of gratitude. This is quite different from the tentative and dreamy mood which Schumann chooses for his setting. The composer’s own temperament, his rueful smile and uncommunicative silences – even with Clara – somehow take musical shape here: there is something plaintive and helpless about the final cadence which tells us that were the dark clouds of depression to descend on Schumann’s personal life, all of these wonders of nature, as well as song itself, would be little consolation. There is also a gloomy prophecy in these words: a life without song would mean, in the case of Schumann, a life without the ability to compose music, and this was eventually to be his sad fate at the asylum in Endenich.
The difficulties of this song are not immediately apparent. It seems a simple enough single page of music, but singers are challenged by its lack of breathing space – the thoughts keep on coming, unpunctuated by a moment’s rest. No doubt Schumann was concerned to keep the music on the move because the whole poem is after all a single sentence governed by a succession of subjunctive clauses which pile up in an ever more urgent need to find a final verb. Schumann finds a melody which is touching in its humility; appoggiatura-like, it leans on many a bar line with all the pathos of a supplicant, but it is driven for ever forward by the words. The beseeching tone is varied with various melodic inflections which derive from the text: the vocal line suddenly jumps a starry octave for ‘sternerhellte Nacht’, and even higher for the mountain-climbing ‘Und du Gebirg’ voll ernster Pracht!’ (this little corner is one of the most awkward in the cycle from a vocal point of view). The setting of ‘Du Lied aus voller Menschenbrust’ is extraordinary – there is a ritardando during the word which is further complicated by ties and syncopations, piano doubling voice, as the music drops down the stave in thirds. This seems a perfect means of illustrating an emotional block, the off-beat stumbling over the word a metaphor for someone tongue-tied and confused. The last four bars of the song are marked ‘adagio’ and it is clear that the song was consciously conceived as a bridge-passage to Stille Tränen; perhaps this is one of the reasons why the brevity of the poem appealed to Schumann. The final question hangs in the air unanswered, and the music ends in the dominant of the relative minor. Schumann’s lack of knowledge about vocal practicalities is illustrated by the fact that from the point of view of the words the phrase ‘ach, was füllte noch In arger Zeit ein Herz mit Lust?’ should be sung in one breath. But the composer has set the words in such a way (the upturn of the final phrase for an elongated final ‘Lust’) that this is all but impossible. One would also think that Frage was the song least able to stand on its own in the cycle, ending as it does on an inconclusive note; but the Schumanns seem to have been very fond of it, and the composer had no qualms about writing out a separate copy of it as a present for Pauline Viardot in 1847.</p>

<p>from notes by Graham Johnson © 1998</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Wärst du nicht, heil’ger Abendschein!
</span><span class='line'>Wärst du nicht, sternerhellte Nacht!
</span><span class='line'>Du Blütenschmuck! Du üpp’ger Hain!
</span><span class='line'>Und du, Gebirg’ voll ernster Pracht!
</span><span class='line'>Du Vogelsang aus Himmeln hoch!
</span><span class='line'>Du Lied aus voller Menschenbrust,
</span><span class='line'>Wärst du nicht, ach, was füllte noch
</span><span class='line'>In arger Zeit ein Herz mit Lust?
</span><span class='line'>Justinus Kerner (1786-1862)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>If you, holy evening star, were not,
</span><span class='line'>and you, star-illumined night,
</span><span class='line'>adorning blossoms, luxuriant wood,
</span><span class='line'>you, mountains, filled with solemn glory,
</span><span class='line'>you, song of birds from heaven on high,
</span><span class='line'>you, song from a full human heart,
</span><span class='line'>if you were not, ah, what still would fill
</span><span class='line'>a heart with joy in adversity?
</span><span class='line'>English: Richard Stokes © 1998</span></code></pre></td></tr></table></div></figure>


<h3>No.10：沉默的眼泪 (No 10: Stille Tränen)</h3>

<blockquote><p>This is nothing less than an epic song, a real blockbuster. Schumann was proud enough of it to publish it as supplement to the Neue Zeitschrift für Musik in 1841. Many more people want to sing it than are able to, and for the wrong reasons. It is a song that does not benefit from being lifted out of its context in the cycle. An artist of operatic possibilities is tempted to bawl it at full tilt; this tends to be a moving experience for everyone except the listeners. Even the accompanist can easily lose his head and make of the piano writing something anachronistically luscious – the debt to Chopin is obvious enough here, but there have been performances of Stille Tränen where the hapless singer is pitted against pulsations which would not be out of place in a Rachmaninov piano concerto.
If he had lived in modern times there seems no doubt that Schumann would have been able to mine a popular seam in his music and reach a wide audience. The panoramic breadth of this melody with its stirring sequences is proof enough of this. A film-music composer could orchestrate the tune just as it stands; someday this may happen, and thousands will hear Schumann’s music for the first time without realizing it. They will not learn of Kerner however, because the poem is dispensable to the music’s effect. Indeed, these words do not easily fit a musical conception which is easily rendered stirring and ecstatic rather than troubled and introverted. Lieder singers have to work particularly hard here in order to marry text and tone convincingly; it is simpler to relish the tune and forget the message behind it. Because Schumann wrote nothing else quite like it, it is a challenge to relate Stille Tränen to the rest of the composer’s song-writing oeuvre. One must remember that the song’s larger-than-life harmonic and melodic contours shelter a short poem entitled ‘Silent Tears’ – neither ‘Stirring Sobs’ nor ‘Joyous Paeans’ will do as a substitute. A great deal of the music is written within a piano dynamic and the song, very much a nocturne, ends on a hushed, rather than a triumphant, note.</p>

<p>Our grief comes out in dreams, despite attempts to hide it even from ourselves in the daylight hours. Kerner, as we have found elsewhere in this cycle, believes in the occult and the power of dreams, but he comes from a time more repressed and less self-aware than our own: his sleepers suppress and forget their dreams rather than interpreting them. Only the tears on their pillow are evidence of deep-seated and unresolved pain. We can see why the poem appealed to Schumann, not quite understanding his own depressions, convinced that ominous forces were ticking away slowly in his mind and body, undermining his chances of happiness. Who was to know his melancholy secret that he had contracted syphilis at the age of twenty-one? And how can any of us know the tortured hidden sadnesses of those who present a seemingly happy face to the world? This music should simmer from within, as if contained in a cauldron which is slow to come to the boil – the heat should not be turned up too soon. But it is this gradually building head of emotional steam which drives the music forward and gives the music its epic quality. (Despite the superscription ‘Sehr langsam’, the music is written alla breve and should never be allowed to become too slow.) Schumann, in an expansive mood not at all typical of his way with exquisite miniatures, seems to have been thinking of the collective sorrows of all mankind when he wrote it. This accounts for the unusually ambitious sweep of the music.</p>

<p>At the same time the healing and calming power of night and sleep has also to be given its due in order to calm the song down and keep it within the Lieder frame. Stille Tränen is, in some ways, Schubert’s Nacht und Träume writ large: similar long-breathed melodic lines, broad and starry, highly arched as the night sky, are spun over a piano ostinato which unfolds in the same register of the instrument in both songs. Also common to both settings is the slow-moving harmony; it is this which suggests the long span of sleep over many hours. The progress of the music from one sumptuous cluster of chords to another suggests a stately galleon cruising the vast oceans of the unconscious, taking soundings as it goes, and plumbing the infinitely resonant depths. It is these chords which both support, and sometimes rock, the raft of dreams; sometimes they signify the agonizing undercurrents, hidden and dark as slime. (The basses are effulgent and booming in the original key, even more cavernous in transposition.)</p>

<p>At the beginning the first thing we hear is three bars of C major. We roll through the plains of sleep, dallying in F (the subdominant), D minor–G7 and back to C major. The second strophe begins in the A flat, the key of the so-called Neapolitan sixth; the second half of the strophe shifts up a minor third to C flat major; with this bold modulation the song becomes truly thrilling in terms of its tessitura and grandeur of utterance. A shift to F7 enables the verse to end in B flat major. This introduces another stirring change – into the key of E flat major for the third strophe where the opening melody makes a reappearance a minor third higher. Schumann does not shy away from the consequences of turning the screw of tension tighter than he normally dares – the resulting high B flat on ‘Schmerz’ is ill-advised for most, but riveting when vocally possible. The harmonic twists of this strophe are adapted to end in C major, and this gives rise to one of the most thrilling of all Schumann’s interludes for piano. The epic tune emerges as a solo – as powerfully as the weak middle register of the piano will allow. The bass stave is awash with a remarkable left-hand trill – a Schubertian device to mirror the ominous; here it is as if the very mud of the ocean floor is bubbling, sending tidal waves to the surface (a stormy right-hand trill appears two bars later).</p>

<p>The composer decides to repeat the poem’s last two lines in a mood of mighty peroration. The interlude leads us into F major from where we can return to C major (via a massive 6–4/V cadence as hackneyed as it is effective). But the final word of the song ‘Herz’ is not harmonized in C major; there is instead a marvellous interrupted cadence on the second inversion of D7. It is here that Chopin’s fervid influence on Schumann’s piano writing is very apparent: the independence of the part-writing is particularly impressive (eloquent quavers erupt in the bass and then catch fire in the tenor register). All this is marked piano however and, unless the markings are ignored, this marvellous piano postlude is a sad let-down for those who seek to finish a blockbuster aria with a loud and triumphant orchestral tutti. An interplay of quintuplets between the soprano line and bass suggests a dialogue (between night and day? dreams and reality? the forces of good and evil? Robert and Clara?) and the song comes to rest in an unlikely way – an adagio bar, piano and resignedly calm. It is a quaver quintuplet deep in the bass that has the last word. The introverted wistfulness of this ending is the key to the whole. It encourages the serious Lieder performers’ attempts to keep the scale of the song within the confines of the Schumannian Lied. There is no doubt that the dividing lines between song and aria are strained here, but with care and taste they need not be demolished.</p>

<p>from notes by Graham Johnson © 1998</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Du bist vom Schlaf erstanden
</span><span class='line'>Und wandelst durch die Au’,
</span><span class='line'>Da liegt ob allen Landen
</span><span class='line'>Der Himmel wunderblau.
</span><span class='line'>So lang du ohne Sorgen
</span><span class='line'>Geschlummert schmerzenlos,
</span><span class='line'>Der Himmel bis zum Morgen
</span><span class='line'>Viel Tränen niedergoss.
</span><span class='line'>
</span><span class='line'>In stillen Nächten weinet
</span><span class='line'>Oft mancher aus den Schmerz,
</span><span class='line'>Und morgens dann ihr meinet,
</span><span class='line'>Stets fröhlich sei sein Herz.
</span><span class='line'>
</span><span class='line'>Justinus Kerner (1786-1862)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>From sleep you have risen
</span><span class='line'>and walk through the meadow.
</span><span class='line'>Everywhere lies
</span><span class='line'>Heaven’s wondrous blue.
</span><span class='line'>As long as, free of care, you have
</span><span class='line'>been slumbering, free of pain,
</span><span class='line'>Heaven has, till morning,
</span><span class='line'>poured down many tears.
</span><span class='line'>
</span><span class='line'>Often on silent nights
</span><span class='line'>many a man weeps his grief away,
</span><span class='line'>and in the morning you imagine
</span><span class='line'>his heart is ever happy.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 1998</span></code></pre></td></tr></table></div></figure>


<h1>Henri Duparc</h1>

<ul>
<li><a href="https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA66323">https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA66323</a></li>
</ul>


<h2>航行的邀请 (L'invitation au voyage)</h2>

<blockquote><p>This is one of the most famous mélodies of all time, composed around 1870. It was Duparc’s special role in the history of French song to introduce a note of depth and seriousness into a genre that had been notably lacking such qualities during the Second Empire. The inspiration with this composer was Wagnerian (Duparc heard Rheingold in 1869) but his music distils Wagner’s visionary qualities into works of art of great concision and translucence. In this unquestionably French music there is no trace of the megalomania and pomposity that repelled Godard and other French anti-Wagnerians. Duparc embraced the Christian ideals typical of the César Franck circle as a whole; perhaps that is why the pagan resonances of Baudelaire’s ‘Luxe, calme et volupté’ are turned into music of unbelievable refinement—here is purity as well as decadence, rigour and sensuality. With Baudelaire and Duparc we traverse the landscapes of the Dutch East Indies; as in all such journeys, where imagination plays the largest part, we find ourselves flying beyond operatic sets of wood and canvas towards realms previously inaccessible to the French duo of singer and pianist. Decades earlier Schubert and Schumann had discovered those regions where the intimate fusion of great words and music worthy of them represents a special flowering of creative opportunity; with L’invitation au voyage French song comes of age and joins the German lied as something separate yet equal.</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mon enfant, ma sœur,
</span><span class='line'>Songe à la douceur
</span><span class='line'>D’aller là-bas vivre ensemble.
</span><span class='line'>Aimer à loisir,
</span><span class='line'>Aimer et mourir
</span><span class='line'>Au pays qui te ressemble!
</span><span class='line'>Les soleils mouillés
</span><span class='line'>De ces ciels brouillés
</span><span class='line'>Pour mon esprit ont les charmes
</span><span class='line'>Si mystérieux
</span><span class='line'>De tes traîtres yeux,
</span><span class='line'>Brillant à travers leurs larmes.
</span><span class='line'>La, tout n’est qu’ordre et beauté,
</span><span class='line'>Luxe, calme et volupté!
</span><span class='line'>
</span><span class='line'>Vois sur ces canaux
</span><span class='line'>Dormir ces vaisseaux
</span><span class='line'>Dont l’humeur est vagabonde;
</span><span class='line'>C’est pour assouvir
</span><span class='line'>Ton moindre désir
</span><span class='line'>Qu’ils viennent du bout du monde.
</span><span class='line'>Les soleils couchants
</span><span class='line'>Revêtent les champs,
</span><span class='line'>Les canaux, la ville entière,
</span><span class='line'>D’hyacinthe et d’or;
</span><span class='line'>Le monde s’endort
</span><span class='line'>Dans une chaude lumière
</span><span class='line'>
</span><span class='line'>Là, tout n’est qu’ordre et beauté,
</span><span class='line'>Luxe, calme et volupté!
</span><span class='line'>
</span><span class='line'>Charles Baudelaire (1821-1867)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>My child, my sister,
</span><span class='line'>think of the sweetness
</span><span class='line'>of going to live there together.
</span><span class='line'>To love at leisure;
</span><span class='line'>to love and to die
</span><span class='line'>in the land which resembles you.
</span><span class='line'>The watery suns
</span><span class='line'>of those hazy skies
</span><span class='line'>have, for me, the charms,
</span><span class='line'>so mysterious,
</span><span class='line'>of your treacherous eyes
</span><span class='line'>shining through their tears.
</span><span class='line'>There, all is naught but order and beauty,
</span><span class='line'>comfort, peace and pleasure.
</span><span class='line'>
</span><span class='line'>See, on those waterways,
</span><span class='line'>how the ships slumber,
</span><span class='line'>though wanderers by nature;
</span><span class='line'>it is to satisfy
</span><span class='line'>your smallest desire
</span><span class='line'>that they come from the ends of the earth.
</span><span class='line'>The setting suns
</span><span class='line'>clothe the fields,
</span><span class='line'>the waters, all the town,
</span><span class='line'>in hyacinth and gold;
</span><span class='line'>the world falls asleep
</span><span class='line'>in a warm light.
</span><span class='line'>
</span><span class='line'>There, all is naught but order and beauty,
</span><span class='line'>comfort, peace and pleasure.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2006</span></code></pre></td></tr></table></div></figure>


<h2>罗斯蒙德的庄园 (Le manoir de Rosemonde)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>De sa dent soudaine et vorace,
</span><span class='line'>Comme un chien l’amour m’a mordu …
</span><span class='line'>En suivant mon sang répandu,
</span><span class='line'>Va, tu pourras suivre ma trace …
</span><span class='line'>Prends un cheval de bonne race,
</span><span class='line'>Pars, et suis mon chemin ardu,
</span><span class='line'>Fondrière ou sentier perdu,
</span><span class='line'>Si la course ne te harasse!
</span><span class='line'>
</span><span class='line'>En passant par où j’ai passé
</span><span class='line'>Tu verras que seul et blessé
</span><span class='line'>J’ai parcouru ce triste monde,
</span><span class='line'>Et qu’ainsi je m’en fus mourir
</span><span class='line'>Bien loin, bien loin, sans découvrir
</span><span class='line'>Le bleu manoir de Rosemonde.
</span><span class='line'>
</span><span class='line'>Robert de Bonnières (1850-1905)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>With its sudden, voracious fangs,
</span><span class='line'>love, like a dog, has bitten me …
</span><span class='line'>Following my spilled blood,
</span><span class='line'>come, you will be able to retrace my path …
</span><span class='line'>Take a horse of good breed,
</span><span class='line'>set out, and follow my arduous road,
</span><span class='line'>—marsh, or lost pathway—
</span><span class='line'>if the journey does not exhaust you!
</span><span class='line'>
</span><span class='line'>Passing where I have passed,
</span><span class='line'>you will see that, alone and wounded,
</span><span class='line'>I have traversed this sorry world,
</span><span class='line'>and that I thus went off to die
</span><span class='line'>far, far away, without discovering
</span><span class='line'>the blue domain of Rosemonde.</span></code></pre></td></tr></table></div></figure>


<h2>悲伤的歌 (Lamento)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Connaissez-vous la blanche tombe
</span><span class='line'>Où flotte avec un son plaintif
</span><span class='line'>L’ombre d’un if?
</span><span class='line'>Sur l’if une pâle colombe,
</span><span class='line'>Triste et seule au soleil couchant,
</span><span class='line'>Chante son chant.
</span><span class='line'>On dirait que l’âme éveillée
</span><span class='line'>Pleure sous terre à l’unisson
</span><span class='line'>De la chanson,
</span><span class='line'>Et du malheur d’être oubliée
</span><span class='line'>Se plaint dans un roucoulement,
</span><span class='line'>Bien doucement.
</span><span class='line'>
</span><span class='line'>Ah! Jamais plus près de la tombe,
</span><span class='line'>Je n’irai, quand descend le soir
</span><span class='line'>Au manteau noir,
</span><span class='line'>Écouter la pâle colombe
</span><span class='line'>Chanter, sur la branche de l’if
</span><span class='line'>Son chant plaintif!
</span><span class='line'>
</span><span class='line'>Théophile Gautier (1811-1872)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Do you know the white tomb
</span><span class='line'>where, with plaintive sound,
</span><span class='line'>waves the shadow of a yew tree?
</span><span class='line'>Upon the yew a pale dove,
</span><span class='line'>sad and lonely in the setting sun,
</span><span class='line'>sings its song.
</span><span class='line'>One feels as if the awakened soul
</span><span class='line'>weeps beneath the ground
</span><span class='line'>in unison with the song,
</span><span class='line'>and with unhappiness at being forgotten
</span><span class='line'>laments, with a cooing sound,
</span><span class='line'>very softly.
</span><span class='line'>
</span><span class='line'>Ah, never again
</span><span class='line'>shall I go near the tomb,
</span><span class='line'>when the black-mantled evening falls,
</span><span class='line'>to listen to the pale dove sing,
</span><span class='line'>on the yew tree’s branch,
</span><span class='line'>its plaintive song!</span></code></pre></td></tr></table></div></figure>


<h2>菲迪莱 (Phidylé)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>L’herbe est molle au sommeil sous les frais peupliers,
</span><span class='line'>Aux pentes des sources moussues
</span><span class='line'>Qui dans les prés en fleurs germant par mille issues,
</span><span class='line'>Se perdent sous les noirs halliers.
</span><span class='line'>Repose, ô Phidylé.
</span><span class='line'>Midi sur les feuillages
</span><span class='line'>Rayonne, et t’invite au sommeil.
</span><span class='line'>
</span><span class='line'>Par le trèfle et le thym, seules, un plein soleil,
</span><span class='line'>Chantent les abeilles volages;
</span><span class='line'>Un chaud parfum circule au détour des sentiers,
</span><span class='line'>La rouge fleur des blés s’incline,
</span><span class='line'>Et les oiseaux, rasant de l’aile la colline,
</span><span class='line'>Cherchent l’ombre des églantiers.
</span><span class='line'>Repose, ô Phidylé.
</span><span class='line'>
</span><span class='line'>Mais quand l’Astre incliné sur sa courbe éclatante,
</span><span class='line'>Verra ses ardeurs s’apaiser,
</span><span class='line'>Que ton plus beau sourire et ton meilleur baiser
</span><span class='line'>Me récompensent de l’attente!
</span><span class='line'>
</span><span class='line'>Charles-Marie-René Leconte de Lisle (1818-1894)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The grass is soft to sleep on beneath the cool poplars,
</span><span class='line'>On the slopes of mossy springs
</span><span class='line'>Which, in the flowery meadows, rise by a thousand outlets
</span><span class='line'>And are lost beneath the dark thickets.
</span><span class='line'>Rest, oh Phidylé.
</span><span class='line'>The midday sun shines through the leaves
</span><span class='line'>and invites you to sleep—
</span><span class='line'>
</span><span class='line'>Alone amid the clover and the thyme
</span><span class='line'>in the sun’s full light where the humming bees hover.
</span><span class='line'>A warm fragrance pervades the winding paths;
</span><span class='line'>the red flowers in the corn droop their heads,
</span><span class='line'>and the birds, skimming the hillside with their wings,
</span><span class='line'>seek the shade of the wild rose bushes.
</span><span class='line'>Rest, oh Phidylé.
</span><span class='line'>
</span><span class='line'>But when the sun, low on his shining curve,
</span><span class='line'>sees his brilliance dimmed,
</span><span class='line'>let your loveliest smile and most ardent kiss
</span><span class='line'>reward my waiting!</span></code></pre></td></tr></table></div></figure>


<h1>中场休息</h1>

<h1>Liszt：裴特拉克的三首十四行诗 S.270</h1>

<ul>
<li><a href="https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67782">https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67782</a></li>
<li><a href="https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67956">https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67956</a></li>
</ul>


<h2>Tre sonetti di Petrarca S270 First version</h2>

<blockquote><p>The Tre sonetti di Petrarca were the direct result of Liszt’s sojourn in Italy during 1838–9; we learn that he and Marie d’Agoult read Petrarch and Dante together. The origins of the poetry are legendary: on Good Friday, 6 April, 1327, the great fourteenth-century poet Petrarch saw a woman named Laura in the church of Sainte-Claire d’Avignon, and his passion for her is celebrated in the 366 poems of his Rime sparse (Scattered rhymes, later known as Il Canzoniere / The Songbook). The songs—arias in all but name—exist in both a pre-Weimar version for tenor and a later revision for mezzo-soprano or baritone; we hear the virtuosic first version on this disc. The first sonnet, ‘Pace non trovo’, is packed with Petrarch’s characteristic oxymorons, antitheses, and dichotomies (staring without eyes, crying without voice, burning and freezing alike) that bespeak the paradoxes of love. For such imagery, Liszt begins with an agitated succession of his most advanced harmonies followed by extreme contrasts between dramatic-operatic outbursts and ecstatic lyricism, twice bidding the tenor reach for the D flat above high C. In ‘Benedetto sia ’l giorno’, Petrarch calls for multiple blessings on his first sight of Laura, his love for her, and his own thoughts and verses about her. Liszt moves from key to key, benediction to benediction, in his trademark restless, innovative way. ‘I’ vidi in terra angelici costumi’ tells of heavenly angels on earth and earth-shattering beauty in the person of Laura, whose harmonious being fills the air with sweetness. This celestial song, with its breathtaking harmonic shift just before the invocation of ‘Love! wisdom! valour, pity and grief’, ends quietly and reverently.</p>

<p>from notes by Susan Youens © 2010</p></blockquote>

<h2>Tre sonetti di Petrarca S270 Second version</h2>

<blockquote><p>When Liszt and his mistress Marie d’Agoult travelled through Italy in 1837–9 (a fraught journey en route to the breach in their relationship after their son Daniel’s birth), they read Dante and Petrarch together. One result of Liszt’s immersion in Petrarch’s Rime sparse (Scattered rhymes, later known as Il Canzoniere / The Songbook) was the set of Tre sonetti di Petrarca, sketched in Italy and completed in their first version between 1842 and 1846 for publication in Vienna. The second version we hear in the present recording was recomposed for mezzo-soprano or baritone and had a long, post-Weimar gestation over nearly twenty years, before publication in 1883. Reversing the order of the first two songs from their original sequence, Liszt begins the set with ‘Benedetto sia ’l giorno’, in which Petrarch multiply blesses the memory of first seeing his muse Laura in the church of Sainte-Claire d’Avignon, his love for her, and his own poetry to her. Whether or not she actually existed is a matter of debate, with little evidence to go on, but his poetry brought a new sensibility into being, one that combines symbolic complexity, perfected form, elegance and allusiveness; these poems are among the richest portraits of the psychology of the lover in world literature. Liszt’s first version began with a lush piano introduction, followed by an aria in all but name; while the second version is more spare on its surface, it is filled with longing-drenched appoggiaturas and suspensions, with Liszt’s trademark tonal shifts as we move from one blessing to the next. Rich, even futuristic harmonies were Liszt’s wont from the beginning to the end of his life, and they are in evidence here. The prayerful harmonies at the end breathe blessing.
‘Pace non trovo’ is one of Petrarch’s most justly famed explorations of the paradoxical effects of love, the sonnet replete with oxymorons and antitheses: no peace but no war, freezing and burning simultaneously, flying and yet earthbound, staring without eyes, shrieking without voice, laughing and crying, life and death. The agitated beginning of the virtuosic first version returns, transposed and slightly varied, and so does the expressive melodic motif for the key-words ‘Pace non trovo’ (I find no peace), with its affective ‘drop’ at the verb. In both versions, we encounter Liszt the emancipator of the augmented triad, the composer who put its dissonant intensity and symmetrical structure to new uses. At the culmination of the sonnet, the persona tells Laura that he is in this tortured-rhapsodic state because of her: in the first version, these words unleashed harp-like arpeggiations and a melody that repeatedly soars to high A flat (in an ossia for the final phrase, a high D flat is called for), but the second time around Liszt avoids the sweet and settled cadence from before. Instead, he creates extreme attenuation and indeterminacy at the ‘end’. This state of being, the music says, will go on and on; if there is rapture in it, there is also fear, doubt and tension.</p>

<p>‘I’ vidi in terra angelici costumi’ is a complex variation on the traditional analogy of the beloved to angels in the heavens; her weeping and her words make the very heavens cease moving. The litany of Laura’s qualities—love, duty, courage, piety and sorrow—unleashed ecstasy in the first version, while here chords waft down from the treble register, darkening as they descend. When the heavens and the trees fall silent to listen to the music of Laura’s words, Liszt makes the piano fall silent, while the lush, offbeat sighs of longing in the earlier postlude become—typically for late Liszt—something far more spare.</p>

<p>from notes by Susan Youens © 2015</p></blockquote>

<h2>值得祝福的日子 (Benedetto sia &lsquo;l giorno)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Benedetto sia ’l giorno, e ’l mese, e l’anno,
</span><span class='line'>E la stagione, e ’l tempo, e l’ora, e ’l punto
</span><span class='line'>E ’l bel paese e ’l loco, ov’io fui giunto
</span><span class='line'>Da’duo begli occhi che legato m’ànno;
</span><span class='line'>E benedetto il primo dolce affanno
</span><span class='line'>Ch’i’ ebbi ad esser con Amor congiunto,
</span><span class='line'>E l’arco e la saette ond’ i’ fui punto,
</span><span class='line'>E le piaghe, ch’infino al cor mi vanno.
</span><span class='line'>
</span><span class='line'>Benedette le voci tante, ch’io
</span><span class='line'>Chiamando il nome di mia Donna ho sparte,
</span><span class='line'>E i sospiri e le lagrime e ’l desio.
</span><span class='line'>
</span><span class='line'>E benedette sian tutte le carte
</span><span class='line'>Ov’io fama le acquisto, e il pensier mio,
</span><span class='line'>Ch’è sol di lei, si, ch’altra non v’ha parte.
</span><span class='line'>
</span><span class='line'>Petrarch (1304-1374)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Blessed be the day, the month, the year,
</span><span class='line'>And the season, and the time, and the hour, and the moment,
</span><span class='line'>And the lovely landscape, and the spot where I was enthralled
</span><span class='line'>By two lovely eyes that have enslaved me.
</span><span class='line'>And blessed be the first sweet pang I suffered,
</span><span class='line'>When Love overwhelmed me,
</span><span class='line'>The bow and the arrows which stung me,
</span><span class='line'>And the wounds which penetrate my heart.
</span><span class='line'>
</span><span class='line'>Blessed be the many voices that have echoed
</span><span class='line'>When I have called my Lady’s name,
</span><span class='line'>And the sighs and the tears, and the longing,
</span><span class='line'>
</span><span class='line'>And blessed be all those writings,
</span><span class='line'>In which I have spread her fame, and my thoughts,
</span><span class='line'>Which stem from her alone.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2015</span></code></pre></td></tr></table></div></figure>


<h2>无法安宁，也不愿争斗 (Pace non trovo)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Pace non trovo, e non ho da far guerra,
</span><span class='line'>E temo, e spero, ed ardo, e son un ghiaccio:
</span><span class='line'>E volo sopra ’l cielo, e giaccio in terra;
</span><span class='line'>E nulla stringo, e tutto ’l mondo abbraccio.
</span><span class='line'>Tal m’ha in priggion, che non m’apre, né serra,
</span><span class='line'>Né per suo mi ritien, né scioglie il laccio,
</span><span class='line'>E non m’accide Amor, e non mi sferra;
</span><span class='line'>Né mi vuol vivo, né mi trahe d’impaccio.
</span><span class='line'>
</span><span class='line'>Veggio senz’occhi; e non ho lingua e grido;
</span><span class='line'>E bramo di perir, e cheggio aita;
</span><span class='line'>Ed ho in odio me stesso, ed amo altrui:
</span><span class='line'>
</span><span class='line'>Pascomi di dolor; piangendo io rido;
</span><span class='line'>Egualmente mi spiace morte e vita.
</span><span class='line'>In questo stato son, Donna, per voi.
</span><span class='line'>
</span><span class='line'>Petrarch (1304-1374)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>I find no peace, and am not inclined for war;
</span><span class='line'>And I fear, and I hope, and burn, and am turned to ice,
</span><span class='line'>And I soar in the air, and lie upon the ground;
</span><span class='line'>And I hold nothing, though I embrace the world.
</span><span class='line'>Love has me in a prison, which he neither opens nor locks;
</span><span class='line'>He neither claims me for his own, nor loosens my halter;
</span><span class='line'>And Love neither slays me, nor unshackles me;
</span><span class='line'>He would not have me live, yet he torments me.
</span><span class='line'>
</span><span class='line'>I see without eyes; and cry without a tongue;
</span><span class='line'>I long to perish, and plead for help;
</span><span class='line'>I hate myself and love another:
</span><span class='line'>
</span><span class='line'>I feed on grief; weeping I laugh;
</span><span class='line'>Death, like life, repels me.
</span><span class='line'>You have reduced me, my Lady, to this state.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2015</span></code></pre></td></tr></table></div></figure>


<h2>我在大地之上看到天使般的美德 (I' vidi in terra angelici costumi)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>I’ vidi in terra angelici costumi,
</span><span class='line'>E celesti bellezze al mondo sole;
</span><span class='line'>Tal che di rimembrar mi giova, e dole:
</span><span class='line'>Che quant’io miro, par sogni, ombre, e fumi.
</span><span class='line'>E vidi lagrimar que’ duo bei lumi,
</span><span class='line'>Ch’han fatto mille volte invidia al sole;
</span><span class='line'>Ed udì’ sospirando dir parole
</span><span class='line'>Che farian gir i monti, e stare i fiumi.
</span><span class='line'>
</span><span class='line'>Amor! senno! valor, pietate, e doglia
</span><span class='line'>Facean piangendo un più dolce concento
</span><span class='line'>D’ogni altro, che nel mondo udir si soglia.
</span><span class='line'>
</span><span class='line'>Ed era ’l cielo all’armonia s’intento
</span><span class='line'>Che non si vedea in ramo mover foglia.
</span><span class='line'>Tanta dolcezza avea pien l’aer e ’l vento.
</span><span class='line'>
</span><span class='line'>Petrarch (1304-1374)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>I beheld on earth angelic grace
</span><span class='line'>And heavenly beauty unmatched in this world,
</span><span class='line'>Such as rejoice and pain my memory,
</span><span class='line'>Which is clouded with dreams, shadows, mists.
</span><span class='line'>And I beheld tears spring from those lovely eyes,
</span><span class='line'>Which many a time have put the sun to shame.
</span><span class='line'>And I heard words uttered with such sighs,
</span><span class='line'>That mountains would be moved and rivers halted.
</span><span class='line'>
</span><span class='line'>Love! wisdom! valour, pity and grief
</span><span class='line'>Created in that lament a sweeter concert
</span><span class='line'>Than any other to be heard on earth.
</span><span class='line'>
</span><span class='line'>And heaven was so intent on that harmony,
</span><span class='line'>That not a leaf was seen to move on the bough;
</span><span class='line'>Such sweetness had filled the air and the wind.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2015</span></code></pre></td></tr></table></div></figure>


<h1>Richard Strauss</h1>

<h2>秘密邀请 (Heimliche Aufforderung, op. 27, no. 3)</h2>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Heimliche_Aufforderung">https://en.wikipedia.org/wiki/Heimliche_Aufforderung</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Heimliche Aufforderung
</span><span class='line'>
</span><span class='line'>Auf, hebe die funkelnde Schale empor zum Mund,
</span><span class='line'>Und trinke beim Freudenmahle dein Herz gesund.
</span><span class='line'>Und wenn du sie hebst, so winke mir heimlich zu,
</span><span class='line'>Dann lächle ich und dann trinke ich still wie du...
</span><span class='line'>
</span><span class='line'>Und still gleich mir betrachte um uns das Heer
</span><span class='line'>Der trunknen Zecher [Schwätzer] - verachte sie nicht zu sehr.
</span><span class='line'>Nein, hebe die blinkende Schale, gefüllt mit Wein,
</span><span class='line'>Und laß beim lärmenden Mahle sie glücklich sein.
</span><span class='line'>
</span><span class='line'>Doch hast du das Mahl genossen, den Durst gestillt,
</span><span class='line'>Dann verlasse der lauten Genossen festfreudiges Bild,
</span><span class='line'>Und wandle hinaus in den Garten zum Rosenstrauch,
</span><span class='line'>Dort will ich dich dann erwarten nach altem Brauch,
</span><span class='line'>
</span><span class='line'>Und will an die Brust dir sinken, eh du's gehofft [erhofft],
</span><span class='line'>Und deine Küsse trinken, wie ehmals oft,
</span><span class='line'>Und flechten in deine Haare der Rose Pracht.
</span><span class='line'>O komm [komme], du wunderbare, ersehnte Nacht!
</span><span class='line'>
</span><span class='line'>John Henry Mackay (1864 - 1933)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The Lover's Pledge
</span><span class='line'>
</span><span class='line'>Up, raise the sparkling cup to your lips,
</span><span class='line'>And drink your heart's fill at the joyous feast.
</span><span class='line'>And when you raise it, so wink secretly at me,
</span><span class='line'>Then I'll smile and drink quietly, as you...
</span><span class='line'>
</span><span class='line'>And quietly as I, look around at the crowd
</span><span class='line'>Of drunken revelers -- don't think too ill of them.
</span><span class='line'>No, lift the twinkling cup, filled with wine,
</span><span class='line'>And let them be happy at the noisy meal.
</span><span class='line'>
</span><span class='line'>But when you've savored the meal, your thirst quenched,
</span><span class='line'>Then quit the loud gathering's joyful fest,
</span><span class='line'>And wander out into the garden, to the rosebush,
</span><span class='line'>There shall I await you, as often of old.
</span><span class='line'>
</span><span class='line'>And ere you know it shall I sink upon your breast,
</span><span class='line'>And drink your kisses, as so often before,
</span><span class='line'>And twine the rose's splendour into your hair.
</span><span class='line'>Oh, come, you wondrous, longed-for night!
</span><span class='line'>
</span><span class='line'>Translation: John Bernhoff (1912)[5]</span></code></pre></td></tr></table></div></figure>


<h2>少女，这有什么用 (Wozu noch, Mädchen, soll es frommen  (No 1 of Sechs Lieder aus Lotusblättern, Op 19))</h2>

<blockquote><p>The initial interplay of piano and voice perfectly establishes a mood of affectionate banter. A delicious step to A major (‘daß du liebst!’) launches us into the heart of the matter, interweaved with a figure suggestive of Der Rosenkavalier (or is it an echo of Till Eulenspiegel?) and gently mocking chords that anticipate the Falcon’s theme in Die Frau ohne Schatten. Already in this tiny song the mature opera composer can be heard.</p>

<p>from notes by Roger Vignoles © 2008</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Wozu noch, Mädchen, soll es frommen,
</span><span class='line'>Daß du vor mir Verstellung übst?
</span><span class='line'>Heiß froh das neue Glück willkommen
</span><span class='line'>Und sag es offen, daß du liebst!
</span><span class='line'>An deines Busens höherm Schwellen,
</span><span class='line'>Dem Wangenrot, das kommt und geht,
</span><span class='line'>Ward dein Geheimnis von den Quellen,
</span><span class='line'>Den Blumengeistern längst erspäht.
</span><span class='line'>
</span><span class='line'>Die Wogen murmelns in den Grotten,
</span><span class='line'>Es flüsterts leis der Abendwind,
</span><span class='line'>Wo du vorbei gehst, hörst du’s spotten:
</span><span class='line'>Wir wissen es seit lange, Kind!
</span><span class='line'>
</span><span class='line'>Adolf Friedrich von Schack (1815-1894)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>What is the purpose, my sweet,
</span><span class='line'>Of trying to deceive me?
</span><span class='line'>Bid your new bliss a joyful welcome
</span><span class='line'>And say openly that you’re in love!
</span><span class='line'>The quickened stirring of your breast,
</span><span class='line'>The way your blushes come and go,
</span><span class='line'>Have long since revealed your secret
</span><span class='line'>To fountains and flower-sprites.
</span><span class='line'>
</span><span class='line'>The waves murmur it in caverns,
</span><span class='line'>The evening breezes whisper it,
</span><span class='line'>Wherever you go, you hear them mocking:
</span><span class='line'>We’ve known it a long time, child!
</span><span class='line'>
</span><span class='line'>English: Richard Stokes</span></code></pre></td></tr></table></div></figure>


<h2>蔓延在我头上的黑发 (Spread over my head your black hair, op. 19, no. 2)</h2>

<blockquote><p>Breit' über mein Haupt  (No 2 of Sechs Lieder aus Lotusblättern, Op 19)</p>

<p>In his next three sets of songs, Strauss concentrated – with the exception of one song to a translation of Michelangelo – on verses by the well known Munich poet Graf Adolf Friedrich von Schack. Breit’ über mein Haupt is distinguished by its high arching phrases, illustrative of the imagined spread of the beloved’s hair above the poet’s head, and the solemn and splendid harmonies with which they are underpinned.</p>

<p>from notes by Roger Vignoles © 2005</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Breit’ über mein Haupt dein schwarzes Haar,
</span><span class='line'>Neig’ zu mir dein Angesicht,
</span><span class='line'>Da strömt in die Seele so hell und klar
</span><span class='line'>Mir deiner Augen Licht.
</span><span class='line'>Ich will nicht droben der Sonne Pracht,
</span><span class='line'>Noch der Sterne leuchtenden Kranz,
</span><span class='line'>Ich will nur deiner Locken Nacht
</span><span class='line'>Und deiner Blicke Glanz.
</span><span class='line'>
</span><span class='line'>Adolf Friedrich von Schack (1815-1894)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unbind your black hair right over my head,
</span><span class='line'>Incline to me your face!
</span><span class='line'>Then clearly and brightly into my soul
</span><span class='line'>The light of your eyes will stream.
</span><span class='line'>I want neither the glory of the sun above
</span><span class='line'>Nor the gleaming garland of stars,
</span><span class='line'>All I want are your black tresses
</span><span class='line'>And the radiance of your eyes.
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2005</span></code></pre></td></tr></table></div></figure>


<h2>我爱你 (I love you, op. 37, no. 2)</h2>

<ul>
<li><a href="https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67488">https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67488</a></li>
</ul>


<blockquote><p>Ich liebe dich  Vier adlige Rosse  (No 2 of Sechs Lieder, Op 37)</p>

<p>Composed in the same year as Ein Heldenleben, this enjoyably extravagant song shares with the tone poem the suitably heroic key of E flat, and is liberally supplied with fanfares and flourishes. In the piano version Strauss dispenses with an introduction, having the singer enter unaccompanied, as though summoning the piano’s orchestral forces by sheer strength of will (not to say vocal power). This dramatic stroke is, however, dispensed with in the orchestral version, for which Strauss added a brief prelude on wind and brass. The song has all the ardent momentum of an operatic scena, introducing a wide-sweeping new melody for the second section at ‘Steht silberbeschlagen’, later reprised in the piano’s lengthy postlude, a triumphant gallop into the jaws of death.</p>

<p>from notes by Roger Vignoles © 2005</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Vier adlige Rosse
</span><span class='line'>Voran unserm Wagen,
</span><span class='line'>Wir wohnen im Schlosse
</span><span class='line'>In stolzem Behagen.
</span><span class='line'>Die Frühlichterwellen
</span><span class='line'>Und nächtens der Blitz,
</span><span class='line'>Was all sie erhellen,
</span><span class='line'>Ist unser Besitz.
</span><span class='line'>Und irrst du verlassen,
</span><span class='line'>Verbannt durch die Lande;
</span><span class='line'>Mit dir durch die Gassen
</span><span class='line'>In Armut und Schande!
</span><span class='line'>Es bluten die Hände,
</span><span class='line'>Die Füße sind wund,
</span><span class='line'>Vier trostlose Wände,
</span><span class='line'>Es kennt uns kein Hund.
</span><span class='line'>
</span><span class='line'>Steht silberbeschlagen
</span><span class='line'>Dein Sarg am Altar,
</span><span class='line'>Sie sollen mich tragen
</span><span class='line'>Zu dir auf die Bahr,
</span><span class='line'>Und fern auf der Heide
</span><span class='line'>Und stirbst du in Not,
</span><span class='line'>Den Dolch aus der Scheide,
</span><span class='line'>Dir nach in den Tod!
</span><span class='line'>
</span><span class='line'>Detlev von Liliencron (1844-1909)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Four noble horses
</span><span class='line'>Draw our carriage,
</span><span class='line'>We live in the castle
</span><span class='line'>Proud and content.
</span><span class='line'>The rays of dawn
</span><span class='line'>And the lightning at night,
</span><span class='line'>All that they shine on
</span><span class='line'>Belongs to us.
</span><span class='line'>And though you roam the land,
</span><span class='line'>Abandoned and banished:
</span><span class='line'>I’ll walk through the streets with you
</span><span class='line'>In poverty and shame!
</span><span class='line'>Our hands will bleed,
</span><span class='line'>Our feet be sore,
</span><span class='line'>Four pitiless walls,
</span><span class='line'>Not a dog to know us.
</span><span class='line'>
</span><span class='line'>When your silver-edged coffin
</span><span class='line'>Stands at the altar,
</span><span class='line'>They must lay me
</span><span class='line'>Beside you on the bie
</span><span class='line'>r. Whether you die on the heath
</span><span class='line'>Or die in distress,
</span><span class='line'>I’ll draw my dagger
</span><span class='line'>And join you in death!
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2005</span></code></pre></td></tr></table></div></figure>


<h2>弗里德 (Freed, op. 39. 4)</h2>

<blockquote><p>Befreit  Du wirst nicht weinen. Leise, leise  (No 4 of Fünf Lieder, Op 39)</p>

<p>Dehmel, not necessarily a good judge, expressed himself unsatisfied by Strauss’s setting of Befreit. But he did subsequently provide a clue to the question often raised as to the exact situation depicted by the poem. Apparently he had in his mind the image of a man speaking to his dying wife, but he also allowed for the possibility of a different interpretation involving the parting of two lovers. Whatever the case, Befreit is one of the greatest of Strauss’s songs, already in its piano part evoking the sonorous weight and emotional sweep of the Straussian orchestra, with its undertow of triplets and the figure of repeated brass-like chords that occasionally interrupts them. Continually anticipating the entry of the voice with a syncopated sforzato, like a momentary shudder in the earth’s foundations, this motif adds to the sense of impending change already established in the opening bars by the semitonal shift on the words ‘Du wirst nicht weinen’ and later with even greater effect at ‘Es wird sehr bald sein’. The long arching curves of the climax are worthy of the closing scene of an opera, and it is not surprising that the repeated phrase accompanying the words ‘O Glück!’ was later quoted by Strauss in Ein Heldenleben.</p>

<p>from notes by Roger Vignoles © 2005</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Du wirst nicht weinen. Leise, leise
</span><span class='line'>wirst du lächeln und wie zur Reise
</span><span class='line'>geb’ ich dir Blick und Kuß zurück.
</span><span class='line'>Unsre lieben vier Wände, du hast sie bereitet,
</span><span class='line'>ich habe sie dir zur Welt geweitet;
</span><span class='line'>O Glück!
</span><span class='line'>Dann wirst du heiß meine Hände fassen
</span><span class='line'>und wirst mir deine Seele lassen,
</span><span class='line'>läßt unsern Kindern mich zurück.
</span><span class='line'>Du schenktest mir dein ganzes Leben,
</span><span class='line'>ich will es ihnen wieder geben;
</span><span class='line'>O Glück!
</span><span class='line'>
</span><span class='line'>Es wird sehr bald sein, wir wissen’s beide,
</span><span class='line'>wir haben einander befreit vom Leide,
</span><span class='line'>so gab’ ich dich der Welt zurück!
</span><span class='line'>Dann wirst du mir nur noch im Traum erscheinen
</span><span class='line'>und mich segnen und mit mir weinen;
</span><span class='line'>O Glück!
</span><span class='line'>
</span><span class='line'>Richard Dehmel (1863-1920)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>You will not weep. Gently, gently
</span><span class='line'>you will smile; and as before a journey
</span><span class='line'>I shall return your gaze and kiss.
</span><span class='line'>You have cared for the room we love!
</span><span class='line'>I have widened these four walls for you into a world –
</span><span class='line'>O happiness!
</span><span class='line'>Then ardently you will seize my hands
</span><span class='line'>and you will leave me your soul,
</span><span class='line'>leave me to care for our children.
</span><span class='line'>You gave your whole life to me,
</span><span class='line'>I shall give it back to them –
</span><span class='line'>O happiness!
</span><span class='line'>
</span><span class='line'>It will be very soon, we both know it,
</span><span class='line'>we have released each other from suffering,
</span><span class='line'>so I returned you to the world.
</span><span class='line'>Then you’ll appear to me only in dreams,
</span><span class='line'>and you will bless me and weep with me –
</span><span class='line'>O happiness!
</span><span class='line'>
</span><span class='line'>English: Richard Stokes © 2005</span></code></pre></td></tr></table></div></figure>


<h2>一个愉快的愿景 (A pleasant vision, op. 48, no. 1)</h2>

<ul>
<li><a href="https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67602">https://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67602</a></li>
</ul>


<blockquote><p>This justly famous song has much in common with the equally celebrated Traum durch die Dämmerung: a gently moving ostinato in the piano part, a companionable walk à deux through the landscape, and—a favourite device of Strauss’s—beginning in a different tonality from that in which he means to continue. In this case, the keyshift perfectly illustrates the contrast between sleeping and waking, and the step into the daylight, with the sharp key of D major again ideal for the densely foliated landscape here described. In a final magical touch Strauss chooses to repeat the two lines beginning at ‘Und ich geh’ mit Einer, die mich lieb hat’. Over a tonic pedal, to the same rhythmic pattern that has accompanied every bar of the song, the lovers walk hand in hand out of sight, and into the ensuing silence.</p>

<p>from notes by Roger Vignoles © 2008</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Nicht im Schlafe hab ich das geträumt,
</span><span class='line'>Hell am Tage sah ich’s schön vor mir:
</span><span class='line'>Eine Wiese voller Margeritten;
</span><span class='line'>Tief ein weißes Haus in grünen Büschen;
</span><span class='line'>Götterbilder leuchten aus dem Laube.
</span><span class='line'>Und ich geh’ mit Einer, die mich lieb hat
</span><span class='line'>Ruhigen Gemütes in die Kühle
</span><span class='line'>Dieses weißen Hauses, in den Frieden,
</span><span class='line'>Der voll Schönheit wartet, daß wir kommen.
</span><span class='line'>Otto Julius Bierbaum (1865-1910)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>I did not dream it in my sleep,
</span><span class='line'>In broad daylight I saw it fair before me:
</span><span class='line'>A meadow full of daisies;
</span><span class='line'>A white house deep in green bushes;
</span><span class='line'>Statues of gods gleaming from the foliage.
</span><span class='line'>And I walk with one who loves me,
</span><span class='line'>My heart at peace, into the coolness
</span><span class='line'>Of this white house, into the peace,
</span><span class='line'>Brimming with beauty, that awaits our coming.
</span><span class='line'>English: Richard Stokes</span></code></pre></td></tr></table></div></figure>


<h2>塞西莉 (Cäcilie Op.27 No.2)</h2>

<ul>
<li><a href="https://en.wikipedia.org/wiki/C%C3%A4cilie_">https://en.wikipedia.org/wiki/C%C3%A4cilie_</a>(Strauss)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Cäcilie
</span><span class='line'>
</span><span class='line'>Wenn du es wüßtest,
</span><span class='line'>Was träumen heißt von brennenden Küssen,
</span><span class='line'>Von wandern und ruhen mit der Geliebten,
</span><span class='line'>Aug in Auge,
</span><span class='line'>Und kosend und plaudernd,
</span><span class='line'>Wenn du es wüßtest,
</span><span class='line'>Du neigtest dein Herz!
</span><span class='line'>
</span><span class='line'>Wenn du es wüßtest,
</span><span class='line'>Was bangen heißt in einsamen Nächten,
</span><span class='line'>Umschauert vom Sturm, da niemand tröstet
</span><span class='line'>Milden Mundes die kampfmüde Seele,
</span><span class='line'>Wenn du es wüßtest,
</span><span class='line'>Du kämest[6] zu mir.
</span><span class='line'>
</span><span class='line'>Wenn du es wüßtest,
</span><span class='line'>Was leben heißt, umhaucht von der Gottheit
</span><span class='line'>weltschaffendem Atem,
</span><span class='line'>Zu schweben empor, lichtgetragen,
</span><span class='line'>Zu seligen Höhn,[7]
</span><span class='line'>Wenn du es wüßtest, wenn du es wüßtest,
</span><span class='line'>Du lebtest mit mir.</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Cecilia
</span><span class='line'>
</span><span class='line'>If you but knew, sweet,
</span><span class='line'>what ‘tis to dream of fond, burning kisses,
</span><span class='line'>of wand’ring and resting with the belov’d one;
</span><span class='line'>gazing fondly
</span><span class='line'>caressing and chatting,
</span><span class='line'>could I but tell you,
</span><span class='line'>your heart would assent.
</span><span class='line'>
</span><span class='line'>If you but knew, sweet,
</span><span class='line'>the anguish of waking thro' nights long and lonely
</span><span class='line'> and rocked by the storm when no-one is near
</span><span class='line'>to soothe and comfort the strife weary spirit.
</span><span class='line'>Could I but tell you,
</span><span class='line'>you’d come, sweet, to me.
</span><span class='line'>
</span><span class='line'>If you but knew, sweet,
</span><span class='line'>what living is, in the creative breath of
</span><span class='line'>God, Lord and Maker
</span><span class='line'>to hover, upborne on dove-like pinions
</span><span class='line'>to regions of light,
</span><span class='line'>if you but knew it, could I but tell you,
</span><span class='line'>you’d dwell, sweet, with me.</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于《原旨主义与本真运动——宪法与古典音乐的解释》的一点浅见]]></title>
    <link href="http://yszheda.github.io/blog/blog/2017/08/26/some-thoughts-on-early-music/"/>
    <updated>2017-08-26T00:55:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2017/08/26/some-thoughts-on-early-music</id>
    <content type="html"><![CDATA[<p>许久不看《读书》，近日看到左先生的<a href="https://mp.weixin.qq.com/s/07hJ7l-zzYPStvYl940a5A">《原旨主义与本真运动——宪法与古典音乐的解释》</a>，将美国宪法研究的原旨主义和古典音乐的本真运动相类比观点新颖，让我萌发了不少思考。然而，作为一位早期音乐爱好者，对其中一些观点并不敢苟同。</p>

<p>第一遍读下来，我发觉文中对于本真派和浪漫派的定义是含糊不清的：“本真派”有时候指尊重乐谱的客观主义诠释理念，有时候又变成早期音乐演奏家，有时候又是说演奏家采用了古乐器和古乐技法；至于“浪漫派”，我也不清楚作者究竟想指演绎以浪漫主义为主的古典音乐核心曲目的演奏家，还是指主张高自由度、不必拘泥乐谱的音乐演绎派别。
对于前者而言， “本真”界定起来确实过于模糊，本真运动中的音乐家也有着各式不同的理念，很难划一个统一标准作为他们的共性：如果说是采用时代乐器和演奏方法吧？ 很多大佬就不遵守：例如Melkus就不用羊肠弦，而且采用现代标准音高和运用大量揉音（vibrato）； 号称play Bach in HIS way的Landowska，用的也是加了踏板的不那么“原汁原味”的harpsichord。如果说是遵照乐谱指示吧？不少古乐演奏大师偏偏还就喜欢改编原作、更改自己觉得谱面出错的地方、调整乐曲内部编排以符合个人审美。从这个角度而言，作者给出的本真派“信言不美”和浪漫派“美言不信”的说法也是站不住脚的（“信”和“美”本身在音乐诠释上也是模糊和多义的。个人甚至认为，在音乐诠释中并不存在所谓“信”与“不信”问题，各派别探索的只是诠释的各种可能性，并没有哪一种可能性是音乐诠释的唯一真实答案）。如果说是演奏早期音乐的话？“本真运动”在兴起之初其实就大量涉足演奏古典主义及其后的音乐作品（而非作者所称的“近来”），不过相当一部分属于相对“冷门”的作曲家（里面名气稍大的如博凯里尼、施塔米茨、戈赛克、几位巴赫等）的作品，确实有“农村包围城市”之感。</p>

<p>由此来看，波斯那把含义模糊的“本真运动”当作古典音乐的原旨主义多少有些张冠李戴了。个人觉得可以和原旨主义类比的，是把尊重乐谱和所谓“作曲家原意”作为出发点的客观主义音乐诠释派别，与以尼基什等人为代表的浪漫主义诠释流派相对。和原旨主义更为相似的是，以理查斯特劳斯、托斯卡尼尼等人为代表的“客观派”获得了极大的影响力，使尼基什、克莱斯勒、科尔托式的浪漫主义诠释在当今几近绝迹。</p>

<p>那么，我们可以仿照作者的说法，认为客观主义打下了古典音乐诠释的江山吗？个人的看法比较矛盾：一方面，我认为“打江山”“坐江山”这种脱胎于高度集权社会的观点在当下多元主义文化的语境下已经过时。这里也小小调侃下作者通过“人们在提起最伟大的钢琴家和小提琴家时首先想到的演奏家”来判定本真派和浪漫派技艺孰优孰劣的说法，这其实就和从“人们在提起最伟大的鲁特琴、recorder和viol演奏家时，首先想到的不会是非古乐演奏家”得出本真派技高一筹的结论一样荒谬。 同理，作者在文中把担任传统顶尖交响乐团首席指挥作为音乐诠释派别是否“革命成功”的标准，也经不起推敲。另一方面，媒体和资本成为一股左右听众和音乐家的强大力量，音乐诠释在朝着独立音乐家们所不乐见的方向僵化固化，形成了本不应存在的“江山”。文中提到的本真派和浪漫派以贝多芬为界划江而治，还有巴伦所抱怨的演奏古典和巴洛克时期作品的市场现在基本已被本真运动垄断，我认为都是有悖多元主义价值观的畸形发展。</p>

<p>最后附上<a href="http://blog.sina.com.cn/s/blog_b50bd5f50102x4fb.html">钟神的《关于音乐的本真主义》</a>，算是对我的回应吧XD</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ARM NEON编程初探——一个简单的BGR888转YUV444实例详解]]></title>
    <link href="http://yszheda.github.io/blog/blog/2017/06/10/use-arm-neon-to-accelerate-bgr888-to-yuv444/"/>
    <updated>2017-06-10T13:00:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2017/06/10/use-arm-neon-to-accelerate-bgr888-to-yuv444</id>
    <content type="html"><![CDATA[<p>最近在学习ARM的SIMD指令集<a href="https://developer.arm.com/technologies/neon">NEON</a>，发现这方面的资料真是太少了，我便来给NEON凑凑人气，姑且以这篇入门文章来分享一些心得吧。</p>

<p>学习一门新技术，总是有一些经典是绕不开的，对于NEON来说，这份必备的武林秘籍自然就是ARM官方的《NEON Programmer&rsquo;s Guide》（以下简称Guide）啦。别看这份Guide有四百多页，其实只有一百来页是正文，后面都是供查阅的手册，通读一番还是不难的。所以这里我也就不打算把Guide里的内容翻译过来敷衍了事了。在此我想借一个简单例子，展示我是如何把一个没采用NEON的普通程序改写为NEON程序、中间又是如何debug、如何调优的。当然，作为一枚ARM小白，我接触NEON指令集毕竟也才两周左右时间，错误在所难免，还请各位方家多多指正。</p>

<!-- more -->


<h1>BGR888ToYUV444</h1>

<p>在众多并行操作模式（Map, Reduce, Scatter, Stencil等）中，最简单的也许要算Map了，所以我选了一个Map的例子——BGR888转YUV444。这两者都是颜色空间的格式：前者表示一个像素有B、G、R三个颜色通道，每个通道占8-bit，在内存中按照<code>B G R</code>的顺序从高位到低位排列；后者表示一个像素有Y、U、V三个通道，每个通道也是8-bit（444仅指Y、U、V的采样率比值为4:4:4，其他类型的采样率还有YUV422、YUV420），我们也假设它在内存中按照<code>V U Y</code>的顺序从高位到低位排列。如何把BGR888格式转成YUV444呢？根据<a href="https://en.wikipedia.org/wiki/YUV">wiki</a>上的转换公式，我们可以写出如下代码（很显然，这是一一对应，典型的Map模式）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">BGR888ToYUV444</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">yuv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_num</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">g</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.299</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">0.587</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mf">0.114</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.169</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mf">0.331</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">v</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mf">0.419</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mf">0.081</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码的意思很简单，我们遍历所有像素，每次把B、G、R三个通道的值从内存中加载进来，再做浮点数乘法和加减法，得到Y、U、V的值，写入相应的内存中。那么，使用NEON可以怎样帮助这段程序跑得更快呢？</p>

<p>前面提到，NEON是一种SIMD（Single Instruction Multiple Data）指令，也就是说，NEON可以把若干源（source）操作数（operand）打包放到一个源寄存器中，对他们执行相同的操作，产生若干目的（dest）操作数，这种方式也叫向量化（vectorization）。这样的话，能打包多少数据同时做运算就取决于寄存器位宽，在ARMv7的NEON unit中，register file总大小是1024-bit，可以划分为16个128-bit的Q-register（Quadword register）或者32个64-bit的D-register（Dualword register），也就是说，最长的寄存器位宽是128-bit（详见Guide第一章）。以上面的R888ToYUV444函数为例，假设我们采用32-bit单精度浮点数float来做浮点运算，那么我们可以 把最多<code>128/32=4</code>个浮点数打包放到Q-register中做SIMD运算，一次拿4个BGR算出4个YUV，从而提高吞吐量，减少loop次数。</p>

<p>（细心的看官可能会问到双精度浮点数double的运算吧？遗憾的是，根据Guide，NEON并不支持double，你可以考虑使用<a href="https://en.wikipedia.org/wiki/ARM_architecture#VFP">VFP/Vector Floating Point</a>，但<a href="https://stackoverflow.com/questions/4097034/arm-cortex-a8-whats-the-difference-between-vfp-and-neon">VFP并非SIMD单元</a>）。</p>

<h1>从浮点运算到整型运算</h1>

<p>那么，我们还可以继续提高向量化程度吗？如果我们回头看<a href="https://en.wikipedia.org/wiki/YUV">wiki</a>，我们会发现在早期不支持浮点操作的SIMD处理器中，使用了如下整型运算来把BGR转成YUV：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Refer to: https://en.wikipedia.org/wiki/YUV (Full swing for BT.601)</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">BGR888ToYUV444</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">yuv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_num</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">g</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 1. Multiply transform matrix (Y′: unsigned, U/V: signed)</span>
</span><span class='line'>        <span class="kt">uint16_t</span> <span class="n">y_tmp</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">29</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16_t</span> <span class="n">u_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">84</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">127</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16_t</span> <span class="n">v_tmp</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">106</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 2. Scale down (&quot;&gt;&gt;8&quot;) to 8-bit values with rounding (&quot;+128&quot;) (Y′: unsigned, U/V: signed)</span>
</span><span class='line'>        <span class="n">y_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">u_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">v_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 3. Add an offset to the values to eliminate any negative values (all results are 8-bit unsigned)</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">y_tmp</span><span class="p">;</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">u_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">v_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从这段代码我们不难发现，32-bit的float运算被16-bit的加减、乘法和移位运算所代替。这样的话，我们可以把最多<code>128/16=8</code>个整型数放到Q-register中做SIMD运算，一次拿8个BGR算出8个YUV，把向量化程度再提一倍。使用整型运算还有一个好处：一般而言，整型运算指令所需要的时钟周期少于浮点运算的时钟周期。所以，我以这段代码为基准（baseline），用NEON来加速它。（细心的看官也许已经看到我说法中的纰漏：虽然单个整型指令的周期小于单个相同运算的浮点指令的周期，但整型版本的BGR888ToYUV444比起浮点版本的多了移位和加法的overhead，指令数目是不同的，总的时钟周期不一定就短。Good point! 看官不妨看完本文后也用NEON改写浮点版本练练手，两相比较就不难得出最终的结论啦XD）</p>

<h1>NEON Intrinsics</h1>

<p>接下来可以着手写NEON代码了。个人推荐新手先别急着一上来就写汇编，NEON提供了intrinsics，其实就是一套可在C/C++中调用的函数API，编译器会代劳把这些intrinsics转成NEON指令（详见Guide的第四章），这样就方便一些。我用NEON intrinsics改写的<code>BGR888ToYUV444</code>函数如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">BGR888ToYUV444</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__restrict__</span> <span class="n">yuv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__restrict__</span> <span class="n">bgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_num</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">uint8x8_t</span> <span class="n">u8_zero</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">uint16x8_t</span> <span class="n">u16_rounding</span> <span class="o">=</span> <span class="n">vdupq_n_u16</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">int16x8_t</span> <span class="n">s16_rounding</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">int8x16_t</span> <span class="n">s8_rounding</span> <span class="o">=</span> <span class="n">vdupq_n_s8</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">pixel_num</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Load bgr</span>
</span><span class='line'>        <span class="kt">uint8x16x3_t</span> <span class="n">pixel_bgr</span> <span class="o">=</span> <span class="n">vld3q_u8</span><span class="p">(</span><span class="n">bgr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">high_r</span> <span class="o">=</span> <span class="n">vget_high_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">low_r</span> <span class="o">=</span> <span class="n">vget_low_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">high_g</span> <span class="o">=</span> <span class="n">vget_high_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">low_g</span> <span class="o">=</span> <span class="n">vget_low_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">high_b</span> <span class="o">=</span> <span class="n">vget_high_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">low_b</span> <span class="o">=</span> <span class="n">vget_low_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_high_r</span> <span class="o">=</span> <span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">vaddl_u8</span><span class="p">(</span><span class="n">high_r</span><span class="p">,</span> <span class="n">u8_zero</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_low_r</span> <span class="o">=</span> <span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">vaddl_u8</span><span class="p">(</span><span class="n">low_r</span><span class="p">,</span> <span class="n">u8_zero</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_high_g</span> <span class="o">=</span> <span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">vaddl_u8</span><span class="p">(</span><span class="n">high_g</span><span class="p">,</span> <span class="n">u8_zero</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_low_g</span> <span class="o">=</span> <span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">vaddl_u8</span><span class="p">(</span><span class="n">low_g</span><span class="p">,</span> <span class="n">u8_zero</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_high_b</span> <span class="o">=</span> <span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">vaddl_u8</span><span class="p">(</span><span class="n">high_b</span><span class="p">,</span> <span class="n">u8_zero</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_low_b</span> <span class="o">=</span> <span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">vaddl_u8</span><span class="p">(</span><span class="n">low_b</span><span class="p">,</span> <span class="n">u8_zero</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// NOTE:</span>
</span><span class='line'>        <span class="c1">// declaration may not appear after executable statement in block</span>
</span><span class='line'>        <span class="kt">uint16x8_t</span> <span class="n">high_y</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint16x8_t</span> <span class="n">low_y</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint8x8_t</span> <span class="n">scalar</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">76</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">high_u</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">low_u</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">signed_scalar</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="o">-</span><span class="mi">43</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">high_v</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16x8_t</span> <span class="n">low_v</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint8x16x3_t</span> <span class="n">pixel_yuv</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int8x16_t</span> <span class="n">u</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int8x16_t</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 1. Multiply transform matrix (Y′: unsigned, U/V: signed)</span>
</span><span class='line'>        <span class="n">high_y</span> <span class="o">=</span> <span class="n">vmull_u8</span><span class="p">(</span><span class="n">high_r</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_y</span> <span class="o">=</span> <span class="n">vmull_u8</span><span class="p">(</span><span class="n">low_r</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">high_u</span> <span class="o">=</span> <span class="n">vmulq_s16</span><span class="p">(</span><span class="n">signed_high_r</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_u</span> <span class="o">=</span> <span class="n">vmulq_s16</span><span class="p">(</span><span class="n">signed_low_r</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">signed_scalar</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="mi">127</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_v</span> <span class="o">=</span> <span class="n">vmulq_s16</span><span class="p">(</span><span class="n">signed_high_r</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_v</span> <span class="o">=</span> <span class="n">vmulq_s16</span><span class="p">(</span><span class="n">signed_low_r</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">scalar</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_y</span> <span class="o">=</span> <span class="n">vmlal_u8</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="n">high_g</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_y</span> <span class="o">=</span> <span class="n">vmlal_u8</span><span class="p">(</span><span class="n">low_y</span><span class="p">,</span> <span class="n">low_g</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">signed_scalar</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="o">-</span><span class="mi">84</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_u</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">high_u</span><span class="p">,</span> <span class="n">signed_high_g</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_u</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">low_u</span><span class="p">,</span> <span class="n">signed_low_g</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">signed_scalar</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="o">-</span><span class="mi">106</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_v</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">high_v</span><span class="p">,</span> <span class="n">signed_high_g</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_v</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">low_v</span><span class="p">,</span> <span class="n">signed_low_g</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">scalar</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">29</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_y</span> <span class="o">=</span> <span class="n">vmlal_u8</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="n">high_b</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_y</span> <span class="o">=</span> <span class="n">vmlal_u8</span><span class="p">(</span><span class="n">low_y</span><span class="p">,</span> <span class="n">low_b</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">signed_scalar</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="mi">127</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_u</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">high_u</span><span class="p">,</span> <span class="n">signed_high_b</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_u</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">low_u</span><span class="p">,</span> <span class="n">signed_low_b</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">signed_scalar</span> <span class="o">=</span> <span class="n">vdupq_n_s16</span><span class="p">(</span><span class="o">-</span><span class="mi">21</span><span class="p">);</span>
</span><span class='line'>        <span class="n">high_v</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">high_v</span><span class="p">,</span> <span class="n">signed_high_b</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_v</span> <span class="o">=</span> <span class="n">vmlaq_s16</span><span class="p">(</span><span class="n">low_v</span><span class="p">,</span> <span class="n">signed_low_b</span><span class="p">,</span> <span class="n">signed_scalar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 2. Scale down (&quot;&gt;&gt;8&quot;) to 8-bit values with rounding (&quot;+128&quot;) (Y′: unsigned, U/V: signed)</span>
</span><span class='line'>        <span class="c1">// 3. Add an offset to the values to eliminate any negative values (all results are 8-bit unsigned)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">high_y</span> <span class="o">=</span> <span class="n">vaddq_u16</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="n">u16_rounding</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_y</span> <span class="o">=</span> <span class="n">vaddq_u16</span><span class="p">(</span><span class="n">low_y</span><span class="p">,</span> <span class="n">u16_rounding</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">high_u</span> <span class="o">=</span> <span class="n">vaddq_s16</span><span class="p">(</span><span class="n">high_u</span><span class="p">,</span> <span class="n">s16_rounding</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_u</span> <span class="o">=</span> <span class="n">vaddq_s16</span><span class="p">(</span><span class="n">low_u</span><span class="p">,</span> <span class="n">s16_rounding</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">high_v</span> <span class="o">=</span> <span class="n">vaddq_s16</span><span class="p">(</span><span class="n">high_v</span><span class="p">,</span> <span class="n">s16_rounding</span><span class="p">);</span>
</span><span class='line'>        <span class="n">low_v</span> <span class="o">=</span> <span class="n">vaddq_s16</span><span class="p">(</span><span class="n">low_v</span><span class="p">,</span> <span class="n">s16_rounding</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pixel_yuv</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcombine_u8</span><span class="p">(</span><span class="n">vqshrn_n_u16</span><span class="p">(</span><span class="n">low_y</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">vqshrn_n_u16</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">u</span> <span class="o">=</span> <span class="n">vcombine_s8</span><span class="p">(</span><span class="n">vqshrn_n_s16</span><span class="p">(</span><span class="n">low_u</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">vqshrn_n_s16</span><span class="p">(</span><span class="n">high_u</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">v</span> <span class="o">=</span> <span class="n">vcombine_s8</span><span class="p">(</span><span class="n">vqshrn_n_s16</span><span class="p">(</span><span class="n">low_v</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">vqshrn_n_s16</span><span class="p">(</span><span class="n">high_v</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">u</span> <span class="o">=</span> <span class="n">vaddq_s8</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">s8_rounding</span><span class="p">);</span>
</span><span class='line'>        <span class="n">pixel_yuv</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vreinterpretq_u8_s8</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">v</span> <span class="o">=</span> <span class="n">vaddq_s8</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">s8_rounding</span><span class="p">);</span>
</span><span class='line'>        <span class="n">pixel_yuv</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vreinterpretq_u8_s8</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Store</span>
</span><span class='line'>        <span class="n">vst3q_u8</span><span class="p">(</span><span class="n">yuv</span><span class="p">,</span> <span class="n">pixel_yuv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bgr</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
</span><span class='line'>        <span class="n">yuv</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Handle leftovers</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">g</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">uint16_t</span> <span class="n">y_tmp</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">29</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16_t</span> <span class="n">u_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">84</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">127</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16_t</span> <span class="n">v_tmp</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">106</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">y_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">u_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">v_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">y_tmp</span><span class="p">;</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">u_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">v_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数中大部分都是很常用的NEON intrinsics，看官不妨结合查阅Guide的附录D自行熟悉，这里我仅针对几个点解释一下：</p>

<ul>
<li><p>我用<code>vld3q_u8</code>指令从内存一次加载16个像素（也就是<code>uint8_t</code>类型的B、G、R三个通道的数值），将各个通道的16个数值放到一个Q-register中（也就是用了三个Q-register，每个分别存放16个B、16个G和16个R），<code>vst3q_u8</code>的写入操作也是类似的，这充分利用128-bit的带宽，使内存存取（memory access）的次数尽可能少。但是，后边运算的向量化程度其实仍然不变，只能同时进行8个16-bit整型运算，也就是说，对于运算的部分，理想加速比（speedup）是8而非16。（当然，一次从内存加载多少数据是一个design choice，没有绝对的答案，看官也可以尝试别的方式XD）</p></li>
<li><p>对于像素个数不能被16整除的情况，可能会有剩下的1到15个像素没被上述NEON代码处理到，这里我把它们称作leftovers，简单粗暴地跑了之前的for循环。其实leftover的情况如果占比高的话，还有更高明的处理方式，请各位看官参见Guide的6.2 Handling non-multiple array lengths一节。</p></li>
<li><p>我把Y通道计算的一部分放到一起，稍作解释，其他的很多运算都是类似的：</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// 复制8个值为128的uint16_t类型整数到某个Q-register，该Q-register对应的C变量是u16_rounding</span>
</span><span class='line'><span class="k">const</span> <span class="kt">uint16x8_t</span> <span class="n">u16_rounding</span> <span class="o">=</span> <span class="n">vdupq_n_u16</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 复制8个值为128的uint8_t类型整数到某个D-register，该D-register对应的C变量是scalar</span>
</span><span class='line'><span class="kt">uint8x8_t</span> <span class="n">scalar</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">76</span><span class="p">);</span>
</span><span class='line'><span class="c1">// pixel_bgr.val[0]为一个Q-register，16个uint8_t类型的数，对应R通道</span>
</span><span class='line'><span class="c1">// pixel_bgr.val[1]为一个Q-register，16个uint8_t类型的数，对应G通道</span>
</span><span class='line'><span class="c1">// pixel_bgr.val[2]为一个Q-register，16个uint8_t类型的数，对应B通道</span>
</span><span class='line'><span class="kt">uint8x16x3_t</span> <span class="n">pixel_bgr</span> <span class="o">=</span> <span class="n">vld3q_u8</span><span class="p">(</span><span class="n">bgr</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 一个Q-register对应有两个D-register</span>
</span><span class='line'><span class="c1">// 这是拿到对应R通道的Q-register高位的D-register，有8个R值</span>
</span><span class='line'><span class="c1">// 参见Guide中Register overlap一节（这部分内容很重要！）</span>
</span><span class='line'><span class="c1">// 其他如low_r、high_g的情况相似，这里从略</span>
</span><span class='line'><span class="kt">uint8x8_t</span> <span class="n">high_r</span> <span class="o">=</span> <span class="n">vget_high_u8</span><span class="p">(</span><span class="n">pixel_bgr</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'><span class="c1">// 对8个R值执行乘76操作</span>
</span><span class='line'><span class="c1">// vmull是变长指令（常以单词末尾额外的L作为标记），源操作数是两个uint8x8_t的向量，目的操作数是uint16x8_t的向量</span>
</span><span class='line'><span class="c1">// 到这一步：Y = R * 76</span>
</span><span class='line'><span class="c1">// low_y的情况类似，从略</span>
</span><span class='line'><span class="n">high_y</span> <span class="o">=</span> <span class="n">vmull_u8</span><span class="p">(</span><span class="n">high_r</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 把scalar的8个128改为8个150</span>
</span><span class='line'><span class="n">scalar</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 执行乘加运算</span>
</span><span class='line'><span class="c1">// 到这一步：Y = R * 76 + G * 150</span>
</span><span class='line'><span class="n">high_y</span> <span class="o">=</span> <span class="n">vmlal_u8</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="n">high_g</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 把scalar的8个150改为8个29</span>
</span><span class='line'><span class="n">scalar</span> <span class="o">=</span> <span class="n">vdup_n_u8</span><span class="p">(</span><span class="mi">29</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 执行乘加运算</span>
</span><span class='line'><span class="c1">// 到这一步：Y = R * 76 + G * 150 + B * 29</span>
</span><span class='line'><span class="n">high_y</span> <span class="o">=</span> <span class="n">vmlal_u8</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="n">high_b</span><span class="p">,</span> <span class="n">scalar</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 到这一步：Y = (R * 76 + G * 150 + B * 29) + 128</span>
</span><span class='line'><span class="n">high_y</span> <span class="o">=</span> <span class="n">vaddq_u16</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="n">u16_rounding</span><span class="p">);</span>
</span><span class='line'><span class="c1">// vqshrn_n_u16是变窄指令（常以单词末尾额外的N作为标记，N为Narrow），将uint16x8_t的向量压缩为uint8x8_t</span>
</span><span class='line'><span class="c1">// 到这一步：Y = ((R * 76 + G * 150 + B * 29) + 128) &gt;&gt; 8</span>
</span><span class='line'><span class="c1">// vcombine_u8用于将两个D-register的值组装到一个Q-register中</span>
</span><span class='line'><span class="n">pixel_yuv</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcombine_u8</span><span class="p">(</span><span class="n">vqshrn_n_u16</span><span class="p">(</span><span class="n">low_y</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">vqshrn_n_u16</span><span class="p">(</span><span class="n">high_y</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>看官也许已经注意到了，在前面的<code>BGR888ToYUV444</code>函数中，我并非像上面的代码一样，将一个通道的运算放到一块，而是有意将Y、U、V三个通道的运算打散搅在一起。这是为了尽可能减少data dependency所引起的stall，这也是优化NEON代码需要着重考虑的方向之一。</p></li>
<li><p>对NEON稍有了解的细心看官可能会问：乘法和加法所需要的128、76等常数为何不用立即数——例如NEON的<code>vmul_n</code>——而是采用先批量复制常数到向量再做向量运算？这是因为我们很多运算的源操作数是<code>int8x8_t</code>或<code>uint8x8_t</code>的向量，<code>vmul_n</code>等API很不幸不支持这种格式。这里也良心提醒看官，写NEON intrinsics或者汇编一定要对照Guide后面的附录列出的格式，否则编译器常常会报一些风马牛不相及的错误，把人往坑里带——我当初可是各种踩坑各种在不相关的地方纠结啊555&hellip;</p></li>
</ul>


<h2>交叉编译及debug</h2>

<p>说到编译和debug，这里再良心提醒几点——如果看官早就知道了，那就权当我这好久没碰过嵌入式开发的小白在碎碎念好了：</p>

<ul>
<li><p>一定要注意编译器EABI的版本！一定要注意编译器EABI的版本！一定要注意编译器EABI的版本！EABI指的是<a href="https://en.wikipedia.org/wiki/Application_binary_interface">Embedded-Application Binary Interface</a>，我在这个白痴问题上浪费了不少时间，一定要把重要事情说三遍&hellip;</p>

<ul>
<li><p>一个需要注意的地方是gnueabi和androideabi的不一样。我最开始遇到的一个问题就是：把一个编译出来的可执行文件拷到开发板上，设了可执行权限，结果在运行时却出现「No such file or directory」，略诡异啊。用<code>strace</code>追踪发现是<code>exec</code>系统调用报的错，<code>exec</code>会根据可执行文件（在Linux系下是ELF）的<code>.interp</code>段运行相应的loader，由该loader做动态链接，再到可执行文件的入口地址开始执行。其实这时候用<code>readelf -l &lt;program&gt; | grep interpreter</code>查看ELF的loader地址，再看看设备上有没有该文件，基本可以确定EABI有没有用对了，但逗逼如我强行搞了个软链接[捂脸]&hellip;后来才发现是在Makefile里用gnueabi系的编译器编译Android程序，但其实编译Android程序还是直接用<code>ndk</code>才是王道啊！</p></li>
<li><p>另一个需要注意的是float-abi。<code>gcc</code>中有一个选项<code>-mfloat-abi</code>，可选<code>soft</code>/<code>softfp</code>/<code>hardfp</code>：<code>soft</code>和后两者的区别是编译器不会生成浮点指令，浮点操作完全由软件实现；相比之下，<code>hardfp</code>走了另一个极端，浮点操作完全由硬件实现，效率最高；<code>softfp</code>则是走中间路线，它有着和<code>hardfp</code>完全不一样的calling convention——<code>hardfp</code>通过<code>VFP</code>来传浮点参数，而<code>softfp</code>还是通过整型寄存器来传参，和<code>soft</code>是一致的。因此，<code>softfp</code>编译的程序和<code>hardfp</code>编译的程序是互不兼容的，如果你把它们链接到一块，会出现「uses VFP register arguments, output does not」的报错。</p></li>
</ul>
</li>
<li><p>需要使用正确的编译参数才能支持NEON。如果前面提到的<code>-mfloat-abi</code>指定了<code>soft</code>，那么就不支持NEON了。另外还常常需要<code>-mfpu=neon</code>来指定<a href="https://en.wikipedia.org/wiki/Floating-point_unit">FPU(Floating-Point Unit)</a>是NEON Unit。具体的编译参数详见Guide第二章。</p></li>
<li><p>可以使用<code>gdb</code>远程调试ARM设备上的程序：</p></li>
</ul>


<p>1.在设备上启动<code>gdbserver</code>（假设在6666端口吧，哈哈我比较喜欢6666）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># &lt;program&gt;是程序名</span>
</span><span class='line'><span class="c"># &lt;arg&gt;是程序参数</span>
</span><span class='line'><span class="nv">$ </span>gdbserver localhost:6666 &lt;program&gt; &lt;arg&gt;
</span></code></pre></td></tr></table></div></figure>


<p>2.在连接设备的主机（host）上启动对应EABI的<code>gdb</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>adb forward tcp:6666 tcp:6666
</span><span class='line'><span class="c"># &lt;program&gt;是程序名</span>
</span><span class='line'><span class="nv">$ </span>gdb &lt;program&gt;
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> target remote :6666
</span></code></pre></td></tr></table></div></figure>


<p>3.和<code>gdbserver</code>连接上后，就可以在主机端的<code>gdb</code>执行各种debug操作了。对于NEON程序，我们常常想查看NEON Unit的register file，可以采用下面的命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>gdb<span class="o">)</span> info all-registers
</span></code></pre></td></tr></table></div></figure>


<h1>NEON汇编</h1>

<p>虽然有了NEON intrinsics程序，但编译器<del>很笨很笨的</del>生成的汇编代码常常不尽如人意。要想发挥NEON指令集的最大威力，我们还需练就优化汇编这一上乘武功。好在有了intrinsics代码，我们可以“偷看”编译器或<code>objdump</code>的<code>-S</code>生成的“答案”，无需自己从头写汇编代码。当然，一开始看<code>-O3</code>优化过的汇编代码还是有点懵逼的，我个人比较偏好先看<code>-O0</code>（竟然和intrinsics的相差无几！）和<code>-O1</code>版的，以此为基准，再看看<code>-O2</code>和<code>-O3</code>，猜猜做了哪些优化，加以借鉴。本着这一思路，我用汇编又改写了一版<code>BGR888ToYUV444</code>，其中大部分汇编指令是由之前的intrinsics代码演化过来的，所以我这里也在注释标上了对应的intrinsics代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">BGR888ToYUV444</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__restrict__</span> <span class="n">yuv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__restrict__</span> <span class="n">bgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_num</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">pixel_num</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span><span class='line'>            <span class="c1">// const uint16x8_t u16_rounding = vdupq_n_u16(128);</span>
</span><span class='line'>            <span class="c1">// const int16x8_t s16_rounding = vdupq_n_s16(128);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I16 q3,#0x80</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="c1">// const int8x16_t s8_rounding = vdupq_n_s8(128);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I8  q4,#0x80</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// i = 0</span>
</span><span class='line'>            <span class="s">&quot;MOV      r2,#0</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="s">&quot;LOOP: </span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// uint8x16x3_t pixel_bgr = vld3q_u8(bgr);</span>
</span><span class='line'>            <span class="s">&quot;ADD      r12,r1,#0x18</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VLD3.8   {d0,d2,d4},[r1]</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VLD3.8   {d1,d3,d5},[r12]</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// // bgr += 3 * 16;</span>
</span><span class='line'>            <span class="c1">// &quot;ADD      r1,r1,#0x30\t\n&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// // i++</span>
</span><span class='line'>            <span class="c1">// &quot;ADD      r2,r2,#1\t\n&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// int16x8_t signed_high_r = vreinterpretq_s16_u16(vmovl_u8(high_r));</span>
</span><span class='line'>            <span class="c1">// int16x8_t signed_low_r = vreinterpretq_s16_u16(vmovl_u8(low_r));</span>
</span><span class='line'>            <span class="c1">// int16x8_t signed_high_g = vreinterpretq_s16_u16(vmovl_u8(high_g));</span>
</span><span class='line'>            <span class="c1">// int16x8_t signed_low_g = vreinterpretq_s16_u16(vmovl_u8(low_g));</span>
</span><span class='line'>            <span class="c1">// int16x8_t signed_high_b = vreinterpretq_s16_u16(vmovl_u8(high_b));</span>
</span><span class='line'>            <span class="c1">// int16x8_t signed_low_b = vreinterpretq_s16_u16(vmovl_u8(low_b));</span>
</span><span class='line'>            <span class="s">&quot;VMOVL.U8 q5,d0</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMOVL.U8 q6,d1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMOVL.U8 q7,d2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMOVL.U8 q8,d3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMOVL.U8 q9,d4</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMOVL.U8 q10,d5</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// uint8x8_t scalar = vdup_n_u8(76);</span>
</span><span class='line'>            <span class="c1">// high_y = vmull_u8(high_r, scalar);</span>
</span><span class='line'>            <span class="c1">// low_y = vmull_u8(low_r, scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I8  d26,#0x4c</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMULL.U8 q11,d0,d26</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMULL.U8 q12,d1,d26</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// scalar = vdup_n_u8(150);</span>
</span><span class='line'>            <span class="c1">// high_y = vmlal_u8(high_y, high_g, scalar);</span>
</span><span class='line'>            <span class="c1">// low_y = vmlal_u8(low_y, low_g, scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I8  d26,#0x96</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLAL.U8 q11,d2,d26</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLAL.U8 q12,d3,d26</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// scalar = vdup_n_u8(29);</span>
</span><span class='line'>            <span class="c1">// high_y = vmlal_u8(high_y, high_b, scalar);</span>
</span><span class='line'>            <span class="c1">// low_y = vmlal_u8(low_y, low_b, scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I8  d26,#0x1d</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLAL.U8 q11,d4,d26</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLAL.U8 q12,d5,d26</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// int16x8_t signed_scalar = vdupq_n_s16(-43);</span>
</span><span class='line'>            <span class="c1">// high_u = vmulq_s16(signed_high_r, signed_scalar);</span>
</span><span class='line'>            <span class="c1">// low_u = vmulq_s16(signed_low_r, signed_scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMVN.I16 q1,#0x2a</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMUL.I16 q13,q5,q1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMUL.I16 q14,q6,q1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// signed_scalar = vdupq_n_s16(127);</span>
</span><span class='line'>            <span class="c1">// high_v = vmulq_s16(signed_high_r, signed_scalar);</span>
</span><span class='line'>            <span class="c1">// low_v = vmulq_s16(signed_low_r, signed_scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I16 q2,#0x7f</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMUL.I16 q15,q5,q2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMUL.I16 q0,q6,q2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// signed_scalar = vdupq_n_s16(-84);</span>
</span><span class='line'>            <span class="c1">// high_u = vmlaq_s16(high_u, signed_high_g, signed_scalar);</span>
</span><span class='line'>            <span class="c1">// low_u = vmlaq_s16(low_u, signed_low_g, signed_scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMVN.I16 q1,#0x53</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q13,q7,q1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q14,q8,q1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// signed_scalar = vdupq_n_s16(-106);</span>
</span><span class='line'>            <span class="c1">// high_v = vmlaq_s16(high_v, signed_high_g, signed_scalar);</span>
</span><span class='line'>            <span class="c1">// low_v = vmlaq_s16(low_v, signed_low_g, signed_scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMVN.I16 q2,#0x69</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q15,q7,q2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q0,q8,q2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// signed_scalar = vdupq_n_s16(127);</span>
</span><span class='line'>            <span class="c1">// high_u = vmlaq_s16(high_u, signed_high_b, signed_scalar);</span>
</span><span class='line'>            <span class="c1">// low_u = vmlaq_s16(low_u, signed_low_b, signed_scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMOV.I16 q1,#0x7f</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q13,q9,q1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q14,q10,q1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// signed_scalar = vdupq_n_s16(-21);</span>
</span><span class='line'>            <span class="c1">// high_v = vmlaq_s16(high_v, signed_high_b, signed_scalar);</span>
</span><span class='line'>            <span class="c1">// low_v = vmlaq_s16(low_v, signed_low_b, signed_scalar);</span>
</span><span class='line'>            <span class="s">&quot;VMVN.I16 q2,#0x14</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q15,q9,q2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VMLA.I16 q0,q10,q2</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// high_y = vaddq_u16(high_y, u16_rounding);</span>
</span><span class='line'>            <span class="c1">// low_y = vaddq_u16(low_y, u16_rounding);</span>
</span><span class='line'>            <span class="s">&quot;VADD.I16 q11,q11,q3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VADD.I16 q12,q12,q3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// high_u = vaddq_s16(high_u, s16_rounding);</span>
</span><span class='line'>            <span class="c1">// low_u = vaddq_s16(low_u, s16_rounding);</span>
</span><span class='line'>            <span class="s">&quot;VADD.I16 q13,q13,q3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VADD.I16 q14,q14,q3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// high_v = vaddq_s16(high_v, s16_rounding);</span>
</span><span class='line'>            <span class="c1">// low_v = vaddq_s16(low_v, s16_rounding);</span>
</span><span class='line'>            <span class="s">&quot;VADD.I16 q15,q15,q3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VADD.I16 q0,q0,q3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// pixel_yuv.val[0] = vcombine_u8(vqshrn_n_u16(low_y, 8), vqshrn_n_u16(high_y, 8));</span>
</span><span class='line'>            <span class="s">&quot;VQSHRN.U16 d10,q11,#8</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VQSHRN.U16 d11,q12,#8</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// u = vcombine_s8(vqshrn_n_s16(low_u, 8), vqshrn_n_s16(high_u, 8));</span>
</span><span class='line'>            <span class="s">&quot;VQSHRN.S16 d12,q13,#8</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VQSHRN.S16 d13,q14,#8</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// v = vcombine_s8(vqshrn_n_s16(low_v, 8), vqshrn_n_s16(high_v, 8));</span>
</span><span class='line'>            <span class="s">&quot;VQSHRN.S16 d14,q15,#8</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VQSHRN.S16 d15,q0,#8</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// u = vaddq_s8(u, s8_rounding);</span>
</span><span class='line'>            <span class="c1">// v = vaddq_s8(v, s8_rounding);</span>
</span><span class='line'>            <span class="s">&quot;VADD.I8  q6,q6,q4</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VADD.I8  q7,q7,q4</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// vst3q_u8(yuv, pixel_yuv);</span>
</span><span class='line'>            <span class="s">&quot;ADD      r12,r0,#0x18</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VST3.8   {d10,d12,d14},[r0]</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;VST3.8   {d11,d13,d15},[r12]</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="c1">// bgr += 3 * 16;</span>
</span><span class='line'>            <span class="c1">// yuv += 3 * 16;</span>
</span><span class='line'>            <span class="s">&quot;ADD      r1,r1,#0x30</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;ADD      r0,r0,#0x30</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="c1">// i++</span>
</span><span class='line'>            <span class="s">&quot;ADD      r2,r2,#1</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="c1">// i &lt; count</span>
</span><span class='line'>            <span class="s">&quot;CMP      r2,r3</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="s">&quot;BLT      LOOP</span><span class="se">\t\n</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="o">:</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">yuv</span><span class="p">),</span> <span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">bgr</span><span class="p">),</span> <span class="p">[</span><span class="n">r3</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span class='line'>            <span class="o">:</span>
</span><span class='line'>            <span class="o">:</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;d0&quot;</span><span class="p">,</span> <span class="s">&quot;d1&quot;</span><span class="p">,</span> <span class="s">&quot;d2&quot;</span><span class="p">,</span> <span class="s">&quot;d3&quot;</span><span class="p">,</span> <span class="s">&quot;d4&quot;</span><span class="p">,</span> <span class="s">&quot;d5&quot;</span><span class="p">,</span> <span class="s">&quot;d6&quot;</span><span class="p">,</span> <span class="s">&quot;d7&quot;</span><span class="p">,</span> <span class="s">&quot;d8&quot;</span><span class="p">,</span> <span class="s">&quot;d9&quot;</span><span class="p">,</span> <span class="s">&quot;d10&quot;</span><span class="p">,</span> <span class="s">&quot;d11&quot;</span><span class="p">,</span> <span class="s">&quot;d12&quot;</span><span class="p">,</span> <span class="s">&quot;d13&quot;</span><span class="p">,</span> <span class="s">&quot;d14&quot;</span><span class="p">,</span> <span class="s">&quot;d15&quot;</span><span class="p">,</span> <span class="s">&quot;d16&quot;</span><span class="p">,</span> <span class="s">&quot;d17&quot;</span><span class="p">,</span> <span class="s">&quot;d18&quot;</span><span class="p">,</span> <span class="s">&quot;d19&quot;</span><span class="p">,</span> <span class="s">&quot;d20&quot;</span><span class="p">,</span> <span class="s">&quot;d21&quot;</span><span class="p">,</span> <span class="s">&quot;d22&quot;</span><span class="p">,</span> <span class="s">&quot;d23&quot;</span><span class="p">,</span> <span class="s">&quot;d24&quot;</span><span class="p">,</span> <span class="s">&quot;d25&quot;</span><span class="p">,</span> <span class="s">&quot;d26&quot;</span><span class="p">,</span> <span class="s">&quot;d27&quot;</span><span class="p">,</span> <span class="s">&quot;d28&quot;</span><span class="p">,</span> <span class="s">&quot;d29&quot;</span><span class="p">,</span> <span class="s">&quot;d30&quot;</span><span class="p">,</span> <span class="s">&quot;d31&quot;</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Handle leftovers</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">g</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">uint8_t</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">uint16_t</span> <span class="n">y_tmp</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">29</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16_t</span> <span class="n">u_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">84</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">127</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int16_t</span> <span class="n">v_tmp</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">106</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">y_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">u_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">v_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">y_tmp</span><span class="p">;</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">u_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>        <span class="n">yuv</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">v_tmp</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>GCC内联汇编</h2>

<p>这里我用到了GCC内联汇编，其基本结构如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">asm</span> <span class="p">[</span><span class="k">volatile</span><span class="p">]</span> <span class="p">(</span> <span class="nl">AssemblerTemplate</span>
</span><span class='line'>                 <span class="p">:</span> <span class="n">OutputOperands</span>
</span><span class='line'>                 <span class="p">[</span> <span class="o">:</span> <span class="n">InputOperands</span>
</span><span class='line'>                 <span class="p">[</span> <span class="o">:</span> <span class="n">Clobbers</span> <span class="p">]</span> <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中，关键字<code>volatile</code>表示禁止编译器对这段汇编代码进行优化以避免编译器优化——你想啊，要是信任编译器优化效果的话，我们也不必手撸汇编了，不是么XD <code>AssemblerTemplate</code>自然是汇编代码部分了。<code>OutputOperands</code>和<code>InputOperands</code>是指定输出和输入的操作数，前面的代码在<code>OutputOperands</code>一栏中指定了输出和输入（指针<code>yuv</code>可读写，存放于<code>r0</code>寄存器；指针<code>bgr</code>可读写，存放于<code>r1</code>寄存器；变量<code>count</code>可读写，存放于<code>r3</code>寄存器）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="o">:</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">yuv</span><span class="p">),</span> <span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">bgr</span><span class="p">),</span> <span class="p">[</span><span class="n">r3</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span class='line'>        <span class="o">:</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Clobbers</code>一栏用来告诉编译器这段内联汇编代码会改变的操作数。如果操作数是在寄存器，编译器会做保护，在执行内联汇编代码前save它的值，在执行内联汇编代码后restore；如果操作数是在内存、编译器在执行内联汇编代码前曾把内存的值cache在寄存器的话，编译器会把寄存器的值flush回内存，再执行内联汇编代码，下次直接从内存读取，从而保证操作数数值的正确性。在上一段代码中，我们会修改的操作数是循环中的自增变量<code>i</code>所在的寄存器<code>r2</code>、内存和32个D寄存器（这32个D寄存器我才懒得一个个敲呢，当然是录了个vim宏啦XD）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="o">:</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;d0&quot;</span><span class="p">,</span> <span class="s">&quot;d1&quot;</span><span class="p">,</span> <span class="s">&quot;d2&quot;</span><span class="p">,</span> <span class="s">&quot;d3&quot;</span><span class="p">,</span> <span class="s">&quot;d4&quot;</span><span class="p">,</span> <span class="s">&quot;d5&quot;</span><span class="p">,</span> <span class="s">&quot;d6&quot;</span><span class="p">,</span> <span class="s">&quot;d7&quot;</span><span class="p">,</span> <span class="s">&quot;d8&quot;</span><span class="p">,</span> <span class="s">&quot;d9&quot;</span><span class="p">,</span> <span class="s">&quot;d10&quot;</span><span class="p">,</span> <span class="s">&quot;d11&quot;</span><span class="p">,</span> <span class="s">&quot;d12&quot;</span><span class="p">,</span> <span class="s">&quot;d13&quot;</span><span class="p">,</span> <span class="s">&quot;d14&quot;</span><span class="p">,</span> <span class="s">&quot;d15&quot;</span><span class="p">,</span> <span class="s">&quot;d16&quot;</span><span class="p">,</span> <span class="s">&quot;d17&quot;</span><span class="p">,</span> <span class="s">&quot;d18&quot;</span><span class="p">,</span> <span class="s">&quot;d19&quot;</span><span class="p">,</span> <span class="s">&quot;d20&quot;</span><span class="p">,</span> <span class="s">&quot;d21&quot;</span><span class="p">,</span> <span class="s">&quot;d22&quot;</span><span class="p">,</span> <span class="s">&quot;d23&quot;</span><span class="p">,</span> <span class="s">&quot;d24&quot;</span><span class="p">,</span> <span class="s">&quot;d25&quot;</span><span class="p">,</span> <span class="s">&quot;d26&quot;</span><span class="p">,</span> <span class="s">&quot;d27&quot;</span><span class="p">,</span> <span class="s">&quot;d28&quot;</span><span class="p">,</span> <span class="s">&quot;d29&quot;</span><span class="p">,</span> <span class="s">&quot;d30&quot;</span><span class="p">,</span> <span class="s">&quot;d31&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>更多关于GCC内联汇编的内容可参考：</p>

<ul>
<li><p><a href="http://www.ethernut.de/en/documents/arm-inline-asm.html">ARM GCC Inline Assembler Cookbook</a></p></li>
<li><p><a href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html">How to Use Inline Assembly Language in C Code</a></p></li>
</ul>


<h2>从intrinsics到汇编</h2>

<p>把intrinsics代码改成汇编的一个关键之处，是如何把C/C++里的变量名高效对应到寄存器。我在用<code>gcc</code>生成汇编代码时就发现，编译器对我这段intrinsics代码使用的实际Q-register超过16个，所以需要不断save/restore寄存器的值来重复使用寄存器。其实我们可以通过巧妙的排布寄存器来减少不必要的save/restore，这也是我写NEON汇编最开始想优化的一个点。在上面的BGR888ToYUV444程序中，我用Q0、Q1、Q2分别保存R、G、B的三个<code>uint8x16_t</code>向量，用Q3保存值为128的<code>int16x8_t</code>向量常量，用Q4保存值为128的<code>int8x16_t</code>向量常量。首先计算Y通道，把中间计算结果的两个<code>uint16x8_t</code>向量分别存到Q11和Q12。这个时候要计算U和V通道了，需要把数值从<code>uint8_t</code>类型转成<code>int16_t</code>，所以我把R通道的D0拷到Q5、D1拷到Q6（还记得Q0寄存器就是由D0和D1组成的吧？），把G通道的D2拷到Q7、D3拷到Q8，把R通道的D4拷到Q9、D5拷到Q10，之后便不再需要用Q0、Q1、Q2来保存R、G、B了。我们再把U通道中间计算结果的两个<code>int16x8_t</code>向量分别存到Q13和Q14，把V通道中间计算结果的两个<code>int16x8_t</code>向量分别存到Q15和Q0（还记得Q0可以被覆写吗？），这样就完美把16个Q寄存器/32个D寄存器都用了个遍，不需要额外save/restore。</p>

<h2>如何debug汇编代码</h2>

<p>写程序总是绕不开debug问题？那么如何debug NEON汇编呢？可以在汇编代码中使用<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0801c/pge1427897654274.html">断点指令BRK</a>，这样在<code>gdb</code>中就能在断点处停下来，执行相关debug操作了。要让程序继续运行只需增加PC跳过<code>BRK</code>即可。</p>

<p>另外，有一个图形化的<a href="https://szeged.github.io/nevada/">网页调试器</a>值得安利一下，这对于新手来说是很用户友好很实用的工具。</p>

<h2>继续优化</h2>

<p>个人认为，在写intrinsics程序的阶段就要力求用尽可能少的intrinsics来实现功能，这样能保证生成的汇编指令尽可能精简。在指令足够精简之后，一项最重要的工作就是instruction reordering/scheduling，减少诸如RAW、WAW等memory dependency引起的stall。</p>

<p>这个时候你需要对每条指令重要阶段的时钟周期了然于心。如何查到相关资料呢？你可以到<a href="http://infocenter.arm.com/help/index.jsp">ARM 信息中心</a>，查你所用的ARM处理器的Technical Reference Manual，其中就有一章Instruction Cycle Timing。另外，WebShaker为Cortex A8做了一个网页版<a href="http://pulsar.webshaker.net/ccc/index.php?lng=us">Cycle Counter for Cortex A8</a>，如果你在使用这一处理器，这是一个很值得使用和参考的工具。</p>

<p>最后，对于实际处理器的NEON汇编调优，考虑到ARM指令和NEON指令走的是不同流水线、dual issue（详见Guide第五章）等等因素，如何达到最优scheduling仍是很有挑战性的问题。个人觉得，像我这种小白，还是需要有intruction-level profiler来定位性能热点进行优化，可惜目前为止尚未找到趁手的工具。另外，以前我在玩CUDA时，有不少不错的tutorial（CUDA玩家想必都会看过的要算Mark Harris的parallel reduction了）给出了step-by-step的优化思路、指标和方法，对新手快速上手CUDA、并迅速应用到新问题上很有帮助。但ARM在这方面确实很欠缺，即使是Guide里的三章Examples，也多半是告诉了最终答案而没有思路和方法。如果有ARM大神知道如何做step-by-step性能分析和优化，还望多多赐教。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[盘点2016年度的现场音乐会]]></title>
    <link href="http://yszheda.github.io/blog/blog/2017/01/01/those-concerts-in-2016/"/>
    <updated>2017-01-01T00:55:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2017/01/01/those-concerts-in-2016</id>
    <content type="html"><![CDATA[<p>很快一年又过去了，又到了总结年度十大的时候，不过今年我不凑十大了，打算分几个主题把一些印象较深的音乐会盘点一下。</p>

<h1>古乐</h1>

<p>之所以先说古乐，是因为16年我从一个古乐小白成为了一个对古乐感兴趣的——小白XD。
恰好这年来魔都的古乐界大咖和名团不少，有Eggar和Academy of Ancient Music、Koopman和Amsterdam Baroque Orchestra、Savall和Hesperion XXI、William Christie和Les Arts Florissants、Herreweghe、Tafelmusik Baroque Orchestra、The English Concert等，让我大饱耳福。其中Hogwood的团AAM和“蛋叔”Eggar那场和郑明勋的独奏会撞车了，我没去听；Herreweghe那场因为觉得曲目不太给力，Royal Flemish Philharmonic我又不了解，所以最后去听了Bicket指挥Pinock的团TEC——其实我还挺想去听赫老的音乐会的&hellip;哎，要是有朝一日能现场听赫老指挥圣乐或歌剧就好了&hellip;（对了，17年他还会回来魔都演贝四贝五&hellip;还有传言说他以后还会回来演当年因天朝某些你懂的原因而没演成的B小调）</p>

<p>先说说“胡子”Koopman大师和他的亲兵ABO，我去听的是他们在魔都两场音乐会中的第二场。由于合唱团没来，BWV42康塔塔就只演了序曲——略可惜，“胡子”和ABO录的巴赫康塔塔可是很赞的——此外还有巴赫勃兰登堡协奏曲第三、海顿“告别”和莫扎特K550。后两首恰好我以前参与过弦乐社的排演，再次听到分外亲切。有趣的是，我发现这次ABO自然圆号的表现竟然要比木管组稳定XD。另外，个人感觉“胡子”对音乐的处理没那么“骚气十足”了——一些人可能不喜欢他的风格，例如嫌他加了太多装饰音，但还是很合本小白口味的。大师虽已71岁高龄了，精力依然十分充沛：在排练了一下午后，他在六点还安排了一次面向公众的讲座，一直进行到了七点，距离音乐会开始只有半个小时，几乎没有休息；在音乐会结束后还为乐迷们签名。</p>

<p>巧的是，在Koopman大师走后不久，他的“好基友”Savall也带着自己的晚星21世纪古乐团（Hesperion XXI）来魔都了。不过Savall带来的“Ibn Battuta的东方游记”世界首演其实是世界音乐大串烧，而非通常意义上的古乐音乐会。尽管曲目编排<a href="https://www.douban.com/note/589635029/">失之严谨</a>，加的几首琵琶和古筝曲打乱了时间编年史的顺序，显得不伦不类，但演奏本身还是挺出色的。自从上回在台北听印度音乐以来，我已经很久没在现场听过这种类型的音乐了，这次也算过了一把瘾吧。</p>

<p>如果非要在16年听的古乐音乐会中评出一场最佳的话，那么我心目中的 Top.1 非“厕公”William Christie与“繁盛艺术”（Les Arts Florissants）的第七版“声之花园”莫属了。在这场音乐会之前，我就特别期待，还做了一些<a href="http://galoisplusplus.coding.me/blog/2016/10/10/Le-Jardin-des-Voix/">功课</a>，而他们的演出甚至还<a href="http://galoisplusplus.coding.me/blog/2016/10/16/Le-Jardin-des-Voix/">超出了我的期待</a>：不仅演奏、演唱本身非常出色，而且曲目、道具、舞台表演均经过精心编排与设计。</p>

<p>16年还有一些形式也很新颖的古乐音乐会，其中就包括了Tafelmusik Baroque Orchestra的“巴赫与莱比锡的故事”。TBO是我很喜爱的一支古乐团，15年Sony清算了她们在Vivarte、DHM等自家厂牌的录音，我就剁了一套，这套也是我16年喜欢听的包子之一。这次演出还是由她们的“灵魂人物”、前音乐总监Lamon带团来——我之前还以为会由客座首席指挥Weil来带呢——自然要去听啦XD。TBO的这场音乐会采用了演奏+旁白+多媒体放映的方式，请了广播主播张明先生担任主持人，由乐团bass手Alison Mackay女士撰写故事。Mackay女士的剧本很有意思：一开始竟然是从阿波罗和墨丘利的历史传说开始，中间还穿插着相关古乐器（如羊肠弦、羽管键琴等等）制作和巴赫乐谱用纸的故事，最后又回到了阿波罗和墨丘利。</p>

<p>和“声之花园”相似、采取歌曲串烧形式的，还有英国协奏团TEC的“Shakespears In Love”主题音乐会。尽管除了之前公布的Purcell仙后和Handel凯撒的选段以外，还多了Arne、Weldon、Johnson、Locke等人的作品，带来了一些惊喜，但TEC的这场演出却总体给人感觉平平。最后的加演也是醉，假声男高音Tim Mead和女高音Mary Bevan唱的是“茉莉花”，乐团演奏的却是Pachelbel卡农&hellip;我回去后听说隔壁Herreweghe的音乐会爆演了，真有点后悔没去听&hellip;</p>

<p>16年是莎翁年，与TEC一样采取莎翁主题的还有上海音乐厅Mini Festival的驻节乐团布里顿小交（Britten Sinfonia）。不过，布里顿小交的曲目除了Purcell的作品以外，都不是古乐——好吧，我承认在这一主题里加入布里顿小交有点乱入，不过他们的CEO David Butcher可是说他们是用HIP理念来演奏的——而是腐国近代作曲家Walton、Vaughan Williams、Tippet等人的作品，其中的亮点是最后那首Britten的“光亮”，这可能也是这部作品在国内的首演吧。相比之下，讲座要比音乐会更为精彩：主办方请来了Britten-Pears Foundation（就是以布里顿和他的好基友命名的基金会）的学术总监（Director of Learning）Lucy Walker女士和剑桥大学三一学院英国文学研究总监Adrian Poole教授，不仅讲了莎士比亚、兰波和布里顿，还从音乐和文学角度把这段腐国历史串起来。作为腐国音乐粉，这场讲座让我受益匪浅，也让我想到了一个问题：在腐国这么一个热爱文学的国度，是否有腐国作曲家创立或发展从文学衍生的音乐体裁呢？就像舒伯特之于lieder、舒曼之于钢琴套曲、李斯特之于交响诗？可我能想到的在腐国发扬光大的音乐体裁——如consort music——与文学并没有紧密的关联。虽然有不少腐国作曲家也写过艺术歌曲、也创作取材自莎翁作品的音乐，但不少欧陆作曲家也是如此啊，并不是前者的独特之处。于是，当时我便向Walker女士和Poole教授请教了这个问题，可是他们回答的却是：Purcell之后英国音乐一度没有令世界瞩目的发展，被黑成“音乐荒漠”——这并不能让我满意。我想，应该还是有这样的音乐体裁的，只是我听得少不知道罢了。于是过后我就在<del>美帝知乎</del>Quora上提了这个问题：<a href="https://www.quora.com/Have-British-composers-developed-some-unique-music-forms-related-to-literature">Have British composers developed some unique music forms related to literature?</a>，有位答主回答得挺好的，他举了两种体裁：清唱剧（oratorio）和从lute song发展而来的英国艺术歌曲（English art song）。如果有大神看到这个问题，还请不吝赐教~</p>

<p>布里顿小交并不是完全采用古乐器演奏的乐团，16年平安夜来沪的Helsinki Baroque Orchestra也是如此。其实我之前并不了解HBO这支乐团，他们那晚的表现实在惊艳，让我印象很深。
整晚最精彩的要算“红发神父”的曲目了：Dmitry Sinkovsky巴洛克小提琴演奏得好，唱假声男高音一样出色；
乐团演奏红发的四季之冬时，大胆采用了现代弦乐演奏技巧（跳弓、震音等）和特殊音效，足以气死谱面原教旨主义者，十分有趣。
此外，在演奏Nickola的Polskas时，乐手们还戴上小红帽，带领观众打节拍，把双人组的民间舞演得活泼生动，算是一大彩蛋了。
既然乐团演奏得出色，观众的反响便同样热烈了：Sinkovsky率领HBO数次谢幕后，加演了帕赫贝尔的卡农；就在他们进入后台、我以为音乐会结束之际，他们又在观众掌声中回到台上，安可了曲目单上最后一首的RV208；然而，又是一波谢幕之后，观众的热情似乎没有减退的痕迹&hellip;最后，直到乐团首席祝大家圣诞快乐，乐手们向观众挥手告别，这场演出才画上句号。</p>

<p>最后还漏掉了穆洛娃和Accademia Bizantina&hellip;回想起来，“蛋筒哥”Dantone没来、AB没有harpsichord失色不少、之后穆洛娃在推特上以莫须有之事黑了一番魔都观众、国内媒体还炒作了一番（你们媒体不要“见着风，是得雨”啊，在宣传上将来如果你们报道上有偏差，你们要负责XD），都令人失望。</p>

<h1>巴赫小无、大无</h1>

<p>作为巴赫小无和大无粉，自然不想错过这两套曲目的演出。</p>

<p>16年听的第一场是“傻汉”Shaham和影像艺术家David Michalek合作的多媒体放映节目“巴赫音画”。老实说，之前曾经现场听过“傻汉”加演小无中的舞曲，印象并不太好，这次可能也受到先入为主的印象的影响，依然无法喜爱他的演奏。
当然，“傻汉”的技术是十分过硬的，在他那样的速度下竟然能将每个声部拉得清清楚楚，不能不令人钦佩。但是，“傻汉”总体拉得太猴急了，简直像在拉帕随。处理上也较为随意，对小无中旋律优美的几首曲子（如1001的Siciliana、1003的Andante、1004的Sarabande、1005的Largo），我个人尤其无法接受。我邻座的观众听完后如此说道：“听得出很厉害，但不能打动我”，这句评价也恰好点出了我的感受。
同时，Michalek的影像我也无力欣赏，虽然都是具象画面，如舞蹈、鲜花等，但是我却难以发现这些画面和音乐之间有什么关联。尤其画面动画和“傻汉”演奏的拍点并不一致，更让我一头雾水。</p>

<p>16年来演奏全本巴赫小无的小提琴家除了“傻汉”，还有郑京和，两人一样都是只在一天晚上拉完，这对独奏家都是一个相当有难度的挑战。老实说，郑阿姨一开始的1001和1002并不理想：Fuga明显比较吃力，Presto拉得太快，以致音准、运弓都出了一些问题。这不禁让我为她暗暗担心，回想起上次在这里演奏巴赫大无的Gutman，怀疑上交小厅是不是“风水不利”，让演奏家无法在此顺利演奏巴赫大小无。好在接下来郑阿姨的状态好多了，打消了我的疑虑。郑阿姨的演奏比她在华纳的新录音要自由，并不完全遵照谱面（例如部分反复的段落被省略了）。虽然我之前已经在魔都听过一次郑阿姨演奏的Ciaccona，也听过她在迪卡、华纳的小无录音，但这次郑阿姨依然带来了一些新的诠释，这也让我佩服不已。在演奏最后一组奏鸣曲和组曲时，发生了一点意外：郑阿姨在演奏完1005的Fuga后，不得不停下来咳嗽了一会，当时底下有观众提议休息一会，她却回答道：“Have a rest? No!”便在停下来的地方卖了个萌，又继续演奏下去了。尽管身体不适的郑阿姨可能累了，1006的水准略有下滑，但我仍为这晚的音乐所感染、被阿姨的毅力所折服。最后粉丝冲上台熊抱阿姨和阿姨比了一个“心”向观众们致谢，成为了这场令人难忘的音乐会暖心的一幕。</p>

<p>16年听的巴赫大无其实并不是音乐会，而是斯卡拉歌剧院芭蕾舞团采用这套曲目中的1002、1003和1006编排的现代芭蕾。担任独奏的是斯卡拉管弦的大提首席Sandro Laffranchini，他的演奏除了1003、1006一些和弦有些失误，完成度还可以，但也许是因为是伴奏的缘故，演奏得中规中矩。虽然我还是看不出来舞蹈和音乐之间的联系，但与之前Michalek的“巴赫音画”不同，舞步是合拍的，音乐上的反复也对应着舞者相似的动作，这使第一次看芭蕾的我也能静下心来感受其中的美。</p>

<h1>柴交</h1>

<p>16年恰好把三部大俗柴交都听全了：先是年初Muti和CSO的柴四，然后是6月份Temirkanov和圣彼得堡爱乐的柴六，之后一直期待能听场柴五，结果年末柴交（此“柴交”指Fedoseyev大师那支团）来华演全套柴交，我便去听了柴五和柴二那一场。这三场演出其实都挺出色，但个人印象最深的还是特米大师那一场——可能是第一次现场听特米大师带来的震撼吧，我甚至觉得这可以归入个人的有生之年系列了。</p>

<h1>老毛子团</h1>

<p>16年来沪的老毛子乐团不少，除了圣彼得堡爱乐和柴交，我还去听了我所喜爱的小提琴家Spivakov所带的俄罗斯国家爱乐（NPR）。Spivakov演奏小提琴小品时就非常有表现力，如今他也把这种表现力用到了乐队指挥上，rubato拿捏得得心应手。下半场从拉赫的交响舞曲Op. 45到加演的老柴、哈恰图良、《北京喜讯到边寨》，掀起了一波又一波高潮，让人十分过瘾。</p>

<p>16年还有“姐夫”带马林斯基、Pletnev和俄罗斯国家交响乐团（RNO），可惜因为一些原因我并没去听，据说也是非常棒的演出。</p>

<h1>国内/本地演奏家/乐团</h1>

<p>可能有些乐迷比较迷信国外的名演奏家和名团，却对国内的演奏家和乐团嗤之以鼻，其实大可不必。
记得以前弦乐社的指导老师叶老师有句话说得挺好的——有些团虽然没有名气，但如果他们特别用心和投入，演起来并不比某些名团差——我深以为然，这个道理也适用于国内团和国外团。上交（SSO）的国际声誉是不及LSO等名团的，但从我听的十来场音乐会来看，上交的水准并不逊于某支14年来亚洲巡演的腐国老牌乐团——想当年我为了买该团一张低价票，花掉了3600NT，结果就听了一场车祸，完全不如攒下来听上交呢——更不用说某些组团来我朝忽悠骗钱的国外野鸡团了。如果遇上马里纳爵爷、Inbal、“伏地魔”Eschenbach等老司机，上交的表现更令人刮目相看。新的一年也祝愿上交越来越出色！</p>

<p>王健大师是我很崇敬的一位大提琴家。16年他和陈萨姐合作“奏鸣俄罗斯”主题音乐会，我也终于第一次在现场聆听到了王大师的演奏。大师每次在演奏前都特意跟观众分享了他对曲目的认识和见解，我非常有收获。回想那个风雨交加的夜晚，我印象最深的曲子，不是老肖，不是拉赫，反而是我最不熟悉的Schnittke大奏。感谢王健大师和萨姐，让我认识了这部现代作品，与之产生共鸣。</p>

<p>16年还去听了上海古乐团（Shanghai Camerata）的创团演出——一场围绕1690年代的室内乐音乐会（其中有我很喜爱的维奥琴界“天使与魔鬼”Marais和Forqueray的作品）。对于古乐乐迷来说，有一支本地的古乐乐团无疑是幸事，新的一年也很期待听到这支新兴的古乐团的更多演出。</p>

<h1>室内乐</h1>

<p>管乐我向来听得少，然而对之前钟神发的安利——高卢风(Les Vents Français)五重奏组的唱片——还是很喜欢的。16年ODP组来沪演出的曲目恰好和那张碟的曲目有部分重合，其中还有我最喜欢的Taffanel的木管五重奏，我自然不想错过他们的演出了。说起来Taffanel的这首木管五重奏算是比较传统的作品，我在网上也听过些杂七杂八的版本，总觉得他们演得太木，不如高卢风组的exciting。这次的ODP组与之相比也处下风，高卢风组对dynamic变化的把握和rubato的运用更胜一筹，乐句塑造更有吸引力。
不过，我第一回听了Malcolm Arnold的爵式风“劳动号子”等作品，挺涨姿势的。此外还发现了一些之前被本木耳草草“听”过的作品，例如从Ligeti的Musica ricercata改编的六首Bagatelle（No. 3, 5, 7, 8, 9, 10），各个乐器间的旋律应答和转换十分美妙，听得我如痴如醉。</p>

<p>之前听过几张Fibonacci Sequence的唱片，对演奏的印象还不错，而且他们主要是挖掘冷门室内乐曲目，很有意思。16年他们由小提琴首席Daniel Pioro、乐团创始人小号演奏家Paul Archibald以及乐团艺术总监钢琴家Kathron Sturrock组三重奏来华巡演，尽管同一时间还有老色魔带RPO加上卡普松独奏、还有Freire弹"皇帝"，但我还是去选择去听他们的演出。事后很满意这一决定，不仅认识了Cecilia McDowall、Henri Busser等人的冷门作品，演奏也很出色（如果非要挑毛病的话，个人觉得Archibald演奏得相对拘谨，也出现了一些失误）。</p>

<p>16年终于现场听了Accardo的演奏，但这次并不是独奏会，而是他与Laura Gorna、Francesco Fiore所组的“非常三重奏”的室内乐音乐会。阿卡多果如之前乐友所说，确实老了：右手运弓、左手音准都不稳定，最可惜的是他以往的音色拉不出来了，一旦没有揉音基本就很难听。想当年上中学初听他的帕格尼尼小协时，我对他简直佩服得五体投地，如今见了这份光景，不免有些伤感。</p>

<h1>歌剧和声乐recital</h1>

<p>16年听的最佳歌剧非<a href="http://galoisplusplus.coding.me/blog/2016/09/04/Simon-Boccanegra/">郑明勋大师指挥斯卡拉歌剧院的威尔第《西蒙·波卡涅拉》</a>莫属了——其实我也只听了这场歌剧XD。</p>

<p>15年错过了Ian Bostridge在魔都的recital，16年年初Ian Bostridge再次来沪，这次一同前来的还有著名的OAE（Orchestra of the Age of Enlightenment），这场音乐会也让我成为了IB粉，希望以后能有机会现场听他唱艺术歌曲（据说IB去对岸唱“冬之旅”，好生羡慕&hellip;）。</p>

<p>年初还听了Thomas Bauer唱舒伯特《天鹅之歌》和舒曼《诗人之恋》，那次的钢伴竟然是Immerseel！希望Immerseel叔以后能来魔都演古乐！</p>

<p>年末上交的巴洛克音乐节请来了“学校”Scholl，我便去听了他和Karamazov的recital。感觉那天“学校”的状态不太好，而且雾霾也重，他在演唱的时候不得不时时清下嗓子，这在音效好的小厅听得一清二楚&hellip;不过捣烂、坎皮恩毕竟也是他拿手曲目，也不至于车祸。下半场“学校”把Brouwer作品换成了三首腐国民谣，包括了他最喜欢的The Wife of Usher&rsquo;s Well、还有暗黑风的Lord Randall，最后安可了巴赫的Jesu, Joy of Man&rsquo;s Desiring。之前对Karamazov并不了解，这次他的即兴演奏——尤其那段BWV1007——让我印象很深，看了下介绍，原来他还是切大嘴学生、曾救过Julian Bream的场，不得不在心里打出666了XD。</p>

<h1>器乐recital</h1>

<p>和往常一样，16年也听了不少小提琴家和钢琴家的recital，出色的演出也不少，但如果非要我挑一场的话，我会选择Lubimov的那场recital。那晚鲁老爷展现了古乐到当代音乐通吃的实力，从莫扎特、CPE巴赫，弹到德彪西、斯特里亚宾，再弹到当代音乐。我印象尤深的是，鲁老爷演奏Ustvolskaya第六钢奏宛如砸琴自虐般的行为艺术，随后马上接上了Arvo Pärt的Für Alina，这种反差所带来的震撼，唯有切身经历才能有有所体会。</p>

<h1>当代音乐</h1>

<p>年中的时候，被石头安利去听了<a href="http://galoisplusplus.coding.me/blog/2016/05/25/damien-rice/">“大米”Damien Rice的专场音乐会</a>，这是我第一回现场听民谣——其实我平时都很少听流行乐——发现米叔竟玩了Lucier、Schaeffer等人的路子，实在是服！（这句真心不是黑XD）</p>

<p>说到当代音乐，Arvo Pärt的tintinnabuli作品是为数不多我喜欢的当代音乐。近两年魔都有几次上演他的作品，可栖我都错过了。年底来的爱沙尼亚的两支团——爱沙尼亚爱乐合唱团和塔林室内乐团——都是ECM帕特作品录音的老面孔，我也总算是如愿听了一回现场。那天恰好是感恩节，他们最后演的是“感恩赞美诗”，我感到被延绵不绝的A和属音D所包裹，和开头的“纪念布里顿”相似。当然，那晚更大的收获还是和钟神的交流了，膜拜一发在研读勋伯格那本“音乐思想”手稿的大神XD。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[my tech talk of "the basics and design of Lua table"]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/11/13/my-lua-tech-talks/"/>
    <updated>2016-11-13T13:00:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/11/13/my-lua-tech-talks</id>
    <content type="html"><![CDATA[<p>前段时间厂里开始搞技术分享，这个月恰好CTO大大钦定了我，让我讲Docker。不过我自己一想，厂里大多数是码农，讲Docker这种偏运维的话题的话，大家可能平常用不到，也不感兴趣；恰好前段时间我在看Lua源代码，我厂技术部门要么是Lua码农，要么也是会C和C艹的，我不妨讲一讲Lua中最重要的类型之一table的基本用法及设计、实现的C代码，这样便能兼顾两种人群了。当然，Lua table能讲的话题特别多，我主要还是介绍基础为主，源代码部分我自己也做了一些简化。这里我分享下这次的slides，希望Lua老司机们多多指点：</p>

<!-- more -->




<object type="text/html" data="https://yszheda.github.io/lua-table-talk/" style="width:100%; height:600px;">
<p><a href="https://yszheda.github.io/lua-table-talk/">the basics and design of Lua table</a></p>
</object>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Le Jardin des Voix演出碎碎念]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/10/16/Le-Jardin-des-Voix/"/>
    <updated>2016-10-16T11:13:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/10/16/Le-Jardin-des-Voix</id>
    <content type="html"><![CDATA[<p>听完了今晚的音乐会，还是想再碎碎念一下这场由乐迷们耳熟能详的“厕公”——William Christie大师——和繁盛艺术古乐团（Les Arts Florissants）的第七版“Le Jardin des Voix”——“In an Italian Garden——L'Accademia d'Amore”。</p>

<p>首先还是要说说这次的曲目。<a href="http://www.arts-florissants.com/main/en_GB/calendar/in-an-italian-garden.html">繁盛艺术古乐团的官网</a>介绍说，与一般先定好曲目、由演唱者去适应这套曲目的做法相反，他们是根据声之花园（Académie du Jardin des Voix）的年轻歌唱家们每个人的声音特点，去挑选能展现他们最佳表现的曲目，这无疑已经给选曲设定了一个初始hard模式。而根据每个歌唱家特点选出来的曲目还不能是一盘散沙，最好都和某一主题相关——像这一版的主题就是“意大利”和“爱情”——这又无形中增加了难度。最后敲定了曲目，编排顺序又是一门大学问：需要平衡几位演唱者的戏份，不能厚此薄彼；也得考虑演唱中间的休息，不能让一位演唱者连续唱太久；甚至乐团的休息也得考虑，例如最好不安排管乐连续演奏太久等等。光是打通了以上这些关卡，便已相当不易，更何况这次曲目还编排成一系列有内在关联又富有含义的歌曲串烧。
这里聊一点我个人粗略想到的：
第一首安排了Adriano Banchieri的"Già che ridotti siamo"，正好引入了男中音、女高音、女低音（其实是次女高音）、男高音、假声男高音和男低音六位歌唱家，就像一部戏剧前面一般有角色说明一样，这六位歌唱家开始扮演不同角色，而角色扮演与演唱的游戏又正好与Orazio Vecchi的"L'humore musicale"相呼应。（此外，Banchieri创办过“繁盛学院Accademia dei Floridi”，一开始选他的曲子可能也是有呼应乐团名字“繁盛艺术”的双关。当然，乐团其实是以夏庞蒂埃的同名歌剧命名的，所以这也许只是我过度联想了XD）
接下来，在Alessandro Stradella的Amanti olà olà的几首选曲中，又把话题引到了Orlando的传说，下面的选段出自Handel、de Wert和Vivaldi根据这一传说的不同文本编写的歌剧，也就毫不突兀了。后面几首从文本上看关联性弱一些，不过通过几位演唱者的表演，变成了因爱情而盲目嫉妒和对这些由爱生恨者的劝导。最后再回到Amore olà olà的其他选段，对前面的爱情主题做了一番颇具哲理的总结，同时又在上半场结束时回到了从最开始六位歌唱家的合唱。这样的设计真是颇具匠心！
而下半场“剧中剧”的创意更是我前所未见，相信看过的观众都心服口服，这里也就不罗嗦了。
这么高水准的编曲的确让人对Sophie Daneman和Paul Agnew的<del>脑洞</del>原创性钦佩不已（这次谢幕时，Daneman女士也来到了舞台上）！</p>

<p>在舞台表演方面，这场演出也是颇具亮点。首先是六位歌唱家都很入戏，甚至在下半场开场前，Renato Dolcini就已经在台上开始表演Cimarosa的L'impresario in angustie中倒霉的剧院经理。其次是歌唱家和指挥“厕公”、乐团之间的互动。“厕公”在上半场歌唱家们演唱无伴奏唱段时，还走到他们中间，打了一会酱油；下半场和Dolcini扮演的剧院经理之间的卖萌也给喜歌剧唱段增色不少。这样的互动让人觉得，乐团、指挥和歌唱家都是戏剧演出的一部分，他们的表演和演奏浑然一体。相比现代人所习惯的把乐团放到乐池、给舞台表演让位的瓦格纳“陋习”（乱黑一下瓦格纳XD），这样的表演也许更接近于戏剧原本的演出方式。最后，这次的道具设计也体现了制作人在细节上的深思熟虑。其中最引人注目的也许要算贯穿上下半场的那只箭了。它最早出现应该是在Amanti olà olà的宣叙调"Hor non fia chi paventi"，这正是丘比特的唱段。丘比特这位爱神对乱射箭什么的最喜欢了，被他射中的人常会备受爱情的煎熬，这也和上半场一系列爱情悲剧息息相关。箭是丘比特的化身，也是爱的象征，下半场在“剧中剧”提到“爱”时，箭这一道具又重新出现，从而呼应了主题之一的L'Accademia d'Amore。至于另一个主题Italian Garden，也有一处呼应的道具，那就是在演唱海顿的《歌女》时，饰演Apollonia的Lea Desandre所织的那匹意大利国旗三色布。
这里不得不再次为Sophie Daneman和Paul Agnew的创意拍案叫绝！</p>

<p>在音乐方面，繁盛艺术团和“厕公”的一流水准自然无需赘述。至于六位青年歌唱家，虽然某些大俗曲（如亨德尔的《Ah! Stigie larve, ah! Scelerati spettri!》《离开荆棘、采摘玫瑰》、莫扎特的《手上一吻》）离著名歌唱家的水准还有一些距离，但今晚的演唱还是很让我满意的。考虑到他们这次亚洲巡演的紧密行程安排（刚在韩国演完后，今早才抵达魔都，晚上演出完后又马上飞赴澳门），按照某些人为某位之前在韩国演出车祸引的“钢琴家”甩锅的讲法，确实是“舟车劳顿”，能有这么高的水准实属不易。</p>

<p>这次还想给上海音乐厅按个赞。像“声之花园”这种外语声乐吃重的节目，节目单的介绍和字幕对于大部分观众的欣赏还是很重要的。但在我印象中，音乐厅之前这方面做得并不好，例如去年听的先知五重唱的音乐会，节目单没有歌词，字幕则基本是在演唱开始时闪一下整首曲目的中文歌词，没多久后就消失，太不人性化了。这次音乐厅都做得很到位，让来的沪上乐迷受惠不少。</p>

<p>最后想扯扯对本真演奏（HIP）和古乐的一点拙见。印象中“厕公”曾经说过，希望他的演奏能给观众的生活带来改变，而这次“厕公”的这场演出着实改变了我对HIP的看法。也许是受到某些对HIP妖魔化宣传的影响，我认为HIPer是一群不切实际地幻想还原作曲家原意、给音乐演奏设定种种“符合原意”的条条框框的无趣的老学究。但看看今晚“厕公”的这场音乐会，我们难道能说他是照着每一位作曲家的原意来演奏他们的作品吗？例如亨德尔《时间与真理的胜利》的那个唱段《离开荆棘、采摘玫瑰》，在原剧中是“快乐”试图引诱“美丽”离开“时间”和“真理”的教导，而这场音乐会则完全剥离了这一层语境，只是化用了歌词的表面意思。我想，真正的HIPer或许就应该是像”厕公“这样，以古乐的研究来拓展表演方式，而不是像本真卫道士一样束缚创造力。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Le Jardin des Voix演前碎碎念及曲目歌词]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/10/10/Le-Jardin-des-Voix/"/>
    <updated>2016-10-10T02:13:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/10/10/Le-Jardin-des-Voix</id>
    <content type="html"><![CDATA[<!-- more -->


<p>本周，William Christie大师将带领他创立的繁盛艺术古乐团（Les Arts Florissants）上演第七版“Le Jardin des Voix”（声之花园）。
这一版“Le Jardin des Voix”的主题是“In an Italian Garden——L'Accademia d'Amore”，即是“意大利式花园——爱之甘醇”（国内将它翻作“意大利花园”，其实Italian与其翻译成“意呆梨的”，不如翻译成“呆梨语的”“呆梨风的”“呆梨式的”，因为这次曲目除了意大利作曲家的作品，还有其他地区作曲家的意大利语唱段）。
这些曲目大部分都较少上演，有的是Adriano Benedetti、Orazio Vecchi等小众作曲家的作品，有的虽然出自Haydn、Mozart等名家之手，但也属于他们的冷门作品。
此外，Sophie Daneman和Paul Agnew对这些曲目进行了精心编排：上半场将从意大利歌剧起源的牧歌开始，再到巴洛克时期维瓦尔第、亨德尔的作品，从中反映这些作品在描写人的爱横情仇方面的发展；下半场甚至用一系列意大利语歌剧选段构成一部“剧中剧”。
感觉上可能上半场偏重历史回顾和风格演变，学术味浓一点；下半场则表演性强一些。
饶是我这种非古乐乐迷，也被这种与众不同的古乐节目所吸引。</p>

<p>有了浓厚的兴趣，我便愈想了解这么多陌生作品。我在网上找到一份<a href="http://lcgreatperformers.org/assets/img/downloads/04-23%20Les%20Arts.pdf">Alice Tully Hall上演同一套节目的节目册</a>，撰稿人写得挺好，我也涨了不少姿势。但美中不足的是，这份节目册没有曲目的歌词。而不了解歌词，欣赏这套节目总是会打折扣的，所以我又花了一点时间搜寻歌词。好在网上还是能找到大部分歌词英文翻译的，这里就来做一点微不足道的搬运工作，如果没有翻译就只能谷歌翻译意大利语原文了。</p>

<h1>上半场</h1>

<ul>
<li>1.&ldquo;Già che ridotti siamo"选自<a href="https://en.wikipedia.org/wiki/Adriano_Banchieri">Adriano Banchieri</a>的作品
Il Zabaione musicale, inventione boscareccia et primo libro de madrigali a cinque voci (1604)</li>
</ul>


<p>我找的歌词来源于<a href="http://mcgautreau.com/notes/early/opera/banchieri.php">这个网站</a>：</p>

<p>原文：</p>

<blockquote><p>Già che ridotti siamo</p>

<p>tutti allegri cantiamo.</p>

<p>— Chi fa il soprano?</p>

<p>— Io che lo tengo in mano.</p>

<p>— Questo contralto?</p>

<p>— Ecco de fuori salto.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Now that we are all together,</p>

<p>Let’s all sing merrily.</p>

<p>&ndash; “Who shall be the soprano?”</p>

<p>&ndash; “I have it in hand.”</p>

<p>&ndash; “The contralto?”</p>

<p>&ndash; “I’ll jump in.”</p></blockquote>

<p>2.&ldquo;Sinfonia (lento)"选自<a href="https://en.wikipedia.org/wiki/Alessandro_Stradella">Alessandro Stradella</a>的
Amanti olà olà (1665)</p>

<p>这是序曲啦～</p>

<p>3.&ldquo;L'humore musicale"选自<a href="https://en.wikipedia.org/wiki/Orazio_Vecchi">Orazio Vecchi</a>的
Le Veglie di Siena, overo i varii humori della musica moderna (1604)</p>

<p>我找的歌词来源于<a href="https://atmaclassique.com/pdf/Livret/9b300048-5ba1-450f-b658-6736216f8013_2504_livret_F.pdf">这个网站</a>：</p>

<p>原文：</p>

<blockquote><p>Fate silentio</p>

<p>Ch’io vuo’ proporv’un gioco.</p>

<p>Ecco:a punto n’invita</p>

<p>Il crepitante foco.</p>

<p>E vegghia non fu mai la più compita.</p>

<p>Hor che son qui adunati</p>

<p>Musici i più pregiati,</p>

<p>Fia ben che questa sera</p>

<p>Tutta si doni al canto,</p>

<p>Quando però fien di cantar contenti.</p>

<p>Ma quale stile canterem noi,</p>

<p>Che non vi paia vile?</p>

<p>Ché quanti capi siam, tanti pareri.</p>

<p>E meglio anco a la prova</p>

<p>Scoprirans’i pensieri</p>

<p>Hor sù dunque, da i vostri dispareri</p>

<p>Questo gioco trarremo:</p>

<p>Che chi di voi più desterà gli affetti,</p>

<p>Col suo lodato modo,</p>

<p>Quell’havrà premio di memoria eterna.</p>

<p>E lo potrem chiamare:</p>

<p>Gli humori della musica moderna.</p>

<p>Hor vi destate,</p>

<p>Ch’è un gioco spiritoso,</p>

<p>Non men che curioso.</p>

<p>Voi ascoltat’ intenti</p>

<p>Il vario stile de’ nostri concenti.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Be silent, because</p>

<p>I want to propose a game to you.</p>

<p>See here, indeed,</p>

<p>the crackling fire invites us to it.</p>

<p>And never has there been</p>

<p>A more gracious evening.</p>

<p>Now the finest musicians</p>

<p>Are gathered here, we shall do well to</p>

<p>dedicate this entire evening to song,</p>

<p>To sing, that is, whenever</p>

<p>it pleases you to sing.</p>

<p>But in what style shall we sing</p>

<p>Which will not seem coarse to you?</p>

<p>For there are as many opinions</p>

<p>among us as there are heads.</p>

<p>And it is even better to reveal ideas</p>

<p>through action. So come now, from your</p>

<p>differing ideas, we shall extract this</p>

<p>game: That whoever among you best</p>

<p>succeeds in awakening the emotions</p>

<p>with his lauded style, He shall have the</p>

<p>prize of eternal fame. And we could call</p>

<p>it “The humours of Modern Music”.</p>

<p>Wake up now, for it is a game no less</p>

<p>Spirited than it is curious.</p>

<p>Listen carefully to the various styles</p>

<p>Of our harmonies.</p></blockquote>

<p>4.&ldquo;Sinfonia [Allegro]"，还是选自Amanti olà olà。</p>

<p>5.Coro &ldquo;Amanti, olà, olà"，以下几首歌曲也是选自Amanti olà olà。
我引用的歌词出自<a href="https://www.chandos.net/chanimages/Booklets/CH0728.pdf">chandos的唱片(CHAN 0728)的小册子</a>。</p>

<p>原文：</p>

<blockquote><p><em>Madrigale a cinque voci</em></p>

<p>Amanti, amanti, olà,</p>

<p>nella reggia d’Amore</p>

<p>di poesie canore</p>

<p>l’accademia si fà.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Five-part madrigal</p>

<p>Lovers, lovers, ho!</p>

<p>In Love’s realm</p>

<p>poetic songs</p>

<p>are the heart of the academy.</p></blockquote>

<p>6.Recitativo &ldquo;Hor non fia chi paventi&rdquo;</p>

<p>原文：</p>

<blockquote><p>(Recit)</p>

<p><em>Amore</em></p>

<p>Or non sia chi paventi</p>

<p>del faretrato Dio l’ire severe,</p>

<p>ch’il mio dardo fatal scrive e non fere;</p>

<p>quindi in temuto trono</p>

<p>se il cor signoreggiai d’ogni amatore,</p>

<p>or di dotta accademia il prence io sono;</p>

<p>né tal dominio mio in lui</p>

<p>stupor rechi ad altrui,</p>

<p>poiché il bendato arciero</p>

<p>degl’ingegni più saggi anche ha l’impero.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p><em>Love</em></p>

<p>Let no one fear</p>

<p>the rages of the bequivered God,</p>

<p>for my fateful dart writes and wounds not;</p>

<p>thus though my rule struck fear</p>

<p>into the heart of every lover,</p>

<p>now of a learned academy I am the prince;</p>

<p>nor should my overlordship here</p>

<p>astonish anyone,</p>

<p>for the blindfold archer’s power</p>

<p>extends even over the wisest.</p></blockquote>

<ul>
<li>7.Duett &ldquo;D’amore a l’invito&rdquo;</li>
</ul>


<p>原文：</p>

<blockquote><p>(Duet)</p>

<p><em>Bellezza, Cortesia</em></p>

<p>D’Amore all’invito</p>

<p>coll’armi de’ carmi,</p>

<p>garreggi, guerreggi</p>

<p>il labro erudito,</p>

<p>e in dotta palestra,</p>

<p>sia guerriera la lingua e non la destra.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p><em>Beauty, Courtesy</em></p>

<p>At Love’s invitation</p>

<p>with verses as weapons,</p>

<p>let learned lips</p>

<p>discourse, dispute,</p>

<p>and in this place of learning</p>

<p>let tongues, not fi sts, do battle.</p></blockquote>

<ul>
<li>8.Recitativo &ldquo;Che sia della beltà&rdquo;</li>
</ul>


<p>原文：</p>

<blockquote><p>(Recit)</p>

<p><em>Bellezza</em></p>

<p>Che sia della Beltà vanto primiero</p>

<p>render suddita ogn’alma</p>

<p>all’impero dolcissimo d’Amore</p>

<p>chi ha lumi il dica, e chi ha nel petto il core;</p>

<p>se Amore altro non è</p>

<p>ch’un desio di beltà,</p>

<p>onde l’antica età</p>

<p>il nome di Cupido a lui già dié,</p>

<p>il negare è sciocchezza</p>

<p>che l’oggetto d’amor sia la bellezza.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p><em>Beauty</em></p>

<p>Let it be Beauty’s foremost boast</p>

<p>to claim all hearts as subjects</p>

<p>in the sweetest realm of Love.</p>

<p>Those with eyes and those with hearts agree:</p>

<p>since Love is none other</p>

<p>than a desire for beauty –</p>

<p>whence in ancient times</p>

<p>men gave it the name of Cupid –</p>

<p>it is foolish to deny</p>

<p>that the object of love is beauty.</p></blockquote>

<ul>
<li>9.Aria &ldquo;La beltà d’un vago viso&rdquo;</li>
</ul>


<p>原文：</p>

<blockquote><p>(Aria)</p>

<p><em>La beltà d’un vago viso</em></p>

<p>paradiso è d’ogni cor;</p>

<p>del sovrano altisonante</p>

<p>ella è un raggio scintillante</p>

<p>e del ciel opra miglior.</p>

<p>Hanno in sen di perle ed ori</p>

<p>due tesori, il labro e ‘l crin;</p>

<p>e ne’ tremoli suoi giri</p>

<p>di piropi e di zaffi ri</p>

<p>pompa fa l’occhio divin.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>The beauty of a lovely face</p>

<p>is paradise for every heart;</p>

<p>of the sovereign on high</p>

<p>it is a shining ray of light,</p>

<p>and heaven’s greatest work.</p>

<p>In lips and tresses nestle</p>

<p>two treasures, pearls and gold;</p>

<p>and in their tremulous glances</p>

<p>garnets and sapphires</p>

<p>do eyes divine display.</p></blockquote>

<ul>
<li>10.Recitativo &ldquo;Chi va se delirante&rdquo;</li>
</ul>


<p>原文：</p>

<blockquote><p>(Recit)</p>

<p>Chi rese delirante</p>

<p>il franco Paladino, il forte Orlando?</p>

<p>D’Angelica il sembiante;</p>

<p>chi dell’eroe Tebano</p>

<p>alla canocchia ammaestrò la mano</p>

<p>nelle feminee scuole?</p>

<p>La bellezza di Jole;</p>

<p>chi di Nettuno infi do,</p>

<p>nel fl uttuante impero</p>

<p>fé già provare al giovane d’Abido</p>

<p>un naufragio funesto?</p>

<p>La fanciulla di Sesto;</p>

<p>e chi l’istesso amor d’amore accese</p>

<p>ond ’avido si rese</p>

<p>di liete nozze amiche?</p>

<p>La bellissima Psiche.</p>

<p>Conchiudo alfi n che la beltà d’un volto</p>

<p>è una dolce tirranide dell’uomo</p>

<p>che fa schiavo il voler, l’arbitrio domo.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>What was it drove to madness</p>

<p>bold Paladin, strong Orlando?</p>

<p>Angelica’s countenance;</p>

<p>What caused the Theban hero [Hercules]</p>

<p>to learn to use a distaff</p>

<p>and perform female tasks?</p>

<p>The beauty of Iole.</p>

<p>Who in treacherous Neptune’s</p>

<p>watery empire</p>

<p>caused the youth from Abido [Leander]</p>

<p>to come to grief?</p>

<p>The girl from Sesto. [Hero]</p>

<p>And who kindled love in Love</p>

<p>that made him</p>

<p>long for wedded bliss?</p>

<p>The exquisite Psyche.</p>

<p>Whence I conclude that beauty of face</p>

<p>exercises a sweet tyranny over men,</p>

<p>enslaving the will and overruling judgement.</p></blockquote>

<ul>
<li>11.Aria “Ah! stigie larve, ah! scelerati spettri!”选自Handel的<a href="https://en.wikipedia.org/wiki/Orlando_(opera">Orlando</a>)</li>
</ul>


<p>我引用的歌词出自<a href="http://www.opera-arias.com/handel/orlando/">这个网站</a>。</p>

<p>原文：</p>

<blockquote><p>Ah! Stigie larve, ah! scellerate spettri,</p>

<p>che la perfida donna ora scondete,</p>

<p>perchè al mio giusto furor non la rendete?</p>

<p>Ah! misero e schernito l'ingrata già m'ha ucciso!</p>

<p>Sono lo spirto mio da me diviso,</p>

<p>sono um ombra, e qual ombra adesso io voglio varcar là giù</p>

<p>ne' regni del cordoglio!</p>

<p>Ecco la stigia barca; di Caronte il dispetto,</p>

<p>Già solco l'onde, l'onde nere.</p>

<p>Ecco di Pluto le affumicate soglie,</p>

<p>e l'arso tetto!</p>

<p>Già latra Cerbero,</p>

<p>e già dell'Erebo ogni terrible squallida furia sen viene a me!</p>

<p>Ma la furia, che sol mi diè martoro, dov'è?</p>

<p>Questa è Medoro!</p>

<p>A Prosepina in braccio vedo che fugge, or a strapparla</p>

<p>io corro&hellip;</p>

<p>Ah! Proserpina piange?</p>

<p>Vien men il mio furore, se si piange all'inferno anco d'amore!</p>

<p>Vaghe pupille no, non piangete no,</p>

<p>che del pianto ancor nel regno può in ognun destar pietà.</p>

<p>Ma sì, piangete sì, che sordo al vostro incanto</p>

<p>nè calma il mio furor.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Ah Stygian monsters, villainous spectres,</p>

<p>That now hide that faithless woman,</p>

<p>Why do you not give her up to my wronged love and my</p>

<p>just fury?</p>

<p>Ah, miserable, and forsaken, that ingrate has killed me!</p>

<p>I am now a spirit divided from myself,</p>

<p>I am a shadow and this shadow now will sink</p>

<p>itself into the gloomy realms of woe!</p>

<p>There is the Stygian boat, in spite of Caronte,</p>

<p>I ride the waves, the black waves.</p>

<p>Here the smoking throne of Pluto,</p>

<p>And the head of the god!</p>

<p>Now Cerberus howls,</p>

<p>And hideous furies scowl at me from every corner of the dead!</p>

<p>But the fury that torments me singly, where is he?</p>

<p>That is Medoro!</p>

<p>In Proserpina’s arms he sits, I wrest him from her&hellip;</p>

<p>Ah Proserpina weeps?</p>

<p>My fury lessens, since even in Hell, love sheds tears.</p>

<p>Lovely eyes, do not weep,</p>

<p>A sight so moving will make my rage abate.</p>

<p>But yes, weep, for I am deaf to your weeping</p>

<p>and will not calm my fury.</p></blockquote>

<ul>
<li>12.<a href="https://en.wikipedia.org/wiki/Giaches_de_Wert">Giaches de Wert</a>的Queste non son più lagrime。</li>
</ul>


<p>原文：</p>

<blockquote><p>Queste non son più lagrime, che fuore</p>

<p>Stillo da gl’occhi con sì larga vena.</p>

<p>Non suppliron le lagrime al dolore:</p>

<p>Finir, ch’a mezz’era il dolor a pena.</p>

<p>Dal foco spinto hor il vital humore</p>

<p>Fugge per quella via ch’a gl’occhi</p>

<p>mena;</p>

<p>Ed è quel che si versa, e trarrà</p>

<p>insieme</p>

<p>E ’l dolor e la vita all’hore estreme.</p></blockquote>

<ul>
<li>13.Aria “Ah sleale, ah spergiura”选自Vivaldi的<a href="https://en.wikipedia.org/wiki/Orlando_furioso_(Vivaldi">Orlando furioso (RV 728)</a>)</li>
</ul>


<p>我引用的歌词出自<a href="http://www.flaminioonline.it/Guide/Vivaldi/Vivaldi-Orlando728-testo.html">这个网站</a>，只有意大利语原文。</p>

<p>原文：</p>

<blockquote><p>Ah sleale, ah spergiura,</p>

<p>Donna ingrata infedel cor traditore;</p>

<p>Del tuo malnato errore</p>

<p>Vengo a smorzar&hellip; oh ciel, che leggo?</p>

<p>(Ahi lasso!)</p>

<p>&ldquo;E vivan sempre amorosi,</p>

<p>Angelica, e Medoro amanti, e sposi".</p>

<p>Angelica, e Medoro amanti, e sposi?</p>

<p>Questa, questa è la scure,</p>

<p>Ahimé, ch'il capo tronca alla mia speme.</p>

<p>Di Medoro il mio bene?</p>

<p>Sgorgate, o lagrime</p>

<p>A fonti, a rivi.</p>

<p>No, ch'è poco, a torrenti, a fiumi, a mari.</p>

<p>Arde Orlando, che Orlando? Eh, Orlando è morto.</p>

<p>La sua donna ingratissima l'ha ucciso.</p>

<p>lo son lo spirto suo da lui diviso,</p>

<p>E son con l'ombra mia, che sol s'avanza</p>

<p>Esempio a chi in amor pone speranza.</p>

<p>(Legge sopra l'alloro)</p>

<p>&ldquo;Angelica qui fu sposa a Medoro&rdquo;.</p>

<p>Chi segnò quest'alloro!</p>

<p>Lo vergò di sua man la mia tiranna,</p>

<p>V'impresse di sua mano il mio martora.</p>

<p>Amanti e sposi? oh Dei! Sposa a Medoro!</p>

<p>Vendetta, sì vendetta incontro amore;</p>

<p>Or n'ho trovato il modo,</p>

<p>Per cacciarmel dal sen trarommi il core.</p>

<p>lo ti getto elmo, ed usbergo:</p>

<p>Ite o piastre e maglie al suolo.</p>

<p>(Legge nel mirto segnato da Medoro)</p>

<p>&ldquo;Medoro qui d'Angelica fu sposo&rdquo;!</p>

<p>A te mirto orgoglioso</p>

<p>Vò sfrondarti, schiantarti</p>

<p>Sino all'ultimo bronco,</p>

<p>Ed estirpar dalla radice il tronco.</p>

<p>Ho cento vanni al tergo</p>

<p>Ho duecent'occhi in fronte,</p>

<p>E nel furor che ho in sen</p>

<p>M'adiro almeno almen</p>

<p>Con mille cuori.</p>

<p>Sopra quei vanni io m'ergo</p>

<p>Volo dal piano al monte</p>

<p>Quelle pupille io miro:</p>

<p>Con tutti i cuor</p>

<p>Sospiro.</p>

<p>Occhi, vanni, furor, cuori, oh martoro!</p>

<p>Amanti, e sposi Angelica, e Medoro!</p></blockquote>

<ul>
<li>14.Aria &ldquo;Lascia la spina cogli la rosa"选自Handel的<a href="https://en.wikipedia.org/wiki/The_Triumph_of_Time_and_Truth">The Triumph of Time and Truth</a>中的Il Trionfo del Tempo e del Disinganno。</li>
</ul>


<p>我引用的歌词出自<a href="http://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67681/2">hyperion唱片CDA67681/2的曲目说明</a>。</p>

<p>原文：</p>

<blockquote><p>Piacere: Lascia la spina,</p>

<p>cogli la rosa;</p>

<p>tu vai cercando</p>

<p>il tuo dolor.</p>

<p>Canuta brina</p>

<p>per mano ascosa,</p>

<p>giungerà quando</p>

<p>nol crede il cor.</p>

<p>Lascia la spina, etc.</p>

<p><em>(Cardinal Benedetto Pamphili (1653-1730))</em></p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Pleasure: Avoid the thorn,</p>

<p>pluck the rose;</p>

<p>you are seeking</p>

<p>your grief.</p>

<p>Hoary frost</p>

<p>by a secret way,</p>

<p>will arrive when</p>

<p>your heart does not expect it.</p>

<p>Avoid the thorn, etc.</p>

<p><em>(English: Anthony Hicks © 2008)</em></p></blockquote>

<ul>
<li>15.Aria &ldquo;Gelosia, tu già rendi l’alma mia"选自Vivaldi的<a href="https://en.wikipedia.org/wiki/Ottone_in_villa">Ottone in villa, RV 729</a>。</li>
</ul>


<p>我引用的歌词出自<a href="http://www.hyperion-records.co.uk/dc.asp?dc=D_CDH55279">hyperion唱片CDH55279的曲目说明</a>。</p>

<p>原文：</p>

<blockquote><p>Gelosia,</p>

<p>Tu già rendi l’alma mia</p>

<p>Dell’Inferno assai peggior.</p>

<p>Ma se pria</p>

<p>La vendetta io non farò,</p>

<p>Non m’uccidere, no, no,</p>

<p>Mio crudele aspro dolor.</p>

<p><em>(Domenico Lalli (1679-1741))</em></p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Jealousy,</p>

<p>You are already making my soul</p>

<p>Much worse than hell.</p>

<p>But if beforehand</p>

<p>I do not take my revenge,</p>

<p>Do not kill me, no, no,</p>

<p>My cruel, harsh grief.</p>

<p><em>(English: Eric Cross)</em></p></blockquote>

<ul>
<li>16.Aria &ldquo;Care pupille"选自Vivaldi的La virtù trionfante dell’amore e dell’odio。</li>
</ul>


<p>我引用的歌词出自<a href="http://www.lieder.net/lieder/assemble_texts.html?SongCycleId=5479&amp;BareDisplay=1">这个网站</a>。</p>

<p>原文：</p>

<blockquote><p>Care pupille</p>

<p>Trà mille e mille</p>

<p>Degne voi siete</p>

<p>Sol di regnare.</p>

<p>Come vi piace</p>

<p>Con egual face</p>

<p>Amor e regno</p>

<p>Vedrò brillar.</p></blockquote>

<p>17.Recitativo &ldquo;Benché ascritto non sia d’amor nell’Accademia"，这和以下几首的都选自之前提到的Amanti olà olà。</p>

<p>原文：</p>

<blockquote><p>(Recit)</p>

<p><em>Disinganno</em></p>

<p>Benché ascritto non sia</p>

<p>d’Amor nell’Accademia il Disinganno,</p>

<p>pur lecito mi fi a</p>

<p>recitare uno scherzo musicale</p>

<p>in cui biasmo d’Amor l’arco e lo strale</p></blockquote>

<p>英文翻译：</p>

<blockquote><p><em>Disenchantment</em></p>

<p>Although Disenchantment is not enrolled</p>

<p>in Love’s Academy,</p>

<p>yet I think I’m justifi ed</p>

<p>in reciting a light-hearted ditty</p>

<p>in which I censure Love’s bow and arrow.</p></blockquote>

<p>18.Aria “Si guardi dai dardi d’Amor”</p>

<p>原文：</p>

<blockquote><p>(Aria)</p>

<p><em>Si guardi, si guardi dai dardi d’Amor</em></p>

<p>chi felice desia di goder,</p>

<p>cara gioia, soave piacer,</p>

<p>senz’un’ombra d’affanno e dolor.</p>

<p>Son condite d’amaro velen</p>

<p>le ferite ch’imprime in un sen</p>

<p>la saetta del cieco fanciul</p>

<p>e dei pianti che versan gl’amanti</p>

<p>ei si prende giocondi trastul,</p>

<p>e sol gode che peni ogni cor.</p>

<p>Si guardi, si guardi dai dardi d’Amor</p>

<p>chi felice desia di goder</p>

<p>cara gioia soave piacer,</p>

<p>senz’un’ombra d’affanno e dolor.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Protect yourself well from Cupid’s darts</p>

<p>if you would enjoy</p>

<p>happiness and sweet pleasure</p>

<p>untroubled by anguish and grief.</p>

<p>The wounds infl icted on the breast</p>

<p>by the dart of the blindfold boy</p>

<p>are tipped with bitter poison,</p>

<p>and he with lovers’ tears</p>

<p>amuses himself right merrily,</p>

<p>only pleased with things that pain all hearts.</p>

<p>Protect yourself well from Cupid’s darts</p>

<p>if you would enjoy</p>

<p>happiness and sweet pleasure</p>

<p>untroubled by anguish and grief.</p></blockquote>

<p>19.Recitativo “Unito il Disinganno a la Ragione”</p>

<p>原文：</p>

<blockquote><p>(Recit)</p>

<p>Unito il Disinganno a la Ragione</p>

<p>a gl’istudi d’Amor sempre s’oppone.</p>

<p>Ma per troncare il fi lo a nuovi eccessi</p>

<p>di poetiche gare al fi n si giunga</p>

<p>e l’Accademia cessi.</p>

<p>Ma pria che si disgiunga</p>

<p>quest’adunanza amica,</p>

<p>unitamente un Madrigal si dica.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>When Disenchantment and Reason unite</p>

<p>Love’s studies are always opposed.</p>

<p>But to prevent fresh abuses,</p>

<p>let us end poetic rivalry</p>

<p>and close the Academy.</p>

<p>But before we dissolve</p>

<p>this friendly gathering,</p>

<p>let us sing a madrigal together.</p></blockquote>

<p>20.Madrigale “Sono Maestro è Amore”</p>

<p>原文：</p>

<blockquote><p><em>Madrigale a cinque voci</em></p>

<p>Dotto Maestro è Amore</p>

<p>con scaltra disciplina</p>

<p>erudisce ogni core,</p>

<p>ogn’anima addottrina.</p>

<p>Quindi apprender si suole,</p>

<p>e s’impara adorando un bel sembiante.</p>

<p>Buon poeta non è chi non è amante.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Five-part Madrigal</p>

<p>Love is a learned teacher</p>

<p>who with shrewd discipline</p>

<p>schools every heart,</p>

<p>informs every soul.</p>

<p>Thus one acquires understanding</p>

<p>and learns while adoring a lovely face.</p>

<p>He who is not a lover cannot be a good poet.</p></blockquote>

<h1>下半场</h1>

<ul>
<li>21.&ldquo;Vè che matta, maledetta!"选自<a href="https://en.wikipedia.org/wiki/Domenico_Cimarosa">Domenico Cimarosa</a>的<a href="https://en.wikipedia.org/wiki/L%27impresario_in_angustie">L'impresario in angustie</a>。</li>
</ul>


<p>没查到。</p>

<ul>
<li>22.Recitativo &ldquo;Donne belle!"，这和以下几首都选自Hadyn的<a href="https://en.wikipedia.org/wiki/La_canterina">La canterina, Hob.XXVIII:2</a>。</li>
</ul>


<p>我引用的歌词出自<a href="http://www.flaminioonline.it/Guide/Haydn/Haydn-Canterina-testo.html">这个网站</a>。</p>

<p>原文：</p>

<blockquote><p>DON PELAGIO</p>

<p>(Entra)</p>

<p>Donne belle! Accostati ed ascolta un po’</p>

<p>quest’aria ch’ho scritta questa notte. Vedi,</p>

<p>è in Do, La, sol, re, terza maggiore, con gli</p>

<p>corni che entrano e rinforzano con le sordine.</p>

<p>Oh, quest’uscite a solo d’oboe!</p>

<p>Senti un po’! Recitativo!</p></blockquote>

<ul>
<li>23.Recitativo and aria &ldquo;Che mai far deggio?&rdquo;</li>
</ul>


<p>原文：</p>

<blockquote><p>(Recitativo)</p>

<p>&ldquo;Che mai far deggio?</p>

<p>Sposo…ti vedrò esangue?</p>

<p>E spirerai quell’alma?</p>

<p>E chiuderai quei lumi, quei dolci lumi?</p>

<p>Ite al tiranno! Oh, Dio!</p>

<p>Io, d’altri e non più tua?</p>

<p>Che far deggio?"</p>

<p>(Aria)</p>

<p>&ldquo;Io sposar l’empio tiranno?</p>

<p>Io mirar lo sposo estinto?</p>

<p>Che farai, misero cor?"</p></blockquote>

<ul>
<li>24.Recitativo &ldquo;Che dici?&rdquo;</li>
</ul>


<p>原文：</p>

<blockquote><p>DON PELAGIO</p>

<p>Che dici?</p>

<p>GASPARINA</p>

<p>Viva!</p>

<p>APOLLONIA</p>

<p>Bravo, signor Maestro!</p>

<p>DON PELAGIO</p>

<p>Via!</p>

<p>(A Gasparina)</p>

<p>Canta appresso a me!</p>

<p>(Recitativo)</p>

<p>DON PELAGIO, GASPARINA</p>

<p>&ldquo;Che mai far deggio! Sposo!&rdquo;</p>

<p>DON PELAGIO</p>

<p>&ldquo;Sposo!&rdquo; Dolce, dolce&hellip;</p>

<p>DON PELAGIO, GASPARINA</p>

<p>&ldquo;Ti vedrò esangue?&rdquo;</p>

<p>DON PELAGIO</p>

<p>Tieni&hellip;</p>

<p>APOLLONIA</p>

<p>&ldquo;Esangue&rdquo; fa così&hellip;</p>

<p>DON PELAGIO</p>

<p>Gnora, fa calze! Non t’impacciar!</p>

<p>DON PELAGIO, GASPARINA</p>

<p>E spirerai quell’alma?</p>

<p>APOLLONIA</p>

<p>Spirare, apri la bocca!</p>

<p>DON PELAGIO</p>

<p>(A Gasparina)</p>

<p>Vedi, che vituperio!</p>

<p>GASPARINA</p>

<p>Soffritela, Maestro. La sapete!</p>

<p>DON PELAGIO, GASPARINA</p>

<p>&ldquo;E chiuderai quei lumi, quei dolci lumi!&rdquo;</p>

<p>DON PELAGIO</p>

<p>(Guardandola)</p>

<p>Ah, quei &ldquo;dolci lumi!&rdquo;</p>

<p>GASPARINA</p>

<p>&ldquo;Quei dolci lumi&hellip;&rdquo;</p>

<p>DON PELAGIO</p>

<p>Dolci lumi tuoi&hellip;</p>

<p>GASPARINA</p>

<p>&ldquo;Tuoi&rdquo; non vi sta.</p>

<p>DON PELAGIO</p>

<p>Parlo di te!</p>

<p>APOLLONIA</p>

<p>Ci vuole &ldquo;Lumi tuoi&rdquo; fa più grazia, tu non capisci?</p>

<p>Ecco: &ldquo;E chiuderai…&rdquo;</p>

<p>DON PELAGIO</p>

<p>(Sottovoce a Gasparina)</p>

<p>Quella fetente bocca! Fa partire la Gnora!</p>

<p>GASPARINA</p>

<p>Signora madre, un po’ di cioccolata!</p>

<p>(Apollonia esce)</p>

<p>APOLLONIA</p>

<p>Dammi la chiave! &ldquo;E chiuderai&hellip;&rdquo;</p>

<p>GASPARINA</p>

<p>Viva il signor Maestro!</p>

<p>DON PELAGIO</p>

<p>Hai vinto già il Maestro, figlia cara.</p>

<p>Via, partiamo, ch’è tardi.</p>

<p>GASPARINA</p>

<p>Ve n’andate?</p>

<p>DON PELAGIO</p>

<p>Sì, figlia cara mia.</p>

<p>(Fra sè)</p>

<p>Vedi, ch’occhiate!</p>

<p>GASPARINA</p>

<p>(Guardando in camera)</p>

<p>Il Maestro è partito. Venga! Che scimunito!</p>

<p>S’ha rotto il collo, sì! Non l’hai veduto? Sei orbo?</p>

<p>(Finalmente Apollonia e Don Ettore entrano)</p>

<p>GASPARINA</p>

<p>Presto! È ora già di pranzo.</p>

<p>(Don Pelagio ritorna)</p>

<p>DON PELAGIO</p>

<p>(Fra sè)</p>

<p>Diavolo! Che ascolto?</p>

<p>GASPARINA</p>

<p>Vedi, fatti capace!</p>

<p>DON ETTORE</p>

<p>Io sempre sono stato a far la spia.</p>

<p>Né l’ho veduto&hellip;</p>

<p>GASPARINA</p>

<p>Ed via!</p>

<p>DON ETTORE</p>

<p>Mi è toccato a dar luogo al signor Maestro!</p>

<p>DON PELAGIO</p>

<p>(Fra sè)</p>

<p>Or io do luogo a voi.</p>

<p>Ah, così sono le vicende umane!</p>

<p>GASPARINA</p>

<p>Che luogo? Tu sei matto!</p>

<p>DON PELAGIO</p>

<p>(Fra sè)</p>

<p>Ah falsa! Ah finta! Più del Falsetto istesso!</p>

<p>DON ETTORE</p>

<p>E quanto deve ancora?</p>

<p>GASPARINA</p>

<p>Quattro zecchini!</p>

<p>DON ETTORE</p>

<p>Lascialo in mal’ora!</p>

<p>DON PELAGIO</p>

<p>(entra)</p>

<p>No, no! Voglio pagare!</p>

<p>Dica signora, l´ho a dare?</p>

<p>GASPARINA</p>

<p>(Fra sè)</p>

<p>Uh, rovina!</p>

<p>(Don Pelagio apre il suo portafoglio)</p>

<p>DON ETTORE</p>

<p>Lei che va facendo?</p>

<p>DON PELAGIO</p>

<p>(A Don Ettore)</p>

<p>Zitto, viso di capra!</p>

<p>(A Gasparina)</p>

<p>Prendi. Ecco il denaro!</p>

<p>APOLLONIA</p>

<p>(Entra)</p>

<p>Presto in tavola, che siete arrivati!</p>

<p>GASPARINA</p>

<p>(Fra sè)</p>

<p>Ah, ch’è venuto il precipizio mio!</p>

<p>APOLLONIA</p>

<p>(Civetta)</p>

<p>Signor Maestro!</p>

<p>DON PELAGIO</p>

<p>(A Don Ettore)</p>

<p>Signor &ldquo;Corno!&rdquo; Addio!</p>

<p>(A le donne)</p></blockquote>

<ul>
<li>25.Intermezzo Secondo (extraits)，选自<a href="https://en.wikipedia.org/wiki/Domenico_Sarro">Domenico Sarro</a>的<a href="https://en.wikipedia.org/wiki/L%27impresario_delle_Isole_Canarie">L'impresario delle Isole Canarie</a>。</li>
</ul>


<p>由于没有具体说明是什么选段，没有查到。</p>

<ul>
<li><p>26.Intermezzo Primo (extraits) ，同上。</p></li>
<li><p>27.Mozart的"Un bacio di mano"。</p></li>
</ul>


<p>我引用的歌词出自<a href="http://www.lieder.net/lieder/get_text.html?TextId=94642">这个网站</a>。</p>

<p>原文：</p>

<blockquote><p>Un bacio di mano</p>

<p>Vi fa maraviglia,</p>

<p>E poi bella figlia</p>

<p>Volete sposar.</p>

<p>Voi siete un po' tondo,</p>

<p>Mio caro Pompeo,</p>

<p>L'usanze del mondo</p>

<p>Andate a studiar.</p>

<p>Un uom, che si sposa</p>

<p>Che giovin vezzosa,</p>

<p>A certi capricci,</p>

<p>Dee pria rinunciar.</p>

<p>Dee libere voglie lasciar alla moglie,</p>

<p>Dee sempre le porte aperte lasciar,</p>

<p>Dee chiudere gli occhi, gli orecchi, la bocca,</p>

<p>Se il re degli sciocchi no vuole sembrar.</p></blockquote>

<p>英文翻译：</p>

<blockquote><p>A kiss on her hand</p>

<p>astonishes you</p>

<p>And then the beautiful girl</p>

<p>you want to marry.</p>

<p>You&rsquo;re a little dull,</p>

<p>My dear Pompeo.</p>

<p>The ways of the world</p>

<p>Go study them.</p>

<p>A man who marries</p>

<p>A pretty young girl</p>

<p>Certain whims</p>

<p>He must give up</p>

<p>To let his wife have her way</p>

<p>To always leave doors open</p>

<p>To shut his eyes, ears, and mouth</p>

<p>If he doesn&rsquo;t want to be the king of fools.</p></blockquote>

<ul>
<li>28.Quartetto &ldquo;Scellerata! Mancatrice! Traditrice!"，也是出自之前提到的La Canterina。</li>
</ul>


<p>原文：</p>

<blockquote><p>DON PELAGIO</p>

<p>(Quartetto)</p>

<p>Scellerata! mancatrice! traditrice!</p>

<p>Vo’ gridar dalli balconi:</p>

<p>&ldquo;Queste donne, miei padroni,</p>

<p>Sono false ed assassine!&ldquo; Basta dir:</p>

<p>&ldquo;Son canterine&rdquo;, imparatelo da me!</p>

<p>APOLLONIA</p>

<p>Non gridate! Che sventura!</p>

<p>Per l’affanno e la paura&hellip;</p>

<p>GASPARINA</p>

<p>Per pietade! Ch’accidente!</p>

<p>&hellip; io mi reggo appena in piè.</p>

<p>DON ETTORE</p>

<p>Signor mio, lei l’uccida che poch’è.</p>

<p>APOLLONIA</p>

<p>(sarcastica)</p>

<p>Ci buttiamo a’ piedi vostri.</p>

<p>DON PELAGIO</p>

<p>Lungi, lungi, gente ingrata!</p>

<p>Castigata hai da restar!</p>

<p>DON ETTORE</p>

<p>(A Gasparina)</p>

<p>La mia tela, i miei diamanti!</p>

<p>Non servon questi pianti?</p>

<p>Or ti faccio cancelar?</p>

<p>GASPARINA, APOLLONIA</p>

<p>Ch’accidente&hellip; Che sventura&hellip; Per l’affanno&hellip;</p></blockquote>

<ul>
<li>29.<a href="https://en.wikipedia.org/wiki/Nicola_Porpora">Nicola Porpora</a>的"Oh se fosse il mio core (Cantata a voce sola)&ldquo;。</li>
</ul>


<p>我引用的歌词出自<a href="http://www.hyperion-records.co.uk/dc.asp?dc=D_CDA67894">hyperion唱片CDA67894的曲目说明</a>。</p>

<p>原文：</p>

<blockquote><p>Oh se fosse il mio core</p>

<p>in libertà di usar teneri affetti,</p>

<p>vostri pallidi aspetti,</p>

<p>vostri sospiri, e le querele e i pianti</p>

<p>potrian sperar pietà, miseri amanti.</p>

<p>Ma de’ verdi anni miei</p>

<p>nel più bel fior, se cieco amor m’accese,</p>

<p>se il cor non si difese</p>

<p>da un guardo feritor che aprì le piaghe,</p>

<p>se due pupille vaghe</p>

<p>mi accesero nel sen fiamma vorace,</p>

<p>altri amar non poss’io, datevi pace.</p>

<p><em>(Pietro Metastasio (1698-1782))</em></p></blockquote>

<p>英文翻译：</p>

<blockquote><p>Ah, if only my heart</p>

<p>were free to give away tender affections,</p>

<p>your pale faces,</p>

<p>your sighs, your laments and your tears</p>

<p>would have some hopes of pity, ye poor lovers.</p>

<p>But if blind love inflamed me</p>

<p>during the prime of my most beautiful years,</p>

<p>if my heart did not take any defence</p>

<p>against a hurting glance that opened my wounds,</p>

<p>if two fair eyes</p>

<p>turned on a voracious fire in my breast—</p>

<p>I cannot possibly love anybody else. Please forget it.</p>

<p><em>(English: Flavio Ferri-Benedetti © 2011)</em></p></blockquote>

<ul>
<li>30.Finale “Son confuso e stupefatto”选自Haydn的<a href="https://en.wikipedia.org/wiki/Orlando_paladino">Orlando paladino, Hob.XXVIII:11</a>。</li>
</ul>


<p>我引用的歌词出自<a href="http://www.dicoseunpo.it/H_files/Orlando_Paladino.pdf">这个网站</a>。</p>

<p>原文：</p>

<blockquote><p>Orlando:</p>

<p>Son confuso e stupefatto.</p>

<p>Donne belle, vel protesto,</p>

<p>nel veder che l’uom sia matto,</p>

<p>per la vostra crudeltà.</p>

<p>Tutti:</p>

<p>Se volete esser felici,</p>

<p>riamate ognor chi v’ama</p>

<p>con candor senz’artifici,</p>

<p>e contento il cor sarà.</p>

<p>Eurilla:</p>

<p>E pur sempre in conclusione</p>

<p>che in amore gli augelletti</p>

<p>di noi abbian più ragione</p>

<p>e maggiore umanità.</p>

<p>Tutti:</p>

<p>Se volete esser felici, etc.</p>

<p>Rodomonte:</p>

<p>Niuna tigre né pantera</p>

<p>non ho visto in Barbaria,</p>

<p>che in amor fosse severa</p>

<p>né sentisse almen pietà.</p>

<p>Tutti:</p>

<p>Se volete esser felici, etc.</p>

<p>Alcina:</p>

<p>Dunque ognun contento sia</p>

<p>di godersi tranquillo in pace,</p>

<p>e in virtù della magia</p>

<p>ciascun lieto sen vivrà.</p>

<p>Tutti:</p>

<p>Se volete esser felici, etc.</p>

<p>Medoro:</p>

<p>Se in amor serbai costanza,</p>

<p>fu l’amor di ciò cagione;</p>

<p>il mio amor vince ed avanza</p>

<p>fin la stessa fedeltà.</p>

<p>Tutti:</p>

<p>Se volete esser felici, etc.</p>

<p>Angelica:</p>

<p>La colomba insegna i baci,</p>

<p>e la fida Tortorella</p>

<p>negli affetti suoi tenaci</p>

<p>mostra a noi la fedeltà.</p>

<p>Tutti:</p>

<p>Se volete esser felici, etc.</p></blockquote>

<p>这里安利下Hochschule RheinMain的Prof. Helmut Weber的主页，他应该是Computer Sciene Department的，但也是一位歌剧爱好者，收集了不少<a href="http://www.cs.hs-rm.de/~weber/opera/libretto.htm">歌剧歌词资料</a>。</p>

<p>最后再从<a href="http://www.arts-florissants.com/main/en_GB/calendar/in-an-italian-garden.html">官网</a>那里盗几张图好了，期待周末的演出！</p>

<p><img src="http://www.arts-florissants.com/cache/media/un-jardin-a-litalienne/jardin-des-voix-7-william-christie-2-p-delval/s%2C1000%2C666-4915f9.jpg"></p>

<p><img src="http://www.arts-florissants.com/cache/media/un-jardin-a-litalienne/jardin-des-voix-7-william-christie-3-p-delval/s%2C1000%2C667-4d07e0.jpg"></p>

<p><img src="http://www.arts-florissants.com/cache/media/un-jardin-a-litalienne/jardin-des-voix-7-5-p-delval/s%2C1000%2C667-f0d56e.jpg"></p>

<p><img src="http://www.arts-florissants.com/cache/media/un-jardin-a-litalienne/jardin-des-voix-7-6-p-delval/s%2C1000%2C666-bc2570.jpg"></p>

<p><img src="http://www.arts-florissants.com/cache/media/un-jardin-a-litalienne/jardin-des-voix-7-william-christie-4-header-p-delval/s%2C1000%2C667-a76704.jpg"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[小记「声音的面容」二：当代艺术的“音”与“乐”]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/09/11/notes-of-visage-acoustique-talks-2/"/>
    <updated>2016-09-11T23:36:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/09/11/notes-of-visage-acoustique-talks-2</id>
    <content type="html"><![CDATA[<h1>John Cage&rsquo;s 4'33''</h1>

<ul>
<li><p>演奏前的演奏者感言：「构成音乐的元素，是声音和沉默。二者综合起来，就是作曲。我有一句“无言”要说，我现在正要说了&hellip;&hellip;」</p></li>
<li><p>John Cage: &ldquo;Everything we do is music.&rdquo;</p></li>
<li><p>1952年8月29日，Irwin Kremen首演4'33'&lsquo;。</p></li>
<li><p>1954年David Tudor复演4'33'&lsquo;：观众有了心理准备，观众的噪音少了，但环境噪音尤在。</p></li>
</ul>


<h1>音与乐的启示</h1>

<h2>日式禅宗：此处无声胜有声</h2>

<ol>
<li><p>聆听“寂静”</p></li>
<li><p>无声里“偶发”声音</p></li>
<li><p>“绝对的空无”</p></li>
</ol>


<h3>禅宗否？</h3>

<p>John Cage确实受到铃木大拙佛学的巨大影响，“万物皆生于有，而有生于无”，遂而做他的“偶发音乐”。在一场《关于无》的演讲中，Cage说：有一件事是可以确定的，如果一个人要创造有，它将会是无。“它可能会通过无而成为有”可能正是John Cage创作4'33'&lsquo;的灵感来源。</p>

<h2>中土道家：大音希声</h2>

<h3>道家否？</h3>

<p>大“音”希“声”，但仍是“有声”。面对这种声音的美学，Cage其实是让听众去倾听在所谓演奏（其实未演奏）过程当中的任何所能听到的声音。于是乎，Cage在提供一个新的框架，让听众们去聆听这些噪音，但如何理解这种噪音？“构成音乐演出的根本行为是聆听，不是制造音乐”——美国公共电视网介绍4'33'&lsquo;时如是说。</p>

<h3>Cage在首演后的解读</h3>

<p>他们误会了，无声是不存在的。他们以为这是无声，那是因为他们不知道如何去听，其实还有很多偶发的声音：</p>

<p>第一乐章时你能听到鼓动的风声。</p>

<p>第二乐章时有雨水滴在屋顶的声音。</p>

<p>第三乐章人们自己就开始发出有意思的声音了，他们开始交头接耳，或者走出去。</p>

<h3>4'33'&lsquo;是否是无声的？</h3>

<p>众所周知的一个事实是，4'33'&lsquo;的无声归根结底不是无声，因为无声是一种从物理学角度不可能达到的状态&hellip;&hellip;4'33&rsquo;&lsquo;是无声不存在的一个证明，是声音永久性存在我们周围的一个证明，证明了它们值得我们注意的这一事实，也证明了Cage的所谓“环境声音与噪音比世界上的音乐文化产生的声音更具有审美价值”这一事实。——迈克尔</p>

<p>所以，4'33'&lsquo;不是对音乐的否定，而是对音乐无所不在的肯定。</p>

<p>问题是，环境声音与噪音一定比音乐更具有审美价值？这种观点仍是从音乐角度出发来看问题的，似乎大千世界里音乐无处不在，但却未区分出（声）音与（音）乐，真正无处不在的是前者而非后者。</p>

<h2>Cage的启示</h2>

<h3>从“音”拓展到了“声”</h3>

<h3>开启了声音艺术的“观念主义”之途</h3>

<h3>关注“音”与“乐”的情境</h3>

<h4>Duchamp对Cage的内在影响</h4>

<p>人们害怕有一天，由于一切都是艺术，一切都将不再是艺术。“否定性”被现成物品物化了，现成品的“反艺术”几乎受到了普遍欢迎。</p>

<h1>何为声音艺术（sound art）？</h1>

<ul>
<li><p>声音艺术的模糊性：无所不包？</p></li>
<li><p>声音艺术的确定性：属于视觉还是听觉？</p></li>
<li><p>Juna Winderen的声音装置《潜水》</p></li>
</ul>


<h2>超逾的美学：声音艺术超出了音乐限度</h2>

<h2>气氛的美学：声音与环境的相互融合</h2>

<h2>显现的美学：声音本身所呈现的意义</h2>

<h1>当代艺术的“用乐”：从库奈里斯《反转现场》谈起</h1>

<h2>走向“总体艺术”</h2>

<h2>关于“贫穷艺术”</h2>

<h2>从达达派到激浪派</h2>

<h2>行为艺术</h2>

<h2>原始根源与艺术“电缆”</h2>

<h1>音与乐的意义层级</h1>

<p>分析美学家斯蒂芬-戴维斯的专著《音乐的意义和表现》，提出了一整套“意义类型学（Typology of meanings）”：</p>

<ul>
<li><p>A: 自然的、无意义的意义</p></li>
<li><p>B: 对自然意义的有意识使用</p></li>
<li><p>C: 对自然要素的系统化、有意识使用</p></li>
<li><p>D: 有意的、人为规定的独立意义</p></li>
<li><p>E: 在某一符号系统中产生的人为的意义（如语言）</p></li>
</ul>


<h2>音乐属于意义几？</h2>

<p>戴维斯认为，音乐作品的最一般属性是意义C。</p>

<h2>苏珊-朗格的音乐观</h2>

<h2>反驳朗格音乐观</h2>

<h2>音乐意义的表现</h2>

<h3>音乐当中使用“自然意义”</h3>

<p>如谭盾的《水乐》</p>

<h3>彻底回归自然意义的“声景”（soundscape）</h3>

<!-- more -->


<p><img src="http://ww3.sinaimg.cn/large/726cbd3dgw1f7irr90stzj20jg0ridkc.jpg"></p>

<p>以上摘自刘悦笛老师的主题言说：「当代艺术的“音”与“乐”」。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[斯卡拉歌剧院演绎威尔第《西蒙·波卡涅拉》]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/09/04/Simon-Boccanegra/"/>
    <updated>2016-09-04T10:12:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/09/04/Simon-Boccanegra</id>
    <content type="html"><![CDATA[<p>虽然我平时很少听声乐，但四年前还在高卢呆时还是很想去现场看著名歌剧院团演歌剧的。不过当时ONP的乐季实在太火，在网上没买着票，去巴士底歌剧院蹲点等rush ticket也没等着；去米兰时也没赶上斯卡拉演歌剧，最后看了场“伏地魔”埃申巴赫指挥斯卡拉爱乐&hellip;..总之是各种杯具，带着这一遗憾就滚回我朝了。所以今年看到斯卡拉歌剧院来亚洲巡演，在东艺演威尔第歌剧《西蒙·波卡涅拉（Simon Boccanegra）》和贝九，我便毫不犹豫拔草了波卡涅拉的票。</p>

<p>这次指挥是大家熟知的韩国指挥大师郑明勋。郑大厨对Verdi这部相对冷门的歌剧相当熟稔，之前看到媒体报道他是“在世的指挥家里最懂《西蒙·波卡涅拉》的人”，看来果然名不虚传。他完全是背谱指挥，无论是与乐团乐手、还是与合唱团和歌唱家的配合都非常默契。虽然我之前已经看过这部歌剧的视频，前几天还找了些录音来重温，但昨晚才发现之前忽略了不少细节——例如乐团如何与演唱家应和，某些乐段又如何衔接、过渡、呼应——似乎是刚刚认识这部作品。</p>

<p>这次担纲三大主角的歌唱家——演唱Boccanegra的Simone Piazzola、Maria/Amelia的Carmen Giannattasio、Fiesco的Dmitry Belosselskiy——虽然实力出众，但给我感觉独唱的部分并不算出彩：例如序幕中Fiesco的“A te l'estremo addio”、Amelia的“Come in quest'ora bruna”，似乎难以和我所听过的Paata Burchuladze和Mirella Freni相比。不过占据更多戏份的重唱仍是高水准的。几位配角中最值得称道的是扮演Gabriele的Fabio Sartori。他在第二幕的“Sento avvampar nell'anima”实在把这一角色的复杂纠结的心理活动唱活了，十分有感染力，以至于这首咏叹调结束后台下观众也按捺不住激动喊起了“Bravo”——这似乎是晚上唯一一次中途喝彩。演唱Paolo的韩国男中音金柱泽也令人印象深刻，不过对于这个反角的黑暗阴险似乎表现不足，看到介绍说他今年在纪念《塞尔维亚理发师》首演200周年的演出中饰演费加洛，倒是觉得他更适合费加洛这种正面角色。此外，斯卡拉歌剧院合唱团也表现得非常出色，让我萌生出听隔天他们演唱贝九的欲望XD 不过在摸摸干瘪的钱包后，我决定还是到富特、凯格尔等作古大师的录音中去找寻我的理想贝九吧XD</p>

<p>唯一有些遗憾的是，这次音乐会版的歌剧基本没有舞美，也几乎没有戏剧表演——有时候我也觉得自己挺矛盾的，上回NTLive的《奥赛罗》这方面做得那么好，却<a href="http://galoisplusplus.coding.me/blog/2016/04/03/nt-live-kinglear-and-othello/">吐槽</a>他们太写实不简洁；这次够简洁了吧，却又要指责，太难伺候了——其实人总是欲壑难填嘛，就当为下次看歌剧留个念想啦XDD</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RNN(Recurrent Neural Networks)的有趣实验]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/08/17/have-fun-with-rnn/"/>
    <updated>2016-08-17T10:12:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/08/17/have-fun-with-rnn</id>
    <content type="html"><![CDATA[<p>前段时间fracting兄分享了<a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">Andrej Karpathy一篇介绍RNN(Recurrent Neural Networks)的文章</a>，我看了之后觉得非常有趣，也用作者Andrej Karpathy写的<a href="https://github.com/karpathy/char-rnn">char-rnn</a>跑了一些实验玩玩。</p>

<h1>代码实验</h1>

<p>作为码农，我最开始自然地想到用<code>rnn</code>来训练代码啦！</p>

<h2>lua源代码</h2>

<p>我把lua-5.2.3的代码都写到一个文件里作为训练数据。<code>lua</code>的代码实在是太精炼了，竟然1M不到，只有544K！我没有更改<code>char-rnn</code>的默认参数，跑完了所有的50个<code>epoch</code>。取样时我一下就把<code>temperature</code>设为1（<code>temperature</code>是一个0到1的参数，越大随机性越高，设为1也就是机器原创性最好的条件了），结果还是比我想象中的好很多：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LUA_API const char *lua_string(lua_State *L, int toidx);
</span><span class='line'>LUAI_FUNC void luaV_op (lua_State *L);
</span><span class='line'>
</span><span class='line'>LUA_API void  (lua_setloge) (lua_State *L, lua_Degrawiol) set) {
</span><span class='line'>  int i;
</span><span class='line'>  for (i = n - "indininple")";
</span><span class='line'>  for (p = luaL_int(func, nup+n, nup), &winzed);
</span><span class='line'>  return ts;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>LUA_API void lua_touserdata (lua_State *L, int nargp) {
</span><span class='line'>  lua_CFunction fo = h-&gt;next;  /* path list of `must the stack is string */
</span><span class='line'>  while (p-&gt;cactconul == NA_JUMP) {  /* remove result back */
</span><span class='line'>      lua_xmove(L, 1);  /* remove functions in empty liblering */
</span><span class='line'>      if (!(!ass_epp(lua_Number)(e) - 1))
</span><span class='line'>        lua_pop(L, 1, 1, i, o2);  /* remove it informed is name */
</span><span class='line'>      else {
</span><span class='line'>        lua_getuserval(L, idx2a(L), nvalue(o));
</span><span class='line'>      lua_pushvalue(L, unsupvalue);
</span><span class='line'>          return finuserode(L, nargs, ns);
</span><span class='line'>          finit = strchr(*(s, p, lewvalues));
</span><span class='line'>        lua_pushliteral(L, "tobove");
</span><span class='line'>        tb = uv-&gt;u.l.pastpvarsing; i++)  /* logits avoid strings */
</span><span class='line'>        lua_Number k = luaL_checkint(L, 2, 1), lua_isnumber(L, idx) != 0)
</span><span class='line'>                            const char *p, expdesc v, int skiZc, L-&gt;clock, int);
</span><span class='line'>      if (lua_getisteop(L, i) != LUA_REGERMADDER) {  /* no move
</span><span class='line'>(followed framaling) */
</span><span class='line'>        L-&gt;oldpc = size_t, L-&gt;stack + G(L)-&gt;currentline;
</span><span class='line'>      checknext(ls, TK_EOS, NO_JUMP);
</span><span class='line'>    i &gt;= casch_k == NO_ORTENS sizeof(char + 1));
</span><span class='line'>    switch (ls-&gt;cause)
</span><span class='line'>      luai_writh(g));
</span><span class='line'>    j-&gt;basstring = NOPribig/ gch(o)-&gt;marked;  /* an open unsigned
</span><span class='line'>instect tocome */
</span><span class='line'>    lua_pushvalue(L, -1);  /* put to use name */
</span><span class='line'>  }
</span><span class='line'>  else {
</span><span class='line'>    int nvars[i] = g-&gt;gcvalue[g-- &lt; data = orr.in_PAXTABL;
</span><span class='line'>lua_pushbouceran(L, v2);  /* value stack */
</span><span class='line'>        sav_char_(luaL_optint(L, strfrot));
</span><span class='line'>  c = sig_meth (level) {
</span><span class='line'>      prongc = (**s == '-');
</span><span class='line'>      else {
</span><span class='line'>        break;
</span><span class='line'>    }
</span><span class='line'>    case GCSsweep = mode;  /* skip liblare `next' */
</span><span class='line'>    if (gnodead(t, a)) {  /* called old return */
</span><span class='line'>      lua_pushstring(L, name);
</span><span class='line'>      setnilvalue(o);
</span><span class='line'>  }
</span><span class='line'>  else {
</span><span class='line'>    while (l &lt; l)
</span><span class='line'>      closeL;
</span><span class='line'>      return NULL;
</span><span class='line'>    }
</span><span class='line'>    ttydebuffield(L, LUA_FINTFOCLEN);  /* signed invalid of capture is
</span><span class='line'>a sunpting */
</span><span class='line'>    setsvalue2s(L, L, luaL_checkinteger)(L, 1), LUA_TFuLLEA) +
</span><span class='line'>(L-&gt;size = LUA_RIDS);  /* elual library operand matched (filencat) */
</span><span class='line'>    if (stmp) res = rowninizers[i]; i-valid */
</span><span class='line'>    makes = 0;
</span><span class='line'>    }
</span><span class='line'>    if (l &lt;= i &lt; args) {
</span><span class='line'>    luaL_addchar(&b, collectar(s, n, 1));
</span><span class='line'>    if (lua_isnoneornil(L, 2))  /* not noting thave arguments */
</span><span class='line'>      /* stat -&gt; == L-&gt;ci-&gt;nexps - '?' */
</span><span class='line'>      if (fermst = 1) {
</span><span class='line'>      if (luaS_eqstr(luaL_checknumber(L, 1))) {
</span><span class='line'>        if (*(s != k &gt;&gt; 2] || ttisstring(g-&gt;GCasbertocaum(L)) != 0 &&
</span><span class='line'>!luaD_freall(L, hvars(luaL_len(p, 0));
</span><span class='line'>      break;
</span><span class='line'>    }
</span><span class='line'>    case LC_LOADG2(L); lua_pushcclosure(L, idx12x(f));
</span><span class='line'>    setobj2s(L,
</span><span class='line'>                 "L_callint " function");
</span><span class='line'>                                               singleballstatis);
</span><span class='line'>  shrint (lua_tointeger(L, 1), luaT_gettmotableark, (lua__collok(L, 1,
</span><span class='line'>0, 2))) == l2);
</span><span class='line'>  return 1;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static int db_setret (lua_State *L) {
</span><span class='line'>  int status = lua_load(L, lua_tointeger(L, L, "cnonal "-") " too pvarial be
</span><span class='line'>* with number of yi-valid function");
</span><span class='line'>  (func == LUA_TFUNCTI NUM: baset2(obj2gco(k));
</span><span class='line'>  checkStaceenstarn(l, nvalue(o));
</span><span class='line'>  api_incr_top(L);
</span><span class='line'>  lua_unlock(L);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>LUA_API const char *lua_pushstring (lua_State *L, int n, const char *e) {
</span><span class='line'>  const char *msg = lua_tolstring(L, -1, &ls);
</span><span class='line'>  lua_unlock(L);
</span><span class='line'>  if (status == LUA_OK) dectal(SeEMASK);
</span><span class='line'>  return 1;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static void pushfunccall (lua_State *L) {
</span><span class='line'>  Labell check;
</span><span class='line'>   lua_assert(argv[i] == LUA_TTABLE);  /* table to compert */
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>采样结果比较像的是：</p>

<ul>
<li><p>结构体和函数命名。有相当一部分和<code>lua</code>源代码是一样的，例如<code>LUA_API</code>、<code>LUAI_FUNC</code>、<code>lua_State</code>、<code>lua_pushvalue</code>、<code>luaL_checkint</code>等等。即使是rnn自造的，也有一些挺符合规范的，例如<code>lua_string</code>、<code>luaV_op</code>，几乎可以以假乱真。一个稍微差一点的例子是<code>luaT_gettmotableark</code>，尽管末尾造的词看不出意义，但仍然符合<code>lua</code>源代码里API的命名规则：<code>lua${一个大写字母表示API类型}_${方法名}</code>（例如<code>lua</code>源代码里，<code>table</code>类型的API叫做<code>luaT_xxx</code>，<code>string</code>类型的叫做<code>luaS_xxx</code>，<code>lua</code>虚拟机的API叫做<code>luaV_xxx</code>）。</p></li>
<li><p><code>lua</code> API中经常用状态机结构体指针作为参数传递，<code>rnn</code>采样的结果中，也经常以<code>lua_State *L</code>作为函数定义的第一个参数，在调用函数时也常常以<code>L</code>作为第一个传入的参数。</p></li>
</ul>


<p>比较不理想的是：</p>

<ul>
<li><p>括号、双引号不成对而引起的语法错误。</p></li>
<li><p>上下文的语义相关性差，例如上面那段代码最后的函数<code>pushfunccall</code>，传入参数<code>L</code>是没有被用到的，里面用到的<code>argv</code>并没有被声明。</p></li>
</ul>


<h2>cocos2d-x源代码</h2>

<p>我用<code>cocos2d-x</code>的源代码做了实验。<code>cocos2d-x</code>的代码就臃肿得多了，合起来有32M。由于数据较大，我训练时就把<code>rnn_size</code>调高，设了700，<code>num_layers</code>设了2。一开始用CPU训练，特别慢，中途我就弃疗了。后来把OpenCL配置好，用集显来训练，比原来大概快了一倍——毕竟是集显没多少核，所以无法达到10倍的加速比，要是能用以前实验室的K20X跑就好了。</p>

<p>这个实验跑得特别慢，我中间机器还重启过，重跑了<code>train.lua</code>，目前只跑了11.32个<code>epoch</code>。所以采样结果就不太理想了，要么是一大段注释，要么各种语法错误，这应该跟<code>cocos2d-x</code>的代码风格和采用<code>C</code>、<code>C++</code>、<code>lua</code>、<code>Python</code>、<code>Objective-C</code>等多种语言也有关系。我把<code>temperature</code>设为0.5才出来下面东拼西凑得稍微像样的结果：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* &lt;/key&gt; TE'Casting C++ Transfer SQLite core constraints.
</span><span class='line'>
</span><span class='line'> */
</span><span class='line'>
</span><span class='line'>typedef struct SPender {
</span><span class='line'>
</span><span class='line'>    /*! The return code for the content of the content of the control
</span><span class='line'>object may be passed to the first character. "
</span><span class='line'>
</span><span class='line'>                                              no tileset -- called
</span><span class='line'>requested to not support android definitions are allocated as the ba
</span><span class='line'>
</span><span class='line'>ckup processed to any this
</span><span class='line'>
</span><span class='line'>        * directory.
</span><span class='line'>
</span><span class='line'>     */
</span><span class='line'>
</span><span class='line'>    std::string getControllerDataBits() const;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    /** @brief Retrieves a GLProgram with the specified name of the
</span><span class='line'>current position of the container.
</span><span class='line'>
</span><span class='line'>     * @param vector The new z-order of the key of this node below.
</span><span class='line'>
</span><span class='line'>     *  @param contains The integer key for the key.
</span><span class='line'>
</span><span class='line'>     *  @return the integer key for setting the key to write to the
</span><span class='line'>key for the key.
</span><span class='line'>
</span><span class='line'>     *  @param[in]          the number of the key of the key.
</span><span class='line'>
</span><span class='line'>    */
</span><span class='line'>
</span><span class='line'>    virtual void visit(const char* target, int defaultValueCount);
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    /** create a new function with an automatic code from a loader to
</span><span class='line'>the ceater's container with a dictionary, the format of the first
</span><span class='line'>
</span><span class='line'> in the writer. The tile did the
</span><span class='line'>
</span><span class='line'>        types since they are not supported
</span><span class='line'>
</span><span class='line'>    */
</span><span class='line'>
</span><span class='line'>    bool onFloat;
</span><span class='line'>
</span><span class='line'>    /*! The cropping to allow the third particular after the width, in
</span><span class='line'>screen coordinates. The value must be the offset to the interfac
</span><span class='line'>
</span><span class='line'>e to disk.
</span><span class='line'>
</span><span class='line'>     */
</span><span class='line'>
</span><span class='line'>    void setUniformValue(const std::string &url);
</span><span class='line'>
</span><span class='line'>    /** @brief Returns the number of tilesets the one node's container
</span><span class='line'>window, it means the default world set is the standard orientati
</span><span class='line'>
</span><span class='line'>on, the director will be returned.
</span><span class='line'>
</span><span class='line'>     *  @return The number of elements also returns NULL.
</span><span class='line'>
</span><span class='line'>     *  @return An autorelease object pointer, or a NULL pointer.
</span><span class='line'>
</span><span class='line'>    */
</span><span class='line'>
</span><span class='line'>    inline const char* getTileGID() const { return _restoreOriginalFrame; };
</span><span class='line'>
</span><span class='line'>    inline Vec2 _projection;
</span><span class='line'>
</span><span class='line'>    std::string _subStepping;
</span></code></pre></td></tr></table></div></figure>


<h1>自然语言实验</h1>

<h2>英文文章</h2>

<p>我写了个很简单的爬虫去爬一个<a href="http://www.musicweb-international.com/">英文音乐网站</a>上的乐评文章，完整地爬了1.8G，但后来我发现：这个网站的样式有改版，而我是通过<code>css</code>去筛选乐评的，导致里面有些数据有问题。这个网站上的乐评基本是碟评，我最开始也想到把碟的标题、曲目和乐评都抓出来一起训练，但后来也是因为网页样式不够统一而作罢，只抓了乐评的内容。最后用的数据大概只有两千多篇乐评文章，12M，所有的内容我都过了一遍，删掉了其中有问题的数据——因为当时不知道有问题的数据大概长啥样，只用正则表达式很简单地筛掉了完全没有出现英文字符的数据，所以这两千多条数据我竟然是很蠢地人肉看的orz&hellip;</p>

<p>训练时把<code>rnn_size</code>设到了300，一共训练了50个<code>epoch</code>。采样时我传了一些音乐家的名字作为<code>-primetext</code>参数，不过奇怪的是，产生的文本并不是我所想的“命题作文”，里面包含我所设定的音乐家名字的很少。</p>

<p>下面是<code>temperature</code>为0.8时产生的一些文本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                John Eliot Gardiners' music has been recorded by Machiavey
</span><span class='line'>            Brahms and the Telarc hand. Here, though it seems the
</span><span class='line'>‘death’ with Ian Walton in the soloist
</span><span class='line'>                    sounds truly resigned as Bartók in . The
</span><span class='line'>                  assurance composer brings to the narrative evocation
</span><span class='line'>                  climax. There’s much lovely theme for Mass
</span><span class='line'>                and of the Boris. All composers look forward to
</span><span class='line'>her cycles, and the notes that sticed him much snob-is off-air points
</span><span class='line'>out.  The detailed and the Canzonetta (Sheher
</span><span class='line'>                is in the collective for distribution for the
</span><span class='line'>                  father to the and spirit of the composer’s voice from DG
</span><span class='line'>                many Greeks.
</span><span class='line'>              The last piece is rather than true to the programme
</span><span class='line'>                for their top recommendation. Add to Ireland’s
</span><span class='line'>                  first performance has one of the most slight lovely small
</span><span class='line'>                  performances of Parama Mozdianic’s music as well
</span><span class='line'>as composer and should
</span><span class='line'>                    write and there is little of its own
</span><span class='line'>individual aspects. The recording of both the recording by Royal Eleno
</span><span class='line'>Stevens, the disc
</span><span class='line'>                  () “…Better and far criticised into the second
</span><span class='line'>movement – most popular of a composer
</span><span class='line'>                    to summarise what was able to depict the way
</span><span class='line'>through it with
</span><span class='line'>                introspective substance to the rest of the most
</span><span class='line'>                  enjoyable theme. It is worth a major prelude, he
</span><span class='line'>had been a versatile, subdued violinist who points out with
</span><span class='line'>                the end of the Sarah and of the Roman concerto for
</span><span class='line'>                a performance in the late CD arrangement of the
</span><span class='line'>soloist which make the strange
</span><span class='line'>                music that tells the sounds to create in the
</span><span class='line'>                  change of rare and warm long, romantic partnership.
</span><span class='line'>                  So too much of it all recently is perfectly
</span><span class='line'>contradictoned, for me,
</span><span class='line'>                  but the harmonies are in the more prominent
</span><span class='line'>            music at the start to “Goldsmith” because
</span><span class='line'>                the result is not as if not merely moving in the
</span><span class='line'>first two sessions. From there  were my repeat that one may seem like
</span><span class='line'>a position appear to be listening to my beef?” Protestating the
</span><span class='line'>            concert-half and the same text – making “destinal” the
</span><span class='line'>use of the innocent
</span><span class='line'>            performances in the pleasure of the piece,
</span><span class='line'>                  but there was a time to convince the ‘allegro
</span><span class='line'>                from the shameful of the experience as the price
</span><span class='line'>of the piece’ (the
</span><span class='line'>                  most movement of Byrd
</span><span class='line'>                John Carroll) and his own sights of the first movement from
</span><span class='line'>                  his opera too. This was the earlier half of the
</span><span class='line'>text. So this is long realised
</span><span class='line'>                from one of the best deserts projects which work very well
</span><span class='line'>                as like yourself, I should even prevent the
</span><span class='line'>correct paces on a prejudice and clear that can also work certainly
</span><span class='line'>                - a compelling performance as principal force and
</span><span class='line'>his live performers in
</span><span class='line'>                the shadow of the work. This is the disc of the talking.
</span><span class='line'>                  This was a well-used recording …. Yet for this
</span><span class='line'>                  recording has more intense from a disc amasted
</span><span class='line'>the Roman Bale’s choir,
</span><span class='line'>                    a pastoral player from the following ‘Composer’ (tr.
</span><span class='line'>                  8) the first slow piece all low delicate and
</span><span class='line'>intense and stunning and then chosen music.</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>These are composers that would say that John Williams has said that
</span><span class='line'>happily should be struck by the singers of the score for a sequel
</span><span class='line'>evocative and character of several Scarlatti.
</span><span class='line'>  The score is also released and with the price of the separately
</span><span class='line'>sopranctic piece and making a case of practical distinction with the
</span><span class='line'>'methoy of information a tragically devout and distant and generally
</span><span class='line'>small exploration).  Strobbe injustice that the sound is subtly but
</span><span class='line'>distanced over flat illustrate scores by the score by Glennie twistens
</span><span class='line'>and the preceding musicians who are uncommonly detailed with much of
</span><span class='line'>the original MGM track. Debney writes down the score, it is, as this
</span><span class='line'>classic opera, Supermulation player
</span><span class='line'>  of Bernard Herrmann and the writing of the Sinfonia (Herberton Koon
</span><span class='line'>& Glyniform Graham) where he wrote some composers, and is a pleasant
</span><span class='line'>work for very little before I think I am of completely different
</span><span class='line'>settings of the score it is, in the background forty band of score for
</span><span class='line'> and , one of the most original excerpts only a revelation to warning
</span><span class='line'>you without
</span><span class='line'>computer use I don’t certainly is
</span><span class='line'>be creating a small sound. Morricone’s ‘Discovery’ is all the same
</span><span class='line'>passages featuring luxurial taste. \rAOr tradition and Victoria’s
</span><span class='line'>sampled confusion from the cinema setting.
</span><span class='line'>His admirable period of recognizably derivatives recalling its
</span><span class='line'>subject. Highly recommended.</span></code></pre></td></tr></table></div></figure>


<p>整篇还是比较前言不搭后语，但是单看句子还是比较通顺的，也用了不少音乐家的名字（Gardiner、Brahms、Scarlatti）、厂牌名（Telarc、DG）和音乐术语（Canzonetta、Sinfonia）。</p>

<h2>中文古诗词</h2>

<p>我觉得中国古诗词是极好的数据集：</p>

<ul>
<li><p>我对把文学作品当做机器学习的数据集也很感兴趣，很好奇最后会产生什么样的“作品”。</p></li>
<li><p>个人认为机器对于处理structed data更为在行，而在文学中，古典诗词无疑是很有规律的。相比之下，散文、小说等现代文学总归是太散了些。</p></li>
<li><p>还有其他一些规律性很强的文体，例如日本的俳句和川柳，但我朝的古诗词起码我们能看得懂——字啊！</p></li>
</ul>


<p>接下来就是从哪里获得数据的问题了。虽然电子书网站不少，不难下载到这方面文本的txt，但这种txt有些问题我不太满意：</p>

<ul>
<li><p>会把某些字拆开，例如把“勖”写成“冒力”。</p></li>
<li><p>会插入一些注解，但我并不想把注释加到训练数据里面。</p></li>
</ul>


<p>后来我发现<a href="http://ctext.org/">Chinese Text Project</a>上有一些资源，而且并没有上述问题，所以我也写了一个简单的<a href="https://github.com/yszheda/ctext_crawler">爬虫</a>去爬《全唐诗》。不过该网站禁止使用自动下载软件，我最开始忘了调爬虫的<code>DOWNLOAD_DELAY</code>参数，所以在爬了一些数据后就被封了&hellip;后来又用代理继续爬，总共爬了2.7M（4794首诗），每首诗按照如下格式存成了json文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>   {
</span><span class='line'>      "title" : "《寄溫飛卿箋紙》",
</span><span class='line'>      "content" : "\n三十六鱗充使時，數番猶得裹相思。\n待將袍襖重抄了，盡寫襄陽播掿詞。",
</span><span class='line'>      "author" : " 段成式著"
</span><span class='line'>   },</span></code></pre></td></tr></table></div></figure>


<p>我用<code>char-rnn</code>训练了50个<code>epoch</code>，诗人<code>rnn</code>在脾气最大（<code>temperature</code>为1）时所作的大作如果集结出版，就叫它<a href="https://coding.net/u/GaloisPlusPlus/p/galoisplusplus/git/raw/source/source/downloads/code/rnn/quantangshi-sample.json">《循神网诗选》</a>（循神网=循环神经网络=Recurrent Neural Networks=RNN）吧XDD</p>

<p>《循神网诗选》中，标题和署名是模仿得最难以分辨的，能一眼看出是机器胡诌的极少——例如有一则标题很长的诗。但是诗的内容总体就是胡言乱语了。不过还有一些有意思的句子：“萬里曙山牢”，用“萬里”“牢”形容山，很形象啊；“春風寒酒憔悴殺”，用的词“寒”“憔悴”意象很相近啊。不过由于前言不搭后语，整联写得好的比较少，《循选》读下来，似乎就“秋水燕蘭樹，春暉漫柳霧”还有对仗工整之处。不过刚刚学诗的循神网来说也是个奇迹，循神网真是骨骼精奇啊！</p>

<p>另外要说明一下，<code>char-rnn</code>目前是以byte而非utf8的一个word来处理的，神奇的是我几乎没在采样中发现有不符合utf8编码的情况——191首诗里仅有三四首不能正确解码——看来<code>rnn</code>竟然很好地掌握了utf8编码的规律。<code>json</code>格式就更不在话下啦！</p>

<p><code>char-rnn</code>上也有一些utf8 word的<a href="https://github.com/karpathy/char-rnn/pull/12">PR</a>，但因为兼容性问题没被接受，我也照着他们改的地方写了个patch，还有点问题，等调好了之后再跑古诗词的实验，应该会有更有趣的结果。</p>

<h1>其他structed data</h1>

<p>此外，我想到网络数据包也是一种可以用来训练的structed data，所以也用<code>tcpdump</code>抓了一些包做实验。不过需要按照<a href="https://github.com/karpathy/char-rnn/issues/51#issuecomment-129625032">这个issue</a>所说的，稍微改下<code>char-rnn</code>的代码。目前还没跑完训练，等训练完50个<code>epoch</code>后，再来看看采样生成的数据能用<code>tcpdump</code>读取的正确率有多高。</p>

<p>说到非文本的structed data，我还想到了图片、语音和音乐，其中我最感兴趣的还是音乐——各位应该也猜到本乐渣想对音乐下手了吧XD。但是用<code>rnn</code>来训练音乐有一些问题，这也使得它暂时还处于我的脑洞阶段：</p>

<ul>
<li><p>最能反映音乐“原貌”的恐怕还是音频，但是音频文件有不同格式的编解码，并不符合<code>rnn</code>的character-level language model。就好比<a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">Andrej Karpathy那篇博文</a>里所举的“hello”的例子：如果“hello”这个文本被加密过，那么两个连续的“l”很可能被加密函数映射成不同的字符，诸如字母"h"后较大可能跟的是字母“e”这种规律也将失效。音频虽然对聆听者而言最能反映音乐“原貌”，但音频文件本身与音乐“原貌”还相距甚远，或许需要从中提取有用的特征作为数据集，才能体现音乐中的有规律之处。</p></li>
<li><p>不能直接用音频文件，只能退而求其次了。你应该想到一种很古老的将音乐图像化的方式——乐谱——了吧？不过乐谱在我看来还主要是作曲家记谱的工具，用于还原音乐演奏会失真。例如钢琴乐谱上虽然会有踏板记号，但实际演奏时踏板应该踩多深、踩多久？此外乐谱也没有记录下演奏者手指所用的力度等细节，而这些细节往往又是庸才与大师之间的鸿沟。后来我想到一种比乐谱更为精确的方式，那就是<a href="https://en.wikipedia.org/wiki/Piano_roll">纸卷录音</a>。不过目前虽然不乏用纸卷放在自动钢琴上重放而录制的录音，但纸卷本身却很难在网上找到。</p></li>
<li><p>即使有了纸卷这种能较精确还原音乐的载体，还有一个关键问题，那就是如何把这种图像转化成文本，而且这种编解码转换应该是可逆的。我发现，就算对于精确度稍逊的乐谱来说，这种要求也很难实现。Andrej Karpathy那篇博文里提到一篇采用rnn训练音乐的<a href="https://highnoongmt.wordpress.com/2015/05/22/lisls-stis-recurrent-neural-networks-for-folk-music-generation/">文章</a>，里面用了一种很简单的<a href="http://abcnotation.com/blog/2010/01/31/how-to-understand-abc-the-basics/">ABC记谱法</a>来把乐谱转成文本，再把<code>rnn</code>生成的文本转成midi。不过这种记谱法实在是太简陋了，连和弦都无法表示，更遑论多声部的旋律了。</p></li>
</ul>


<p>说到编解码，我还想到上个月听的巴西生物艺术家<a href="http://ekac.org/">Eduardo Kac</a>的一场讲座。其中他早年的一件作品<a href="http://www.ekac.org/geninfo2.html">Genesis</a>给我的印象很深：Kac从《圣经》里摘了一句话“Let man have dominion over the fish of the sea, and over the fowl of the air, and over every living thing that moves upon the earth.”，把它转成莫尔斯码，又把莫尔斯码转换成ACTG序列。他将这段序列植入细菌中，然后邀请观众对细菌施以紫外光照，让细菌产生变异。在展览结束后，Kac把这段变异后的DNA重新转成莫尔斯码，最后再转成英语（编解码过程和结果可以看<a href="http://www.ekac.org/genseries.html">这个网页</a>的前两张图）。 Kac的这个作品给了我一些启发，我也由此开下脑洞：如果把某段DNA序列拿给rnn做训练，采样得到新的DNA序列，那么后者将合成什么样的蛋白质、表现出怎样的性状？这想法太疯狂啦，还好我不是biohacker XD</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Take Tmux Snapshots Automatically (2)]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/08/07/take-tmux-snapshots-automatically-2/"/>
    <updated>2016-08-07T16:12:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/08/07/take-tmux-snapshots-automatically-2</id>
    <content type="html"><![CDATA[<p>还记得本渣以前写的<a href="http://galoisplusplus.coding.me/blog/2014/02/23/take-tmux-snapshots-automatically/">给tmux现场做备胎的脚本</a>吗？其实后来本渣就没再去拓展<a href="https://gist.github.com/yszheda/9138288">这个脚本</a>了，不是因为之前的脚本运行得够好不需要再改了，而是在写好那个脚本那年，有一个工具横空出世，让本渣觉得再也不用造轮子了——好了，不卖关子了，这个工具就是<code>tmux</code>的<a href="https://github.com/tmux-plugins/tmux-resurrect">resurrect插件</a>！</p>

<p>resurrect官方有一个<a href="https://vimeo.com/104763018">使用录屏</a></p>

<iframe src="https://player.vimeo.com/video/104763018" width="640" height="360" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<p><a href="https://vimeo.com/104763018">Tmux Resurrect plugin</a> from <a href="https://vimeo.com/brunosutic">Bruno Sutic</a> on <a href="https://vimeo.com">Vimeo</a>.</p>


<p>怎么样？狂拽酷炫屌！我们想要有的功能基本都有了吧！而且resurrect还部分支持<a href="https://github.com/tmux-plugins/tmux-resurrect/blob/master/docs/restoring_programs.md">恢复panel里运行的程序</a>啊有木有！要知道这并不好实现，以前本渣写备胎脚本时也折腾过，当时还只能在恢复panel时给出上次运行程序的提示。
不过resurrect插件需要手动保存和恢复<code>tmux</code>现场，如果需要自动化的话，可以再配合<a href="https://github.com/tmux-plugins/tmux-continuum">continuum插件</a>来使用。</p>

<p>好了，软文就写到这么多了，下面我们来看看如何安装使用。</p>

<p>首先查看<code>tmux</code>版本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tmux -V</span></code></pre></td></tr></table></div></figure>


<p>resurrect插件需要<code>tmux</code>1.9以上的版本。如果你的版本低于1.9，那么升级是必须的，其实把<code>tmux</code>升级到1.9以上还是蛮推荐的。</p>

<p>这里推荐安装<a href="https://github.com/tmux-plugins/tpm">tpm (Tmux Plugin Manager)</a>做<code>tmux</code>插件管理，再通过<code>tpm</code>安装continuum等插件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm</span></code></pre></td></tr></table></div></figure>


<p>编辑<code>~/.tmux.conf</code>，在文件末尾加入以下几行:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Set default shell to zsh
</span><span class='line'># set-option -g default-shell /bin/zsh
</span><span class='line'>
</span><span class='line'># Use the following line to fix OS X tmux problems
</span><span class='line'># set-option -g default-command "reattach-to-user-namespace -l zsh"
</span><span class='line'>
</span><span class='line'># List of plugins
</span><span class='line'>set -g @plugin 'tmux-plugins/tpm'
</span><span class='line'>set -g @plugin 'tmux-plugins/tmux-sensible'
</span><span class='line'>set -g @plugin 'tmux-plugins/tmux-resurrect'
</span><span class='line'>set -g @plugin 'tmux-plugins/tmux-continuum'
</span><span class='line'>
</span><span class='line'># Other examples:
</span><span class='line'># set -g @plugin 'github_username/plugin_name'
</span><span class='line'># set -g @plugin 'git@github.com/user/plugin'
</span><span class='line'># set -g @plugin 'git@bitbucket.com/user/plugin'
</span><span class='line'>
</span><span class='line'># Enable automatic restore
</span><span class='line'>set -g @continuum-restore 'on'
</span><span class='line'>
</span><span class='line'># Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
</span><span class='line'>run '~/.tmux/plugins/tpm/tpm'</span></code></pre></td></tr></table></div></figure>


<p>如果你的默认shell是<code>zsh</code>，请把这句的注释去掉：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set-option -g default-shell /bin/zsh</span></code></pre></td></tr></table></div></figure>


<p>如果你用的是Mac OSX，把这句的注释也去掉：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set-option -g default-command "reattach-to-user-namespace -l zsh"</span></code></pre></td></tr></table></div></figure>


<p>这主要是<code>tmux</code>在OSX下水土不服（更详细的问题描述可以看这篇文章：<a href="http://www.economyofeffort.com/2013/07/29/reattach-to-user-namespace-the-fix-for-your-tmux-in-os-x-woes/">Reattach-to-user-namespace: The Fix for Your Tmux in OS X Woes</a>），需要用<a href="https://github.com/ChrisJohnsen/tmux-MacOSX-pasteboard">reattach-to-user-namespace</a>黑科技，所以你最好也用<a href="http://www.macports.org"><em>MacPorts</em></a>或者<a href="http://brew.sh"><em>Homebrew</em></a>装下这个工具：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>port install tmux-pasteboard</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install reattach-to-user-namespace</span></code></pre></td></tr></table></div></figure>


<p>在终端下执行以下命令更新<code>tmux</code>配置，运行<code>tpm</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tmux source ~/.tmux.conf</span></code></pre></td></tr></table></div></figure>


<p>最后在<code>tmux</code>下运行<code>prefix + I</code>（如果你没改键绑定的话就是<code>&lt;Ctrl&gt;-b + &lt;Shift&gt;-i</code>）安装插件。你还可以通过<code>prefix + U</code>（<code>&lt;Ctrl&gt;-b + &lt;Shift&gt;-u</code>）更新插件，用<code>prefix + &lt;Alt&gt; + u</code>删除插件。</p>

<p>安装完成之后，你可以在<code>~/.tmux/plugins/</code>里找到每个插件的代码目录。resurrect插件还有一个<code>run_tests</code>脚本用于检查是否安装正确，不过要运行这个脚本需要装上虚拟化神器<a href="https://www.vagrantup.com">vagrant</a>。</p>

<p>如果安装正确，continuum插件会每隔15分钟产生一份备胎，我们也可以用<code>prefix + &lt;Ctrl&gt;-s</code>手动备份，用<code>prefix + &lt;Ctrl&gt;-r</code>手动恢复——vimer吐槽一记，这热键定义得好emacs风&hellip;</p>

<p>下面我们来看看resurrect插件产生的<code>tmux</code>环境备胎。在<code>tmux</code>环境备胎生成之后，在<code>~/.tmux/resurrect/</code>目录下就会有名为<code>tmux_resurrect_$(date).txt</code>的文本文件，同时会有一个叫<code>last</code>的软链接指向最新的<code>tmux_resurrect_$(date).txt</code>。那么这个神秘的txt文件里有啥呢？这里本渣随意贴上一份：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pane    0       0       :apt-fast       1       :*      0       :/home/ys    1       sudo  :sudo apt-fast install linux-image-3.13.0-70-generic-dbgsym
</span><span class='line'>pane    0       1       :~      0       :       0       :/home/ys    1       zsh     :
</span><span class='line'>pane    0       2       :~      0       :-      0       :/home/ys    1       zsh     :
</span><span class='line'>window  0       0       1       :*      c51d,95x28,0,0,0
</span><span class='line'>window  0       1       0       :       c51e,95x28,0,0,1
</span><span class='line'>window  0       2       0       :-      c51f,95x28,0,0,2
</span><span class='line'>state   0</span></code></pre></td></tr></table></div></figure>


<p>啊哈，看起来思路和本渣<a href="https://gist.github.com/yszheda/9138288">之前脚本</a>的<a href="http://galoisplusplus.coding.me/blog/2014/02/23/take-tmux-snapshots-automatically/">思路</a>差不多嘛！只不过resurrect插件记录的信息更详细，还做了键绑定。resurrect的代码也不难懂，如果你对它的实现感兴趣的话可以去阅读一下啦～</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[搭建Docker私有仓库折腾记]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/08/02/setup-private-docker-registry/"/>
    <updated>2016-08-02T02:13:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/08/02/setup-private-docker-registry</id>
    <content type="html"><![CDATA[<p>最近折腾了一些Docker image，为了方便厂里其他人用，于是本渣还得折腾docker-registry搭个内网的Docker私有仓库~</p>

<p>本渣是照着<a href="https://yeasy.gitbooks.io/docker_practice/content/repository/local_repo.html">Docker —— 从入门到实践</a>做的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install -y build-essential python-dev libevent-dev python-pip liblzma-dev
</span><span class='line'>sudo pip install docker-registry</span></code></pre></td></tr></table></div></figure>


<p>不过还需要再安装<code>swig</code>这个软件包才能正常安装<code>docker-registry</code>。</p>

<p>总算安装好了，但在push镜像时出现如下问题：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server gave HTTP response to HTTPS client</span></code></pre></td></tr></table></div></figure>


<p>看了<a href="https://github.com/docker/distribution/issues/1874">Docker Github上这个issue</a>和<a href="http://stackoverflow.com/questions/38695515/can-not-pull-push-images-after-update-docker-to-1-12">SOF上这个问题</a>后才明白，是由于<code>Docker</code>服务默认是采用安全连接HTTPS的，对于我们来讲用HTTPS大可不必，可以照着以下步骤修改：</p>

<ul>
<li>编辑<code>/etc/docker/daemon.json</code>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{ "insecure-registries":["192.168.0.251:5000"] }</span></code></pre></td></tr></table></div></figure>


<ul>
<li>重启Docker服务：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo service docker restart</span></code></pre></td></tr></table></div></figure>


<p>在拉取镜像的机器上也需要做这样的配置才能成功<code>docker pull</code>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[小记「声音的面容」一：后声音艺术与恐惧的情动（affect of fear）]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/07/31/notes-of-visage-acoustique-talks/"/>
    <updated>2016-07-31T23:36:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/07/31/notes-of-visage-acoustique-talks</id>
    <content type="html"><![CDATA[<h1>声音作为解放</h1>

<ul>
<li><p>音乐作为声音艺术的原始阶段</p></li>
<li><p>从音乐到噪音（bruit/noise）：20世纪声音艺术的发端</p></li>
<li><p>音乐——有组织的噪音（organisation du bruit）：</p>

<ul>
<li>雅克·阿塔利(Jacques Attali)《噪音》：「与噪音同生的是混乱和与之相对的世界。与音乐同生的是权力以及与它相对的颠覆。」</li>
</ul>
</li>
<li><p>音乐/噪音之二元对立是不充分的：</p>

<ul>
<li><p>形式/物质？</p></li>
<li><p>权力/抵抗？</p></li>
</ul>
</li>
<li><p>代表人物：</p>

<ul>
<li><p><a href="https://en.wikipedia.org/wiki/Luigi_Russolo">Luigi Rossolo</a>: <strong><a href="https://en.wikipedia.org/wiki/The_Art_of_Noises">《The Art of Noise(1913)》</a></strong></p>

<ul>
<li><p>&ldquo;Music sounds is too limited in its variety of timbres.&rdquo;</p></li>
<li><p>&ldquo;the variety of timbres in noises&rdquo;</p></li>
<li><p>Musical Noise</p></li>
</ul>


<p><iframe width="420" height="315" src="https://www.youtube.com/embed/VcHJySm7ZO0" frameborder="0" allowfullscreen></iframe></p>

<p><iframe width="420" height="315" src="https://www.youtube.com/embed/IC3KMbSkYNI" frameborder="0" allowfullscreen></iframe></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Edgard_Var%C3%A8se">Edgard Varèse</a>: <strong>《The Liberation of Sound》</strong></p>

<ul>
<li><a href="http://www.zakros.com/mica/soundart/s04/varese_text.html">&ldquo;opened up for them the whole mysterious world of sound&rdquo;</a></li>
</ul>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Pierre_Schaeffer">Pierre Schaeffer</a>: <strong>musique concrète</strong></p>

<ul>
<li>铁道练习曲(&ldquo;Étude aux chemins de fer&rdquo; from <a href="https://en.wikipedia.org/wiki/Cinq_%C3%A9tudes_de_bruits">&ldquo;Cinq études de bruits&rdquo;</a>)</li>
</ul>


<p><iframe width="420" height="315" src="https://www.youtube.com/embed/N9pOq8u6-bA" frameborder="0" allowfullscreen></iframe></p>

<ul>
<li>&ldquo;To distinguish an element (to hear [entendre] it in itself, for its texture, its matter, its colour). To repeat it. Repeat the same thing twice, there is music.&rdquo;</li>
</ul>
</li>
</ul>
</li>
</ul>


<h1>声音作为媒介</h1>

<ul>
<li><p>“辨识性媒介”：retransmition</p></li>
<li><p>“幽灵性媒介”：expression</p></li>
<li><p>代表人物：</p>

<ul>
<li><p><a href="https://en.wikipedia.org/wiki/Iannis_Xenakis">Iannis Xenakis</a></p>

<ul>
<li><p><a href="https://en.wikiquote.org/wiki/Iannis_Xenakis">&ldquo;Music is not a language. Any musical piece is akin to a boulder with complex forms, with striations and engraved designs atop and within, which men can decipher in a thousand different ways without ever finding the right answer or the best one&hellip;&rdquo;</a></p></li>
<li><p>model of musical articulation -> control structure -> sound material</p></li>
<li><p>控制 -> 实验 -> 发明</p></li>
</ul>


<p><iframe width="560" height="315" src="https://www.youtube.com/embed/SZazYFchLRI" frameborder="0" allowfullscreen></iframe></p>

<p><iframe width="420" height="315" src="https://www.youtube.com/embed/dqtFGaHcWRk" frameborder="0" allowfullscreen></iframe></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Alvin_Lucier">Alvin Lucier</a></p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/I_Am_Sitting_in_a_Room">I Am Sitting in a Room</a></li>
</ul>


<p><iframe width="560" height="315" src="https://www.youtube.com/embed/fAxHlLK3Oyk" frameborder="0" allowfullscreen></iframe></p>

<p><iframe width="560" height="315" src="https://www.youtube.com/embed/v9XJWBZBzq4" frameborder="0" allowfullscreen></iframe></p>

<ul>
<li>《Music 109》</li>
</ul>
</li>
</ul>
</li>
</ul>


<h1>声音作为本体</h1>

<ul>
<li><p>日本噪音：20世纪声音艺术的终极形态</p></li>
<li><p>声音的“原教旨主义”：</p>

<ul>
<li><p>还原，盲听</p></li>
<li><p>地下，抵抗</p></li>
<li><p>疏离，分裂</p></li>
</ul>
</li>
<li><p>极限的affect：“疼痛”与“晕眩”</p>

<ul>
<li>Mike Goldsmith《Discord: The Story of Noise》</li>
</ul>
</li>
<li><p>“世界肉身”（chair du Monde）：声音作为修补世界的事件</p>

<ul>
<li><p>&ldquo;My body is the texture common to all subjects.&rdquo;</p></li>
<li><p>&ldquo;The body as sensible and the body as sentient&rdquo;</p></li>
</ul>
</li>
<li><p>泛声论：<a href="https://mitpress.mit.edu/books/noise-water-meat">《Noise, Water, Meat: A History of Voice, Sound, and Aurality in the Arts》</a></p></li>
<li><p>Audio-Vision的再联结：<a href="http://sel.fas.harvard.edu/">Sensory Ethnography Lab</a></p></li>
<li><p>Brian Massumi<a href="https://www.dukeupress.edu/ontopower">《Ontopower: War, Powers, and the State of Perception》</a></p></li>
</ul>


<!-- more -->


<p><img src="https://img1.doubanio.com/view/event_poster/raw/public/97b0ef75392ddf9.jpg"></p>

<p>以上摘自姜宇辉老师的主题言说：「后声音艺术与恐惧的情动（affect of fear）」。</p>

<p>姜老师虽然对声音艺术的历史做了清晰的梳理，但个人觉得对于「声音艺术」本身的界定却比较模糊，例如他并没有把「声音艺术」和「音乐」区分开，反而把音乐当作是一种特殊的声音艺术形态，倒是殷漪老师随后厘清了这两者的关系。
殷老师讲的我也大概整理了一下：</p>

<ul>
<li><p>「声音艺术」不单是以「声音」作为素材的艺术。殷老师的理由是：如果以「声音」为素材的作品就是「声音艺术」，那么混音师就可以是声音艺术家了？当然我觉得这只是个比方，实际「声音艺术」作品的界定还要看创作目的，而非简单粗暴的职业划分：通过混音等录音手段制作出来的作品未必就一定不能是声音艺术作品，在某些条件下混音师当然可以是声音艺术家。</p></li>
<li><p>「声音艺术」不仅仅包括了「声音」这个载体，而且还包含「聆听」这种接收方式。当然，古典音乐也强调「聆听」，一位音乐家越是训练有素，一位乐迷的聆听经验越是丰富，就越能从被Rossolo所诟病的有限音色中听出一个无比广阔的世界。不过，后面殷老师的讲述让我意识到这两种「聆听」有着本质的区别。</p></li>
<li><p>「音乐」和「声音艺术」的一大区别是「音乐」对于声音「时间」属性的固执，从而忽视了声音在「空间」上另一面。我觉得殷老师这一点真是戳中了「音乐」的要害：就我个人有限的古典音乐了解而言，sonata、rondo等曲式所包含的反复的元素，正是对声音「时间」上的不可重复性的一种抗拒；作曲家们创作作品基本是从声音「时间」属性来考虑，他们所用的种种和声、旋律、力度、节奏等音乐要素其实也视为为了让随着时间消逝的音乐尽可能丰满。（当然也有对音乐空间性敏感的作曲家，施托克豪森就是其中之一。《群（Gruppen）》是他广为乐迷们所知的一首“神曲”，这首乐曲将管弦乐团拆为三组，分置于听众的左右和前方。但像这种注重音响空间感的作品和作曲家并不多。）相较作曲家而言，反而是演奏者和听众对于音乐的「空间」属性更为敏感一些：优秀演奏家能够对演出场合中声音传播的特点，调整自己演奏的方式（例如我印象中有人在讲Horowitz的现场演奏时提到，霍老或许有意让那些花了大价钱坐前排的、不懂音乐附庸风雅的富豪权贵们听得很“糊”很“炸”，而让经济上不太宽裕、因而坐在后面的音乐爱好者们更能听出自己指下音乐中清晰的层次）；经验丰富的乐迷或者音响发烧友也会注意到演出场所影响音乐传播的空间性质，在他们的论坛上我们也常常可以看到诸如“音质干”“残响时间不够长”这类评语。不过，这些对「空间」的关注仍然只是次要的。「音乐」和「声音艺术」这两者由于上面所提到的「聆听」方式的差异，导致在它们对待声音的「空间」属性方面也不尽一致。</p></li>
<li><p>殷老师从上述角度出发，重新解读了Lucier的作品“I Am Sitting in a Room”。殷老师的解读给我很多启发，让我对上述问题又有了更进一步的理解。</p>

<ul>
<li><p>在此之前，我个人一直把“I Am Sitting in a Room”这样的作品理解为录音和回放过程中AD/DA转换导致的失真，而殷老师却把它解读为：在录音过程中，记录下的不仅仅是Lucier所说的话，而且还有同时同地的回荡在空间的声音，Lucier通过不断进行录音和回放，后者被逐渐放大。殷老师这一解读真是让我恍然大悟，觉得自己之前的观点实在是太狭隘了。这也让我发现，「音乐」和「声音艺术」在「聆听」方式的差别，在于它们有着截然不同的价值观。在前者的世界中，声音仍然有着等级秩序的，所以带着「音乐」思维的聆听者，无论他听出多少细节，对于声音仍然带着优劣判断去取舍的；而在「声音艺术」看来，众声平等，「声音艺术」思维的聆听者关注被大家忽略的声音——表面上看和敏感的音乐听者相似，但他们并不会因为某些声音是无意义的噪音就将它们舍弃。站在这一立场，殷老师也认为Lucier在做这个作品时采取了种种「隔音」措施，其实还是没有摆脱传统聆听音乐的观念。</p></li>
<li><p>殷老师对Lucier的这个作品的另一点批判是Lucier采用了乐谱的方式。对于古典音乐而言，记谱法确实密不可分，而且在一定程度上成为了一种桎梏。然而，我个人觉得Lucier记录乐谱并不意味着他没有摆脱记谱法的束缚。就像杜尚把他的“泉”拿去送展并不表明他屈从于美术馆体制一样，我倾向于把Lucier的记谱看成是他的作品中一种对记谱法的反讽，正如Cage的4'33'&lsquo;也记下了乐谱，但却绝非「遵从乐谱」「忠实作曲家原意」的传统思潮所理解的作曲家指示。</p></li>
</ul>
</li>
<li><p>「声音艺术」的起源除了「音乐」，还有「当代艺术」。这一点很重要，可惜两位老师没能就这一点展开讲下去。</p></li>
</ul>


<p>还有，殷老师认为姜老师前面所提到的声音艺术作品对他来说都是音乐——哈哈，殷老师有点夸张，不过像Varèse在我的概念中确实是古典音乐作曲家——姜老师便请殷老师介绍一些他所认为的声音艺术作品，殷老师举了几个例子：</p>

<ul>
<li><p>Max Neuhaus的Field Trips Through Found Sound Environments</p></li>
<li><p>Susan Philipsz的<a href="http://weibo.com/ttarticle/p/show?id=2309403998997307086157">You Are Not Alone</a>，这个作品正好最近在OCAT展出。</p></li>
</ul>


<p>当然了，以上只是我个人一些夹杂私货的整理，想必<a href="http://www.ocatshanghai.com/">OCAT官方</a>未来应该会有翔实的讲座记录发表。<del>只不过官方的拖延症好像比我严重得多XD</del></p>

<p>对了，去年王婧老师在“Agora广场”做了一次<a href="http://weibo.com/p/1001603859473541259173">「声音视觉化」的主题言说</a>，王老师提到一个关于声音艺术的网站<a href="http://www.sonorouspresence.org/">Sonorous Presence</a>，介绍声音艺术的中文网站似乎不多，在这里也强烈安利一下哈！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Docker容器来生成quick-x/cocos2d-x游戏apk包]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/07/28/dockerfile-for-building-quickx-apk/"/>
    <updated>2016-07-28T02:13:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/07/28/dockerfile-for-building-quickx-apk</id>
    <content type="html"><![CDATA[<p>前段时间本渣在做服务器端开发时，采用了<code>Docker</code>作为解决方案的一部分，最初的动机主要是想用<code>namespace</code>做环境隔离、用<code>cgroups</code>做资源限制，却也切身体会到<code>Docker</code>所带来的构建上的便利。故而本渣也回头去想之前cocos2d-x客户端的开发工作是否也能<code>Docker</code>化，很快就找到了一个很适合采用<code>Docker</code>的场景，那就是打apk包。从之前<a href="http://galoisplusplus.coding.me/blog/2014/08/03/customize-dev-environment-for-cocos2d-x/">搭建cocos2d-x游戏开发环境的博文</a>中不难发现，要搭建打包环境特别麻烦，不仅需要下一堆软件包，而且安装Android SDK和NDK时还会遇到GFW的问题。也正是因为这个缘故，我们团队只有最开始的三位老司机在开发机上搭好了这套环境，之后陆陆续续来的新人都没做过这项工作，所以平时打包也基本是在这几台开发机上。这简直太应该<code>Docker</code>化了！有了一套配好打包环境的<code>Docker</code> image，再也不用担心小鲜肉跑来要求打包、占用开发机了！而且还可以扔到服务器上去做，多省心啊！想想就excited，于是本渣马上就折腾起<code>Dockerfile</code>来了！</p>

<p>首先要确定基础镜像。本渣一开始以为，配置<code>Linux</code>下的cocos2d-x打包环境需要在执行cocos2d-x代码里的<code>build/install-deps-linux.sh</code>，而这个脚本需要用到<code>Debian</code>系的包管理器，所以就选了<code>Ubuntu</code>作为基础镜像。</p>

<p>配置apk打包环境自然少不了下载需要的软件包。<code>Ubuntu</code>的<code>apt-get install</code>会询问用户是否安装软件包，在<code>Dockerfile</code>中需要把这一交互性去掉，最好采用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get install -y</span></code></pre></td></tr></table></div></figure>


<p>有些人喜欢把<code>DEBIAN_FRONTEND</code>设成<code>ENV</code>，这样<code>ENV</code>下面的命令就不用重复打<code>DEBIAN_FRONTEND=noninteractive</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ENV DEBIAN_FRONTEND noninteractive
</span><span class='line'>RUN apt-get install -y</span></code></pre></td></tr></table></div></figure>


<p>但根据<a href="https://medium.com/@rlbaker/deploying-python-with-docker-15a472cf12a5#.5vl6ihty3">Deploying Python with Docker</a>的说法，这种做法是不推荐的，因为这会影响到容器使用，最好还是对每条需要的命令单独设置环境变量。</p>

<p>安装的几个软件包中少不了<code>Java</code>，我用的是Oracle的而非<code>openjdk</code>，所以需要用<code>add-apt-repository</code>把Oracle的ppa加上，这又需要先安装<code>add-apt-repository</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 更新软件包列表
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get update -qq
</span><span class='line'>
</span><span class='line'># 安装add-apt-repository
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get -y install python-software-properties software-properties-common
</span><span class='line'>
</span><span class='line'># 安装Oracle Java
</span><span class='line'>RUN echo "debconf shared/accepted-oracle-license-v1-1 select true" | debconf-set-selections
</span><span class='line'>RUN echo "debconf shared/accepted-oracle-license-v1-1 seen true" | debconf-set-selections
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive add-apt-repository ppa:webupd8team/java \
</span><span class='line'>    && apt-get update -qq
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get -y oracle-java6-installer</span></code></pre></td></tr></table></div></figure>


<p>打包还需要<code>ant</code>、之后下载SDK等需要<code>wget</code>或<code>curl</code>，这些软件包可以写在这句<code>apt-get -y</code>后面，因为我们不希望<code>Docker</code> image有太多layer。</p>

<p>接下来就是下载Android SDK和设置相应的环境变量了。Android SDK和NDK的google下载链接是被墙的，可以换成国内相关镜像的链接。本渣是先下好这些包，然后在我们内网nginx起了一个简单的静态页面，我们内部再通过这个页面去下载就灰常快了XD</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Install Android SDK
</span><span class='line'>ENV ANDROID_SDK_ROOT /opt/android-sdk-linux
</span><span class='line'>
</span><span class='line'>RUN cd /opt && wget -q https://dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz \
</span><span class='line'>    && tar -zxvf android-sdk.tgz \
</span><span class='line'>    && rm -f android-sdk.tgz
</span><span class='line'>
</span><span class='line'>ENV PATH ${PATH}:${ANDROID_SDK_ROOT}:${ANDROID_SDK_ROOT}/tools
</span><span class='line'>
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter platform-tools | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter extra-android-support | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter android-20 | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter build-tools-20.0.0 | grep 'package installed'</span></code></pre></td></tr></table></div></figure>


<p>如果你需要用代理来绕过GFW，可以这么写：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># NOTE: google is blocked by GFW in China,
</span><span class='line'># So I use the proxy: http://android-mirror.bugly.qq.com:8080.
</span><span class='line'># You can remove `--proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s`
</span><span class='line'># in the following commands if you don't have to worry about this issue.
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter platform-tools --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter extra-android-support --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter android-20 --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter build-tools-20.0.0 --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'</span></code></pre></td></tr></table></div></figure>


<p>接下来就是安装Android NDK了，和SDK差不多。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Install Android NDK
</span><span class='line'>ENV ANDROID_NDK_ROOT /opt/android-ndk-r10e
</span><span class='line'>ENV NDK_ROOT /opt/android-ndk-r10e
</span><span class='line'>
</span><span class='line'>RUN cd /opt && wget -q http://dl.google.com/android/repository/android-ndk-r10e-linux-x86_64.zip -O android-ndk.zip \
</span><span class='line'>    && unzip -q android-ndk.zip \
</span><span class='line'>    && rm -f android-ndk.zip
</span><span class='line'>
</span><span class='line'>ENV PATH ${PATH}:${ANDROID_NDK_ROOT}</span></code></pre></td></tr></table></div></figure>


<p>最后别忘了清理安装的软件包：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUN apt-get clean</span></code></pre></td></tr></table></div></figure>


<p>到了这一步，本渣就可以先把<code>Docker</code> image构建起来，把cocos2d-x代码、quick-x代码和客户端代码作为host的三个volumn挂载到<code>Docker</code> container里了。经试验发现还需要做如下配置：</p>

<ul>
<li><p>在<code>PATH</code>里加入<code>cocos2d-console/bin</code>的目录才能使用<code>cocos</code>命令。</p></li>
<li><p><code>cocos2d-console</code>需要安装<code>python</code>。</p></li>
<li><p>需要把quick-x代码所在目录配在<code>QUICK_V3_ROOT</code>环境变量中。</p></li>
<li><p>quick-x用到<code>php</code>，需要安装。</p></li>
<li><p>需要装上32位系统的软件包<code>lib32stdc++6</code>和<code>lib32z1</code>才能正常打包。</p></li>
</ul>


<p>于是本渣就可以相应地在<code>Dockerfile</code>中继续添加了，虽然试验的过程有点繁琐，但可以保证生成的<code>Docker</code> image只包含需要的软件包，让image尽可能小。</p>

<p>接下来就是如何继续优化了，例如以上需要从host挂载cocos2d-x代码和quick-x代码的volumn还是比较烦。其中我们完全没必要把整份cocos2d-x代码挂载进来，因为创建cocos2d-x项目时会把需要的源代码文件拷到项目目录里，所以我们只需要其中的<code>cocos2d-console</code>，配置好<code>cocos</code>所在的目录到环境变量<code>PATH</code>即可。最后我把<code>cocos2d-console</code>和<code>quick-x</code>的代码打包，放到之前的内网网页中，这样就有了一份只需要挂载项目代码目录就能进行apk打包的<code>Dockerfile</code>啦！</p>

<p>还记得前面所提到的cocos2d-x代码里的<code>build/install-deps-linux.sh</code>脚本吗？其实这个脚本还是有交互，所以我也把它所实现的功能挪到了<code>Dockerfile</code>中，其实也不外乎用<code>apt-get</code>下载一些软件包和下载<code>glfw</code>编译安装罢了。既然这个脚本并非必须，那么基础镜像也就不一定非要<code>Debian</code>系的系统了，小巧的<code>Alpine</code>无疑才是更理想的基础镜像。不过，目前我们主要是内网开发用，还没有压缩<code>Docker</code> image体积的需求，本渣也就不打算重新用<code>Alpine</code>折腾一遍了XD</p>

<p><strong>Update:</strong></p>

<p>我把一份通用的<code>Dockerfile</code>放到了<a href="https://github.com/yszheda/quick-x-apk-docker">Github</a>上，你也可以在Docker Hub拉取对应的<code>Docker</code>镜像：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker pull galoisplusplus/quick-x-apk-docker</span></code></pre></td></tr></table></div></figure>


<p>这一<code>Docker</code>镜像对不采用quick-x的cocos2d-x游戏打包也是可以用的，只需要把<code>Dockerfile</code>中quick-x的部分去掉后进行构建即可。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OpenResty折腾记]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/07/24/my-first-openresty-journey/"/>
    <updated>2016-07-24T11:22:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/07/24/my-first-openresty-journey</id>
    <content type="html"><![CDATA[<p>前面几篇文章稍稍提到本渣最近接手了一个server端开发的活，这次就来碎碎念一下好了。虽然我们server端用<code>OpenResty</code>，和client端一样主要也是用<code>lua</code>开发，不过实在也不是本渣谦虚，本渣一个client端码农，肿么就被叫去写server端代码捏？<del>是因为组织上对本渣的信任。</del>是因为啊，我们server端想要实现战斗这块功能。而这块功能呢，恰好client端已经实现过。本渣嘛，又承担过不少战斗功能的开发工作。所以组织上说，既然你以前在client端挖过不少这种坑，那么server端的坑也由你来挖吧？于是本渣就<del>念了两句诗</del>接了这活。</p>

<p>本渣从一开始接手开始，就打定主意直接在server端重用client端的战斗功能代码。一方面是因为本渣很懒，已经实现过的轮子不想再造一遍；另一方面是因为我们client端的这块代码仍在迭代中，会不时上一些新类型的战斗玩法，如果server端再重新实现一遍，以后还得把client端新的改动也搬过来，这不仅不好维护，而且又是翻倍的工作量。最好就是把client端的战斗功能代码当做server端代码的一个submodule，client端有改动的话就直接pull下更新来使用。client端的这部分代码虽然也是<code>lua</code>写的，但要重用的话有个问题：我们client端用了<code>cocos2d-x</code>和<code>quick-x</code>，但server端只是个Web API Server，最好避免引入<code>cocos2d-x</code>和<code>quick-x</code>的<code>C++</code> API、以及<code>Node</code>之类的view（嗯，MVC的view）相关对象。好在最开始做战斗的大神设计得当，把战斗功能划分为战斗计算模块和战斗表现模块——前者计算出手先后、技能释放、buff和属性值改变等等，生成战报；后者再根据前者所生成的战报，播放相应的特效动画和人物动作——等到半年后本渣接手时，为了实现独立的战报播放功能，又把这块代码重构了，去掉了两个模块之间的耦合，所以战斗计算模块基本是独立于<code>cocos2d-x</code>和<code>quick-x</code>的<code>C++</code>代码、与view完全无关的纯<code>lua</code>实现。本渣只需要再补上<code>quick-x</code>中一些如<code>math.round</code>的全局函数的定义，很快就能在server端跑通了，但是新的问题又来了：</p>

<ol>
<li><p>有一定概率出现全局函数没有定义的错误，但是在代码里，这些全局函数在定义后并没有被修改。</p></li>
<li><p>在用<code>nginx</code> start或reload的方式创建新的<code>nginx</code> worker进程后，第一次访问有很大概率会失败。</p></li>
</ol>


<p>由于本渣是第一次接触<code>OpenResty</code>，这些问题一开始让本渣丈二和尚摸不着头脑，后来才渐渐理清了头绪。
前一个问题与<code>OpenResty</code>的code cache有关。本渣在<code>nginx</code>配置里打开了code cache：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lua_code_cache on</span></code></pre></td></tr></table></div></figure>


<p>而全局函数的使用是通过<code>nginx</code> content阶段的<code>lua</code>代码<code>require</code>加载定义这些全局函数的文件的。根据<code>OpenResty</code>官方对于code cache的说明，只有最开始运行的LuaVM才会去真正加载这些文件，执行那些定义全局函数的代码，所以这些全局函数只有在该LuaVM所在的进程里是被定义的。此后，如果请求被同一个<code>nginx</code> worker处理，则可以正常使用之前定义的全局函数；但如果请求被分到不同的worker，就会出现变量没有定义的报错。</p>

<p>至于后一个问题，本渣观察到：在第一次访问时，<code>nginx</code> worker的CPU使用量飙升，一定概率导致server端响应时间超过设置的timeout时间，从而被client端认为是超时。
后来本渣继续缩小问题的排查范围，最后将它定位到client端读取并处理策划表的代码上。由于策划表的数据量大，所以这部分代码运行起来比较耗时倒也不奇怪。而前面提到code cache打开时，被<code>require</code>的文件只加载一次，这些处理策划表的代码也只有第一次才被真正运行，所以看到的现象就是第一次的请求会经常失败了。</p>

<p>前一个问题与全局函数有关，本渣看到不少<code>OpenResty</code>前辈提到<a href="https://segmentfault.com/a/1190000004297908">要避免使用全局变量</a>：</p>

<blockquote><p>一般来说，在ngx_lua的上下文中使用Lua全局变量真的不是什么好主意：</p>

<ol>
<li><p>滥用全局变量的副作用会对并发场景产生副作用，比如当使用者把这些变量看作是本地变量的时候；</p></li>
<li><p>Lua的全局变量需要向上查找一个全局环境（只是一个Lua表），代价比较高；</p></li>
<li><p>一些Lua的全局变量引用只是拼写错误，这会导致出错很难排查。</p></li>
</ol>
</blockquote>

<p>其中一个重要原因是会对并发场景产生副作用，本渣以前入过并行程序的坑，对这一点是不能同意更多的。不过回头来看我们client端代码里的那些全局“变”量，其实都是全局常量，不仅值不会被改变，而且我们代码中只会对这些常量执行一次赋值操作（当且仅当它们被定义时），这就不存在并发的副作用问题了。对于全局变量访问开销大的问题，本渣写了个脚本，在代码文件开头对使用到的全局变量<code>local</code>化（例如<code>local XXX = require('XXX')</code>）。拼写错误引发的bug嘛，本渣之前在<a href="http://galoisplusplus.coding.me/blog/2016/03/12/svn-precommit-hook/">svn hook</a>加了检查，所以在开发过程中提交代码就能及时发现问题。逐条分析下来，倒是命名空间污染不可避免，但是我们server端和client端的代码是完全独立的，命名空间污染并不会引发什么问题。当然严格一点，还是可以把client端涉及到的全局常量全部改成<code>local</code>的，写个脚本来处理所有代码也不难。<del>但处理问题要灵活嘛，既然在具体场景里无关紧要为啥还要迷信教条多此一举？嘿嘿，本渣就是这么懒XD</del>不过本渣考虑到client端这块代码仍在持续开发新的功能，这样做会给client端码农的开发带来限制：“喂，大熊弟，乃们的代码server端也要跑的哦，以后不能用全局常量了！”“WTF！”。这种节奏就不太理想了，本渣希望server端的代码重用对client端而言是透明的，client端的大熊弟在挖坑时可以完全无视server端战斗功能的存在：“server端关我鸟事，老子该干嘛还干嘛！”所以i呢，本渣放弃了去掉全局常量的治疗，最终选择在保留client端全局常量的前提下去解决它所带来的问题。</p>

<p>本渣最后解决前面提到的两个问题的黑科技是：把<code>require</code> client端代码的部分从<code>nginx</code>的content阶段，挪到了<code>nginx</code> lua module的init阶段：</p>

<p><img src="https://cloud.githubusercontent.com/assets/2137369/15272097/77d1c09e-1a37-11e6-97ef-d9767035fc3e.png"></p>

<p>init阶段会在<code>nginx</code> master进程加载<code>nginx</code>配置时执行，之后才由master进程clone出worker进程。全局常量放在这个阶段初始化，就不会有某些worker进程没有定义全局变量的报错；处理策划表的代码放在这个阶段执行，就把CPU开销转移到加载<code>nginx</code>配置上，不会增加请求的响应时间，可谓是一石二鸟。</p>

<p>有了一个可行的prototype，接下来本渣最关心的就是性能问题了：毕竟是第一次搞<code>OpenResty</code>，没啥经验，万一上线后server不堪重负挂了呢？不过我们做server端的老司机们都对自己开的车很自信，之前从没有写过测试代码，所以单接口压力测试还得本渣这server端小白自行琢磨啦。压测工具中，<code>Apache</code>的<code>ab</code>还是挺好上手的，输出的信息也很好分析。不过本渣也犯过傻：有一次正和小伙伴吹牛逼呢，说压测出来性能特别棒，一细看就打脸了，原来都是Non-200 response&hellip;&hellip;HTTP code为啥不是200捏？原来本渣是通过写client端<code>lua</code>代码来获取POST参数的，本渣的这段代码有bug，导致POST的参数有误。后来bug改掉了，结果小伙伴一脸鄙夷：乃不是可以看server端的access log吗？干嘛非要在client端写代码获取POST参数？&hellip;&hellip;好吧，开森就好&hellip;&hellip;<code>ab</code>做压测有个问题，就是POST参数是固定的，但本渣想用不同的战斗来压测自己那块功能，需要让不同请求的POST参数各不相同。最后本渣找到了<a href="https://github.com/wg/wrk"><code>wrk</code></a>这个压测工具。<code>wrk</code>最吸引本渣的，是它支持<code>lua</code>编程，普大喜奔啊！本渣这个懒人又可以重用client端的<code>lua</code>代码了！XDD</p>

<p>压测结果有了，但要知道性能热点才好对症下药做优化啊。这个时候本渣找到了春哥写的<a href="https://github.com/OpenResty/nginx-systemtap-toolkit">SystemTap脚本</a>和<a href="https://github.com/brendangregg/FlameGraph">火焰图工具</a>，这套工具简直是profile神器啊有不有！本渣之前也折腾过cocos2d-x游戏client端的profiler，万万没想到还有内核trace这种玩法！借助春哥所介绍的On-CPU和Off-CPU火焰图，本渣改进了一些问题，例如某些不被<code>luajit</code>支持的函数，会被<code>luajit</code>解释执行，在火焰图中会有<code>lj_xxx</code>的frame。这时候可以看看这些函数能否换成<code>luajit</code>支持的函数，像本渣就发现我们client端代码里有不少用<code>pairs</code>的地方，其实应该把相应的<code>lua table</code>设计成array而非hash table，采用<code>ipairs</code>来遍历。</p>

<p>在做压测和做火焰图的时候还发生过意外，有次<code>nginx</code> worker进程占满CPU，把开发server卡死了。分析下来是因为某个testcase使client端的战斗计算一直没有达到结束条件，死循环了。这倒也不奇怪，因为我们client端的战斗按照策划大大们的需求就是支持无限回合的。那为虾米在client端不会出现战斗计算死循环导致机器卡死呢？前面提到client端有战斗计算模块和战斗表现模块，这是一个典型的producer-consumer模型：战斗计算模块是producer，生产出若干回合的战报交给战斗表现模块，然后挂起；战斗表现模块是consumer，“消费”当前尚未播放的战报，同时接收玩家的操作信息，转交给战斗计算模块进行新回合的计算。也就是说，这两者总是相继运行的。而server端不存在战斗表现模块，战斗计算模块全部算完后就返回所有回合的战报，所以server端会有卡死问题而client端木有。这个问题大家讨论下来，最后策划大大决定在server端战斗加上战斗最大回合数限制，避免死循环。现在理论上没问题了，但本渣还是不放心：万一哪天代码有个bug会触发死循环呢？一出现问题就搞个大新闻，影响到整台机器，后果很严重啊！本渣首先想到把server端拆成一般业务server和战斗server，把两者隔离开，万一战斗出现问题，其他业务仍可以正常运作；然后对战斗server的<code>nginx</code> worker进程要有资源限制，不能让它们拖垮整台机器。最后采用的大杀器也许你已经猜到了，那就是<code>Docker</code>！采用<code>Docker</code>可以很方便地用<code>namespace</code>做环境隔离、用<code>cgroups</code>做资源限制，而且<code>Docker</code> container本质上是host机的进程，不会有虚拟机的性能降级。</p>

<p>敲定了这一解决方案，接下来的挖坑工作就顺理成章分成了两块：一个是如何把我们server端<code>Docker</code>化，另一个是业务server和战斗server如何协作。前者可以被<code>Docker</code>化的有<code>OpenResty</code>的<code>nginx</code>进程、<code>MySQL</code>和<code>redis</code>实例，好在<code>OpenResty</code>、<code>MySQL</code>和<code>redis</code>都有现成的<code>Docker</code>镜像，只需要稍做修改，就可以用到我们这套server端代码上。
<code>Docker</code>的构建实在太方便了，本渣也趁着把server端<code>Docker</code>化的时候，简化搭建开发server的流程。中间为了解决自动化快速备份现有数据库数据作为开发server数据的问题，折腾了一阵，学到不少东西，不过像<code>MySQL</code> <code>InnoDB</code>等技术细节还是得找时间扫盲一下～
至于后者，由于一般业务server和战斗server采用的是同一套代码（只是<code>nginx</code>配置稍有不同，本渣折腾配置时还踩过<code>nginx</code> <code>if</code>的坑，<a href="https://moonbingbing.gitbooks.io/OpenResty-best-practices/content/ngx/if_is_evil.html">“if is evil”</a>啊！），访问的是同样的<code>MySQL</code>和<code>redis</code>实例，所以只需要考虑这样一个问题：client端在连上一般业务server后，一般业务server如何把战斗相关的请求转给战斗server来处理？<a href="https://moonbingbing.gitbooks.io/OpenResty-best-practices/content/OpenResty/how_request_http.html">《Openresty最佳实践》</a>介绍了两种最常见的HTTP接口调用方法：</p>

<ol>
<li><p><code>proxy_pass</code></p></li>
<li><p><code>cosocket</code></p></li>
</ol>


<p>这两种方式本渣都折腾过了，最后采用了<code>proxy_pass</code>的方式。因为本渣考虑到以后可能会出现战斗server集群的情况，采用<code>proxy_pass</code>可以方便在<code>nginx</code>配置的<code>upstream</code>中配置多个战斗server，做load balance，可拓展性更好。加上我们启动战斗server其实只需要创建新的<code>Docker</code>容器，这整套方案可以很容易scale上去。当然，我们游戏目前的访问量还远不需要集群去撑，考虑集群似乎有杀鸡用牛刀之嫌，不过梦想总是要有的，万一我们游戏火了呢XD</p>

<p>嗯，最近就做了这么一点微不足道的工作，本篇也没什么干货，谢谢大家！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nginx Tips]]></title>
    <link href="http://yszheda.github.io/blog/blog/2016/07/19/nginx-tips/"/>
    <updated>2016-07-19T11:22:00+08:00</updated>
    <id>http://yszheda.github.io/blog/blog/2016/07/19/nginx-tips</id>
    <content type="html"><![CDATA[<p>最近在做server端开发，需要熟悉nginx，本渣也就在这里记录下自己遇到的一些问题。其实都比较小白，纯粹当作自我扫盲啦XD 本文将不定期更新。</p>

<h1>nginx: [emerg] bind() to \&lt;ip>:\&lt;port> failed (98: Address already in use)</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nginx: [emerg] bind() to &lt;ip&gt;:&lt;port&gt; failed (98: Address already in use)</span></code></pre></td></tr></table></div></figure>


<p>端口被占用，可以用查看使用文件或socket的命令<code>fuser</code>来杀掉占用端口的进程：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo fuser -k &lt;port&gt;/tcp</span></code></pre></td></tr></table></div></figure>


<p>此外，如果使用IPv6还可能出现如下报错：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nginx: [emerg] bind() to [::]:&lt;port&gt; failed (98: Address already in use)</span></code></pre></td></tr></table></div></figure>


<p>这是由于<code>nginx</code>配置中有<code>listen &lt;port&gt;;</code>，又有<code>listen [::]:&lt;port&gt;;</code>所致。
根据<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#listen">nginx文档</a>的描述：</p>

<blockquote><p>By default, nginx will look up both IPv4 and IPv6 addresses while resolving.</p></blockquote>

<p>也就是说，<code>listen [::]:&lt;port&gt;;</code>会同时监听IPv4和IPv6的流量，所以<code>listen &lt;port&gt;;</code>是重复配置，将它删掉即可。
如果只想使用IPv6可以采用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen [::]:&lt;port&gt; ipv6only=on;</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>

<p><a href="http://stackoverflow.com/questions/14972792/nginx-nginx-emerg-bind-to-80-failed-98-address-already-in-use">(SOF) nginx - nginx: [emerg] bind() to [::]:80 failed (98: Address already in use)</a></p>

<h1>worker_connections are more than open file resource limit: 1024</h1>

<p>这是因为nginx worker的用户打开的文件超过上限。</p>

<p>如果nginx配置中有<code>worker_rlimit_nofile</code>参数，则打开的文件数量上限由<code>worker_rlimit_nofile</code>决定（nofile=number of open files）。
那么<code>worker_rlimit_nofile</code>应该配多少呢？</p>

<p>在nginx配置的core module中找到<code>worker_processes</code>数量：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>worker_processes  4;</span></code></pre></td></tr></table></div></figure>


<p>在event module中找到<code>worker_connections</code>数量：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>events {
</span><span class='line'>    worker_connections  1024;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>那么最大总连接数是<code>worker_connections * worker_processes</code>，每个active connection都会占用一个文件描述符（file descriptor），所以<code>worker_rlimit_nofile</code>最好大于<code>worker_connections * worker_processes</code>。</p>

<h2>参考</h2>

<p><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile">nginx worker_rlimit_nofile文档</a></p>

<p><a href="http://serverfault.com/questions/208916/understanding-max-file-descriptors-for-linux-and-nginx-and-best-value-for-worke">(SOF) understanding max file descriptors for linux and nginx, and best value for worker_rlimit_nofile</a></p>

<p><a href="http://serverfault.com/questions/209014/how-can-i-observe-what-nginx-is-doing-to-solve-1024-worker-connections-are-n">(SOF) How can I observe what nginx is doing? (to solve: “1024 worker_connections are not enough”)</a></p>

<p>如果nginx配置中没有<code>worker_rlimit_nofile</code>参数，则采用系统默认的打开的文件数量上限。那么如何查看并修改这一上限呢？</p>

<p>首先在nginx配置的core module中找到nginx worker进程的用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user nginx;</span></code></pre></td></tr></table></div></figure>


<p>在终端登入这一用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo su - nginx</span></code></pre></td></tr></table></div></figure>


<p>查看文件描述符的硬上限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ulimit -Hn</span></code></pre></td></tr></table></div></figure>


<p>查看文件描述符的软上限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ulimit -Sn</span></code></pre></td></tr></table></div></figure>


<p>这里硬上限是严格不能超过的上限，不能增加。软上限属于警告性质的上限，可以调高，但也不能超过硬上限。</p>

<p>在<code>/etc/sysctl.conf</code>中修改下述数值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fs.file-max = 65536</span></code></pre></td></tr></table></div></figure>


<p>使用以下命令加载新的配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>检查是否已更新：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /proc/sys/fs/file-max</span></code></pre></td></tr></table></div></figure>


<p>一些资料提到修改<code>/etc/security/limits.conf</code>中nofile的软上限和硬上限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* soft     nofile         65535
</span><span class='line'>* hard     nofile         65535
</span><span class='line'>root soft     nofile         65535
</span><span class='line'>root hard     nofile         65535</span></code></pre></td></tr></table></div></figure>


<p>这种方式至少需要nginx worker进程重启才能生效。</p>

<h2>参考</h2>

<p><a href="http://ss64.com/bash/ulimit.html">ulimit manual</a></p>

<p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/index.html">通过 ulimit 改善系统性能</a></p>

<p><a href="http://stackoverflow.com/questions/3107476/what-does-soft-hard-nofile-mean-on-linux">What does “soft/hard nofile” mean on Linux</a></p>

<p><a href="http://unix.stackexchange.com/questions/29577/ulimit-difference-between-hard-and-soft-limits">ulimit: difference between hard and soft limits</a></p>

<p><a href="http://ss64.com/bash/limits.conf.html">limits.conf manual</a></p>

<p><a href="http://www.cyberciti.biz/faq/making-changes-to-proc-filesystem-permanently/">Making changes to /proc filesystem permanently</a></p>

<p><a href="http://serverfault.com/questions/640976/nginx-ulimit-worker-connections-exceed-open-file-resource-limit-1024">nginx uLimit &lsquo;worker_connections exceed open file resource limit: 1024&rsquo;</a></p>

<p><a href="http://unix.stackexchange.com/questions/108603/do-changes-in-etc-security-limits-conf-require-a-reboot">do changes in /etc/security/limits.conf require a reboot?</a></p>

<p><a href="http://serverfault.com/questions/165316/how-to-configure-linux-file-descriptor-limit-with-fs-file-max-and-ulimit">How to configure linux file descriptor limit with fs.file-max and ulimit</a></p>

<p><a href="http://stackoverflow.com/questions/21515463/how-to-increase-maximum-file-open-limit-ulimit-in-ubuntu">How to increase maximum file open limit (ulimit) in Ubuntu?</a></p>

<p><a href="http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files/">Nginx: 24: Too Many Open Files Error And Solution</a></p>

<h1>an upstream response is buffered to a temporary file</h1>

<h1>proxy_temp failed (13: Permission denied) while reading upstream</h1>
]]></content>
  </entry>
  
</feed>
