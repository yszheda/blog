
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Galoisplusplus</title>
  <meta name="author" content="Galoisplusplus">

  
  <meta name="description" content="">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yszheda.github.io/blog/posts/2">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Galoisplusplus" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <!--
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  -->
  <script src="//libs.baidu.com/jquery/1.7.2/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  
<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="http://fonts.googleapis.com/css?family=Crimson+Text:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Galoisplusplus</a></h1>
  
    <h2>A fan of science, technology and Classical music.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yszheda.github.io/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/10/10/Le-Jardin-des-Voix/">Le Jardin Des Voix演前碎碎念及曲目歌词</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-10T02:13:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"></div>
  
  
    <footer>
      <a rel="full-article" href="/blog/blog/2016/10/10/Le-Jardin-des-Voix/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/09/11/notes-of-visage-acoustique-talks-2/">小记「声音的面容」二：当代艺术的“音”与“乐”</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-09-11T23:36:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>John Cage&rsquo;s 4'33''</h1>

<ul>
<li><p>演奏前的演奏者感言：「构成音乐的元素，是声音和沉默。二者综合起来，就是作曲。我有一句“无言”要说，我现在正要说了&hellip;&hellip;」</p></li>
<li><p>John Cage: &ldquo;Everything we do is music.&rdquo;</p></li>
<li><p>1952年8月29日，Irwin Kremen首演4'33'&lsquo;。</p></li>
<li><p>1954年David Tudor复演4'33'&lsquo;：观众有了心理准备，观众的噪音少了，但环境噪音尤在。</p></li>
</ul>


<h1>音与乐的启示</h1>

<h2>日式禅宗：此处无声胜有声</h2>

<ol>
<li><p>聆听“寂静”</p></li>
<li><p>无声里“偶发”声音</p></li>
<li><p>“绝对的空无”</p></li>
</ol>


<h3>禅宗否？</h3>

<p>John Cage确实受到铃木大拙佛学的巨大影响，“万物皆生于有，而有生于无”，遂而做他的“偶发音乐”。在一场《关于无》的演讲中，Cage说：有一件事是可以确定的，如果一个人要创造有，它将会是无。“它可能会通过无而成为有”可能正是John Cage创作4'33'&lsquo;的灵感来源。</p>

<h2>中土道家：大音希声</h2>

<h3>道家否？</h3>

<p>大“音”希“声”，但仍是“有声”。面对这种声音的美学，Cage其实是让听众去倾听在所谓演奏（其实未演奏）过程当中的任何所能听到的声音。于是乎，Cage在提供一个新的框架，让听众们去聆听这些噪音，但如何理解这种噪音？“构成音乐演出的根本行为是聆听，不是制造音乐”——美国公共电视网介绍4'33'&lsquo;时如是说。</p>

<h3>Cage在首演后的解读</h3>

<p>他们误会了，无声是不存在的。他们以为这是无声，那是因为他们不知道如何去听，其实还有很多偶发的声音：</p>

<p>第一乐章时你能听到鼓动的风声。</p>

<p>第二乐章时有雨水滴在屋顶的声音。</p>

<p>第三乐章人们自己就开始发出有意思的声音了，他们开始交头接耳，或者走出去。</p>

<h3>4'33'&lsquo;是否是无声的？</h3>

<p>众所周知的一个事实是，4'33'&lsquo;的无声归根结底不是无声，因为无声是一种从物理学角度不可能达到的状态&hellip;&hellip;4'33&rsquo;&lsquo;是无声不存在的一个证明，是声音永久性存在我们周围的一个证明，证明了它们值得我们注意的这一事实，也证明了Cage的所谓“环境声音与噪音比世界上的音乐文化产生的声音更具有审美价值”这一事实。——迈克尔</p>

<p>所以，4'33'&lsquo;不是对音乐的否定，而是对音乐无所不在的肯定。</p>

<p>问题是，环境声音与噪音一定比音乐更具有审美价值？这种观点仍是从音乐角度出发来看问题的，似乎大千世界里音乐无处不在，但却未区分出（声）音与（音）乐，真正无处不在的是前者而非后者。</p>

<h2>Cage的启示</h2>

<h3>从“音”拓展到了“声”</h3>

<h3>开启了声音艺术的“观念主义”之途</h3>

<h3>关注“音”与“乐”的情境</h3>

<h4>Duchamp对Cage的内在影响</h4>

<p>人们害怕有一天，由于一切都是艺术，一切都将不再是艺术。“否定性”被现成物品物化了，现成品的“反艺术”几乎受到了普遍欢迎。</p>

<h1>何为声音艺术（sound art）？</h1>

<ul>
<li><p>声音艺术的模糊性：无所不包？</p></li>
<li><p>声音艺术的确定性：属于视觉还是听觉？</p></li>
<li><p>Juna Winderen的声音装置《潜水》</p></li>
</ul>


<h2>超逾的美学：声音艺术超出了音乐限度</h2>

<h2>气氛的美学：声音与环境的相互融合</h2>

<h2>显现的美学：声音本身所呈现的意义</h2>

<h1>当代艺术的“用乐”：从库奈里斯《反转现场》谈起</h1>

<h2>走向“总体艺术”</h2>

<h2>关于“贫穷艺术”</h2>

<h2>从达达派到激浪派</h2>

<h2>行为艺术</h2>

<h2>原始根源与艺术“电缆”</h2>

<h1>音与乐的意义层级</h1>

<p>分析美学家斯蒂芬-戴维斯的专著《音乐的意义和表现》，提出了一整套“意义类型学（Typology of meanings）”：</p>

<ul>
<li><p>A: 自然的、无意义的意义</p></li>
<li><p>B: 对自然意义的有意识使用</p></li>
<li><p>C: 对自然要素的系统化、有意识使用</p></li>
<li><p>D: 有意的、人为规定的独立意义</p></li>
<li><p>E: 在某一符号系统中产生的人为的意义（如语言）</p></li>
</ul>


<h2>音乐属于意义几？</h2>

<p>戴维斯认为，音乐作品的最一般属性是意义C。</p>

<h2>苏珊-朗格的音乐观</h2>

<h2>反驳朗格音乐观</h2>

<h2>音乐意义的表现</h2>

<h3>音乐当中使用“自然意义”</h3>

<p>如谭盾的《水乐》</p>

<h3>彻底回归自然意义的“声景”（soundscape）</h3>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/blog/2016/09/11/notes-of-visage-acoustique-talks-2/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/09/04/Simon-Boccanegra/">斯卡拉歌剧院演绎威尔第《西蒙·波卡涅拉》</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-09-04T10:12:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>虽然我平时很少听声乐，但四年前还在高卢呆时还是很想去现场看著名歌剧院团演歌剧的。不过当时ONP的乐季实在太火，在网上没买着票，去巴士底歌剧院蹲点等rush ticket也没等着；去米兰时也没赶上斯卡拉演歌剧，最后看了场“伏地魔”埃申巴赫指挥斯卡拉爱乐&hellip;..总之是各种杯具，带着这一遗憾就滚回我朝了。所以今年看到斯卡拉歌剧院来亚洲巡演，在东艺演威尔第歌剧《西蒙·波卡涅拉（Simon Boccanegra）》和贝九，我便毫不犹豫拔草了波卡涅拉的票。</p>

<p>这次指挥是大家熟知的韩国指挥大师郑明勋。郑大厨对Verdi这部相对冷门的歌剧相当熟稔，之前看到媒体报道他是“在世的指挥家里最懂《西蒙·波卡涅拉》的人”，看来果然名不虚传。他完全是背谱指挥，无论是与乐团乐手、还是与合唱团和歌唱家的配合都非常默契。虽然我之前已经看过这部歌剧的视频，前几天还找了些录音来重温，但昨晚才发现之前忽略了不少细节——例如乐团如何与演唱家应和，某些乐段又如何衔接、过渡、呼应——似乎是刚刚认识这部作品。</p>

<p>这次担纲三大主角的歌唱家——演唱Boccanegra的Simone Piazzola、Maria/Amelia的Carmen Giannattasio、Fiesco的Dmitry Belosselskiy——虽然实力出众，但给我感觉独唱的部分并不算出彩：例如序幕中Fiesco的“A te l'estremo addio”、Amelia的“Come in quest'ora bruna”，似乎难以和我所听过的Paata Burchuladze和Mirella Freni相比。不过占据更多戏份的重唱仍是高水准的。几位配角中最值得称道的是扮演Gabriele的Fabio Sartori。他在第二幕的“Sento avvampar nell'anima”实在把这一角色的复杂纠结的心理活动唱活了，十分有感染力，以至于这首咏叹调结束后台下观众也按捺不住激动喊起了“Bravo”——这似乎是晚上唯一一次中途喝彩。演唱Paolo的韩国男中音金柱泽也令人印象深刻，不过对于这个反角的黑暗阴险似乎表现不足，看到介绍说他今年在纪念《塞尔维亚理发师》首演200周年的演出中饰演费加洛，倒是觉得他更适合费加洛这种正面角色。此外，斯卡拉歌剧院合唱团也表现得非常出色，让我萌生出听隔天他们演唱贝九的欲望XD 不过在摸摸干瘪的钱包后，我决定还是到富特、凯格尔等作古大师的录音中去找寻我的理想贝九吧XD</p>

<p>唯一有些遗憾的是，这次音乐会版的歌剧基本没有舞美，也几乎没有戏剧表演——有时候我也觉得自己挺矛盾的，上回NTLive的《奥赛罗》这方面做得那么好，却<a href="http://galoisplusplus.coding.me/blog/2016/04/03/nt-live-kinglear-and-othello/">吐槽</a>他们太写实不简洁；这次够简洁了吧，却又要指责，太难伺候了——其实人总是欲壑难填嘛，就当为下次看歌剧留个念想啦XDD</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/08/17/have-fun-with-rnn/">RNN(Recurrent Neural Networks)的有趣实验</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-17T10:12:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前段时间fracting兄分享了<a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">Andrej Karpathy一篇介绍RNN(Recurrent Neural Networks)的文章</a>，我看了之后觉得非常有趣，也用作者Andrej Karpathy写的<a href="https://github.com/karpathy/char-rnn">char-rnn</a>跑了一些实验玩玩。</p>

<h1>代码实验</h1>

<p>作为码农，我最开始自然地想到用<code>rnn</code>来训练代码啦！</p>

<h2>lua源代码</h2>

<p>我把lua-5.2.3的代码都写到一个文件里作为训练数据。<code>lua</code>的代码实在是太精炼了，竟然1M不到，只有544K！我没有更改<code>char-rnn</code>的默认参数，跑完了所有的50个<code>epoch</code>。取样时我一下就把<code>temperature</code>设为1（<code>temperature</code>是一个0到1的参数，越大随机性越高，设为1也就是机器原创性最好的条件了），结果还是比我想象中的好很多：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LUA_API const char *lua_string(lua_State *L, int toidx);
</span><span class='line'>LUAI_FUNC void luaV_op (lua_State *L);
</span><span class='line'>
</span><span class='line'>LUA_API void  (lua_setloge) (lua_State *L, lua_Degrawiol) set) {
</span><span class='line'>  int i;
</span><span class='line'>  for (i = n - "indininple")";
</span><span class='line'>  for (p = luaL_int(func, nup+n, nup), &winzed);
</span><span class='line'>  return ts;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>LUA_API void lua_touserdata (lua_State *L, int nargp) {
</span><span class='line'>  lua_CFunction fo = h-&gt;next;  /* path list of `must the stack is string */
</span><span class='line'>  while (p-&gt;cactconul == NA_JUMP) {  /* remove result back */
</span><span class='line'>      lua_xmove(L, 1);  /* remove functions in empty liblering */
</span><span class='line'>      if (!(!ass_epp(lua_Number)(e) - 1))
</span><span class='line'>        lua_pop(L, 1, 1, i, o2);  /* remove it informed is name */
</span><span class='line'>      else {
</span><span class='line'>        lua_getuserval(L, idx2a(L), nvalue(o));
</span><span class='line'>      lua_pushvalue(L, unsupvalue);
</span><span class='line'>          return finuserode(L, nargs, ns);
</span><span class='line'>          finit = strchr(*(s, p, lewvalues));
</span><span class='line'>        lua_pushliteral(L, "tobove");
</span><span class='line'>        tb = uv-&gt;u.l.pastpvarsing; i++)  /* logits avoid strings */
</span><span class='line'>        lua_Number k = luaL_checkint(L, 2, 1), lua_isnumber(L, idx) != 0)
</span><span class='line'>                            const char *p, expdesc v, int skiZc, L-&gt;clock, int);
</span><span class='line'>      if (lua_getisteop(L, i) != LUA_REGERMADDER) {  /* no move
</span><span class='line'>(followed framaling) */
</span><span class='line'>        L-&gt;oldpc = size_t, L-&gt;stack + G(L)-&gt;currentline;
</span><span class='line'>      checknext(ls, TK_EOS, NO_JUMP);
</span><span class='line'>    i &gt;= casch_k == NO_ORTENS sizeof(char + 1));
</span><span class='line'>    switch (ls-&gt;cause)
</span><span class='line'>      luai_writh(g));
</span><span class='line'>    j-&gt;basstring = NOPribig/ gch(o)-&gt;marked;  /* an open unsigned
</span><span class='line'>instect tocome */
</span><span class='line'>    lua_pushvalue(L, -1);  /* put to use name */
</span><span class='line'>  }
</span><span class='line'>  else {
</span><span class='line'>    int nvars[i] = g-&gt;gcvalue[g-- &lt; data = orr.in_PAXTABL;
</span><span class='line'>lua_pushbouceran(L, v2);  /* value stack */
</span><span class='line'>        sav_char_(luaL_optint(L, strfrot));
</span><span class='line'>  c = sig_meth (level) {
</span><span class='line'>      prongc = (**s == '-');
</span><span class='line'>      else {
</span><span class='line'>        break;
</span><span class='line'>    }
</span><span class='line'>    case GCSsweep = mode;  /* skip liblare `next' */
</span><span class='line'>    if (gnodead(t, a)) {  /* called old return */
</span><span class='line'>      lua_pushstring(L, name);
</span><span class='line'>      setnilvalue(o);
</span><span class='line'>  }
</span><span class='line'>  else {
</span><span class='line'>    while (l &lt; l)
</span><span class='line'>      closeL;
</span><span class='line'>      return NULL;
</span><span class='line'>    }
</span><span class='line'>    ttydebuffield(L, LUA_FINTFOCLEN);  /* signed invalid of capture is
</span><span class='line'>a sunpting */
</span><span class='line'>    setsvalue2s(L, L, luaL_checkinteger)(L, 1), LUA_TFuLLEA) +
</span><span class='line'>(L-&gt;size = LUA_RIDS);  /* elual library operand matched (filencat) */
</span><span class='line'>    if (stmp) res = rowninizers[i]; i-valid */
</span><span class='line'>    makes = 0;
</span><span class='line'>    }
</span><span class='line'>    if (l &lt;= i &lt; args) {
</span><span class='line'>    luaL_addchar(&b, collectar(s, n, 1));
</span><span class='line'>    if (lua_isnoneornil(L, 2))  /* not noting thave arguments */
</span><span class='line'>      /* stat -&gt; == L-&gt;ci-&gt;nexps - '?' */
</span><span class='line'>      if (fermst = 1) {
</span><span class='line'>      if (luaS_eqstr(luaL_checknumber(L, 1))) {
</span><span class='line'>        if (*(s != k &gt;&gt; 2] || ttisstring(g-&gt;GCasbertocaum(L)) != 0 &&
</span><span class='line'>!luaD_freall(L, hvars(luaL_len(p, 0));
</span><span class='line'>      break;
</span><span class='line'>    }
</span><span class='line'>    case LC_LOADG2(L); lua_pushcclosure(L, idx12x(f));
</span><span class='line'>    setobj2s(L,
</span><span class='line'>                 "L_callint " function");
</span><span class='line'>                                               singleballstatis);
</span><span class='line'>  shrint (lua_tointeger(L, 1), luaT_gettmotableark, (lua__collok(L, 1,
</span><span class='line'>0, 2))) == l2);
</span><span class='line'>  return 1;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static int db_setret (lua_State *L) {
</span><span class='line'>  int status = lua_load(L, lua_tointeger(L, L, "cnonal "-") " too pvarial be
</span><span class='line'>* with number of yi-valid function");
</span><span class='line'>  (func == LUA_TFUNCTI NUM: baset2(obj2gco(k));
</span><span class='line'>  checkStaceenstarn(l, nvalue(o));
</span><span class='line'>  api_incr_top(L);
</span><span class='line'>  lua_unlock(L);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>LUA_API const char *lua_pushstring (lua_State *L, int n, const char *e) {
</span><span class='line'>  const char *msg = lua_tolstring(L, -1, &ls);
</span><span class='line'>  lua_unlock(L);
</span><span class='line'>  if (status == LUA_OK) dectal(SeEMASK);
</span><span class='line'>  return 1;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static void pushfunccall (lua_State *L) {
</span><span class='line'>  Labell check;
</span><span class='line'>   lua_assert(argv[i] == LUA_TTABLE);  /* table to compert */
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>采样结果比较像的是：</p>

<ul>
<li><p>结构体和函数命名。有相当一部分和<code>lua</code>源代码是一样的，例如<code>LUA_API</code>、<code>LUAI_FUNC</code>、<code>lua_State</code>、<code>lua_pushvalue</code>、<code>luaL_checkint</code>等等。即使是rnn自造的，也有一些挺符合规范的，例如<code>lua_string</code>、<code>luaV_op</code>，几乎可以以假乱真。一个稍微差一点的例子是<code>luaT_gettmotableark</code>，尽管末尾造的词看不出意义，但仍然符合<code>lua</code>源代码里API的命名规则：<code>lua${一个大写字母表示API类型}_${方法名}</code>（例如<code>lua</code>源代码里，<code>table</code>类型的API叫做<code>luaT_xxx</code>，<code>string</code>类型的叫做<code>luaS_xxx</code>，<code>lua</code>虚拟机的API叫做<code>luaV_xxx</code>）。</p></li>
<li><p><code>lua</code> API中经常用状态机结构体指针作为参数传递，<code>rnn</code>采样的结果中，也经常以<code>lua_State *L</code>作为函数定义的第一个参数，在调用函数时也常常以<code>L</code>作为第一个传入的参数。</p></li>
</ul>


<p>比较不理想的是：</p>

<ul>
<li><p>括号、双引号不成对而引起的语法错误。</p></li>
<li><p>上下文的语义相关性差，例如上面那段代码最后的函数<code>pushfunccall</code>，传入参数<code>L</code>是没有被用到的，里面用到的<code>argv</code>并没有被声明。</p></li>
</ul>


<h2>cocos2d-x源代码</h2>

<p>我用<code>cocos2d-x</code>的源代码做了实验。<code>cocos2d-x</code>的代码就臃肿得多了，合起来有32M。由于数据较大，我训练时就把<code>rnn_size</code>调高，设了700，<code>num_layers</code>设了2。一开始用CPU训练，特别慢，中途我就弃疗了。后来把OpenCL配置好，用集显来训练，比原来大概快了一倍——毕竟是集显没多少核，所以无法达到10倍的加速比，要是能用以前实验室的K20X跑就好了。</p>

<p>这个实验跑得特别慢，我中间机器还重启过，重跑了<code>train.lua</code>，目前只跑了11.32个<code>epoch</code>。所以采样结果就不太理想了，要么是一大段注释，要么各种语法错误，这应该跟<code>cocos2d-x</code>的代码风格和采用<code>C</code>、<code>C++</code>、<code>lua</code>、<code>Python</code>、<code>Objective-C</code>等多种语言也有关系。我把<code>temperature</code>设为0.5才出来下面东拼西凑得稍微像样的结果：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* &lt;/key&gt; TE'Casting C++ Transfer SQLite core constraints.
</span><span class='line'>
</span><span class='line'> */
</span><span class='line'>
</span><span class='line'>typedef struct SPender {
</span><span class='line'>
</span><span class='line'>    /*! The return code for the content of the content of the control
</span><span class='line'>object may be passed to the first character. "
</span><span class='line'>
</span><span class='line'>                                              no tileset -- called
</span><span class='line'>requested to not support android definitions are allocated as the ba
</span><span class='line'>
</span><span class='line'>ckup processed to any this
</span><span class='line'>
</span><span class='line'>        * directory.
</span><span class='line'>
</span><span class='line'>     */
</span><span class='line'>
</span><span class='line'>    std::string getControllerDataBits() const;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    /** @brief Retrieves a GLProgram with the specified name of the
</span><span class='line'>current position of the container.
</span><span class='line'>
</span><span class='line'>     * @param vector The new z-order of the key of this node below.
</span><span class='line'>
</span><span class='line'>     *  @param contains The integer key for the key.
</span><span class='line'>
</span><span class='line'>     *  @return the integer key for setting the key to write to the
</span><span class='line'>key for the key.
</span><span class='line'>
</span><span class='line'>     *  @param[in]          the number of the key of the key.
</span><span class='line'>
</span><span class='line'>    */
</span><span class='line'>
</span><span class='line'>    virtual void visit(const char* target, int defaultValueCount);
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    /** create a new function with an automatic code from a loader to
</span><span class='line'>the ceater's container with a dictionary, the format of the first
</span><span class='line'>
</span><span class='line'> in the writer. The tile did the
</span><span class='line'>
</span><span class='line'>        types since they are not supported
</span><span class='line'>
</span><span class='line'>    */
</span><span class='line'>
</span><span class='line'>    bool onFloat;
</span><span class='line'>
</span><span class='line'>    /*! The cropping to allow the third particular after the width, in
</span><span class='line'>screen coordinates. The value must be the offset to the interfac
</span><span class='line'>
</span><span class='line'>e to disk.
</span><span class='line'>
</span><span class='line'>     */
</span><span class='line'>
</span><span class='line'>    void setUniformValue(const std::string &url);
</span><span class='line'>
</span><span class='line'>    /** @brief Returns the number of tilesets the one node's container
</span><span class='line'>window, it means the default world set is the standard orientati
</span><span class='line'>
</span><span class='line'>on, the director will be returned.
</span><span class='line'>
</span><span class='line'>     *  @return The number of elements also returns NULL.
</span><span class='line'>
</span><span class='line'>     *  @return An autorelease object pointer, or a NULL pointer.
</span><span class='line'>
</span><span class='line'>    */
</span><span class='line'>
</span><span class='line'>    inline const char* getTileGID() const { return _restoreOriginalFrame; };
</span><span class='line'>
</span><span class='line'>    inline Vec2 _projection;
</span><span class='line'>
</span><span class='line'>    std::string _subStepping;
</span></code></pre></td></tr></table></div></figure>


<h1>自然语言实验</h1>

<h2>英文文章</h2>

<p>我写了个很简单的爬虫去爬一个<a href="http://www.musicweb-international.com/">英文音乐网站</a>上的乐评文章，完整地爬了1.8G，但后来我发现：这个网站的样式有改版，而我是通过<code>css</code>去筛选乐评的，导致里面有些数据有问题。这个网站上的乐评基本是碟评，我最开始也想到把碟的标题、曲目和乐评都抓出来一起训练，但后来也是因为网页样式不够统一而作罢，只抓了乐评的内容。最后用的数据大概只有两千多篇乐评文章，12M，所有的内容我都过了一遍，删掉了其中有问题的数据——因为当时不知道有问题的数据大概长啥样，只用正则表达式很简单地筛掉了完全没有出现英文字符的数据，所以这两千多条数据我竟然是很蠢地人肉看的orz&hellip;</p>

<p>训练时把<code>rnn_size</code>设到了300，一共训练了50个<code>epoch</code>。采样时我传了一些音乐家的名字作为<code>-primetext</code>参数，不过奇怪的是，产生的文本并不是我所想的“命题作文”，里面包含我所设定的音乐家名字的很少。</p>

<p>下面是<code>temperature</code>为0.8时产生的一些文本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                John Eliot Gardiners' music has been recorded by Machiavey
</span><span class='line'>            Brahms and the Telarc hand. Here, though it seems the
</span><span class='line'>‘death’ with Ian Walton in the soloist
</span><span class='line'>                    sounds truly resigned as Bartók in . The
</span><span class='line'>                  assurance composer brings to the narrative evocation
</span><span class='line'>                  climax. There’s much lovely theme for Mass
</span><span class='line'>                and of the Boris. All composers look forward to
</span><span class='line'>her cycles, and the notes that sticed him much snob-is off-air points
</span><span class='line'>out.  The detailed and the Canzonetta (Sheher
</span><span class='line'>                is in the collective for distribution for the
</span><span class='line'>                  father to the and spirit of the composer’s voice from DG
</span><span class='line'>                many Greeks.
</span><span class='line'>              The last piece is rather than true to the programme
</span><span class='line'>                for their top recommendation. Add to Ireland’s
</span><span class='line'>                  first performance has one of the most slight lovely small
</span><span class='line'>                  performances of Parama Mozdianic’s music as well
</span><span class='line'>as composer and should
</span><span class='line'>                    write and there is little of its own
</span><span class='line'>individual aspects. The recording of both the recording by Royal Eleno
</span><span class='line'>Stevens, the disc
</span><span class='line'>                  () “…Better and far criticised into the second
</span><span class='line'>movement – most popular of a composer
</span><span class='line'>                    to summarise what was able to depict the way
</span><span class='line'>through it with
</span><span class='line'>                introspective substance to the rest of the most
</span><span class='line'>                  enjoyable theme. It is worth a major prelude, he
</span><span class='line'>had been a versatile, subdued violinist who points out with
</span><span class='line'>                the end of the Sarah and of the Roman concerto for
</span><span class='line'>                a performance in the late CD arrangement of the
</span><span class='line'>soloist which make the strange
</span><span class='line'>                music that tells the sounds to create in the
</span><span class='line'>                  change of rare and warm long, romantic partnership.
</span><span class='line'>                  So too much of it all recently is perfectly
</span><span class='line'>contradictoned, for me,
</span><span class='line'>                  but the harmonies are in the more prominent
</span><span class='line'>            music at the start to “Goldsmith” because
</span><span class='line'>                the result is not as if not merely moving in the
</span><span class='line'>first two sessions. From there  were my repeat that one may seem like
</span><span class='line'>a position appear to be listening to my beef?” Protestating the
</span><span class='line'>            concert-half and the same text – making “destinal” the
</span><span class='line'>use of the innocent
</span><span class='line'>            performances in the pleasure of the piece,
</span><span class='line'>                  but there was a time to convince the ‘allegro
</span><span class='line'>                from the shameful of the experience as the price
</span><span class='line'>of the piece’ (the
</span><span class='line'>                  most movement of Byrd
</span><span class='line'>                John Carroll) and his own sights of the first movement from
</span><span class='line'>                  his opera too. This was the earlier half of the
</span><span class='line'>text. So this is long realised
</span><span class='line'>                from one of the best deserts projects which work very well
</span><span class='line'>                as like yourself, I should even prevent the
</span><span class='line'>correct paces on a prejudice and clear that can also work certainly
</span><span class='line'>                - a compelling performance as principal force and
</span><span class='line'>his live performers in
</span><span class='line'>                the shadow of the work. This is the disc of the talking.
</span><span class='line'>                  This was a well-used recording …. Yet for this
</span><span class='line'>                  recording has more intense from a disc amasted
</span><span class='line'>the Roman Bale’s choir,
</span><span class='line'>                    a pastoral player from the following ‘Composer’ (tr.
</span><span class='line'>                  8) the first slow piece all low delicate and
</span><span class='line'>intense and stunning and then chosen music.</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>These are composers that would say that John Williams has said that
</span><span class='line'>happily should be struck by the singers of the score for a sequel
</span><span class='line'>evocative and character of several Scarlatti.
</span><span class='line'>  The score is also released and with the price of the separately
</span><span class='line'>sopranctic piece and making a case of practical distinction with the
</span><span class='line'>'methoy of information a tragically devout and distant and generally
</span><span class='line'>small exploration).  Strobbe injustice that the sound is subtly but
</span><span class='line'>distanced over flat illustrate scores by the score by Glennie twistens
</span><span class='line'>and the preceding musicians who are uncommonly detailed with much of
</span><span class='line'>the original MGM track. Debney writes down the score, it is, as this
</span><span class='line'>classic opera, Supermulation player
</span><span class='line'>  of Bernard Herrmann and the writing of the Sinfonia (Herberton Koon
</span><span class='line'>& Glyniform Graham) where he wrote some composers, and is a pleasant
</span><span class='line'>work for very little before I think I am of completely different
</span><span class='line'>settings of the score it is, in the background forty band of score for
</span><span class='line'> and , one of the most original excerpts only a revelation to warning
</span><span class='line'>you without
</span><span class='line'>computer use I don’t certainly is
</span><span class='line'>be creating a small sound. Morricone’s ‘Discovery’ is all the same
</span><span class='line'>passages featuring luxurial taste. \rAOr tradition and Victoria’s
</span><span class='line'>sampled confusion from the cinema setting.
</span><span class='line'>His admirable period of recognizably derivatives recalling its
</span><span class='line'>subject. Highly recommended.</span></code></pre></td></tr></table></div></figure>


<p>整篇还是比较前言不搭后语，但是单看句子还是比较通顺的，也用了不少音乐家的名字（Gardiner、Brahms、Scarlatti）、厂牌名（Telarc、DG）和音乐术语（Canzonetta、Sinfonia）。</p>

<h2>中文古诗词</h2>

<p>我觉得中国古诗词是极好的数据集：</p>

<ul>
<li><p>我对把文学作品当做机器学习的数据集也很感兴趣，很好奇最后会产生什么样的“作品”。</p></li>
<li><p>个人认为机器对于处理structed data更为在行，而在文学中，古典诗词无疑是很有规律的。相比之下，散文、小说等现代文学总归是太散了些。</p></li>
<li><p>还有其他一些规律性很强的文体，例如日本的俳句和川柳，但我朝的古诗词起码我们能看得懂——字啊！</p></li>
</ul>


<p>接下来就是从哪里获得数据的问题了。虽然电子书网站不少，不难下载到这方面文本的txt，但这种txt有些问题我不太满意：</p>

<ul>
<li><p>会把某些字拆开，例如把“勖”写成“冒力”。</p></li>
<li><p>会插入一些注解，但我并不想把注释加到训练数据里面。</p></li>
</ul>


<p>后来我发现<a href="http://ctext.org/">Chinese Text Project</a>上有一些资源，而且并没有上述问题，所以我也写了一个简单的<a href="https://github.com/yszheda/ctext_crawler">爬虫</a>去爬《全唐诗》。不过该网站禁止使用自动下载软件，我最开始忘了调爬虫的<code>DOWNLOAD_DELAY</code>参数，所以在爬了一些数据后就被封了&hellip;后来又用代理继续爬，总共爬了2.7M（4794首诗），每首诗按照如下格式存成了json文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>   {
</span><span class='line'>      "title" : "《寄溫飛卿箋紙》",
</span><span class='line'>      "content" : "\n三十六鱗充使時，數番猶得裹相思。\n待將袍襖重抄了，盡寫襄陽播掿詞。",
</span><span class='line'>      "author" : " 段成式著"
</span><span class='line'>   },</span></code></pre></td></tr></table></div></figure>


<p>我用<code>char-rnn</code>训练了50个<code>epoch</code>，诗人<code>rnn</code>在脾气最大（<code>temperature</code>为1）时所作的大作如果集结出版，就叫它<a href="https://coding.net/u/GaloisPlusPlus/p/galoisplusplus/git/raw/source/source/downloads/code/rnn/quantangshi-sample.json">《循神网诗选》</a>（循神网=循环神经网络=Recurrent Neural Networks=RNN）吧XDD</p>

<p>《循神网诗选》中，标题和署名是模仿得最难以分辨的，能一眼看出是机器胡诌的极少——例如有一则标题很长的诗。但是诗的内容总体就是胡言乱语了。不过还有一些有意思的句子：“萬里曙山牢”，用“萬里”“牢”形容山，很形象啊；“春風寒酒憔悴殺”，用的词“寒”“憔悴”意象很相近啊。不过由于前言不搭后语，整联写得好的比较少，《循选》读下来，似乎就“秋水燕蘭樹，春暉漫柳霧”还有对仗工整之处。不过刚刚学诗的循神网来说也是个奇迹，循神网真是骨骼精奇啊！</p>

<p>另外要说明一下，<code>char-rnn</code>目前是以byte而非utf8的一个word来处理的，神奇的是我几乎没在采样中发现有不符合utf8编码的情况——191首诗里仅有三四首不能正确解码——看来<code>rnn</code>竟然很好地掌握了utf8编码的规律。<code>json</code>格式就更不在话下啦！</p>

<p><code>char-rnn</code>上也有一些utf8 word的<a href="https://github.com/karpathy/char-rnn/pull/12">PR</a>，但因为兼容性问题没被接受，我也照着他们改的地方写了个patch，还有点问题，等调好了之后再跑古诗词的实验，应该会有更有趣的结果。</p>

<h1>其他structed data</h1>

<p>此外，我想到网络数据包也是一种可以用来训练的structed data，所以也用<code>tcpdump</code>抓了一些包做实验。不过需要按照<a href="https://github.com/karpathy/char-rnn/issues/51#issuecomment-129625032">这个issue</a>所说的，稍微改下<code>char-rnn</code>的代码。目前还没跑完训练，等训练完50个<code>epoch</code>后，再来看看采样生成的数据能用<code>tcpdump</code>读取的正确率有多高。</p>

<p>说到非文本的structed data，我还想到了图片、语音和音乐，其中我最感兴趣的还是音乐——各位应该也猜到本乐渣想对音乐下手了吧XD。但是用<code>rnn</code>来训练音乐有一些问题，这也使得它暂时还处于我的脑洞阶段：</p>

<ul>
<li><p>最能反映音乐“原貌”的恐怕还是音频，但是音频文件有不同格式的编解码，并不符合<code>rnn</code>的character-level language model。就好比<a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">Andrej Karpathy那篇博文</a>里所举的“hello”的例子：如果“hello”这个文本被加密过，那么两个连续的“l”很可能被加密函数映射成不同的字符，诸如字母"h"后较大可能跟的是字母“e”这种规律也将失效。音频虽然对聆听者而言最能反映音乐“原貌”，但音频文件本身与音乐“原貌”还相距甚远，或许需要从中提取有用的特征作为数据集，才能体现音乐中的有规律之处。</p></li>
<li><p>不能直接用音频文件，只能退而求其次了。你应该想到一种很古老的将音乐图像化的方式——乐谱——了吧？不过乐谱在我看来还主要是作曲家记谱的工具，用于还原音乐演奏会失真。例如钢琴乐谱上虽然会有踏板记号，但实际演奏时踏板应该踩多深、踩多久？此外乐谱也没有记录下演奏者手指所用的力度等细节，而这些细节往往又是庸才与大师之间的鸿沟。后来我想到一种比乐谱更为精确的方式，那就是<a href="https://en.wikipedia.org/wiki/Piano_roll">纸卷录音</a>。不过目前虽然不乏用纸卷放在自动钢琴上重放而录制的录音，但纸卷本身却很难在网上找到。</p></li>
<li><p>即使有了纸卷这种能较精确还原音乐的载体，还有一个关键问题，那就是如何把这种图像转化成文本，而且这种编解码转换应该是可逆的。我发现，就算对于精确度稍逊的乐谱来说，这种要求也很难实现。Andrej Karpathy那篇博文里提到一篇采用rnn训练音乐的<a href="https://highnoongmt.wordpress.com/2015/05/22/lisls-stis-recurrent-neural-networks-for-folk-music-generation/">文章</a>，里面用了一种很简单的<a href="http://abcnotation.com/blog/2010/01/31/how-to-understand-abc-the-basics/">ABC记谱法</a>来把乐谱转成文本，再把<code>rnn</code>生成的文本转成midi。不过这种记谱法实在是太简陋了，连和弦都无法表示，更遑论多声部的旋律了。</p></li>
</ul>


<p>说到编解码，我还想到上个月听的巴西生物艺术家<a href="http://ekac.org/">Eduardo Kac</a>的一场讲座。其中他早年的一件作品<a href="http://www.ekac.org/geninfo2.html">Genesis</a>给我的印象很深：Kac从《圣经》里摘了一句话“Let man have dominion over the fish of the sea, and over the fowl of the air, and over every living thing that moves upon the earth.”，把它转成莫尔斯码，又把莫尔斯码转换成ACTG序列。他将这段序列植入细菌中，然后邀请观众对细菌施以紫外光照，让细菌产生变异。在展览结束后，Kac把这段变异后的DNA重新转成莫尔斯码，最后再转成英语（编解码过程和结果可以看<a href="http://www.ekac.org/genseries.html">这个网页</a>的前两张图）。 Kac的这个作品给了我一些启发，我也由此开下脑洞：如果把某段DNA序列拿给rnn做训练，采样得到新的DNA序列，那么后者将合成什么样的蛋白质、表现出怎样的性状？这想法太疯狂啦，还好我不是biohacker XD</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/08/07/take-tmux-snapshots-automatically-2/">Take Tmux Snapshots Automatically (2)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-07T16:12:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>还记得本渣以前写的<a href="http://galoisplusplus.coding.me/blog/2014/02/23/take-tmux-snapshots-automatically/">给tmux现场做备胎的脚本</a>吗？其实后来本渣就没再去拓展<a href="https://gist.github.com/yszheda/9138288">这个脚本</a>了，不是因为之前的脚本运行得够好不需要再改了，而是在写好那个脚本那年，有一个工具横空出世，让本渣觉得再也不用造轮子了——好了，不卖关子了，这个工具就是<code>tmux</code>的<a href="https://github.com/tmux-plugins/tmux-resurrect">resurrect插件</a>！</p>

<p>resurrect官方有一个<a href="https://vimeo.com/104763018">使用录屏</a></p>

<iframe src="https://player.vimeo.com/video/104763018" width="640" height="360" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<p><a href="https://vimeo.com/104763018">Tmux Resurrect plugin</a> from <a href="https://vimeo.com/brunosutic">Bruno Sutic</a> on <a href="https://vimeo.com">Vimeo</a>.</p>


<p>怎么样？狂拽酷炫屌！我们想要有的功能基本都有了吧！而且resurrect还部分支持<a href="https://github.com/tmux-plugins/tmux-resurrect/blob/master/docs/restoring_programs.md">恢复panel里运行的程序</a>啊有木有！要知道这并不好实现，以前本渣写备胎脚本时也折腾过，当时还只能在恢复panel时给出上次运行程序的提示。
不过resurrect插件需要手动保存和恢复<code>tmux</code>现场，如果需要自动化的话，可以再配合<a href="https://github.com/tmux-plugins/tmux-continuum">continuum插件</a>来使用。</p>

<p>好了，软文就写到这么多了，下面我们来看看如何安装使用。</p>

<p>首先查看<code>tmux</code>版本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tmux -V</span></code></pre></td></tr></table></div></figure>


<p>resurrect插件需要<code>tmux</code>1.9以上的版本。如果你的版本低于1.9，那么升级是必须的，其实把<code>tmux</code>升级到1.9以上还是蛮推荐的。</p>

<p>这里推荐安装<a href="https://github.com/tmux-plugins/tpm">tpm (Tmux Plugin Manager)</a>做<code>tmux</code>插件管理，再通过<code>tpm</code>安装continuum等插件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm</span></code></pre></td></tr></table></div></figure>


<p>编辑<code>~/.tmux.conf</code>，在文件末尾加入以下几行:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Set default shell to zsh
</span><span class='line'># set-option -g default-shell /bin/zsh
</span><span class='line'>
</span><span class='line'># Use the following line to fix OS X tmux problems
</span><span class='line'># set-option -g default-command "reattach-to-user-namespace -l zsh"
</span><span class='line'>
</span><span class='line'># List of plugins
</span><span class='line'>set -g @plugin 'tmux-plugins/tpm'
</span><span class='line'>set -g @plugin 'tmux-plugins/tmux-sensible'
</span><span class='line'>set -g @plugin 'tmux-plugins/tmux-resurrect'
</span><span class='line'>set -g @plugin 'tmux-plugins/tmux-continuum'
</span><span class='line'>
</span><span class='line'># Other examples:
</span><span class='line'># set -g @plugin 'github_username/plugin_name'
</span><span class='line'># set -g @plugin 'git@github.com/user/plugin'
</span><span class='line'># set -g @plugin 'git@bitbucket.com/user/plugin'
</span><span class='line'>
</span><span class='line'># Enable automatic restore
</span><span class='line'>set -g @continuum-restore 'on'
</span><span class='line'>
</span><span class='line'># Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
</span><span class='line'>run '~/.tmux/plugins/tpm/tpm'</span></code></pre></td></tr></table></div></figure>


<p>如果你的默认shell是<code>zsh</code>，请把这句的注释去掉：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set-option -g default-shell /bin/zsh</span></code></pre></td></tr></table></div></figure>


<p>如果你用的是Mac OSX，把这句的注释也去掉：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set-option -g default-command "reattach-to-user-namespace -l zsh"</span></code></pre></td></tr></table></div></figure>


<p>这主要是<code>tmux</code>在OSX下水土不服（更详细的问题描述可以看这篇文章：<a href="http://www.economyofeffort.com/2013/07/29/reattach-to-user-namespace-the-fix-for-your-tmux-in-os-x-woes/">Reattach-to-user-namespace: The Fix for Your Tmux in OS X Woes</a>），需要用<a href="https://github.com/ChrisJohnsen/tmux-MacOSX-pasteboard">reattach-to-user-namespace</a>黑科技，所以你最好也用<a href="http://www.macports.org"><em>MacPorts</em></a>或者<a href="http://brew.sh"><em>Homebrew</em></a>装下这个工具：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>port install tmux-pasteboard</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install reattach-to-user-namespace</span></code></pre></td></tr></table></div></figure>


<p>在终端下执行以下命令更新<code>tmux</code>配置，运行<code>tpm</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tmux source ~/.tmux.conf</span></code></pre></td></tr></table></div></figure>


<p>最后在<code>tmux</code>下运行<code>prefix + I</code>（如果你没改键绑定的话就是<code>&lt;Ctrl&gt;-b + &lt;Shift&gt;-i</code>）安装插件。你还可以通过<code>prefix + U</code>（<code>&lt;Ctrl&gt;-b + &lt;Shift&gt;-u</code>）更新插件，用<code>prefix + &lt;Alt&gt; + u</code>删除插件。</p>

<p>安装完成之后，你可以在<code>~/.tmux/plugins/</code>里找到每个插件的代码目录。resurrect插件还有一个<code>run_tests</code>脚本用于检查是否安装正确，不过要运行这个脚本需要装上虚拟化神器<a href="https://www.vagrantup.com">vagrant</a>。</p>

<p>如果安装正确，continuum插件会每隔15分钟产生一份备胎，我们也可以用<code>prefix + &lt;Ctrl&gt;-s</code>手动备份，用<code>prefix + &lt;Ctrl&gt;-r</code>手动恢复——vimer吐槽一记，这热键定义得好emacs风&hellip;</p>

<p>下面我们来看看resurrect插件产生的<code>tmux</code>环境备胎。在<code>tmux</code>环境备胎生成之后，在<code>~/.tmux/resurrect/</code>目录下就会有名为<code>tmux_resurrect_$(date).txt</code>的文本文件，同时会有一个叫<code>last</code>的软链接指向最新的<code>tmux_resurrect_$(date).txt</code>。那么这个神秘的txt文件里有啥呢？这里本渣随意贴上一份：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pane    0       0       :apt-fast       1       :*      0       :/home/ys    1       sudo  :sudo apt-fast install linux-image-3.13.0-70-generic-dbgsym
</span><span class='line'>pane    0       1       :~      0       :       0       :/home/ys    1       zsh     :
</span><span class='line'>pane    0       2       :~      0       :-      0       :/home/ys    1       zsh     :
</span><span class='line'>window  0       0       1       :*      c51d,95x28,0,0,0
</span><span class='line'>window  0       1       0       :       c51e,95x28,0,0,1
</span><span class='line'>window  0       2       0       :-      c51f,95x28,0,0,2
</span><span class='line'>state   0</span></code></pre></td></tr></table></div></figure>


<p>啊哈，看起来思路和本渣<a href="https://gist.github.com/yszheda/9138288">之前脚本</a>的<a href="http://galoisplusplus.coding.me/blog/2014/02/23/take-tmux-snapshots-automatically/">思路</a>差不多嘛！只不过resurrect插件记录的信息更详细，还做了键绑定。resurrect的代码也不难懂，如果你对它的实现感兴趣的话可以去阅读一下啦～</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/08/02/setup-private-docker-registry/">搭建Docker私有仓库折腾记</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-02T02:13:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近折腾了一些Docker image，为了方便厂里其他人用，于是本渣还得折腾docker-registry搭个内网的Docker私有仓库~</p>

<p>本渣是照着<a href="https://yeasy.gitbooks.io/docker_practice/content/repository/local_repo.html">Docker —— 从入门到实践</a>做的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install -y build-essential python-dev libevent-dev python-pip liblzma-dev
</span><span class='line'>sudo pip install docker-registry</span></code></pre></td></tr></table></div></figure>


<p>不过还需要再安装<code>swig</code>这个软件包才能正常安装<code>docker-registry</code>。</p>

<p>总算安装好了，但在push镜像时出现如下问题：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server gave HTTP response to HTTPS client</span></code></pre></td></tr></table></div></figure>


<p>看了<a href="https://github.com/docker/distribution/issues/1874">Docker Github上这个issue</a>和<a href="http://stackoverflow.com/questions/38695515/can-not-pull-push-images-after-update-docker-to-1-12">SOF上这个问题</a>后才明白，是由于<code>Docker</code>服务默认是采用安全连接HTTPS的，对于我们来讲用HTTPS大可不必，可以照着以下步骤修改：</p>

<ul>
<li>编辑<code>/etc/docker/daemon.json</code>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{ "insecure-registries":["192.168.0.251:5000"] }</span></code></pre></td></tr></table></div></figure>


<ul>
<li>重启Docker服务：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo service docker restart</span></code></pre></td></tr></table></div></figure>


<p>在拉取镜像的机器上也需要做这样的配置才能成功<code>docker pull</code>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/07/31/notes-of-visage-acoustique-talks/">小记「声音的面容」一：后声音艺术与恐惧的情动（affect of Fear）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-31T23:36:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>声音作为解放</h1>

<ul>
<li><p>音乐作为声音艺术的原始阶段</p></li>
<li><p>从音乐到噪音（bruit/noise）：20世纪声音艺术的发端</p></li>
<li><p>音乐——有组织的噪音（organisation du bruit）：</p>

<ul>
<li>雅克·阿塔利(Jacques Attali)《噪音》：「与噪音同生的是混乱和与之相对的世界。与音乐同生的是权力以及与它相对的颠覆。」</li>
</ul>
</li>
<li><p>音乐/噪音之二元对立是不充分的：</p>

<ul>
<li><p>形式/物质？</p></li>
<li><p>权力/抵抗？</p></li>
</ul>
</li>
<li><p>代表人物：</p>

<ul>
<li><p><a href="https://en.wikipedia.org/wiki/Luigi_Russolo">Luigi Rossolo</a>: <strong><a href="https://en.wikipedia.org/wiki/The_Art_of_Noises">《The Art of Noise(1913)》</a></strong></p>

<ul>
<li><p>&ldquo;Music sounds is too limited in its variety of timbres.&rdquo;</p></li>
<li><p>&ldquo;the variety of timbres in noises&rdquo;</p></li>
<li><p>Musical Noise</p></li>
</ul>


<p><iframe width="420" height="315" src="https://www.youtube.com/embed/VcHJySm7ZO0" frameborder="0" allowfullscreen></iframe></p>

<p><iframe width="420" height="315" src="https://www.youtube.com/embed/IC3KMbSkYNI" frameborder="0" allowfullscreen></iframe></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Edgard_Var%C3%A8se">Edgard Varèse</a>: <strong>《The Liberation of Sound》</strong></p>

<ul>
<li><a href="http://www.zakros.com/mica/soundart/s04/varese_text.html">&ldquo;opened up for them the whole mysterious world of sound&rdquo;</a></li>
</ul>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Pierre_Schaeffer">Pierre Schaeffer</a>: <strong>musique concrète</strong></p>

<ul>
<li>铁道练习曲(&ldquo;Étude aux chemins de fer&rdquo; from <a href="https://en.wikipedia.org/wiki/Cinq_%C3%A9tudes_de_bruits">&ldquo;Cinq études de bruits&rdquo;</a>)</li>
</ul>


<p><iframe width="420" height="315" src="https://www.youtube.com/embed/N9pOq8u6-bA" frameborder="0" allowfullscreen></iframe></p>

<ul>
<li>&ldquo;To distinguish an element (to hear [entendre] it in itself, for its texture, its matter, its colour). To repeat it. Repeat the same thing twice, there is music.&rdquo;</li>
</ul>
</li>
</ul>
</li>
</ul>


<h1>声音作为媒介</h1>

<ul>
<li><p>“辨识性媒介”：retransmition</p></li>
<li><p>“幽灵性媒介”：expression</p></li>
<li><p>代表人物：</p>

<ul>
<li><p><a href="https://en.wikipedia.org/wiki/Iannis_Xenakis">Iannis Xenakis</a></p>

<ul>
<li><p><a href="https://en.wikiquote.org/wiki/Iannis_Xenakis">&ldquo;Music is not a language. Any musical piece is akin to a boulder with complex forms, with striations and engraved designs atop and within, which men can decipher in a thousand different ways without ever finding the right answer or the best one&hellip;&rdquo;</a></p></li>
<li><p>model of musical articulation -> control structure -> sound material</p></li>
<li><p>控制 -> 实验 -> 发明</p></li>
</ul>


<p><iframe width="560" height="315" src="https://www.youtube.com/embed/SZazYFchLRI" frameborder="0" allowfullscreen></iframe></p>

<p><iframe width="420" height="315" src="https://www.youtube.com/embed/dqtFGaHcWRk" frameborder="0" allowfullscreen></iframe></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Alvin_Lucier">Alvin Lucier</a></p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/I_Am_Sitting_in_a_Room">I Am Sitting in a Room</a></li>
</ul>


<p><iframe width="560" height="315" src="https://www.youtube.com/embed/fAxHlLK3Oyk" frameborder="0" allowfullscreen></iframe></p>

<p><iframe width="560" height="315" src="https://www.youtube.com/embed/v9XJWBZBzq4" frameborder="0" allowfullscreen></iframe></p>

<ul>
<li>《Music 109》</li>
</ul>
</li>
</ul>
</li>
</ul>


<h1>声音作为本体</h1>

<ul>
<li><p>日本噪音：20世纪声音艺术的终极形态</p></li>
<li><p>声音的“原教旨主义”：</p>

<ul>
<li><p>还原，盲听</p></li>
<li><p>地下，抵抗</p></li>
<li><p>疏离，分裂</p></li>
</ul>
</li>
<li><p>极限的affect：“疼痛”与“晕眩”</p>

<ul>
<li>Mike Goldsmith《Discord: The Story of Noise》</li>
</ul>
</li>
<li><p>“世界肉身”（chair du Monde）：声音作为修补世界的事件</p>

<ul>
<li><p>&ldquo;My body is the texture common to all subjects.&rdquo;</p></li>
<li><p>&ldquo;The body as sensible and the body as sentient&rdquo;</p></li>
</ul>
</li>
<li><p>泛声论：<a href="https://mitpress.mit.edu/books/noise-water-meat">《Noise, Water, Meat: A History of Voice, Sound, and Aurality in the Arts》</a></p></li>
<li><p>Audio-Vision的再联结：<a href="http://sel.fas.harvard.edu/">Sensory Ethnography Lab</a></p></li>
<li><p>Brian Massumi<a href="https://www.dukeupress.edu/ontopower">《Ontopower: War, Powers, and the State of Perception》</a></p></li>
</ul>


</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/blog/2016/07/31/notes-of-visage-acoustique-talks/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/07/28/dockerfile-for-building-quickx-apk/">用Docker容器来生成quick-x/cocos2d-x游戏apk包</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-28T02:13:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前段时间本渣在做服务器端开发时，采用了<code>Docker</code>作为解决方案的一部分，最初的动机主要是想用<code>namespace</code>做环境隔离、用<code>cgroups</code>做资源限制，却也切身体会到<code>Docker</code>所带来的构建上的便利。故而本渣也回头去想之前cocos2d-x客户端的开发工作是否也能<code>Docker</code>化，很快就找到了一个很适合采用<code>Docker</code>的场景，那就是打apk包。从之前<a href="http://galoisplusplus.coding.me/blog/2014/08/03/customize-dev-environment-for-cocos2d-x/">搭建cocos2d-x游戏开发环境的博文</a>中不难发现，要搭建打包环境特别麻烦，不仅需要下一堆软件包，而且安装Android SDK和NDK时还会遇到GFW的问题。也正是因为这个缘故，我们团队只有最开始的三位老司机在开发机上搭好了这套环境，之后陆陆续续来的新人都没做过这项工作，所以平时打包也基本是在这几台开发机上。这简直太应该<code>Docker</code>化了！有了一套配好打包环境的<code>Docker</code> image，再也不用担心小鲜肉跑来要求打包、占用开发机了！而且还可以扔到服务器上去做，多省心啊！想想就excited，于是本渣马上就折腾起<code>Dockerfile</code>来了！</p>

<p>首先要确定基础镜像。本渣一开始以为，配置<code>Linux</code>下的cocos2d-x打包环境需要在执行cocos2d-x代码里的<code>build/install-deps-linux.sh</code>，而这个脚本需要用到<code>Debian</code>系的包管理器，所以就选了<code>Ubuntu</code>作为基础镜像。</p>

<p>配置apk打包环境自然少不了下载需要的软件包。<code>Ubuntu</code>的<code>apt-get install</code>会询问用户是否安装软件包，在<code>Dockerfile</code>中需要把这一交互性去掉，最好采用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get install -y</span></code></pre></td></tr></table></div></figure>


<p>有些人喜欢把<code>DEBIAN_FRONTEND</code>设成<code>ENV</code>，这样<code>ENV</code>下面的命令就不用重复打<code>DEBIAN_FRONTEND=noninteractive</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ENV DEBIAN_FRONTEND noninteractive
</span><span class='line'>RUN apt-get install -y</span></code></pre></td></tr></table></div></figure>


<p>但根据<a href="https://medium.com/@rlbaker/deploying-python-with-docker-15a472cf12a5#.5vl6ihty3">Deploying Python with Docker</a>的说法，这种做法是不推荐的，因为这会影响到容器使用，最好还是对每条需要的命令单独设置环境变量。</p>

<p>安装的几个软件包中少不了<code>Java</code>，我用的是Oracle的而非<code>openjdk</code>，所以需要用<code>add-apt-repository</code>把Oracle的ppa加上，这又需要先安装<code>add-apt-repository</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 更新软件包列表
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get update -qq
</span><span class='line'>
</span><span class='line'># 安装add-apt-repository
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get -y install python-software-properties software-properties-common
</span><span class='line'>
</span><span class='line'># 安装Oracle Java
</span><span class='line'>RUN echo "debconf shared/accepted-oracle-license-v1-1 select true" | debconf-set-selections
</span><span class='line'>RUN echo "debconf shared/accepted-oracle-license-v1-1 seen true" | debconf-set-selections
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive add-apt-repository ppa:webupd8team/java \
</span><span class='line'>    && apt-get update -qq
</span><span class='line'>RUN DEBIAN_FRONTEND=noninteractive apt-get -y oracle-java6-installer</span></code></pre></td></tr></table></div></figure>


<p>打包还需要<code>ant</code>、之后下载SDK等需要<code>wget</code>或<code>curl</code>，这些软件包可以写在这句<code>apt-get -y</code>后面，因为我们不希望<code>Docker</code> image有太多layer。</p>

<p>接下来就是下载Android SDK和设置相应的环境变量了。Android SDK和NDK的google下载链接是被墙的，可以换成国内相关镜像的链接。本渣是先下好这些包，然后在我们内网nginx起了一个简单的静态页面，我们内部再通过这个页面去下载就灰常快了XD</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Install Android SDK
</span><span class='line'>ENV ANDROID_SDK_ROOT /opt/android-sdk-linux
</span><span class='line'>
</span><span class='line'>RUN cd /opt && wget -q https://dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz \
</span><span class='line'>    && tar -zxvf android-sdk.tgz \
</span><span class='line'>    && rm -f android-sdk.tgz
</span><span class='line'>
</span><span class='line'>ENV PATH ${PATH}:${ANDROID_SDK_ROOT}:${ANDROID_SDK_ROOT}/tools
</span><span class='line'>
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter platform-tools | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter extra-android-support | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter android-20 | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter build-tools-20.0.0 | grep 'package installed'</span></code></pre></td></tr></table></div></figure>


<p>如果你需要用代理来绕过GFW，可以这么写：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># NOTE: google is blocked by GFW in China,
</span><span class='line'># So I use the proxy: http://android-mirror.bugly.qq.com:8080.
</span><span class='line'># You can remove `--proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s`
</span><span class='line'># in the following commands if you don't have to worry about this issue.
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter platform-tools --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter extra-android-support --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter android-20 --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'
</span><span class='line'>RUN echo y | android update sdk --no-ui --all --filter build-tools-20.0.0 --proxy-host android-mirror.bugly.qq.com --proxy-port 8080 -s | grep 'package installed'</span></code></pre></td></tr></table></div></figure>


<p>接下来就是安装Android NDK了，和SDK差不多。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Install Android NDK
</span><span class='line'>ENV ANDROID_NDK_ROOT /opt/android-ndk-r10e
</span><span class='line'>ENV NDK_ROOT /opt/android-ndk-r10e
</span><span class='line'>
</span><span class='line'>RUN cd /opt && wget -q http://dl.google.com/android/repository/android-ndk-r10e-linux-x86_64.zip -O android-ndk.zip \
</span><span class='line'>    && unzip -q android-ndk.zip \
</span><span class='line'>    && rm -f android-ndk.zip
</span><span class='line'>
</span><span class='line'>ENV PATH ${PATH}:${ANDROID_NDK_ROOT}</span></code></pre></td></tr></table></div></figure>


<p>最后别忘了清理安装的软件包：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUN apt-get clean</span></code></pre></td></tr></table></div></figure>


<p>到了这一步，本渣就可以先把<code>Docker</code> image构建起来，把cocos2d-x代码、quick-x代码和客户端代码作为host的三个volumn挂载到<code>Docker</code> container里了。经试验发现还需要做如下配置：</p>

<ul>
<li><p>在<code>PATH</code>里加入<code>cocos2d-console/bin</code>的目录才能使用<code>cocos</code>命令。</p></li>
<li><p><code>cocos2d-console</code>需要安装<code>python</code>。</p></li>
<li><p>需要把quick-x代码所在目录配在<code>QUICK_V3_ROOT</code>环境变量中。</p></li>
<li><p>quick-x用到<code>php</code>，需要安装。</p></li>
<li><p>需要装上32位系统的软件包<code>lib32stdc++6</code>和<code>lib32z1</code>才能正常打包。</p></li>
</ul>


<p>于是本渣就可以相应地在<code>Dockerfile</code>中继续添加了，虽然试验的过程有点繁琐，但可以保证生成的<code>Docker</code> image只包含需要的软件包，让image尽可能小。</p>

<p>接下来就是如何继续优化了，例如以上需要从host挂载cocos2d-x代码和quick-x代码的volumn还是比较烦。其中我们完全没必要把整份cocos2d-x代码挂载进来，因为创建cocos2d-x项目时会把需要的源代码文件拷到项目目录里，所以我们只需要其中的<code>cocos2d-console</code>，配置好<code>cocos</code>所在的目录到环境变量<code>PATH</code>即可。最后我把<code>cocos2d-console</code>和<code>quick-x</code>的代码打包，放到之前的内网网页中，这样就有了一份只需要挂载项目代码目录就能进行apk打包的<code>Dockerfile</code>啦！</p>

<p>还记得前面所提到的cocos2d-x代码里的<code>build/install-deps-linux.sh</code>脚本吗？其实这个脚本还是有交互，所以我也把它所实现的功能挪到了<code>Dockerfile</code>中，其实也不外乎用<code>apt-get</code>下载一些软件包和下载<code>glfw</code>编译安装罢了。既然这个脚本并非必须，那么基础镜像也就不一定非要<code>Debian</code>系的系统了，小巧的<code>Alpine</code>无疑才是更理想的基础镜像。不过，目前我们主要是内网开发用，还没有压缩<code>Docker</code> image体积的需求，本渣也就不打算重新用<code>Alpine</code>折腾一遍了XD</p>

<p><strong>Update:</strong></p>

<p>我把一份通用的<code>Dockerfile</code>放到了<a href="https://github.com/yszheda/quick-x-apk-docker">Github</a>上，你也可以在Docker Hub拉取对应的<code>Docker</code>镜像：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker pull galoisplusplus/quick-x-apk-docker</span></code></pre></td></tr></table></div></figure>


<p>这一<code>Docker</code>镜像对不采用quick-x的cocos2d-x游戏打包也是可以用的，只需要把<code>Dockerfile</code>中quick-x的部分去掉后进行构建即可。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/07/24/my-first-openresty-journey/">OpenResty折腾记</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-24T11:22:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前面几篇文章稍稍提到本渣最近接手了一个server端开发的活，这次就来碎碎念一下好了。虽然我们server端用<code>OpenResty</code>，和client端一样主要也是用<code>lua</code>开发，不过实在也不是本渣谦虚，本渣一个client端码农，肿么就被叫去写server端代码捏？<del>是因为组织上对本渣的信任。</del>是因为啊，我们server端想要实现战斗这块功能。而这块功能呢，恰好client端已经实现过。本渣嘛，又承担过不少战斗功能的开发工作。所以组织上说，既然你以前在client端挖过不少这种坑，那么server端的坑也由你来挖吧？于是本渣就<del>念了两句诗</del>接了这活。</p>

<p>本渣从一开始接手开始，就打定主意直接在server端重用client端的战斗功能代码。一方面是因为本渣很懒，已经实现过的轮子不想再造一遍；另一方面是因为我们client端的这块代码仍在迭代中，会不时上一些新类型的战斗玩法，如果server端再重新实现一遍，以后还得把client端新的改动也搬过来，这不仅不好维护，而且又是翻倍的工作量。最好就是把client端的战斗功能代码当做server端代码的一个submodule，client端有改动的话就直接pull下更新来使用。client端的这部分代码虽然也是<code>lua</code>写的，但要重用的话有个问题：我们client端用了<code>cocos2d-x</code>和<code>quick-x</code>，但server端只是个Web API Server，最好避免引入<code>cocos2d-x</code>和<code>quick-x</code>的<code>C++</code> API、以及<code>Node</code>之类的view（嗯，MVC的view）相关对象。好在最开始做战斗的大神设计得当，把战斗功能划分为战斗计算模块和战斗表现模块——前者计算出手先后、技能释放、buff和属性值改变等等，生成战报；后者再根据前者所生成的战报，播放相应的特效动画和人物动作——等到半年后本渣接手时，为了实现独立的战报播放功能，又把这块代码重构了，去掉了两个模块之间的耦合，所以战斗计算模块基本是独立于<code>cocos2d-x</code>和<code>quick-x</code>的<code>C++</code>代码、与view完全无关的纯<code>lua</code>实现。本渣只需要再补上<code>quick-x</code>中一些如<code>math.round</code>的全局函数的定义，很快就能在server端跑通了，但是新的问题又来了：</p>

<ol>
<li><p>有一定概率出现全局函数没有定义的错误，但是在代码里，这些全局函数在定义后并没有被修改。</p></li>
<li><p>在用<code>nginx</code> start或reload的方式创建新的<code>nginx</code> worker进程后，第一次访问有很大概率会失败。</p></li>
</ol>


<p>由于本渣是第一次接触<code>OpenResty</code>，这些问题一开始让本渣丈二和尚摸不着头脑，后来才渐渐理清了头绪。
前一个问题与<code>OpenResty</code>的code cache有关。本渣在<code>nginx</code>配置里打开了code cache：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lua_code_cache on</span></code></pre></td></tr></table></div></figure>


<p>而全局函数的使用是通过<code>nginx</code> content阶段的<code>lua</code>代码<code>require</code>加载定义这些全局函数的文件的。根据<code>OpenResty</code>官方对于code cache的说明，只有最开始运行的LuaVM才会去真正加载这些文件，执行那些定义全局函数的代码，所以这些全局函数只有在该LuaVM所在的进程里是被定义的。此后，如果请求被同一个<code>nginx</code> worker处理，则可以正常使用之前定义的全局函数；但如果请求被分到不同的worker，就会出现变量没有定义的报错。</p>

<p>至于后一个问题，本渣观察到：在第一次访问时，<code>nginx</code> worker的CPU使用量飙升，一定概率导致server端响应时间超过设置的timeout时间，从而被client端认为是超时。
后来本渣继续缩小问题的排查范围，最后将它定位到client端读取并处理策划表的代码上。由于策划表的数据量大，所以这部分代码运行起来比较耗时倒也不奇怪。而前面提到code cache打开时，被<code>require</code>的文件只加载一次，这些处理策划表的代码也只有第一次才被真正运行，所以看到的现象就是第一次的请求会经常失败了。</p>

<p>前一个问题与全局函数有关，本渣看到不少<code>OpenResty</code>前辈提到<a href="https://segmentfault.com/a/1190000004297908">要避免使用全局变量</a>：</p>

<blockquote><p>一般来说，在ngx_lua的上下文中使用Lua全局变量真的不是什么好主意：</p>

<ol>
<li><p>滥用全局变量的副作用会对并发场景产生副作用，比如当使用者把这些变量看作是本地变量的时候；</p></li>
<li><p>Lua的全局变量需要向上查找一个全局环境（只是一个Lua表），代价比较高；</p></li>
<li><p>一些Lua的全局变量引用只是拼写错误，这会导致出错很难排查。</p></li>
</ol>
</blockquote>

<p>其中一个重要原因是会对并发场景产生副作用，本渣以前入过并行程序的坑，对这一点是不能同意更多的。不过回头来看我们client端代码里的那些全局“变”量，其实都是全局常量，不仅值不会被改变，而且我们代码中只会对这些常量执行一次赋值操作（当且仅当它们被定义时），这就不存在并发的副作用问题了。对于全局变量访问开销大的问题，本渣写了个脚本，在代码文件开头对使用到的全局变量<code>local</code>化（例如<code>local XXX = require('XXX')</code>）。拼写错误引发的bug嘛，本渣之前在<a href="http://galoisplusplus.coding.me/blog/2016/03/12/svn-precommit-hook/">svn hook</a>加了检查，所以在开发过程中提交代码就能及时发现问题。逐条分析下来，倒是命名空间污染不可避免，但是我们server端和client端的代码是完全独立的，命名空间污染并不会引发什么问题。当然严格一点，还是可以把client端涉及到的全局常量全部改成<code>local</code>的，写个脚本来处理所有代码也不难。<del>但处理问题要灵活嘛，既然在具体场景里无关紧要为啥还要迷信教条多此一举？嘿嘿，本渣就是这么懒XD</del>不过本渣考虑到client端这块代码仍在持续开发新的功能，这样做会给client端码农的开发带来限制：“喂，大熊弟，乃们的代码server端也要跑的哦，以后不能用全局常量了！”“WTF！”。这种节奏就不太理想了，本渣希望server端的代码重用对client端而言是透明的，client端的大熊弟在挖坑时可以完全无视server端战斗功能的存在：“server端关我鸟事，老子该干嘛还干嘛！”所以i呢，本渣放弃了去掉全局常量的治疗，最终选择在保留client端全局常量的前提下去解决它所带来的问题。</p>

<p>本渣最后解决前面提到的两个问题的黑科技是：把<code>require</code> client端代码的部分从<code>nginx</code>的content阶段，挪到了<code>nginx</code> lua module的init阶段：</p>

<p><img src="https://cloud.githubusercontent.com/assets/2137369/15272097/77d1c09e-1a37-11e6-97ef-d9767035fc3e.png"></p>

<p>init阶段会在<code>nginx</code> master进程加载<code>nginx</code>配置时执行，之后才由master进程clone出worker进程。全局常量放在这个阶段初始化，就不会有某些worker进程没有定义全局变量的报错；处理策划表的代码放在这个阶段执行，就把CPU开销转移到加载<code>nginx</code>配置上，不会增加请求的响应时间，可谓是一石二鸟。</p>

<p>有了一个可行的prototype，接下来本渣最关心的就是性能问题了：毕竟是第一次搞<code>OpenResty</code>，没啥经验，万一上线后server不堪重负挂了呢？不过我们做server端的老司机们都对自己开的车很自信，之前从没有写过测试代码，所以单接口压力测试还得本渣这server端小白自行琢磨啦。压测工具中，<code>Apache</code>的<code>ab</code>还是挺好上手的，输出的信息也很好分析。不过本渣也犯过傻：有一次正和小伙伴吹牛逼呢，说压测出来性能特别棒，一细看就打脸了，原来都是Non-200 response&hellip;&hellip;HTTP code为啥不是200捏？原来本渣是通过写client端<code>lua</code>代码来获取POST参数的，本渣的这段代码有bug，导致POST的参数有误。后来bug改掉了，结果小伙伴一脸鄙夷：乃不是可以看server端的access log吗？干嘛非要在client端写代码获取POST参数？&hellip;&hellip;好吧，开森就好&hellip;&hellip;<code>ab</code>做压测有个问题，就是POST参数是固定的，但本渣想用不同的战斗来压测自己那块功能，需要让不同请求的POST参数各不相同。最后本渣找到了<a href="https://github.com/wg/wrk"><code>wrk</code></a>这个压测工具。<code>wrk</code>最吸引本渣的，是它支持<code>lua</code>编程，普大喜奔啊！本渣这个懒人又可以重用client端的<code>lua</code>代码了！XDD</p>

<p>压测结果有了，但要知道性能热点才好对症下药做优化啊。这个时候本渣找到了春哥写的<a href="https://github.com/OpenResty/nginx-systemtap-toolkit">SystemTap脚本</a>和<a href="https://github.com/brendangregg/FlameGraph">火焰图工具</a>，这套工具简直是profile神器啊有不有！本渣之前也折腾过cocos2d-x游戏client端的profiler，万万没想到还有内核trace这种玩法！借助春哥所介绍的On-CPU和Off-CPU火焰图，本渣改进了一些问题，例如某些不被<code>luajit</code>支持的函数，会被<code>luajit</code>解释执行，在火焰图中会有<code>lj_xxx</code>的frame。这时候可以看看这些函数能否换成<code>luajit</code>支持的函数，像本渣就发现我们client端代码里有不少用<code>pairs</code>的地方，其实应该把相应的<code>lua table</code>设计成array而非hash table，采用<code>ipairs</code>来遍历。</p>

<p>在做压测和做火焰图的时候还发生过意外，有次<code>nginx</code> worker进程占满CPU，把开发server卡死了。分析下来是因为某个testcase使client端的战斗计算一直没有达到结束条件，死循环了。这倒也不奇怪，因为我们client端的战斗按照策划大大们的需求就是支持无限回合的。那为虾米在client端不会出现战斗计算死循环导致机器卡死呢？前面提到client端有战斗计算模块和战斗表现模块，这是一个典型的producer-consumer模型：战斗计算模块是producer，生产出若干回合的战报交给战斗表现模块，然后挂起；战斗表现模块是consumer，“消费”当前尚未播放的战报，同时接收玩家的操作信息，转交给战斗计算模块进行新回合的计算。也就是说，这两者总是相继运行的。而server端不存在战斗表现模块，战斗计算模块全部算完后就返回所有回合的战报，所以server端会有卡死问题而client端木有。这个问题大家讨论下来，最后策划大大决定在server端战斗加上战斗最大回合数限制，避免死循环。现在理论上没问题了，但本渣还是不放心：万一哪天代码有个bug会触发死循环呢？一出现问题就搞个大新闻，影响到整台机器，后果很严重啊！本渣首先想到把server端拆成一般业务server和战斗server，把两者隔离开，万一战斗出现问题，其他业务仍可以正常运作；然后对战斗server的<code>nginx</code> worker进程要有资源限制，不能让它们拖垮整台机器。最后采用的大杀器也许你已经猜到了，那就是<code>Docker</code>！采用<code>Docker</code>可以很方便地用<code>namespace</code>做环境隔离、用<code>cgroups</code>做资源限制，而且<code>Docker</code> container本质上是host机的进程，不会有虚拟机的性能降级。</p>

<p>敲定了这一解决方案，接下来的挖坑工作就顺理成章分成了两块：一个是如何把我们server端<code>Docker</code>化，另一个是业务server和战斗server如何协作。前者可以被<code>Docker</code>化的有<code>OpenResty</code>的<code>nginx</code>进程、<code>MySQL</code>和<code>redis</code>实例，好在<code>OpenResty</code>、<code>MySQL</code>和<code>redis</code>都有现成的<code>Docker</code>镜像，只需要稍做修改，就可以用到我们这套server端代码上。
<code>Docker</code>的构建实在太方便了，本渣也趁着把server端<code>Docker</code>化的时候，简化搭建开发server的流程。中间为了解决自动化快速备份现有数据库数据作为开发server数据的问题，折腾了一阵，学到不少东西，不过像<code>MySQL</code> <code>InnoDB</code>等技术细节还是得找时间扫盲一下～
至于后者，由于一般业务server和战斗server采用的是同一套代码（只是<code>nginx</code>配置稍有不同，本渣折腾配置时还踩过<code>nginx</code> <code>if</code>的坑，<a href="https://moonbingbing.gitbooks.io/OpenResty-best-practices/content/ngx/if_is_evil.html">“if is evil”</a>啊！），访问的是同样的<code>MySQL</code>和<code>redis</code>实例，所以只需要考虑这样一个问题：client端在连上一般业务server后，一般业务server如何把战斗相关的请求转给战斗server来处理？<a href="https://moonbingbing.gitbooks.io/OpenResty-best-practices/content/OpenResty/how_request_http.html">《Openresty最佳实践》</a>介绍了两种最常见的HTTP接口调用方法：</p>

<ol>
<li><p><code>proxy_pass</code></p></li>
<li><p><code>cosocket</code></p></li>
</ol>


<p>这两种方式本渣都折腾过了，最后采用了<code>proxy_pass</code>的方式。因为本渣考虑到以后可能会出现战斗server集群的情况，采用<code>proxy_pass</code>可以方便在<code>nginx</code>配置的<code>upstream</code>中配置多个战斗server，做load balance，可拓展性更好。加上我们启动战斗server其实只需要创建新的<code>Docker</code>容器，这整套方案可以很容易scale上去。当然，我们游戏目前的访问量还远不需要集群去撑，考虑集群似乎有杀鸡用牛刀之嫌，不过梦想总是要有的，万一我们游戏火了呢XD</p>

<p>嗯，最近就做了这么一点微不足道的工作，本篇也没什么干货，谢谢大家！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/07/19/nginx-tips/">Nginx Tips</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-19T11:22:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近在做server端开发，需要熟悉nginx，本渣也就在这里记录下自己遇到的一些问题。其实都比较小白，纯粹当作自我扫盲啦XD 本文将不定期更新。</p>

<h1>nginx: [emerg] bind() to \&lt;ip>:\&lt;port> failed (98: Address already in use)</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nginx: [emerg] bind() to &lt;ip&gt;:&lt;port&gt; failed (98: Address already in use)</span></code></pre></td></tr></table></div></figure>


<p>端口被占用，可以用查看使用文件或socket的命令<code>fuser</code>来杀掉占用端口的进程：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo fuser -k &lt;port&gt;/tcp</span></code></pre></td></tr></table></div></figure>


<p>此外，如果使用IPv6还可能出现如下报错：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nginx: [emerg] bind() to [::]:&lt;port&gt; failed (98: Address already in use)</span></code></pre></td></tr></table></div></figure>


<p>这是由于<code>nginx</code>配置中有<code>listen &lt;port&gt;;</code>，又有<code>listen [::]:&lt;port&gt;;</code>所致。
根据<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#listen">nginx文档</a>的描述：</p>

<blockquote><p>By default, nginx will look up both IPv4 and IPv6 addresses while resolving.</p></blockquote>

<p>也就是说，<code>listen [::]:&lt;port&gt;;</code>会同时监听IPv4和IPv6的流量，所以<code>listen &lt;port&gt;;</code>是重复配置，将它删掉即可。
如果只想使用IPv6可以采用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen [::]:&lt;port&gt; ipv6only=on;</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>

<p><a href="http://stackoverflow.com/questions/14972792/nginx-nginx-emerg-bind-to-80-failed-98-address-already-in-use">(SOF) nginx - nginx: [emerg] bind() to [::]:80 failed (98: Address already in use)</a></p>

<h1>worker_connections are more than open file resource limit: 1024</h1>

<p>这是因为nginx worker的用户打开的文件超过上限。</p>

<p>如果nginx配置中有<code>worker_rlimit_nofile</code>参数，则打开的文件数量上限由<code>worker_rlimit_nofile</code>决定（nofile=number of open files）。
那么<code>worker_rlimit_nofile</code>应该配多少呢？</p>

<p>在nginx配置的core module中找到<code>worker_processes</code>数量：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>worker_processes  4;</span></code></pre></td></tr></table></div></figure>


<p>在event module中找到<code>worker_connections</code>数量：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>events {
</span><span class='line'>    worker_connections  1024;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>那么最大总连接数是<code>worker_connections * worker_processes</code>，每个active connection都会占用一个文件描述符（file descriptor），所以<code>worker_rlimit_nofile</code>最好大于<code>worker_connections * worker_processes</code>。</p>

<h2>参考</h2>

<p><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile">nginx worker_rlimit_nofile文档</a></p>

<p><a href="http://serverfault.com/questions/208916/understanding-max-file-descriptors-for-linux-and-nginx-and-best-value-for-worke">(SOF) understanding max file descriptors for linux and nginx, and best value for worker_rlimit_nofile</a></p>

<p><a href="http://serverfault.com/questions/209014/how-can-i-observe-what-nginx-is-doing-to-solve-1024-worker-connections-are-n">(SOF) How can I observe what nginx is doing? (to solve: “1024 worker_connections are not enough”)</a></p>

<p>如果nginx配置中没有<code>worker_rlimit_nofile</code>参数，则采用系统默认的打开的文件数量上限。那么如何查看并修改这一上限呢？</p>

<p>首先在nginx配置的core module中找到nginx worker进程的用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user nginx;</span></code></pre></td></tr></table></div></figure>


<p>在终端登入这一用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo su - nginx</span></code></pre></td></tr></table></div></figure>


<p>查看文件描述符的硬上限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ulimit -Hn</span></code></pre></td></tr></table></div></figure>


<p>查看文件描述符的软上限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ulimit -Sn</span></code></pre></td></tr></table></div></figure>


<p>这里硬上限是严格不能超过的上限，不能增加。软上限属于警告性质的上限，可以调高，但也不能超过硬上限。</p>

<p>在<code>/etc/sysctl.conf</code>中修改下述数值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fs.file-max = 65536</span></code></pre></td></tr></table></div></figure>


<p>使用以下命令加载新的配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>检查是否已更新：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /proc/sys/fs/file-max</span></code></pre></td></tr></table></div></figure>


<p>一些资料提到修改<code>/etc/security/limits.conf</code>中nofile的软上限和硬上限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* soft     nofile         65535
</span><span class='line'>* hard     nofile         65535
</span><span class='line'>root soft     nofile         65535
</span><span class='line'>root hard     nofile         65535</span></code></pre></td></tr></table></div></figure>


<p>这种方式至少需要nginx worker进程重启才能生效。</p>

<h2>参考</h2>

<p><a href="http://ss64.com/bash/ulimit.html">ulimit manual</a></p>

<p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/index.html">通过 ulimit 改善系统性能</a></p>

<p><a href="http://stackoverflow.com/questions/3107476/what-does-soft-hard-nofile-mean-on-linux">What does “soft/hard nofile” mean on Linux</a></p>

<p><a href="http://unix.stackexchange.com/questions/29577/ulimit-difference-between-hard-and-soft-limits">ulimit: difference between hard and soft limits</a></p>

<p><a href="http://ss64.com/bash/limits.conf.html">limits.conf manual</a></p>

<p><a href="http://www.cyberciti.biz/faq/making-changes-to-proc-filesystem-permanently/">Making changes to /proc filesystem permanently</a></p>

<p><a href="http://serverfault.com/questions/640976/nginx-ulimit-worker-connections-exceed-open-file-resource-limit-1024">nginx uLimit &lsquo;worker_connections exceed open file resource limit: 1024&rsquo;</a></p>

<p><a href="http://unix.stackexchange.com/questions/108603/do-changes-in-etc-security-limits-conf-require-a-reboot">do changes in /etc/security/limits.conf require a reboot?</a></p>

<p><a href="http://serverfault.com/questions/165316/how-to-configure-linux-file-descriptor-limit-with-fs-file-max-and-ulimit">How to configure linux file descriptor limit with fs.file-max and ulimit</a></p>

<p><a href="http://stackoverflow.com/questions/21515463/how-to-increase-maximum-file-open-limit-ulimit-in-ubuntu">How to increase maximum file open limit (ulimit) in Ubuntu?</a></p>

<p><a href="http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files/">Nginx: 24: Too Many Open Files Error And Solution</a></p>

<h1>an upstream response is buffered to a temporary file</h1>

<h1>proxy_temp failed (13: Permission denied) while reading upstream</h1>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="3">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="1">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2019/04/07/macbeth-by-tang-shu-wing/">《麦克白》的布莱希特剧场实践</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/01/those-concerts-in-2018/">盘点2018年度的现场音乐会</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/05/22/cudaErrorCudartUnloading/">cudaErrorCudartUnloading问题排查及建议方案</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/01/01/those-concerts-in-2017/">盘点2017年度的现场音乐会</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2017/11/11/Jonas-Kaufmann-recital/">Jonas Kaufmann独奏会之艺术歌曲</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
<!--
Copyright &copy; 2020 - Galoisplusplus -
-->
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


</body>
</html>
