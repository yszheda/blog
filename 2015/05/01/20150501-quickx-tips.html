<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>quick-cocos2d-x tips</title>
                        <link rel="stylesheet" href="../../../theme/css/main.css" />
    <meta name="description" content="承接上一篇，这篇主要谈谈本渣在quickx用的一些脚本或自己折腾的一些定制，本文也将不时更新。 如无特殊说明，相关函数放在一个MyPackage的lua global table中： 1MyPackage = MyPackage or {} UI组件 滚动列 …" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../../../">Galoisplusplus</a></h1>
                        <nav><ul>
                                                <li><a href="../../../category/misc.html">misc</a></li>
                                                <li><a href="../../../category/music.html">music</a></li>
                                                <li><a href="../../../category/reading.html">reading</a></li>
                                                <li class="active"><a href="../../../category/tech.html">tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="../../../2015/05/01/20150501-quickx-tips.html" rel="bookmark"
             title="Permalink to quick-cocos2d-x tips">quick-cocos2d-x tips</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-05-01T14:00:00+08:00">
                Published: 五 01 5月 2015
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../../../author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="../../../category/tech.html">tech</a>.</p>
<p>tags: <a href="../../../tag/cocos2d-x.html">cocos2d-x</a> <a href="../../../tag/cs.html">CS</a> <a href="../../../tag/tech.html">tech</a> <a href="../../../tag/cocos2d-x-quick-cocos2d-x-quickx-cocos2d-cocos-game-gamedev-you-xi-kai-fa-you-xi-shou-you-kai-fa-shou-you-shou-ji-you-xi.html">cocos2d-x quick-cocos2d-x quickx cocos2d cocos game gameDev 游戏开发 游戏 手游开发 手游 手机游戏</a> </p>        
</footer><!-- /.post-info -->        <p>承接<a href="http://galoisplusplus.coding.me/blog/2015/01/04/quick-cocos2d-x-pitfalls/">上一篇</a>，这篇主要谈谈本渣在quickx用的一些脚本或自己折腾的一些定制，本文也将不时更新。</p>
<p>如无特殊说明，相关函数放在一个<code>MyPackage</code>的lua global table中：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">MyPackage</span> <span class="o">=</span> <span class="n">MyPackage</span> <span class="ow">or</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>

<!-- more -->

<h2 id="ui">UI组件</h2>
<h3 id="_1">滚动列表相关</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">--[[--</span>
<span class="cm">Refresh UIListView at the current postion.</span>
<span class="cm">NOTE: only needed in async mode</span>
<span class="cm">]]</span>
<span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">refreshUIListView</span><span class="p">(</span><span class="n">listView</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">listView</span><span class="p">.</span><span class="n">bAsyncLoad</span> <span class="kr">then</span>
        <span class="n">listView</span><span class="p">:</span><span class="n">reload</span><span class="p">()</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="o">#</span><span class="n">listView</span><span class="p">.</span><span class="n">items_</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="kr">then</span>
        <span class="n">listView</span><span class="p">:</span><span class="n">reload</span><span class="p">()</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">originPos</span> <span class="o">=</span> <span class="n">MyPackage</span><span class="p">.</span><span class="n">getOriginPosOfUIListView</span><span class="p">(</span><span class="n">listView</span><span class="p">)</span>
    <span class="c1">-- index of the previous beginning item</span>
    <span class="kd">local</span> <span class="n">beginIdx</span> <span class="o">=</span> <span class="n">listView</span><span class="p">.</span><span class="n">items_</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idx_</span>

    <span class="n">listView</span><span class="p">:</span><span class="n">removeAllItems</span><span class="p">()</span>
    <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">setPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">setContentSize</span><span class="p">(</span><span class="n">cc</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">MyPackage</span><span class="p">.</span><span class="n">drawUIListViewFromIdx</span><span class="p">(</span><span class="n">listView</span><span class="p">,</span> <span class="n">beginIdx</span><span class="p">,</span> <span class="n">originPos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">originPos</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="kr">end</span>

<span class="cm">--[[--</span>
<span class="cm">NOTE: only needed in async mode</span>
<span class="cm">]]</span>
<span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">getOriginPosOfUIListView</span><span class="p">(</span><span class="n">listView</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">listView</span><span class="p">.</span><span class="n">bAsyncLoad</span> <span class="kr">then</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">getContainerCascadeBoundingBox</span> <span class="o">=</span> <span class="kr">function</span> <span class="p">(</span><span class="n">listView</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">boundingBox</span>
        <span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">listView</span><span class="p">.</span><span class="n">items_</span><span class="p">)</span> <span class="kr">do</span>
            <span class="kd">local</span> <span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">item</span><span class="p">:</span><span class="n">getItemSize</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">item</span><span class="p">:</span><span class="n">getPosition</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">anchor</span> <span class="o">=</span> <span class="n">item</span><span class="p">:</span><span class="n">getAnchorPoint</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">h</span>

            <span class="kr">if</span> <span class="n">boundingBox</span> <span class="kr">then</span>
                <span class="n">boundingBox</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">rectUnion</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">,</span> <span class="n">cc</span><span class="p">.</span><span class="n">rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
            <span class="kr">else</span>
                <span class="n">boundingBox</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="kr">end</span>
        <span class="kr">end</span>

        <span class="kd">local</span> <span class="n">point</span> <span class="o">=</span> <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">convertToWorldSpace</span><span class="p">(</span><span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">boundingBox</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">boundingBox</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">point</span><span class="p">.</span><span class="n">x</span>
        <span class="n">boundingBox</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">.</span><span class="n">y</span>
        <span class="kr">return</span> <span class="n">boundingBox</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">cascadeBound</span> <span class="o">=</span> <span class="n">getContainerCascadeBoundingBox</span><span class="p">(</span><span class="n">listView</span><span class="p">)</span>
<span class="c1">--  local cascadeBound = listView.scrollNode:getCascadeBoundingBox()</span>

    <span class="kd">local</span> <span class="n">localPos</span> <span class="o">=</span> <span class="n">listView</span><span class="p">:</span><span class="n">convertToNodeSpace</span><span class="p">(</span><span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>

    <span class="kd">local</span> <span class="n">originPosX</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">originPosY</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kr">if</span> <span class="n">cc</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">UIScrollView</span><span class="p">.</span><span class="n">DIRECTION_VERTICAL</span> <span class="o">==</span> <span class="n">listView</span><span class="p">.</span><span class="n">direction</span> <span class="kr">then</span>
        <span class="c1">-- ahead part of view</span>
        <span class="n">originPosY</span> <span class="o">=</span> <span class="n">localPos</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">height</span>
    <span class="kr">else</span>
        <span class="c1">-- left part of view</span>
        <span class="n">originPosX</span> <span class="o">=</span> <span class="o">-</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">localPos</span><span class="p">.</span><span class="n">x</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">originPosX</span><span class="p">,</span> <span class="n">originPosY</span><span class="p">)</span>
<span class="kr">end</span>

<span class="cm">--[[--</span>
<span class="cm">Draw UIListView from the `beginIdx`th item at position (`originPosX`, `originPosY`).</span>
<span class="cm">NOTE: only needed in async mode</span>
<span class="cm">]]</span>
<span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">drawUIListViewFromIdx</span><span class="p">(</span><span class="n">listView</span><span class="p">,</span> <span class="n">beginIdx</span><span class="p">,</span> <span class="n">originPosX</span><span class="p">,</span> <span class="n">originPosY</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">listView</span><span class="p">.</span><span class="n">bAsyncLoad</span> <span class="kr">then</span>
        <span class="n">listView</span><span class="p">:</span><span class="n">reload</span><span class="p">()</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="n">listView</span><span class="p">:</span><span class="n">removeAllItems</span><span class="p">()</span>
    <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">setPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">setContentSize</span><span class="p">(</span><span class="n">cc</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="kd">local</span> <span class="n">beginIdx</span> <span class="o">=</span> <span class="n">beginIdx</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="kd">local</span> <span class="n">originPosX</span> <span class="o">=</span> <span class="n">originPosX</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">originPosY</span> <span class="o">=</span> <span class="n">originPosY</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="kd">local</span> <span class="n">count</span> <span class="o">=</span> <span class="n">listView</span><span class="p">.</span><span class="n">delegate_</span><span class="p">[</span><span class="n">cc</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">UIListView</span><span class="p">.</span><span class="n">DELEGATE</span><span class="p">](</span><span class="n">listView</span><span class="p">,</span> <span class="n">cc</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">UIListView</span><span class="p">.</span><span class="n">COUNT_TAG</span><span class="p">)</span>
    <span class="n">listView</span><span class="p">.</span><span class="n">items_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">itemW</span><span class="p">,</span> <span class="n">itemH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">item</span>
    <span class="kd">local</span> <span class="n">containerW</span><span class="p">,</span> <span class="n">containerH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">beginIdx</span><span class="p">,</span> <span class="n">count</span> <span class="kr">do</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">itemW</span><span class="p">,</span> <span class="n">itemH</span> <span class="o">=</span> <span class="n">listView</span><span class="p">:</span><span class="n">loadOneItem_</span><span class="p">(</span><span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">originPosX</span><span class="p">,</span> <span class="n">originPosY</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">cc</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">UIScrollView</span><span class="p">.</span><span class="n">DIRECTION_VERTICAL</span> <span class="o">==</span> <span class="n">listView</span><span class="p">.</span><span class="n">direction</span> <span class="kr">then</span>
            <span class="n">originPosY</span> <span class="o">=</span> <span class="n">originPosY</span> <span class="o">-</span> <span class="n">itemH</span>
            <span class="n">containerH</span> <span class="o">=</span> <span class="n">containerH</span> <span class="o">+</span> <span class="n">itemH</span>
        <span class="kr">else</span>
            <span class="n">originPosX</span> <span class="o">=</span> <span class="n">originPosX</span> <span class="o">+</span> <span class="n">itemW</span>
            <span class="n">containerW</span> <span class="o">=</span> <span class="n">containerW</span> <span class="o">+</span> <span class="n">itemW</span>
        <span class="kr">end</span>
        <span class="kr">if</span> <span class="n">containerW</span> <span class="o">&gt;</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">listView</span><span class="p">.</span><span class="n">redundancyViewVal</span>
            <span class="ow">or</span> <span class="n">containerH</span> <span class="o">&gt;</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">height</span> <span class="o">+</span> <span class="n">listView</span><span class="p">.</span><span class="n">redundancyViewVal</span> <span class="kr">then</span>
            <span class="kr">break</span>
        <span class="kr">end</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">cc</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">UIScrollView</span><span class="p">.</span><span class="n">DIRECTION_VERTICAL</span> <span class="o">==</span> <span class="n">listView</span><span class="p">.</span><span class="n">direction</span> <span class="kr">then</span>
        <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">setPosition</span><span class="p">(</span><span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
    <span class="kr">else</span>
        <span class="n">listView</span><span class="p">.</span><span class="n">container</span><span class="p">:</span><span class="n">setPosition</span><span class="p">(</span><span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">listView</span><span class="p">.</span><span class="n">viewRect_</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
    <span class="kr">end</span>

    <span class="n">listView</span><span class="p">:</span><span class="n">increaseOrReduceItem_</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">elasticMoveUIScrollView</span><span class="p">(</span><span class="n">scrollView</span><span class="p">,</span> <span class="n">scrollToBottom</span><span class="p">,</span> <span class="n">scrollToRight</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">cascadeBound</span> <span class="o">=</span> <span class="n">scrollView</span><span class="p">:</span><span class="n">getScrollNodeRect</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">disX</span><span class="p">,</span> <span class="n">disY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">viewRect</span> <span class="o">=</span> <span class="n">scrollView</span><span class="p">:</span><span class="n">getViewRectInWorldSpace</span><span class="p">()</span>

    <span class="kr">if</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">width</span> <span class="kr">then</span>
        <span class="kr">if</span> <span class="n">scrollToRight</span> <span class="kr">then</span>
            <span class="n">disX</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">width</span>
        <span class="kr">else</span>
            <span class="n">disX</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span>
        <span class="kr">end</span>
    <span class="kr">else</span>
        <span class="kr">if</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">x</span> <span class="kr">then</span>
            <span class="n">disX</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span>
        <span class="kr">elseif</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">width</span> <span class="kr">then</span>
            <span class="n">disX</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">width</span>
        <span class="kr">end</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">height</span> <span class="kr">then</span>
        <span class="kr">if</span> <span class="n">scrollToBottom</span> <span class="kr">then</span>
            <span class="n">disY</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span>
        <span class="kr">else</span>
            <span class="n">disY</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">height</span>
        <span class="kr">end</span>
    <span class="kr">else</span>
        <span class="kr">if</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">y</span> <span class="kr">then</span>
            <span class="n">disY</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span>
        <span class="kr">elseif</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">height</span> <span class="kr">then</span>
            <span class="n">disY</span> <span class="o">=</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">viewRect</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cascadeBound</span><span class="p">.</span><span class="n">height</span>
        <span class="kr">end</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">disX</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">disY</span> <span class="kr">then</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">posX</span><span class="p">,</span> <span class="n">posY</span> <span class="o">=</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">scrollNode</span><span class="p">:</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="n">scrollView</span><span class="p">.</span><span class="n">position_</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">posX</span> <span class="o">+</span> <span class="n">disX</span><span class="p">,</span> <span class="n">posY</span> <span class="o">+</span> <span class="n">disY</span><span class="p">)</span>
    <span class="n">scrollView</span><span class="p">.</span><span class="n">scrollNode</span><span class="p">:</span><span class="n">setPosition</span><span class="p">(</span><span class="n">scrollView</span><span class="p">.</span><span class="n">position_</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<p><em><em>更新</em>：以上改动已挪到<a href="https://github.com/yszheda/quickx-extensions">yszheda/quickx-extensions</a>的UIScrollView或UIListView中。</em></p>
<h2 id="lua">lua语言相关</h2>
<h3 id="bool">bool转数字</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">bool2number</span><span class="p">(</span><span class="n">bool</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">bool</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<h3 id="table">table相关</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">removeValueFromArray</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">idx</span>
    <span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="kr">do</span>
        <span class="kr">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span> <span class="kr">then</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="kr">break</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="n">idx</span> <span class="kr">then</span>
        <span class="nb">table.remove</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">hasValueInArray</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">hasValue</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="kr">do</span>
        <span class="kr">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span> <span class="kr">then</span>
            <span class="n">hasValue</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="kr">break</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">hasValue</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<h3 id="utf8">UTF8字符串</h3>
<p>cocos2d-x的label默认为UTF8编码，一般场景下主要需要以下两个功能：</p>
<ul>
<li>
<p>字符串长度</p>
</li>
<li>
<p>截取子串</p>
</li>
</ul>
<p>原先本渣用cocos2d-x时写了个C++函数来求长度：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">utf8StringSize</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">charArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">charArray</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charArray</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm">     *  References: http://stackoverflow.com/questions/4063146/getting-the-actual-length-of-a-utf-8-encoded-stdstring</span>
<span class="cm">     *-----------------------------------------------------------------------------*/</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x80</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">charArray</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>cocos2d-x <code>Helper</code>也提供了接口来做字符串截取：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">getSubStringOfUTF8String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">str</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">size_type</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">size_type</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>

<p>在lua方面，quickx已经提供<code>string.utf8len</code>来求字符串长度，本渣仿照其实现写了个截取子串的函数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">utf8str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="kd">local</span> <span class="kr">function</span> <span class="nf">utf8CharSize</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="kd">local</span> <span class="n">arr</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">}</span>
        <span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="o">#</span><span class="n">arr</span>
        <span class="kr">while</span> <span class="n">arr</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="kr">do</span>
            <span class="kr">if</span> <span class="n">char</span> <span class="o">&gt;=</span> <span class="n">arr</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="kr">then</span>
                <span class="kr">break</span>
            <span class="kr">end</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="kr">end</span>

        <span class="kr">return</span> <span class="n">size</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">startIdx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kr">while</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">char</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">startIdx</span><span class="p">)</span>
        <span class="n">startIdx</span> <span class="o">=</span> <span class="n">startIdx</span> <span class="o">+</span> <span class="n">utf8CharSize</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">endIdx</span> <span class="o">=</span> <span class="n">startIdx</span>
    <span class="kr">while</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">do</span>
        <span class="kr">if</span> <span class="n">endIdx</span> <span class="o">&gt;</span> <span class="o">#</span><span class="n">str</span> <span class="kr">then</span>
            <span class="n">endIdx</span> <span class="o">=</span> <span class="o">#</span><span class="n">str</span>
            <span class="kr">break</span>
        <span class="kr">end</span>
        <span class="kd">local</span> <span class="n">char</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">endIdx</span><span class="p">)</span>
        <span class="n">endIdx</span> <span class="o">=</span> <span class="n">endIdx</span> <span class="o">+</span> <span class="n">utf8CharSize</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">str</span><span class="p">:</span><span class="n">sub</span><span class="p">(</span><span class="n">startIdx</span><span class="p">,</span> <span class="n">endIdx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<p>不过目前lua5.3已经有UTF8库，可以不用自行造轮子了。另外，关于其他UTF8相关的lua问题可以参考<a href="http://lua-users.org/wiki/LuaUnicode">Lua Unicode</a>。</p>
<h2 id="helper-functions">其他Helper Functions</h2>
<h3 id="viewcallbackwrapper">更新view的callbackWrapper</h3>
<p>我们经常碰到如下的情景：
游戏向后端请求数据，在拿到数据之后执行某个callback去更新某个view。
这种网络请求通常是异步的，如果所请求的数据回来时相关的view被释放，则执行操作该view的callback会导致问题（例如访问非法内存地址）。
这时候我们可以用<code>tolua.isnull</code>来判断相关的view对象是否被释放。
由于每个这种类型的callback都有必要加上这样的guard code，所以本渣干脆做了如下的接口：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">callbackWrapper</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="kr">return</span> <span class="kr">function</span><span class="p">(...)</span>
        <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">view</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">views</span><span class="p">)</span> <span class="kr">do</span>
            <span class="kr">if</span> <span class="n">tolua</span><span class="p">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="kr">then</span>
                <span class="kr">return</span>
            <span class="kr">end</span>
        <span class="kr">end</span>
        <span class="kr">if</span> <span class="n">callback</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
            <span class="n">callback</span><span class="p">(...)</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<h3 id="node">拿到一个node九个端点的坐标</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">--[[--</span>
<span class="cm">get the nine positions of a node (the following variables are defined in display.lua of quickx):</span>
<span class="cm">display.CENTER</span>
<span class="cm">display.LEFT_TOP</span>
<span class="cm">display.CENTER_TOP</span>
<span class="cm">display.RIGHT_TOP</span>
<span class="cm">display.CENTER_LEFT</span>
<span class="cm">display.CENTER_RIGHT</span>
<span class="cm">display.BOTTOM_LEFT</span>
<span class="cm">display.BOTTOM_RIGHT</span>
<span class="cm">display.BOTTOM_CENTER</span>
<span class="cm">]]</span>
<span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">getPositionOfNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">alignType</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">node</span> <span class="ow">or</span> <span class="n">tolua</span><span class="p">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="n">node</span><span class="p">:</span><span class="n">getContentSize</span><span class="p">()</span>
    <span class="kr">if</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">node</span><span class="p">:</span><span class="n">getCascadeBoundingBox</span><span class="p">()</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">node</span><span class="p">:</span><span class="n">getPosition</span><span class="p">())</span>
    <span class="kd">local</span> <span class="n">anchorPoint</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">p</span><span class="p">(</span><span class="n">node</span><span class="p">:</span><span class="n">getAnchorPoint</span><span class="p">())</span>

    <span class="kr">if</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">LEFT_TOP</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">LEFT_CENTER</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">LEFT_BOTTOM</span> <span class="kr">then</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">x</span>
    <span class="kr">elseif</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER_TOP</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER_BOTTOM</span> <span class="kr">then</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="kr">elseif</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">RIGHT_TOP</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">RIGHT_CENTER</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">RIGHT_BOTTOM</span> <span class="kr">then</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">BOTTOM_LEFT</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">BOTTOM_CENTER</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">BOTTOM_RIGHT</span> <span class="kr">then</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">y</span>
    <span class="kr">elseif</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER_LEFT</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER_RIGHT</span> <span class="kr">then</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="kr">elseif</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">TOP_LEFT</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">TOP_CENTER</span> <span class="ow">or</span>
        <span class="n">alignType</span> <span class="o">==</span> <span class="n">display</span><span class="p">.</span><span class="n">TOP_RIGHT</span> <span class="kr">then</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">pos</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<h3 id="containerspritecontainer">在某个container中加入sprite，可指定根据container大小进行缩放及对齐方式</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span> <span class="nc">MyPackage</span><span class="p">.</span><span class="nf">displaySpriteOnContainer</span><span class="p">(</span><span class="n">sprite</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">scaleToFit</span><span class="p">,</span> <span class="n">alignType</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">tolua</span><span class="p">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">container</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span>
    <span class="kr">end</span>

    <span class="c1">-- default settings</span>
    <span class="kd">local</span> <span class="n">scaleToFit</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaleToFit</span> <span class="o">~=</span> <span class="kc">false</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">alignType</span> <span class="o">=</span> <span class="n">alignType</span> <span class="ow">or</span> <span class="n">display</span><span class="p">.</span><span class="n">CENTER</span>

    <span class="kr">if</span> <span class="ow">not</span> <span class="n">tolua</span><span class="p">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">sprite</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kd">local</span> <span class="n">originSize</span> <span class="o">=</span> <span class="n">sprite</span><span class="p">:</span><span class="n">getContentSize</span><span class="p">()</span>
        <span class="kr">if</span> <span class="n">originSize</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">originSize</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
            <span class="n">originSize</span> <span class="o">=</span> <span class="n">sprite</span><span class="p">:</span><span class="n">getCascadeBoundingBox</span><span class="p">()</span>
        <span class="kr">end</span>

        <span class="kd">local</span> <span class="n">targetSize</span> <span class="o">=</span> <span class="n">container</span><span class="p">:</span><span class="n">getContentSize</span><span class="p">()</span>
        <span class="kr">if</span> <span class="n">targetSize</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">targetSize</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
            <span class="n">targetSize</span> <span class="o">=</span> <span class="n">container</span><span class="p">:</span><span class="n">getCascadeBoundingBox</span><span class="p">()</span>
        <span class="kr">end</span>

        <span class="kr">if</span> <span class="n">scaleToFit</span> <span class="kr">then</span>
            <span class="n">sprite</span><span class="p">:</span><span class="n">setScale</span><span class="p">(</span><span class="n">targetSize</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">originSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">targetSize</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">originSize</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
        <span class="kr">end</span>

        <span class="c1">-- NOTE: ignore container&#39;s anchor point</span>
        <span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">MyPackage</span><span class="p">.</span><span class="n">getPositionOfNode</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">alignType</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">leftBottomPos</span> <span class="o">=</span> <span class="n">MyPackage</span><span class="p">.</span><span class="n">getPositionOfNode</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">display</span><span class="p">.</span><span class="n">LEFT_BOTTOM</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">posX</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">leftBottomPos</span><span class="p">.</span><span class="n">x</span>
        <span class="kd">local</span> <span class="n">posY</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">leftBottomPos</span><span class="p">.</span><span class="n">y</span>
        <span class="n">display</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">sprite</span><span class="p">,</span> <span class="n">alignType</span><span class="p">,</span> <span class="n">posX</span><span class="p">,</span> <span class="n">posY</span><span class="p">)</span>
        <span class="n">container</span><span class="p">:</span><span class="n">addChild</span><span class="p">(</span><span class="n">sprite</span><span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="http://getpelican.com/">Pelican</a></li>
                                                        <li><a href="http://python.org/">Python.org</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/yszheda">GitHub</a></li>
                                                        <li><a href="https://twitter.com/yszheda">Twitter</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>