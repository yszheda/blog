<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>cocos2d-x中的auto-batching</title>
                        <link rel="stylesheet" href="http://yszheda.github.io/blog/theme/css/main.css" />
    <meta name="description" content="本渣比较懒，就直接从工作邮件挑一部分放上来哈～ 1.神马是GL calls？ GL calls也称batch，可以单纯理解成绘制次数，一般来说CPU向GPU发送batch会造成瓶颈，这个指标越 …" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="http://yszheda.github.io/blog/">Galoisplusplus</a></h1>
                        <nav><ul>
                                                <li><a href="http://yszheda.github.io/blog/category/misc.html">misc</a></li>
                                                <li><a href="http://yszheda.github.io/blog/category/music.html">music</a></li>
                                                <li><a href="http://yszheda.github.io/blog/category/reading.html">reading</a></li>
                                                <li class="active"><a href="http://yszheda.github.io/blog/category/tech.html">tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="http://yszheda.github.io/blog/2015/06/08/20150608-auto-batch-in-cocos2d-x.html" rel="bookmark"
             title="Permalink to cocos2d-x中的auto-batching">cocos2d-x中的auto-batching</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-06-08T02:00:00+08:00">
                Published: 一 08 6月 2015
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="http://yszheda.github.io/blog/author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="http://yszheda.github.io/blog/category/tech.html">tech</a>.</p>
<p>tags: <a href="http://yszheda.github.io/blog/tag/cocos2d-x.html">cocos2d-x</a> <a href="http://yszheda.github.io/blog/tag/cs.html">CS</a> <a href="http://yszheda.github.io/blog/tag/tech.html">tech</a> <a href="http://yszheda.github.io/blog/tag/cocos.html">cocos</a> <a href="http://yszheda.github.io/blog/tag/cocos2d.html">cocos2d</a> <a href="http://yszheda.github.io/blog/tag/you-xi-kai-fa.html">游戏开发</a> <a href="http://yszheda.github.io/blog/tag/shou-you-kai-fa.html">手游开发</a> <a href="http://yszheda.github.io/blog/tag/mobile-game.html">mobile game</a> <a href="http://yszheda.github.io/blog/tag/game-devolopment.html">game devolopment</a> </p>        
</footer><!-- /.post-info -->        <p>本渣比较懒，就直接从工作邮件挑一部分放上来哈～</p>
<p>1.神马是GL calls？</p>
<p>GL calls也称batch，可以单纯理解成绘制次数，一般来说CPU向GPU发送batch会造成瓶颈，这个指标越小越好。</p>
<p>2.如何降低GL calls？</p>
<p>通常我们会在测试版的屏幕左下角看到一些指标，其中GL verts是需要绘制的总顶点数，一般是让每个batch的顶点数越多越好。cocosd-x引擎提供了auto batching的机制，在一定条件下，对于多个同一纹理（事实上是纹理、shader、blendFunc都需要一样）的<code>node</code>，只需要一次GL call。</p>
<p>3.auto batching原理？</p>
<p>引擎在绘制场景时会遍历每个<code>node</code>，调<code>node</code>的<code>draw</code>函数：以前<code>draw</code>函数会直接绘制<code>node</code>，但3.0之后的版本改为向一个叫<code>RenderQueue</code>的队列push绘制命令，并不马上渲染。在渲染时从该queue拿出命令，如果连续的命令都是纹理A，那么A只需要一个batch，但如果中间插入了一个纹理B，则无法只用一个batch。</p>
<p>例如：<code>RenderQueue</code>中是AAAAABAAAAA，则需要三个batches。</p>
<p>4.auto-batching/<code>RenderQueue</code>中连续的条件？</p>
<p><code>node</code>在向<code>RenderQueue</code> push命令时会先对子节点排序（排序按照<code>localZOrder</code>，<code>localZOrder</code>一样就比较子节点添加的顺序），排完序再依次push相应子节点的绘制命令。<code>RenderQueue</code>会根据<code>globalZOrder</code>再排一次序。所以最后<code>RenderQueue</code>中顺序是先按<code>globalZOrder</code>、再按<code>localZOrder</code>、最后按子节点添加到父节点的顺序。</p>
<p>PS. <code>node</code>默认的<code>globalZOrder</code>和<code>localZOrder</code>都为0</p>
<p>5.现有的系统如何用auto-batching？</p>
<ul>
<li>
<p>为同一纹理的UI元素都设同一个大于0的<code>globalZOrder</code>：可以保证一定只有一次batch。</p>
</li>
<li>
<p>为同一纹理的UI元素都设同一个大于0的<code>localZOrder</code>：推荐使用。<code>localZOrder</code>可以直接在UI编辑器里改，但有一定限制和技巧</p>
<ul>
<li>
<p>如果同一纹理的UI元素的parent都是同一个<code>node</code>，这种情况比较简单，直接在UI编辑器改即可（如果同一纹理的UI元素在编辑器中都放在一块添加，则也已经被auto batch了，不用改）。</p>
</li>
<li>
<p>如果同一纹理的UI元素的parent不是同一个<code>node</code>（这种情况在各处用<code>UIListView</code>的地方很常见），不一定能被auto-batch到，要具体看在<code>RenderQueue</code>里是否连续。希望cocos2d-x引擎能继续优化auto-batching机制以方便处理这一情况。</p>
</li>
</ul>
</li>
</ul>
<p>6.如何判读改的东西被auto-batch？</p>
<p>代码中给它设一个专有的大于0的<code>globalZOrder</code>，看看GL calls是否减少。不变则说明之前的改动已被auto batch。</p>
<h1 id="_1">参考资料</h1>
<ul>
<li>
<p>[1]<a href="http://www.cocos2d-x.org/wiki/Cocos2d_v30_renderer_pipeline_roadmap">COCOS2D V30 RENDERER PIPELINE ROADMAP</a></p>
</li>
<li>
<p>[2]“笨木头”大神这篇讲得挺好，安利一下<a href="http://www.benmutou.com/archives/1006">Cocos2d-x Auto-batching 浅浅的”深入分析”</a></p>
</li>
<li>
<p>[3]<a href="http://blog.csdn.net/kaitiren/article/details/30478695">COCOS2DX 3.0 优化提升渲染速度 Auto-batching</a></p>
</li>
<li>
<p>[4]<a href="http://blog.csdn.net/fansongy/article/details/26968473">10行代码看自动Batch，10行代码看自动剔除</a></p>
</li>
<li>
<p>[5]<a href="http://blog.csdn.net/cloud95/article/details/40046697">cocos2dx auto culling 和 auto batching</a></p>
</li>
<li>
<p>[6]<a href="http://www.cocoachina.com/bbs/read.php?tid-200808.html">自动批处理（Auto-batching）</a></p>
</li>
</ul>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="http://getpelican.com/">Pelican</a></li>
                                                        <li><a href="http://python.org/">Python.org</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/yszheda">GitHub</a></li>
                                                        <li><a href="https://twitter.com/yszheda">Twitter</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>