<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Galoisplusplus - 特效</title>
                        <link rel="stylesheet" href="../theme/css/main.css" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../">Galoisplusplus</a></h1>
                        <nav><ul>
                                                <li><a href="../category/misc.html">misc</a></li>
                                                <li><a href="../category/music.html">music</a></li>
                                                <li><a href="../category/reading.html">reading</a></li>
                                                <li><a href="../category/tech.html">tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="../2015/02/01/20150201-label-typewriting-effect.html">cocos2d-x实现打字特效</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-02-01T02:36:00+08:00">
                Published: 日 01 2月 2015
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="../category/tech.html">tech</a>.</p>
<p>tags: <a href="../tag/tech.html">tech</a> <a href="../tag/cs.html">CS</a> <a href="../tag/cocos2d-x.html">cocos2d-x</a> <a href="../tag/quick.html">quick</a> <a href="../tag/quickx.html">quickx</a> <a href="../tag/quick-cocos2d-x.html">quick-cocos2d-x</a> <a href="../tag/cocos.html">cocos</a> <a href="../tag/cocos2d.html">cocos2d</a> <a href="../tag/te-xiao.html">特效</a> <a href="../tag/da-zi-te-xiao.html">打字特效</a> <a href="../tag/effect.html">effect</a> <a href="../tag/typewriting.html">typewriting</a> <a href="../tag/you-xi-kai-fa.html">游戏开发</a> <a href="../tag/shou-you-kai-fa.html">手游开发</a> <a href="../tag/mobile-game.html">mobile game</a> <a href="../tag/game-devolopment.html">game devolopment</a> </p>        
</footer><!-- /.post-info --><p>这次分享一个在cocos2d-x中实现打字特效的小功能。</p>
<p>首先，cocos2d-x中label默认是utf8编码，quickx提供了一个<code>string.utf8len</code>接口，这里再加一个截取子字符串的函数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span> <span class="nf">utf8str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="kd">local</span> <span class="kr">function</span> <span class="nf">utf8CharSize</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="kr">if</span> <span class="ow">not</span> <span class="n">char</span> <span class="kr">then</span>
            <span class="kr">return</span> <span class="mi">0</span>
        <span class="kr">elseif</span> <span class="n">char</span> <span class="o">&gt;</span> <span class="mi">240</span> <span class="kr">then</span>
            <span class="kr">return</span> <span class="mi">4</span>
        <span class="kr">elseif</span> <span class="n">char</span> <span class="o">&gt;</span> <span class="mi">225</span> <span class="kr">then</span>
            <span class="kr">return</span> <span class="mi">3</span>
        <span class="kr">elseif</span> <span class="n">char</span> <span class="o">&gt;</span> <span class="mi">192</span> <span class="kr">then</span>
            <span class="kr">return</span> <span class="mi">2</span>
        <span class="kr">else</span>
            <span class="kr">return</span> <span class="mi">1</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">startIdx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kr">while</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">char</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">startIdx</span><span class="p">)</span>
        <span class="n">startIdx</span> <span class="o">=</span> <span class="n">startIdx</span> <span class="o">+</span> <span class="n">utf8CharSize</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">endIdx</span> <span class="o">=</span> <span class="n">startIdx</span>
    <span class="kr">while</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">do</span>
        <span class="kr">if</span> <span class="n">endIdx</span> <span class="o">&gt;</span> <span class="o">#</span><span class="n">str</span> <span class="kr">then</span>
            <span class="n">endIdx</span> <span class="o">=</span> <span class="o">#</span><span class="n">str</span>
            <span class="kr">break</span>
        <span class="kr">end</span>
        <span class="kd">local</span> <span class="n">char</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">endIdx</span> <span class="o">=</span> <span class="n">endIdx</span> <span class="o">+</span> <span class="n">utf8CharSize</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">str</span><span class="p">:</span><span class="n">sub</span><span class="p">(</span><span class="n">startIdx</span><span class="p">,</span> <span class="n">endIdx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<p>第一种实现方式是一开始把每个字符scale到0，延迟一定时间后再scale到原大小：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- textDelayTime为每个字显示的延迟时间</span>
<span class="kr">function</span> <span class="nf">typewriting</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">textDelayTime</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getString</span><span class="p">()</span>
    <span class="c1">-- 这里考虑了label可能有换行的情况</span>
    <span class="kd">local</span> <span class="n">totalLen</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">utf8len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">+</span> <span class="n">label</span><span class="p">:</span><span class="n">getStringNumLines</span><span class="p">()</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">totalLen</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">sprite</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getLetter</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">sprite</span> <span class="kr">then</span>
            <span class="n">sprite</span><span class="p">:</span><span class="n">setScale</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">textAppear</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">ScaleTo</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">totalLen</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">textDelay</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">DelayTime</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">textDelayTime</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="kd">local</span> <span class="n">textActionSeq</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">Sequence</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">textDelay</span><span class="p">,</span> <span class="n">textAppear</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">sprite</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getLetter</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">sprite</span> <span class="kr">then</span>
            <span class="n">sprite</span><span class="p">:</span><span class="n">runAction</span><span class="p">(</span><span class="n">textActionSeq</span><span class="p">)</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<p>这种实现的效果有跳入感，换一种方式，用visibility来控制：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- textDelayTime为每个字显示的延迟时间</span>
<span class="kr">function</span> <span class="nf">typewriting</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">textDelayTime</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getString</span><span class="p">()</span>
    <span class="c1">-- 这里考虑了label可能有换行的情况</span>
    <span class="kd">local</span> <span class="n">totalLen</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">utf8len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">+</span> <span class="n">label</span><span class="p">:</span><span class="n">getStringNumLines</span><span class="p">()</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">totalLen</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">sprite</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getLetter</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">sprite</span> <span class="kr">then</span>
            <span class="n">sprite</span><span class="p">:</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">textAppear</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">Show</span><span class="p">:</span><span class="n">create</span><span class="p">()</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">totalLen</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">textDelay</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">DelayTime</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">textDelayTime</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="kd">local</span> <span class="n">textActionSeq</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">Sequence</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">textDelay</span><span class="p">,</span> <span class="n">textAppear</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">sprite</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getLetter</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">sprite</span> <span class="kr">then</span>
            <span class="n">sprite</span><span class="p">:</span><span class="n">runAction</span><span class="p">(</span><span class="n">textActionSeq</span><span class="p">)</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<p>这种效果也没好多少，最后本渣换了一种思路，不按一个字一个字来runAction了，改为把label作为整体来runAction，在action中去setString，这种方式的效果好多了：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- textDelayTime为每个字显示的延迟时间</span>
<span class="kr">function</span> <span class="nf">typewriting</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">textDelayTime</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">label</span><span class="p">:</span><span class="n">getString</span><span class="p">()</span>
    <span class="c1">-- 这里考虑了label可能有换行的情况</span>
    <span class="kd">local</span> <span class="n">totalLen</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">utf8len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">+</span> <span class="n">label</span><span class="p">:</span><span class="n">getStringNumLines</span><span class="p">()</span>
    <span class="n">label</span><span class="p">:</span><span class="n">setString</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">textActions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">totalLen</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">textDelay</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">DelayTime</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">textDelayTime</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">textAppear</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">CallFunc</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
            <span class="n">label</span><span class="p">:</span><span class="n">setString</span><span class="p">(</span><span class="n">utf8str</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="kr">end</span><span class="p">)</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">textActions</span><span class="p">,</span> <span class="n">textDelay</span><span class="p">)</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">textActions</span><span class="p">,</span> <span class="n">textAppear</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">textActionSeq</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">Sequence</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">textActions</span><span class="p">)</span>
    <span class="n">label</span><span class="p">:</span><span class="n">runAction</span><span class="p">(</span><span class="n">textActionSeq</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>                    </article>
                </aside><!-- /#featured -->
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="http://getpelican.com/">Pelican</a></li>
                                                        <li><a href="http://python.org/">Python.org</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/yszheda">GitHub</a></li>
                                                        <li><a href="https://twitter.com/yszheda">Twitter</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>