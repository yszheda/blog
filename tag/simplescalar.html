<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Galoisplusplus - SimpleScalar</title>
                        <link rel="stylesheet" href="../theme/css/main.css" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../">Galoisplusplus</a></h1>
                        <nav><ul>
                                                <li><a href="../category/misc.html">misc</a></li>
                                                <li><a href="../category/music.html">music</a></li>
                                                <li><a href="../category/reading.html">reading</a></li>
                                                <li><a href="../category/tech.html">tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="../2013/08/23/20130823-learn-branch-prediction-from-simplescalar-source-2.html">Learn branch prediction from SimpleScalar source (2)</a></h1>
<footer class="post-info">
        <abbr class="published" title="2013-08-23T16:12:00+08:00">
                Published: 五 23 8月 2013
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="../category/tech.html">tech</a>.</p>
<p>tags: <a href="../tag/tech.html">tech</a> <a href="../tag/cs.html">CS</a> <a href="../tag/branch-prediction.html">Branch Prediction</a> <a href="../tag/simplescalar.html">SimpleScalar</a> <a href="../tag/computer-architecture.html">Computer Architecture</a> <a href="../tag/fen-zhi-yu-ce.html">分支预测</a> <a href="../tag/ti-xi-jie-gou.html">体系结构</a> <a href="../tag/ji-suan-ji-ti-xi.html">计算机体系</a> </p>        
</footer><!-- /.post-info --><p>(施工中...)</p>
<h2 id="branch-direction-predictor">branch direction predictor</h2>
<h3 id="dynamic-branch-prediction">dynamic branch prediction</h3>
<h4 id="correlated-branch-predictor">correlated branch predictor</h4>
<p>前面提到我们用一张被称为PHT（Pattern History Table）的hash table来存放branch指令的跳转历史，我们也解释了这张hash table的entry如何更新以及如何根据entry来作出相应的预测。
接下来的问题是使用什么hash function？</p>
<!--
既然PHT的index是以branch指令的PC（Program Counter）的hash值，那么
-->
<p>最自然的想法当然是以branch指令的PC（Program Counter）作为hash值。
这样的想法已经可以应对简单的branch，可是实际程序中的分支往往很复杂，导致这种简单的实现方式的正确率很低。
导致分支复杂性的一大原因是分支与分支之间存在关联（correlation），即其中某分支是否跳转取决于其他分支的结果。</p>
<p>以SPEC Benchmark中的eqntott程序的一段代码为例：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">if</span><span class="p">(</span><span class="n">aa</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">         </span><span class="cm">/*branch-1*/</span>
<span class="w">    </span><span class="n">aa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">bb</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">         </span><span class="cm">/*branch-2*/</span>
<span class="w">    </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">aa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="cm">/*branch-3*/</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>branch-3的结果与branch-1和branch-2相关，这种相关性看了下面的branch tree便一目了然：</p>
<p>以branch指令的PC作为hash值的branch predictor无法准确预测像branch-3这种分支，因为这种predictor完全忽略了分支之间的关联性。
这种predictor（假设PHT的entry是2-bit saturating counter）的运作情况如下表所示：</p>
<p>由上表已很难看出branch-3的跳转历史与实际跳转行为的关系，但如果我们从branch path的角度来看，我们便不难发现branch-3实际跳转行为的规律性：</p>
<p>当我们考虑到branch之间的关联性后，我们就可以借助其他branch的跳转结果来预测当前branch指令会遵循什么模式（branch path）。而branch path只需采用一个shift register来记录最近其他branch的跳转结果。这个register的width取决于与该branch相关的分支数目。
以上例来说，由于与branch-3相关的有两个分支，所以这个shift register用2-bit即可。
这个shift register是correlated branch predictor的关键，我们把它称为Branch History Register (BHR)。</p>
<h4 id="2-level-branch-predictor">2-level branch predictor</h4>
<p>2-level branch predictor是对correlated branch predictor的进一步拓展。
BHR与PHT一样有三种模式：
- Global
- Per-set
- Per-address</p>
<h4 id="gshare-branch-predictor">gshare branch predictor</h4>
<h4 id="hybrid-branch-predictor">hybrid branch predictor</h4>
<h2 id="branch-target-buffer">Branch Target Buffer</h2>
<h2 id="return-address-stack">Return Address Stack</h2>
<h2 id="_1">参考资料</h2>
<p>[1]<a href="http://www.hpl.hp.com/techreports/Compaq-DEC/WRL-TN-36.pdf">McFarling S. Combining branch predictors[R]. Technical Report TN-36, Digital Western Research Laboratory, 1993.</a></p>
<p>[2]<a href="http://users.ece.gatech.edu/~leehs/ECE6100/papers/Pan92.pdf">Pan S T, So K, Rahmeh J T. Improving the accuracy of dynamic branch prediction using branch correlation[C]//ACM SIGPLAN Notices. ACM, 1992, 27(9): 76-84.</a></p>
<p>[3]<a href="https://cs.binghamton.edu/~ghose/CS522/papers/yehpattISCA92.pdf">Yeh T Y, Patt Y N. Alternative implementations of two-level adaptive branch prediction[C]//ACM SIGARCH Computer Architecture News. ACM, 1992, 20(2): 124-134.</a></p>                    </article>
                </aside><!-- /#featured -->
                    <section id="content" class="body">
                        <h1>Other articles</h1>
                        <hr />
                        <ol id="posts-list" class="hfeed">

                <li><article class="hentry">
                    <header>
                        <h1><a href="../2013/07/22/20130722-learn-branch-predictor-from-simplescalar-source-1.html" rel="bookmark"
                               title="Permalink to Learn branch prediction from SimpleScalar source (1)">Learn branch prediction from SimpleScalar source (1)</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-07-22T17:10:00+08:00">
                Published: 一 22 7月 2013
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="../category/tech.html">tech</a>.</p>
<p>tags: <a href="../tag/tech.html">tech</a> <a href="../tag/cs.html">CS</a> <a href="../tag/branch-prediction.html">Branch Prediction</a> <a href="../tag/simplescalar.html">SimpleScalar</a> <a href="../tag/computer-architecture.html">Computer Architecture</a> <a href="../tag/fen-zhi-yu-ce.html">分支预测</a> <a href="../tag/ti-xi-jie-gou.html">体系结构</a> <a href="../tag/ji-suan-ji-ti-xi.html">计算机体系</a> </p>        
</footer><!-- /.post-info -->                        <p>作为一名CSer，最好的学习方式之一无疑是tracing code，看源代码——
不知你此时是否与我一样想起了Linus那句名言「talk is cheap, show me the <del>fucking</del> code!」?
可是对计 …</p>
                        <a class="readmore" href="../2013/07/22/20130722-learn-branch-predictor-from-simplescalar-source-1.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>
                    </ol><!-- /#posts-list -->
                    </section><!-- /#content -->
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="http://getpelican.com/">Pelican</a></li>
                                                        <li><a href="http://python.org/">Python.org</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/yszheda">GitHub</a></li>
                                                        <li><a href="https://twitter.com/yszheda">Twitter</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>