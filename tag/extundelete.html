<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Galoisplusplus - extundelete</title>
                        <link rel="stylesheet" href="http://yszheda.github.io/blog/theme/css/main.css" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="http://yszheda.github.io/blog/">Galoisplusplus</a></h1>
                        <nav><ul>
                                                <li><a href="http://yszheda.github.io/blog/category/misc.html">misc</a></li>
                                                <li><a href="http://yszheda.github.io/blog/category/music.html">music</a></li>
                                                <li><a href="http://yszheda.github.io/blog/category/reading.html">reading</a></li>
                                                <li><a href="http://yszheda.github.io/blog/category/tech.html">tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="http://yszheda.github.io/blog/2016/02/02/20160202-how-to-restore-deleted-file-in-linux.html">小记Linux/UNIX下错删文件恢复</a></h1>
<footer class="post-info">
        <abbr class="published" title="2016-02-02T22:43:00+08:00">
                Published: 二 02 2月 2016
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="http://yszheda.github.io/blog/author/galoisplusplus.html">Galoisplusplus</a>
                </address>
        <p>In <a href="http://yszheda.github.io/blog/category/tech.html">tech</a>.</p>
<p>tags: <a href="http://yszheda.github.io/blog/tag/linux.html">Linux</a> <a href="http://yszheda.github.io/blog/tag/cs.html">CS</a> <a href="http://yszheda.github.io/blog/tag/tech.html">tech</a> <a href="http://yszheda.github.io/blog/tag/linux.html">linux</a> <a href="http://yszheda.github.io/blog/tag/wen-jian-hui-fu.html">文件恢复</a> <a href="http://yszheda.github.io/blog/tag/recover.html">recover</a> <a href="http://yszheda.github.io/blog/tag/lsof.html">lsof</a> <a href="http://yszheda.github.io/blog/tag/extundelete.html">extundelete</a> <a href="http://yszheda.github.io/blog/tag/debugfs.html">debugfs</a> <a href="http://yszheda.github.io/blog/tag/photorec.html">PhotoRec</a> </p>        
</footer><!-- /.post-info --><p>一个月前，我的洁癖犯了，想执行<code>find . -name "*~" -exec rm {} \;</code>清下某目录下由vim生成的~文件，不料漏打了<code>~</code>，把一些文件删掉了...好在有用<code>git</code>做版本控制，即使<code>.git/index</code>也被删没了，但也可以通过<code>git reset</code>恢复，之后再用<code>git</code>恢复版本管理中的其他被删文件即可。不料今天二月二号，我又犯二了，被做死历史<code>find . -name "*" -exec rm {} \;</code>坑了一把...这次被删的还有不少特意不放在版本控制的配置文件，这次不得不做文件恢复了。</p>
<p>最简单的情况是被删除的文件被某个进程打开，这个时候可以通过该进程在<code>/proc</code>下的文件描述符来恢复。首先由<code>lsof</code>找到打开文件的进程，有了<code>PID</code>和<code>FD</code>之后，就可以执行以下命令恢复文件：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>cp /proc/&lt;PID&gt;/fd/&lt;FD&gt; &lt;recovered-file&gt;
</code></pre></div></td></tr></table></div>

<p>不幸的是，我删的文件并没有被打开...所以不能用这种方式了。<code>df -T</code>查到被删文件所在的文件系统是ext4，于是可以试试ext的文件恢复方法。</p>
<p>ext3/ext4文件系统的恢复可以用<code>extundelete</code>，例如恢复被误删的目录可以用：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>extundelete /dev/&lt;device&gt; --restore-directory &lt;path&gt;
</code></pre></div></td></tr></table></div>

<p>恢复被误删的文件可以用：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>extundelete --restore-file &lt;path/to/deleted/file&gt;
</code></pre></div></td></tr></table></div>

<p>此外也可以用<code>debugfs</code>工具，相较<code>extundelete</code>，<code>debugfs</code>适用于ext2/ext3/ext4文件系统</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>debugfs -w /dev/&lt;device&gt;
</code></pre></div></td></tr></table></div>

<p>在<code>debugfs</code>中用<code>lsdel</code>查找最近的删除操作，找到被删文件的inode：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">debugfs</span><span class="o">:</span><span class="w"> </span><span class="n">lsdel</span>
</code></pre></div></td></tr></table></div>

<p>接下来当然还是可以用<code>extundelete</code>：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>extundelete --restore-inode &lt;inode&gt;
</code></pre></div></td></tr></table></div>

<p>不过也可以用<code>debugfs</code>：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">debugfs</span><span class="o">:</span><span class="w"> </span><span class="n">dump</span><span class="w"> </span><span class="o">&lt;</span><span class="n">inode</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">recovered</span><span class="o">-</span><span class="n">file</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>

<p>不少资料还提到，可以先在<code>debugfs</code>中用：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">debugfs</span><span class="o">:</span><span class="w"> </span><span class="n">logdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="n">inode</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>

<p>找到以下信息</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>Blocks: (&lt;block id&gt;): &lt;block offset&gt;
</code></pre></div></td></tr></table></div>

<p>再通过<code>dd</code>命令恢复文件。</p>
<p>不过<code>extundelete</code>和<code>debugfs</code>可谓是段誉的六脉神剑，时灵时不灵的，我的问题竟也无法通过它们搞定，最后无奈只好动用<a href="http://www.cgsecurity.org/wiki/PhotoRec">PhotoRec</a>“黑科技”了...PhotoRec恢复后的文件名好乱，好在我还有<a href="https://github.com/ggreer/the_silver_searcher">ag</a>这种大杀器，找到被删的配置文件是分分钟的事XDD</p>
<p>哎，恢复文件真是麻烦，又想起了Zoom大妈的名言“冗余不做，日子甭过；备份不做，十恶不赦！”...</p>
<h1 id="_1">参考资料</h1>
<p>[1]<a href="http://man7.org/linux/man-pages/man5/proc.5.html">man proc</a></p>
<p>[2]<a href="http://www.ibm.com/developerworks/aix/library/au-lsof.html">Finding open files with lsof</a></p>
<p>[3]<a href="http://archive09.linux.com/feature/58142">Bring back deleted files with lsof</a></p>
<p>[4]<a href="http://superuser.com/questions/283102/how-to-recover-deleted-file-if-it-is-still-opened-by-some-process">How to recover deleted file if it is still opened by some process?</a></p>
<p>[5]身为Arch党自然要安利一发Archwiki：<a href="https://wiki.archlinux.org/index.php/File_recovery">File recovery</a></p>
<p>[6]<a href="http://www.tech-g.com/2014/01/27/recovering-files-from-ext4-partition/">Recovering files from ext4 partition</a></p>
<p>[7]<a href="http://linux.die.net/man/8/debugfs">man debugfs</a></p>
<p>[8]<a href="http://www.cyberciti.biz/tips/linux-ext3-ext4-deleted-files-recovery-howto.html">Linux debugfs Hack: Undelete Files</a></p>
<p>[9]<a href="http://stackoverflow.com/questions/18197365/linux-file-deleted-recovery">Linux file deleted recovery</a></p>
<p>[10]<a href="http://unix.stackexchange.com/questions/122305/undelete-a-just-deleted-file-on-ext4-with-extundelete">undelete a just deleted file on ext4 with extundelete</a></p>
<p>[11]<a href="http://unix.stackexchange.com/questions/80270/unix-linux-undelete-recover-deleted-files">Unix/Linux undelete/recover deleted files</a></p>
<p>[12]<a href="http://sundayhut.is-programmer.com/posts/50859.html">debugfs总结</a></p>
<p>[13]<a href="http://coolshell.cn/articles/1265.html">恢复Ext3下被删除的文件</a></p>
<p>[14]这里有一些<a href="http://www.cgsecurity.org/wiki/After_Using_PhotoRec">脚本</a>用来整理PhotoRec恢复的文件</p>                    </article>
                </aside><!-- /#featured -->
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="http://getpelican.com/">Pelican</a></li>
                                                        <li><a href="http://python.org/">Python.org</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/yszheda">GitHub</a></li>
                                                        <li><a href="https://twitter.com/yszheda">Twitter</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>